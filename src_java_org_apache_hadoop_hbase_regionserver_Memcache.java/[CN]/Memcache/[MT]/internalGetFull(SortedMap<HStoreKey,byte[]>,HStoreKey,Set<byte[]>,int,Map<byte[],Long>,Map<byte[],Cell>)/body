{
  if (map.isEmpty() || key == null) {
    return;
  }
  List<HStoreKey> victims=new ArrayList<HStoreKey>();
  SortedMap<HStoreKey,byte[]> tailMap=map.tailMap(key);
  long now=System.currentTimeMillis();
  for (  Map.Entry<HStoreKey,byte[]> es : tailMap.entrySet()) {
    HStoreKey itKey=es.getKey();
    byte[] itCol=itKey.getColumn();
    Cell cell=results.get(itCol);
    if ((cell == null || cell.getNumValues() < numVersions) && key.matchesWithoutColumn(itKey)) {
      if (columns == null || columns.contains(itKey.getColumn())) {
        byte[] val=tailMap.get(itKey);
        if (HLogEdit.isDeleted(val)) {
          if (!deletes.containsKey(itCol) || deletes.get(itCol).longValue() < itKey.getTimestamp()) {
            deletes.put(itCol,Long.valueOf(itKey.getTimestamp()));
          }
        }
 else         if (!(deletes.containsKey(itCol) && deletes.get(itCol).longValue() >= itKey.getTimestamp())) {
          if (ttl == HConstants.FOREVER || now < itKey.getTimestamp() + ttl) {
            if (cell == null) {
              results.put(itCol,new Cell(val,itKey.getTimestamp()));
            }
 else {
              cell.add(val,itKey.getTimestamp());
            }
          }
 else {
            addVictim(victims,itKey);
          }
        }
      }
    }
 else     if (this.rawcomparator.compareRows(key.getRow(),itKey.getRow()) < 0) {
      break;
    }
  }
  for (  HStoreKey v : victims) {
    map.remove(v);
  }
}
