{
  HStoreKey strippedKey=null;
  HStoreKey search_key=candidateKeys.isEmpty() ? new HStoreKey(key) : new HStoreKey(candidateKeys.firstKey().getRow());
  Iterator<HStoreKey> key_iterator=null;
  HStoreKey found_key=null;
  ArrayList<HStoreKey> victims=new ArrayList<HStoreKey>();
  long now=System.currentTimeMillis();
  SortedMap<HStoreKey,byte[]> tailMap=map.tailMap(search_key);
  if (!tailMap.isEmpty() && Bytes.compareTo(tailMap.firstKey().getRow(),key) <= 0) {
    key_iterator=tailMap.keySet().iterator();
    do {
      found_key=key_iterator.next();
      if (Bytes.compareTo(found_key.getRow(),key) <= 0) {
        strippedKey=stripTimestamp(found_key);
        if (HLogEdit.isDeleted(tailMap.get(found_key))) {
          if (candidateKeys.containsKey(strippedKey)) {
            long bestCandidateTs=candidateKeys.get(strippedKey).longValue();
            if (bestCandidateTs <= found_key.getTimestamp()) {
              candidateKeys.remove(strippedKey);
            }
          }
        }
 else {
          if (ttl == HConstants.FOREVER || now < found_key.getTimestamp() + ttl) {
            candidateKeys.put(strippedKey,new Long(found_key.getTimestamp()));
          }
 else {
            victims.add(found_key);
            if (LOG.isDebugEnabled()) {
              LOG.debug(":" + found_key + ": expired, skipped");
            }
          }
        }
      }
    }
 while (Bytes.compareTo(found_key.getRow(),key) <= 0 && key_iterator.hasNext());
  }
 else {
    SortedMap<HStoreKey,byte[]> headMap=map.headMap(search_key);
    if (headMap.isEmpty()) {
      return;
    }
    if (candidateKeys.isEmpty()) {
      HStoreKey[] cells=headMap.keySet().toArray(new HStoreKey[headMap.keySet().size()]);
      byte[] lastRowFound=null;
      for (int i=cells.length - 1; i >= 0; i--) {
        HStoreKey thisKey=cells[i];
        if (lastRowFound != null && !Bytes.equals(lastRowFound,thisKey.getRow())) {
          break;
        }
        if (!HLogEdit.isDeleted(headMap.get(thisKey))) {
          if (ttl == HConstants.FOREVER) {
            lastRowFound=thisKey.getRow();
            candidateKeys.put(stripTimestamp(thisKey),new Long(thisKey.getTimestamp()));
          }
 else {
            victims.add(found_key);
            if (LOG.isDebugEnabled()) {
              LOG.debug("internalGetRowKeyAtOrBefore: " + found_key + ": expired, skipped");
            }
          }
        }
      }
    }
 else {
      SortedMap<HStoreKey,byte[]> thisRowTailMap=headMap.tailMap(new HStoreKey(headMap.lastKey().getRow()));
      key_iterator=thisRowTailMap.keySet().iterator();
      do {
        found_key=key_iterator.next();
        if (HLogEdit.isDeleted(thisRowTailMap.get(found_key))) {
          strippedKey=stripTimestamp(found_key);
          if (candidateKeys.containsKey(strippedKey)) {
            long bestCandidateTs=candidateKeys.get(strippedKey).longValue();
            if (bestCandidateTs <= found_key.getTimestamp()) {
              candidateKeys.remove(strippedKey);
            }
          }
        }
 else {
          if (ttl == HConstants.FOREVER || now < found_key.getTimestamp() + ttl) {
            candidateKeys.put(stripTimestamp(found_key),Long.valueOf(found_key.getTimestamp()));
          }
 else {
            victims.add(found_key);
            if (LOG.isDebugEnabled()) {
              LOG.debug("internalGetRowKeyAtOrBefore: " + found_key + ": expired, skipped");
            }
          }
        }
      }
 while (key_iterator.hasNext());
    }
  }
  for (  HStoreKey victim : victims)   map.remove(victim);
}
