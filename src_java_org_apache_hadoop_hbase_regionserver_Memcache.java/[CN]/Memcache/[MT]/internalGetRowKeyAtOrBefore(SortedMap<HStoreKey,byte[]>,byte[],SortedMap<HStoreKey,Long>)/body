{
  HStoreKey search_key=candidateKeys.isEmpty() ? new HStoreKey(row) : new HStoreKey(candidateKeys.firstKey().getRow());
  List<HStoreKey> victims=new ArrayList<HStoreKey>();
  long now=System.currentTimeMillis();
  SortedMap<HStoreKey,byte[]> tailMap=map.tailMap(search_key);
  if (!tailMap.isEmpty() && Bytes.compareTo(tailMap.firstKey().getRow(),search_key.getRow()) <= 0) {
    Iterator<HStoreKey> key_iterator=tailMap.keySet().iterator();
    HStoreKey deletedOrExpiredRow=null;
    for (HStoreKey found_key=null; key_iterator.hasNext() && (found_key == null || Bytes.compareTo(found_key.getRow(),row) <= 0); ) {
      found_key=key_iterator.next();
      if (Bytes.compareTo(found_key.getRow(),row) <= 0) {
        if (HLogEdit.isDeleted(tailMap.get(found_key))) {
          handleDeleted(found_key,candidateKeys);
          if (deletedOrExpiredRow == null) {
            deletedOrExpiredRow=found_key;
          }
        }
 else {
          if (ttl == HConstants.FOREVER || now < found_key.getTimestamp() + ttl) {
            HStoreKey strippedKey=stripTimestamp(found_key);
            candidateKeys.put(strippedKey,new Long(found_key.getTimestamp()));
          }
 else {
            if (deletedOrExpiredRow == null) {
              deletedOrExpiredRow=new HStoreKey(found_key);
            }
            victims.add(found_key);
            if (LOG.isDebugEnabled()) {
              LOG.debug("internalGetRowKeyAtOrBefore:" + found_key + " expired, skipped");
            }
          }
        }
      }
    }
    if (candidateKeys.isEmpty() && deletedOrExpiredRow != null) {
      getRowKeyBefore(map,deletedOrExpiredRow,candidateKeys,victims,now);
    }
  }
 else {
    getRowKeyBefore(map,search_key,candidateKeys,victims,now);
  }
  for (  HStoreKey victim : victims) {
    map.remove(victim);
  }
}
