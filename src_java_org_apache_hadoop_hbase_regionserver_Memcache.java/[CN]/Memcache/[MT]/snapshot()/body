{
  this.lock.writeLock().lock();
  try {
    if (this.snapshot.size() > 0) {
      LOG.debug("Returning existing snapshot. Either the snapshot was run " + "by the region -- normal operation but to be fixed -- or there is " + "another ongoing flush or did we fail last attempt?");
      return this.snapshot;
    }
    if (this.memcache.size() != 0) {
      this.snapshot=this.memcache;
      this.memcache=createSynchronizedSortedMap();
    }
    return this.snapshot;
  }
  finally {
    this.lock.writeLock().unlock();
  }
}
