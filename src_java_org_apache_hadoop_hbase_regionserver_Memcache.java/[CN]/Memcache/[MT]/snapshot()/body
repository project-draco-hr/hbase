{
  this.lock.writeLock().lock();
  try {
    if (this.snapshot.size() > 0) {
      LOG.warn("Returning extant snapshot. Is there another ongoing " + "flush or did last attempt fail?");
      return this.snapshot;
    }
    if (this.memcache.size() != 0) {
      this.snapshot=this.memcache;
      this.memcache=createSynchronizedSortedMap();
    }
    return this.snapshot;
  }
  finally {
    this.lock.writeLock().unlock();
  }
}
