{
  long now=System.currentTimeMillis();
  List<HStoreKey> result=new ArrayList<HStoreKey>();
  List<HStoreKey> victims=new ArrayList<HStoreKey>();
  SortedMap<HStoreKey,byte[]> tailMap=map.tailMap(origin);
  for (  Map.Entry<HStoreKey,byte[]> es : tailMap.entrySet()) {
    HStoreKey key=es.getKey();
    if (origin.getColumn().length == 0) {
      if (!Bytes.equals(key.getRow(),origin.getRow())) {
        break;
      }
      if (key.getTimestamp() > origin.getTimestamp()) {
        continue;
      }
    }
 else {
      if (!key.matchesRowCol(origin)) {
        break;
      }
    }
    if (!HLogEdit.isDeleted(es.getValue())) {
      if (ttl == HConstants.FOREVER || now < key.getTimestamp() + ttl) {
        result.add(key);
      }
 else {
        victims.add(key);
        if (LOG.isDebugEnabled()) {
          LOG.debug("internalGetKeys: " + key + ": expired, skipped");
        }
      }
      if (result.size() >= versions) {
        break;
      }
    }
  }
  for (  HStoreKey v : victims)   map.remove(v);
  return result;
}
