{
  MiniHBaseCluster cluster=UTIL.getHBaseCluster();
  final TableName tableName=TableName.valueOf(name.getMethodName());
  HMaster master=cluster.getMaster();
  MasterCoprocessorHost host=master.getMasterCoprocessorHost();
  CPMasterObserver cp=(CPMasterObserver)host.findCoprocessor(CPMasterObserver.class.getName());
  cp.enableBypass(true);
  cp.resetStates();
  assertFalse("No table created yet",cp.wasCreateTableCalled());
  HTableDescriptor htd=new HTableDescriptor(tableName);
  htd.addFamily(new HColumnDescriptor(TEST_FAMILY));
  Admin admin=UTIL.getHBaseAdmin();
  tableCreationLatch=new CountDownLatch(1);
  admin.createTable(htd);
  assertTrue("Test table should be created",cp.wasCreateTableCalled());
  tableCreationLatch.await();
  assertTrue("Table pre create handler called.",cp.wasPreCreateTableHandlerCalled());
  assertTrue("Table create handler should be called.",cp.wasCreateTableHandlerCalled());
  tableCreationLatch=new CountDownLatch(1);
  admin.disableTable(tableName);
  assertTrue(admin.isTableDisabled(tableName));
  assertTrue("Coprocessor should have been called on table disable",cp.wasDisableTableCalled());
  assertTrue("Disable table handler should be called.",cp.wasDisableTableHandlerCalled());
  assertFalse(cp.wasEnableTableCalled());
  admin.enableTable(tableName);
  assertTrue(admin.isTableEnabled(tableName));
  assertTrue("Coprocessor should have been called on table enable",cp.wasEnableTableCalled());
  assertTrue("Enable table handler should be called.",cp.wasEnableTableHandlerCalled());
  admin.disableTable(tableName);
  assertTrue(admin.isTableDisabled(tableName));
  htd.setMaxFileSize(512 * 1024 * 1024);
  modifyTableSync(admin,tableName,htd);
  assertTrue("Test table should have been modified",cp.wasModifyTableCalled());
  admin.addColumn(tableName,new HColumnDescriptor(TEST_FAMILY2));
  assertTrue("New column family shouldn't have been added to test table",cp.preAddColumnCalledOnly());
  HColumnDescriptor hcd1=new HColumnDescriptor(TEST_FAMILY2);
  hcd1.setMaxVersions(25);
  admin.modifyColumn(tableName,hcd1);
  assertTrue("Second column family should be modified",cp.preModifyColumnCalledOnly());
  admin.truncateTable(tableName,false);
  admin.disableTable(tableName);
  assertTrue(admin.isTableDisabled(tableName));
  deleteTable(admin,tableName);
  assertFalse("Test table should have been deleted",admin.tableExists(tableName));
  assertTrue("Coprocessor should have been called on table delete",cp.wasDeleteTableCalled());
  assertTrue("Delete table handler should be called.",cp.wasDeleteTableHandlerCalled());
  cp.enableBypass(false);
  cp.resetStates();
  admin.createTable(htd);
  assertTrue("Test table should be created",cp.wasCreateTableCalled());
  tableCreationLatch.await();
  assertTrue("Table pre create handler called.",cp.wasPreCreateTableHandlerCalled());
  assertTrue("Table create handler should be called.",cp.wasCreateTableHandlerCalled());
  assertFalse(cp.wasDisableTableCalled());
  assertFalse(cp.wasDisableTableHandlerCalled());
  admin.disableTable(tableName);
  assertTrue(admin.isTableDisabled(tableName));
  assertTrue("Coprocessor should have been called on table disable",cp.wasDisableTableCalled());
  assertTrue("Disable table handler should be called.",cp.wasDisableTableHandlerCalled());
  htd.setMaxFileSize(512 * 1024 * 1024);
  modifyTableSync(admin,tableName,htd);
  assertTrue("Test table should have been modified",cp.wasModifyTableCalled());
  admin.addColumn(tableName,new HColumnDescriptor(TEST_FAMILY2));
  assertTrue("New column family should have been added to test table",cp.wasAddColumnCalled());
  assertTrue("Add column handler should be called.",cp.wasAddColumnHandlerCalled());
  HColumnDescriptor hcd=new HColumnDescriptor(TEST_FAMILY2);
  hcd.setMaxVersions(25);
  admin.modifyColumn(tableName,hcd);
  assertTrue("Second column family should be modified",cp.wasModifyColumnCalled());
  assertTrue("Modify table handler should be called.",cp.wasModifyColumnHandlerCalled());
  assertFalse(cp.wasEnableTableCalled());
  assertFalse(cp.wasEnableTableHandlerCalled());
  admin.enableTable(tableName);
  assertTrue(admin.isTableEnabled(tableName));
  assertTrue("Coprocessor should have been called on table enable",cp.wasEnableTableCalled());
  assertTrue("Enable table handler should be called.",cp.wasEnableTableHandlerCalled());
  admin.disableTable(tableName);
  assertTrue(admin.isTableDisabled(tableName));
  assertFalse("No column family deleted yet",cp.wasDeleteColumnCalled());
  assertFalse("Delete table column handler should not be called.",cp.wasDeleteColumnHandlerCalled());
  admin.deleteColumn(tableName,TEST_FAMILY2);
  HTableDescriptor tableDesc=admin.getTableDescriptor(tableName);
  assertNull("'" + Bytes.toString(TEST_FAMILY2) + "' should have been removed",tableDesc.getFamily(TEST_FAMILY2));
  assertTrue("Coprocessor should have been called on column delete",cp.wasDeleteColumnCalled());
  assertTrue("Delete table column handler should be called.",cp.wasDeleteColumnHandlerCalled());
  assertFalse("No table deleted yet",cp.wasDeleteTableCalled());
  assertFalse("Delete table handler should not be called.",cp.wasDeleteTableHandlerCalled());
  deleteTable(admin,tableName);
  assertFalse("Test table should have been deleted",admin.tableExists(tableName));
  assertTrue("Coprocessor should have been called on table delete",cp.wasDeleteTableCalled());
  assertTrue("Delete table handler should be called.",cp.wasDeleteTableHandlerCalled());
}
