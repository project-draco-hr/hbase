{
  try {
    checkOpen();
    requestCount.increment();
    HRegion region=getRegion(request.getRegion());
    LOG.info("Flushing " + region.getRegionNameAsString());
    boolean shouldFlush=true;
    if (request.hasIfOlderThanTs()) {
      shouldFlush=region.getEarliestFlushTimeForAllStores() < request.getIfOlderThanTs();
    }
    FlushRegionResponse.Builder builder=FlushRegionResponse.newBuilder();
    if (shouldFlush) {
      boolean writeFlushWalMarker=request.hasWriteFlushWalMarker() ? request.getWriteFlushWalMarker() : false;
      long startTime=EnvironmentEdgeManager.currentTime();
      HRegion.FlushResult flushResult=region.flushcache(true,writeFlushWalMarker);
      if (flushResult.isFlushSucceeded()) {
        long endTime=EnvironmentEdgeManager.currentTime();
        regionServer.metricsRegionServer.updateFlushTime(endTime - startTime);
      }
      boolean compactionNeeded=flushResult.isCompactionNeeded();
      if (compactionNeeded) {
        regionServer.compactSplitThread.requestSystemCompaction(region,"Compaction through user triggered flush");
      }
      builder.setFlushed(flushResult.isFlushSucceeded());
      builder.setWroteFlushWalMarker(flushResult.wroteFlushWalMarker);
    }
    builder.setLastFlushTime(region.getEarliestFlushTimeForAllStores());
    return builder.build();
  }
 catch (  DroppedSnapshotException ex) {
    regionServer.abort("Replay of WAL required. Forcing server shutdown",ex);
    throw new ServiceException(ex);
  }
catch (  IOException ie) {
    throw new ServiceException(ie);
  }
}
