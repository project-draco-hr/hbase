{
  try {
    checkOpen();
    requestCount.increment();
    Region regionA=getRegion(request.getRegionA());
    Region regionB=getRegion(request.getRegionB());
    boolean forcible=request.getForcible();
    regionA.startRegionOperation(Operation.MERGE_REGION);
    regionB.startRegionOperation(Operation.MERGE_REGION);
    if (regionA.getRegionInfo().getReplicaId() != HRegionInfo.DEFAULT_REPLICA_ID || regionB.getRegionInfo().getReplicaId() != HRegionInfo.DEFAULT_REPLICA_ID) {
      throw new ServiceException(new MergeRegionException("Can't merge non-default replicas"));
    }
    LOG.info("Receiving merging request for  " + regionA + ", "+ regionB+ ",forcible="+ forcible);
    long startTime=EnvironmentEdgeManager.currentTime();
    FlushResult flushResult=regionA.flush(true);
    if (flushResult.isFlushSucceeded()) {
      long endTime=EnvironmentEdgeManager.currentTime();
      regionServer.metricsRegionServer.updateFlushTime(endTime - startTime);
    }
    startTime=EnvironmentEdgeManager.currentTime();
    flushResult=regionB.flush(true);
    if (flushResult.isFlushSucceeded()) {
      long endTime=EnvironmentEdgeManager.currentTime();
      regionServer.metricsRegionServer.updateFlushTime(endTime - startTime);
    }
    regionServer.compactSplitThread.requestRegionsMerge(regionA,regionB,forcible);
    return MergeRegionsResponse.newBuilder().build();
  }
 catch (  DroppedSnapshotException ex) {
    regionServer.abort("Replay of WAL required. Forcing server shutdown",ex);
    throw new ServiceException(ex);
  }
catch (  IOException ie) {
    throw new ServiceException(ie);
  }
}
