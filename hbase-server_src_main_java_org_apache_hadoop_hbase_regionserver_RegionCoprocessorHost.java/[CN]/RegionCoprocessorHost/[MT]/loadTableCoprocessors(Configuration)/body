{
  List<RegionEnvironment> configured=new ArrayList<RegionEnvironment>();
  for (  Map.Entry<ImmutableBytesWritable,ImmutableBytesWritable> e : region.getTableDesc().getValues().entrySet()) {
    String key=Bytes.toString(e.getKey().get()).trim();
    String spec=Bytes.toString(e.getValue().get()).trim();
    if (HConstants.CP_HTD_ATTR_KEY_PATTERN.matcher(key).matches()) {
      try {
        Matcher matcher=HConstants.CP_HTD_ATTR_VALUE_PATTERN.matcher(spec);
        if (matcher.matches()) {
          Path path=matcher.group(1).trim().isEmpty() ? null : new Path(matcher.group(1).trim());
          String className=matcher.group(2).trim();
          int priority=matcher.group(3).trim().isEmpty() ? Coprocessor.PRIORITY_USER : Integer.valueOf(matcher.group(3));
          String cfgSpec=null;
          try {
            cfgSpec=matcher.group(4);
          }
 catch (          IndexOutOfBoundsException ex) {
          }
          Configuration ourConf;
          if (cfgSpec != null) {
            cfgSpec=cfgSpec.substring(cfgSpec.indexOf('|') + 1);
            ourConf=new Configuration(false);
            HBaseConfiguration.merge(ourConf,conf);
            Matcher m=HConstants.CP_HTD_ATTR_VALUE_PARAM_PATTERN.matcher(cfgSpec);
            while (m.find()) {
              ourConf.set(m.group(1),m.group(2));
            }
          }
 else {
            ourConf=conf;
          }
          try {
            RegionEnvironment env=load(path,className,priority,ourConf);
            configured.add(env);
            LOG.info("Loaded coprocessor " + className + " from HTD of "+ region.getTableDesc().getTableName().getNameAsString()+ " successfully.");
          }
 catch (          Throwable t) {
            if (conf.getBoolean(ABORT_ON_ERROR_KEY,DEFAULT_ABORT_ON_ERROR)) {
              abortServer(className,t);
            }
 else {
              LOG.error("Failed to load coprocessor " + className,t);
            }
          }
        }
 else {
          LOG.error("Malformed table coprocessor specification: key=" + key + ", spec: "+ spec);
        }
      }
 catch (      Exception ioe) {
        LOG.error("Malformed table coprocessor specification: key=" + key + ", spec: "+ spec);
      }
    }
  }
  coprocessors.addAll(configured);
}
