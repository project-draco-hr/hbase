{
  MiniDFSCluster dfsCluster=null;
  try {
    dfsCluster=new MiniDFSCluster(conf,2,true,(String[])null);
    this.conf.set(HConstants.HBASE_DIR,new Path(dfsCluster.getFileSystem().getHomeDirectory(),"hbase").toString());
    FileSystem dfs=dfsCluster.getFileSystem();
    Path root=dfs.makeQualified(new Path(conf.get(HConstants.HBASE_DIR)));
    dfs.mkdirs(root);
    FileSystem localfs=FileSystem.getLocal(conf);
    FSDataInputStream hs=localfs.open(new Path(Path.CUR_DIR,"../../../src/testdata/HADOOP-2478-testdata.zip"));
    ZipInputStream zip=new ZipInputStream(hs);
    unzip(zip,dfs,root);
    zip.close();
    hs.close();
    listPaths(dfs,root,root.toString().length() + 1);
    Migrate u=new Migrate(conf);
    u.run(new String[]{"check"});
    listPaths(dfs,root,root.toString().length() + 1);
    u=new Migrate(conf);
    u.run(new String[]{"upgrade"});
    listPaths(dfs,root,root.toString().length() + 1);
    dfs.delete(new Path(root,HConstants.VERSION_FILE_NAME));
    u=new Migrate(conf);
    u.run(new String[]{"upgrade"});
    listPaths(dfs,root,root.toString().length() + 1);
    u=new Migrate(conf);
    u.run(new String[]{"check"});
    u=new Migrate(conf);
    u.run(new String[]{"upgrade"});
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
 finally {
    if (dfsCluster != null) {
      shutdownDfs(dfsCluster);
    }
  }
}
