{
  MiniDFSCluster dfsCluster=null;
  try {
    dfsCluster=new MiniDFSCluster(conf,2,true,(String[])null);
    this.conf.set(HConstants.HBASE_DIR,new Path(dfsCluster.getFileSystem().getHomeDirectory(),"hbase").toString());
    FileSystem dfs=dfsCluster.getFileSystem();
    Path rootDir=dfs.makeQualified(new Path(conf.get(HConstants.HBASE_DIR)));
    dfs.mkdirs(rootDir);
    loadTestData(dfs,rootDir);
    listPaths(dfs,rootDir,rootDir.toString().length() + 1);
    Migrate u=new Migrate(conf);
    u.run(new String[]{"check"});
    listPaths(dfs,rootDir,rootDir.toString().length() + 1);
    u=new Migrate(conf);
    u.run(new String[]{"upgrade"});
    listPaths(dfs,rootDir,rootDir.toString().length() + 1);
    u=new Migrate(conf);
    u.run(new String[]{"check"});
    u=new Migrate(conf);
    u.run(new String[]{"upgrade"});
    verify();
  }
  finally {
    if (dfsCluster != null) {
      shutdownDfs(dfsCluster);
    }
  }
}
