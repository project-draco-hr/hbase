{
  in.rewind();
  ByteBufferUtils.putInt(out,in.limit());
  DiffCompressionState previousState=new DiffCompressionState();
  DiffCompressionState currentState=new DiffCompressionState();
  while (in.hasRemaining()) {
    compressSingleKeyValue(previousState,currentState,out,in);
    afterEncodingKeyValue(in,out,includesMemstoreTS);
    DiffCompressionState tmp=previousState;
    previousState=currentState;
    currentState=tmp;
  }
}
