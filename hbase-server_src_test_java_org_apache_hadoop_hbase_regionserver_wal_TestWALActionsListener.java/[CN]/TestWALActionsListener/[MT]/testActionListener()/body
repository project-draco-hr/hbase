{
  DummyWALActionsListener observer=new DummyWALActionsListener();
  List<WALActionsListener> list=new ArrayList<WALActionsListener>();
  list.add(observer);
  final WALFactory wals=new WALFactory(conf,list,"testActionListener");
  DummyWALActionsListener laterobserver=new DummyWALActionsListener();
  final AtomicLong sequenceId=new AtomicLong(1);
  HRegionInfo hri=new HRegionInfo(TableName.valueOf(SOME_BYTES),SOME_BYTES,SOME_BYTES,false);
  final WAL wal=wals.getWAL(hri.getEncodedNameAsBytes());
  for (int i=0; i < 20; i++) {
    byte[] b=Bytes.toBytes(i + "");
    KeyValue kv=new KeyValue(b,b,b);
    WALEdit edit=new WALEdit();
    edit.add(kv);
    HTableDescriptor htd=new HTableDescriptor();
    htd.addFamily(new HColumnDescriptor(b));
    final long txid=wal.append(htd,hri,new WALKey(hri.getEncodedNameAsBytes(),TableName.valueOf(b),0),edit,sequenceId,true,null);
    wal.sync(txid);
    if (i == 10) {
      wal.registerWALActionsListener(laterobserver);
    }
    if (i % 2 == 0) {
      wal.rollWriter();
    }
  }
  wal.close();
  assertEquals(11,observer.preLogRollCounter);
  assertEquals(11,observer.postLogRollCounter);
  assertEquals(5,laterobserver.preLogRollCounter);
  assertEquals(5,laterobserver.postLogRollCounter);
  assertEquals(1,observer.closedCount);
}
