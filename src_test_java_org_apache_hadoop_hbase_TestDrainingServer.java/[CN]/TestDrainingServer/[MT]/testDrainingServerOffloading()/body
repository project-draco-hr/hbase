{
  HMaster master=TEST_UTIL.getMiniHBaseCluster().getMaster();
  HRegionInfo hriToMoveBack=null;
  HRegionServer drainingServer=setDrainingServer(TEST_UTIL.getMiniHBaseCluster().getRegionServer(0));
  try {
    final int regionsOnDrainingServer=drainingServer.getNumberOfOnlineRegions();
    Assert.assertTrue(regionsOnDrainingServer > 0);
    List<HRegionInfo> hris=ProtobufUtil.getOnlineRegions(drainingServer);
    for (    HRegionInfo hri : hris) {
      master.moveRegion(null,RequestConverter.buildMoveRegionRequest(hri.getEncodedNameAsBytes(),null));
      hriToMoveBack=hri;
    }
    waitForAllRegionsOnline();
    Assert.assertEquals(0,drainingServer.getNumberOfOnlineRegions());
  }
  finally {
    unsetDrainingServer(drainingServer);
  }
  master.moveRegion(null,RequestConverter.buildMoveRegionRequest(hriToMoveBack.getEncodedNameAsBytes(),Bytes.toBytes(drainingServer.getServerName().toString())));
  waitForAllRegionsOnline();
  Assert.assertEquals(1,drainingServer.getNumberOfOnlineRegions());
}
