{
  Scan scan=new Scan();
  byte[] family=request.getFamily().toByteArray();
  byte[] qualifier=request.hasQualifier() ? request.getQualifier().toByteArray() : null;
  if (request.hasQualifier()) {
    scan.addColumn(family,qualifier);
  }
 else {
    scan.addFamily(family);
  }
  int sumResult=0;
  InternalScanner scanner=null;
  try {
    scanner=this.env.getRegion().getScanner(scan);
    List<KeyValue> curVals=new ArrayList<KeyValue>();
    boolean hasMore=false;
    do {
      curVals.clear();
      hasMore=scanner.next(curVals);
      for (      KeyValue kv : curVals) {
        if (Bytes.equals(qualifier,kv.getQualifier())) {
          sumResult+=Bytes.toInt(kv.getBuffer(),kv.getValueOffset());
        }
      }
    }
 while (hasMore);
  }
 catch (  IOException e) {
    ResponseConverter.setControllerException(controller,e);
    sumResult=-1;
    LOG.info("Setting sum result to -1 to indicate error",e);
  }
 finally {
    if (scanner != null) {
      try {
        scanner.close();
      }
 catch (      IOException e) {
        ResponseConverter.setControllerException(controller,e);
        sumResult=-1;
        LOG.info("Setting sum result to -1 to indicate error",e);
      }
    }
  }
  done.run(SumResponse.newBuilder().setSum(sumResult).build());
}
