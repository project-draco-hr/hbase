{
  MapFile.Reader top=null;
  MapFile.Reader bottom=null;
  HStoreKey key=new HStoreKey();
  ImmutableBytesWritable value=new ImmutableBytesWritable();
  String previous=null;
  try {
    bottom=new HStoreFile.HalfMapFileReader(this.fs,p.toString(),this.conf,HStoreFile.Range.bottom,midkey,null);
    boolean first=true;
    while (bottom.next(key,value)) {
      previous=key.toString();
      if (first) {
        first=false;
        LOG.info("First in bottom: " + previous);
      }
      assertTrue(key.compareTo((HStoreKey)midkey) < 0);
    }
    if (previous != null) {
      LOG.info("Last in bottom: " + previous.toString());
    }
    top=new HStoreFile.HalfMapFileReader(this.fs,p.toString(),this.conf,HStoreFile.Range.top,midkey,null);
    first=true;
    while (top.next(key,value)) {
      assertTrue(key.compareTo((HStoreKey)midkey) >= 0);
      if (first) {
        first=false;
        assertTrue(Bytes.equals(((HStoreKey)midkey).getRow(),key.getRow()));
        LOG.info("First in top: " + key.toString());
      }
    }
    LOG.info("Last in top: " + key.toString());
    top.getClosest(midkey,value);
    assertTrue(Bytes.equals(value.get(),((HStoreKey)midkey).getRow()));
    WritableComparable badkey=new HStoreKey("   ");
    bottom=new HStoreFile.HalfMapFileReader(this.fs,p.toString(),this.conf,HStoreFile.Range.bottom,badkey,null);
    assertFalse(bottom.next(key,value));
    top=new HStoreFile.HalfMapFileReader(this.fs,p.toString(),this.conf,HStoreFile.Range.top,badkey,null);
    first=true;
    while (top.next(key,value)) {
      assertTrue(key.compareTo((HStoreKey)badkey) >= 0);
      if (first) {
        first=false;
        LOG.info("First top when key < bottom: " + key.toString());
        String tmp=Bytes.toString(key.getRow());
        for (int i=0; i < tmp.length(); i++) {
          assertTrue(tmp.charAt(i) == 'a');
        }
      }
    }
    LOG.info("Last top when key < bottom: " + key.toString());
    String tmp=Bytes.toString(key.getRow());
    for (int i=0; i < tmp.length(); i++) {
      assertTrue(tmp.charAt(i) == 'z');
    }
    badkey=new HStoreKey("|||");
    bottom=new HStoreFile.HalfMapFileReader(this.fs,p.toString(),this.conf,HStoreFile.Range.bottom,badkey,null);
    first=true;
    while (bottom.next(key,value)) {
      if (first) {
        first=false;
        LOG.info("First bottom when key > top: " + key.toString());
        tmp=Bytes.toString(key.getRow());
        for (int i=0; i < tmp.length(); i++) {
          assertTrue(tmp.charAt(i) == 'a');
        }
      }
    }
    LOG.info("Last bottom when key > top: " + key.toString());
    tmp=Bytes.toString(key.getRow());
    for (int i=0; i < tmp.length(); i++) {
      assertTrue(tmp.charAt(i) == 'z');
    }
    top=new HStoreFile.HalfMapFileReader(this.fs,p.toString(),this.conf,HStoreFile.Range.top,badkey,null);
    assertFalse(top.next(key,value));
  }
  finally {
    if (top != null) {
      top.close();
    }
    if (bottom != null) {
      bottom.close();
    }
    fs.delete(p,true);
  }
}
