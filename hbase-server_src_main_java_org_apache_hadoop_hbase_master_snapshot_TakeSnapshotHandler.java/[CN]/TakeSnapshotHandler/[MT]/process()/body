{
  String msg="Running " + snapshot.getType() + " table snapshot "+ snapshot.getName()+ " "+ eventType+ " on table "+ snapshotTable;
  LOG.info(msg);
  status.setStatus(msg);
  try {
    SnapshotDescriptionUtils.writeSnapshotInfo(snapshot,workingDir,this.fs);
    new TableInfoCopyTask(monitor,snapshot,fs,rootDir).call();
    monitor.rethrowException();
    List<Pair<HRegionInfo,ServerName>> regionsAndLocations=MetaReader.getTableRegionsAndLocations(this.server.getCatalogTracker(),snapshotTable,true);
    snapshotRegions(regionsAndLocations);
    monitor.rethrowException();
    Set<String> serverNames=new HashSet<String>();
    for (    Pair<HRegionInfo,ServerName> p : regionsAndLocations) {
      serverNames.add(p.getSecond().toString());
    }
    status.setStatus("Verifying snapshot: " + snapshot.getName());
    verifier.verifySnapshot(this.workingDir,serverNames);
    completeSnapshot(this.snapshotDir,this.workingDir,this.fs);
    status.markComplete("Snapshot " + snapshot.getName() + " of table "+ snapshotTable+ " completed");
    metricsMaster.addSnapshot(status.getCompletionTimestamp() - status.getStartTime());
  }
 catch (  Exception e) {
    status.abort("Failed to complete snapshot " + snapshot.getName() + " on table "+ snapshotTable+ " because "+ e.getMessage());
    String reason="Failed taking snapshot " + ClientSnapshotDescriptionUtils.toString(snapshot) + " due to exception:"+ e.getMessage();
    LOG.error(reason,e);
    ForeignException ee=new ForeignException(reason,e);
    monitor.receive(ee);
    cancel("Failed to take snapshot '" + ClientSnapshotDescriptionUtils.toString(snapshot) + "' due to exception");
  }
 finally {
    LOG.debug("Launching cleanup of working dir:" + workingDir);
    try {
      if (fs.exists(workingDir) && !this.fs.delete(workingDir,true)) {
        LOG.error("Couldn't delete snapshot working directory:" + workingDir);
      }
    }
 catch (    IOException e) {
      LOG.error("Couldn't delete snapshot working directory:" + workingDir);
    }
    releaseTableLock();
  }
}
