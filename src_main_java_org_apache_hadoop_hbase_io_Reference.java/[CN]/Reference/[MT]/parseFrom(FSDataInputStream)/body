{
  InputStream is=in.markSupported() ? in : new BufferedInputStream(in);
  int pblen=ProtobufUtil.lengthOfPBMagic();
  is.mark(pblen);
  byte[] pbuf=new byte[pblen];
  int read=is.read(pbuf);
  if (read != pblen)   throw new IOException("read=" + read + ", wanted="+ pblen);
  if (ProtobufUtil.isPBMagicPrefix(pbuf)) {
    return convert(FSProtos.Reference.parseFrom(is));
  }
 else {
    in.reset();
    Reference r=new Reference();
    r.readFields(in);
    return r;
  }
}
