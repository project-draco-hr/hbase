{
  int retries=30;
  int rows=0;
  HTable meta=new HTable(getConfiguration(),HConstants.META_TABLE_NAME);
  try {
    do {
      Scan scan=new Scan();
      scan.addColumn(HConstants.CATALOG_FAMILY,HConstants.REGIONINFO_QUALIFIER);
      scan.addColumn(HConstants.CATALOG_FAMILY,HConstants.SERVER_QUALIFIER);
      ResultScanner s=meta.getScanner(scan);
      try {
        for (Result r=null; (r=s.next()) != null; ) {
          byte[] b=r.getValue(HConstants.CATALOG_FAMILY,HConstants.REGIONINFO_QUALIFIER);
          HRegionInfo hri=HRegionInfo.parseFromOrNull(b);
          if (hri != null && Bytes.equals(hri.getTableName(),tableName)) {
            b=r.getValue(HConstants.CATALOG_FAMILY,HConstants.SERVER_QUALIFIER);
            if (b == null || b.length <= 0) {
              continue;
            }
            rows++;
          }
        }
      }
  finally {
        s.close();
      }
      if (rows == countOfRegions) {
        break;
      }
      LOG.info("Found=" + rows);
      Threads.sleep(1000);
    }
 while (--retries > 0);
  }
  finally {
    meta.close();
  }
  if (rows != countOfRegions) {
    throw new IOException("Timed out waiting for " + countOfRegions + " regions of "+ Bytes.toStringBinary(tableName)+ " to come online");
  }
}
