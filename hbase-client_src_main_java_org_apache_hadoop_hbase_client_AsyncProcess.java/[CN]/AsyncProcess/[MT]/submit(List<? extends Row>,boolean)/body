{
  if (rows.isEmpty()) {
    return;
  }
  Map<HRegionLocation,MultiAction<Row>> actionsByServer=new HashMap<HRegionLocation,MultiAction<Row>>();
  List<Action<Row>> retainedActions=new ArrayList<Action<Row>>(rows.size());
  do {
    waitForMaximumCurrentTasks(maxTotalConcurrentTasks - 1);
    Map<String,Boolean> regionIncluded=new HashMap<String,Boolean>();
    Map<ServerName,Boolean> serverIncluded=new HashMap<ServerName,Boolean>();
    int posInList=-1;
    Iterator<? extends Row> it=rows.iterator();
    while (it.hasNext()) {
      Row r=it.next();
      HRegionLocation loc=findDestLocation(r,1,posInList);
      if (loc != null && canTakeOperation(loc,regionIncluded,serverIncluded)) {
        Action<Row> action=new Action<Row>(r,++posInList);
        retainedActions.add(action);
        addAction(loc,action,actionsByServer);
        it.remove();
      }
    }
  }
 while (retainedActions.isEmpty() && atLeastOne && !hasError());
  HConnectionManager.ServerErrorTracker errorsByServer=createServerErrorTracker();
  sendMultiAction(retainedActions,actionsByServer,1,errorsByServer);
}
