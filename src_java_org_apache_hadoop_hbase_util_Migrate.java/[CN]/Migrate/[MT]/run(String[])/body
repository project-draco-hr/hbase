{
  parseArgs(args);
  try {
    HBaseAdmin admin=new HBaseAdmin(conf);
    if (admin.isMasterRunning()) {
      throw new IllegalStateException("HBase cluster must be off-line while being upgraded");
    }
  }
 catch (  MasterNotRunningException e) {
  }
  FileSystem fs=FileSystem.get(conf);
  Path rootdir=fs.makeQualified(new Path(conf.get(HConstants.HBASE_DIR,HConstants.DEFAULT_HBASE_DIR)));
  if (FSUtils.checkVersion(fs,rootdir)) {
    LOG.info("file system is at current level, no upgrade necessary");
    return 0;
  }
  extraFiles(fs,rootdir);
  Path rootRegion=new Path(rootdir,OLD_PREFIX + HRegionInfo.rootRegionInfo.getEncodedName());
  if (!fs.exists(rootRegion)) {
    throw new IOException("cannot find root region " + rootRegion.toString());
  }
  processRegionDir(fs,rootdir,HConstants.ROOT_TABLE_NAME,rootRegion);
  scanRootRegion(fs,rootdir);
  extraRegions(fs,rootdir);
  FSUtils.setVersion(fs,rootdir);
  return 0;
}
