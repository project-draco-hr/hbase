{
  if (this.check && this.migrationNeeded) {
    return;
  }
  Path hbaseRootDir=new Path(conf.get(HConstants.HBASE_DIR));
  boolean pre020=FSUtils.isPre020FileLayout(fs,hbaseRootDir);
  if (pre020) {
    LOG.info("Checking pre020 filesystem is major compacted");
    if (!FSUtils.isMajorCompactedPre020(fs,hbaseRootDir)) {
      String msg="All tables must be major compacted before migration." + MIGRATION_LINK;
      System.out.println(msg);
      throw new IOException(msg);
    }
    rewrite(hbaseRootDir);
  }
  LOG.info("Checking filesystem is major compacted");
  if (!FSUtils.isMajorCompacted(fs,hbaseRootDir)) {
    LOG.info("Checking filesystem is major compacted");
    if (!FSUtils.isMajorCompacted(fs,hbaseRootDir)) {
      String msg="All tables must be major compacted before migration." + MIGRATION_LINK;
      System.out.println(msg);
      throw new IOException(msg);
    }
  }
  final MetaUtils utils=new MetaUtils(this.conf);
  final List<HRegionInfo> metas=new ArrayList<HRegionInfo>();
  try {
    rewriteHRegionInfo(utils.getRootRegion().getRegionInfo());
    utils.scanRootRegion(new MetaUtils.ScannerListener(){
      public boolean processRow(      HRegionInfo info) throws IOException {
        if (check && !migrationNeeded) {
          migrationNeeded=true;
          return false;
        }
        metas.add(info);
        rewriteHRegionInfo(utils.getRootRegion(),info);
        return true;
      }
    }
);
    for (    HRegionInfo hri : metas) {
      final HRegionInfo metahri=hri;
      utils.scanMetaRegion(hri,new MetaUtils.ScannerListener(){
        public boolean processRow(        HRegionInfo info) throws IOException {
          if (check && !migrationNeeded) {
            migrationNeeded=true;
            return false;
          }
          rewriteHRegionInfo(utils.getMetaRegion(metahri),info);
          return true;
        }
      }
);
    }
    cleanOldLogFiles(hbaseRootDir);
  }
  finally {
    utils.shutdown();
  }
}
