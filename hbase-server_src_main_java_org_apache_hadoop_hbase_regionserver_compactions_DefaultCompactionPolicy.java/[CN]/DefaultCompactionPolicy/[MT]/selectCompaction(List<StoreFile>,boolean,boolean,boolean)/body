{
  CompactSelection candidateSelection=new CompactSelection(candidateFiles);
  long cfTtl=this.storeConfigInfo.getStoreFileTtl();
  if (!forceMajor) {
    if (comConf.shouldDeleteExpired() && (cfTtl != Long.MAX_VALUE)) {
      CompactSelection expiredSelection=selectExpiredStoreFiles(candidateSelection,EnvironmentEdgeManager.currentTimeMillis() - cfTtl);
      if (expiredSelection != null) {
        return expiredSelection;
      }
    }
    candidateSelection=skipLargeFiles(candidateSelection);
  }
  boolean majorCompaction=((forceMajor && isUserCompaction) || ((forceMajor || isMajorCompaction(candidateSelection.getFilesToCompact())) && (candidateSelection.getFilesToCompact().size() < comConf.getMaxFilesToCompact())) || StoreUtils.hasReferences(candidateSelection.getFilesToCompact()));
  if (!majorCompaction) {
    candidateSelection.setOffPeak(mayUseOffPeak);
    candidateSelection=filterBulk(candidateSelection);
    candidateSelection=applyCompactionPolicy(candidateSelection);
    candidateSelection=checkMinFilesCriteria(candidateSelection);
  }
  candidateSelection=removeExcessFiles(candidateSelection,isUserCompaction,majorCompaction);
  return candidateSelection;
}
