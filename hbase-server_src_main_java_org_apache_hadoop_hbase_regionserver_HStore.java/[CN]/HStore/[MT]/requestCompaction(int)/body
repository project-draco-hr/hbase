{
  if (!this.region.areWritesEnabled()) {
    return null;
  }
  CompactionRequest ret=null;
  this.lock.readLock().lock();
  try {
    List<StoreFile> candidates=Lists.newArrayList(storeFileManager.getStorefiles());
synchronized (filesCompacting) {
      candidates=compactionPolicy.preSelectCompaction(candidates,filesCompacting);
      boolean override=false;
      if (region.getCoprocessorHost() != null) {
        override=region.getCoprocessorHost().preCompactSelection(this,candidates);
      }
      CompactSelection filesToCompact;
      if (override) {
        filesToCompact=new CompactSelection(candidates);
      }
 else {
        boolean isUserCompaction=priority == Store.PRIORITY_USER;
        boolean mayUseOffPeak=this.offPeakCompactions.tryStartOffPeakRequest();
        filesToCompact=compactionPolicy.selectCompaction(candidates,isUserCompaction,mayUseOffPeak,forceMajor && filesCompacting.isEmpty());
        if (mayUseOffPeak && !filesToCompact.isOffPeakCompaction()) {
          this.offPeakCompactions.endOffPeakRequest();
        }
      }
      if (region.getCoprocessorHost() != null) {
        region.getCoprocessorHost().postCompactSelection(this,ImmutableList.copyOf(filesToCompact.getFilesToCompact()));
      }
      if (filesToCompact.getFilesToCompact().isEmpty()) {
        return null;
      }
      if (!Collections.disjoint(filesCompacting,filesToCompact.getFilesToCompact())) {
        Preconditions.checkArgument(false,"%s overlaps with %s",filesToCompact,filesCompacting);
      }
      filesCompacting.addAll(filesToCompact.getFilesToCompact());
      Collections.sort(filesCompacting,StoreFile.Comparators.SEQ_ID);
      boolean isMajor=(filesToCompact.getFilesToCompact().size() == this.getStorefilesCount());
      if (isMajor) {
        this.forceMajor=false;
      }
      LOG.debug(getRegionInfo().getEncodedName() + " - " + getColumnFamilyName()+ ": Initiating "+ (isMajor ? "major" : "minor")+ " compaction");
      int pri=getCompactPriority(priority);
      ret=new CompactionRequest(region,this,filesToCompact,isMajor,pri);
    }
  }
  finally {
    this.lock.readLock().unlock();
  }
  if (ret != null) {
    this.region.reportCompactionRequestStart(ret.isMajor());
  }
  return ret;
}
