{
  final CacheConfig writerCacheConf;
  if (isCompaction) {
    writerCacheConf=new CacheConfig(cacheConf);
    writerCacheConf.setCacheDataOnWrite(false);
  }
 else {
    writerCacheConf=cacheConf;
  }
  InetSocketAddress[] favoredNodes=null;
  if (region.getRegionServerServices() != null) {
    favoredNodes=region.getRegionServerServices().getFavoredNodesForRegion(region.getRegionInfo().getEncodedName());
  }
  HFileContext hFileContext=createFileContext(compression,includeMVCCReadpoint,includesTag);
  StoreFile.Writer w=new StoreFile.WriterBuilder(conf,writerCacheConf,this.getFileSystem()).withFilePath(fs.createTempName()).withComparator(comparator).withBloomType(family.getBloomFilterType()).withMaxKeyCount(maxKeyCount).withFavoredNodes(favoredNodes).withFileContext(hFileContext).build();
  return w;
}
