{
  this.lock.writeLock().lock();
  try {
    ImmutableList<StoreFile> result=storefiles;
    storefiles=ImmutableList.of();
    if (!result.isEmpty()) {
      ThreadPoolExecutor storeFileCloserThreadPool=this.region.getStoreFileOpenAndCloseThreadPool("StoreFileCloserThread-" + this.family.getNameAsString());
      CompletionService<Void> completionService=new ExecutorCompletionService<Void>(storeFileCloserThreadPool);
      for (      final StoreFile f : result) {
        completionService.submit(new Callable<Void>(){
          public Void call() throws IOException {
            f.closeReader(true);
            return null;
          }
        }
);
      }
      IOException ioe=null;
      try {
        for (int i=0; i < result.size(); i++) {
          try {
            Future<Void> future=completionService.take();
            future.get();
          }
 catch (          InterruptedException e) {
            if (ioe == null) {
              ioe=new InterruptedIOException();
              ioe.initCause(e);
            }
          }
catch (          ExecutionException e) {
            if (ioe == null)             ioe=new IOException(e.getCause());
          }
        }
      }
  finally {
        storeFileCloserThreadPool.shutdownNow();
      }
      if (ioe != null)       throw ioe;
    }
    LOG.info("Closed " + this);
    return result;
  }
  finally {
    this.lock.writeLock().unlock();
  }
}
