{
  StoreFile result=null;
  if (newFile != null) {
    validateStoreFile(newFile);
    Path destPath=new Path(homedir,newFile.getName());
    LOG.info("Renaming compacted file at " + newFile + " to "+ destPath);
    if (!fs.rename(newFile,destPath)) {
      LOG.error("Failed move of compacted file " + newFile + " to "+ destPath);
      throw new IOException("Failed move of compacted file " + newFile + " to "+ destPath);
    }
    result=new StoreFile(this.fs,destPath,this.conf,this.cacheConf,this.family.getBloomFilterType(),this.dataBlockEncoder);
    result.createReader();
  }
  try {
    this.lock.writeLock().lock();
    try {
      List<StoreFile> results=new ArrayList<StoreFile>(1);
      if (result != null) {
        results.add(result);
      }
      this.storeFileManager.addCompactionResults(compactedFiles,results);
      filesCompacting.removeAll(compactedFiles);
    }
  finally {
      this.lock.writeLock().unlock();
    }
    notifyChangedReadersObservers();
    LOG.debug("Removing store files after compaction...");
    HFileArchiver.archiveStoreFiles(this.conf,this.fs,this.region,this.family.getName(),compactedFiles);
  }
 catch (  IOException e) {
    e=RemoteExceptionHandler.checkIOException(e);
    LOG.error("Failed replacing compacted files in " + this + ". Compacted file is "+ (result == null ? "none" : result.toString())+ ".  Files replaced "+ compactedFiles.toString()+ " some of which may have been already removed",e);
  }
  this.storeSize=0L;
  this.totalUncompressedBytes=0L;
  for (  StoreFile hsf : this.storeFileManager.getStorefiles()) {
    StoreFile.Reader r=hsf.getReader();
    if (r == null) {
      LOG.warn("StoreFile " + hsf + " has a null Reader");
      continue;
    }
    this.storeSize+=r.length();
    this.totalUncompressedBytes+=r.getTotalUncompressedBytes();
  }
  return result;
}
