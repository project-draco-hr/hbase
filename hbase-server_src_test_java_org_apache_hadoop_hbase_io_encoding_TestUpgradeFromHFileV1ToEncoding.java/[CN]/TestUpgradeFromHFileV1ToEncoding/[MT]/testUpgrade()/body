{
  int numBatches=0;
  HTableDescriptor htd=new HTableDescriptor(TABLE);
  HColumnDescriptor hcd=new HColumnDescriptor(CF);
  htd.addFamily(hcd);
  HBaseAdmin admin=new HBaseAdmin(conf);
  admin.createTable(htd);
  admin.close();
  for (int i=0; i < NUM_HFILE_V1_BATCHES; ++i) {
    TestChangingEncoding.writeTestDataBatch(conf,TABLE,numBatches++);
  }
  TEST_UTIL.shutdownMiniHBaseCluster();
  conf.setInt(HFile.FORMAT_VERSION_KEY,2);
  TEST_UTIL.startMiniHBaseCluster(1,NUM_SLAVES);
  LOG.debug("Started an HFile v2 cluster");
  admin=new HBaseAdmin(conf);
  htd=admin.getTableDescriptor(TABLE_BYTES);
  hcd=htd.getFamily(CF_BYTES);
  hcd.setDataBlockEncoding(DataBlockEncoding.PREFIX);
  admin.disableTable(TABLE);
  admin.modifyColumn(TABLE,hcd);
  admin.enableTable(TABLE);
  admin.close();
  for (int i=0; i < NUM_HFILE_V2_BATCHES; ++i) {
    TestChangingEncoding.writeTestDataBatch(conf,TABLE,numBatches++);
  }
  LOG.debug("Verifying all 'batches', both HFile v1 and encoded HFile v2");
  verifyBatches(numBatches);
  LOG.debug("Doing a manual compaction");
  admin.compact(TABLE);
  Thread.sleep(TimeUnit.SECONDS.toMillis(10));
  LOG.debug("Verify all the data again");
  verifyBatches(numBatches);
}
