{
  if (blockType == BlockType.DATA) {
    this.dataBlockEncoder.endBlockEncoding(dataBlockEncodingCtx,userDataStream,baosInMemory.toByteArray(),blockType);
    blockType=dataBlockEncodingCtx.getBlockType();
  }
  userDataStream.flush();
  uncompressedBytesWithHeader=baosInMemory.toByteArray();
  prevOffset=prevOffsetByType[blockType.getId()];
  state=State.BLOCK_READY;
  if (blockType == BlockType.DATA || blockType == BlockType.ENCODED_DATA) {
    onDiskBytesWithHeader=dataBlockEncodingCtx.compressAndEncrypt(uncompressedBytesWithHeader);
  }
 else {
    onDiskBytesWithHeader=defaultBlockEncodingCtx.compressAndEncrypt(uncompressedBytesWithHeader);
  }
  putHeader(onDiskBytesWithHeader,0,onDiskBytesWithHeader.length,uncompressedBytesWithHeader.length);
  putHeader(uncompressedBytesWithHeader,0,onDiskBytesWithHeader.length,uncompressedBytesWithHeader.length);
}
