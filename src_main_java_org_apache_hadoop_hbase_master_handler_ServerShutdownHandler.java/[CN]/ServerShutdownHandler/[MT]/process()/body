{
  final String serverName=this.hsi.getServerName();
  LOG.info("Splitting logs for " + serverName);
  this.services.getMasterFileSystem().splitLog(serverName);
  List<HRegionInfo> regionsInTransition=this.services.getAssignmentManager().processServerShutdown(this.hsi);
  if (isCarryingRoot()) {
    try {
      this.services.getAssignmentManager().assignRoot();
    }
 catch (    KeeperException e) {
      this.server.abort("In server shutdown processing, assigning root",e);
      throw new IOException("Aborting",e);
    }
  }
  if (isCarryingMeta())   this.services.getAssignmentManager().assignMeta();
  NavigableMap<HRegionInfo,Result> hris=null;
  while (!this.server.isStopped()) {
    try {
      this.server.getCatalogTracker().waitForMeta();
      hris=MetaReader.getServerUserRegions(this.server.getCatalogTracker(),this.hsi);
      break;
    }
 catch (    InterruptedException e) {
      Thread.currentThread().interrupt();
      throw new IOException("Interrupted",e);
    }
catch (    IOException ioe) {
      LOG.info("Received exception accessing META during server shutdown of " + serverName + ", retrying META read");
    }
  }
  for (  HRegionInfo rit : regionsInTransition)   hris.remove(rit);
  LOG.info("Reassigning the " + hris.size() + " region(s) that "+ serverName+ " was carrying (skipping "+ regionsInTransition.size()+ " regions(s) that are in transition)");
  for (  Map.Entry<HRegionInfo,Result> e : hris.entrySet()) {
    if (processDeadRegion(e.getKey(),e.getValue(),this.services.getAssignmentManager(),this.server.getCatalogTracker())) {
      this.services.getAssignmentManager().assign(e.getKey(),true);
    }
  }
  this.deadServers.remove(serverName);
  LOG.info("Finished processing of shutdown of " + serverName);
}
