{
  int versionOfClosingNode=-1;
  if (request.hasVersionOfClosingNode()) {
    versionOfClosingNode=request.getVersionOfClosingNode();
  }
  boolean zk=request.getTransitionInZK();
  final ServerName sn=(request.hasDestinationServer() ? ProtobufUtil.toServerName(request.getDestinationServer()) : null);
  try {
    checkOpen();
    requestCount.incrementAndGet();
    String encodedRegionName=ProtobufUtil.getRegionEncodedName(request.getRegion());
    byte[] encodedName=Bytes.toBytes(encodedRegionName);
    Boolean openAction=regionsInTransitionInRS.get(encodedName);
    if (openAction != null) {
      if (openAction.booleanValue()) {
        regionsInTransitionInRS.replace(encodedName,openAction,Boolean.FALSE);
      }
      checkIfRegionInTransition(encodedName,CLOSE);
    }
    HRegion region=getRegionByEncodedName(encodedRegionName);
    LOG.info("Received close region: " + region.getRegionNameAsString() + ". Version of ZK closing node:"+ versionOfClosingNode+ ". Destination server:"+ sn);
    HRegionInfo regionInfo=region.getRegionInfo();
    checkIfRegionInTransition(encodedName,CLOSE);
    boolean closed=closeRegion(regionInfo,false,zk,versionOfClosingNode,sn);
    CloseRegionResponse.Builder builder=CloseRegionResponse.newBuilder().setClosed(closed);
    return builder.build();
  }
 catch (  IOException ie) {
    throw new ServiceException(ie);
  }
}
