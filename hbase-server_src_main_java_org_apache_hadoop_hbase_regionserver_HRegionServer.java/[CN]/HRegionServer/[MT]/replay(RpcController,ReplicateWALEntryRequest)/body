{
  long before=EnvironmentEdgeManager.currentTimeMillis();
  CellScanner cells=((PayloadCarryingRpcController)controller).cellScanner();
  try {
    checkOpen();
    List<WALEntry> entries=request.getEntryList();
    if (entries == null || entries.isEmpty()) {
      return ReplicateWALEntryResponse.newBuilder().build();
    }
    HRegion region=this.getRegionByEncodedName(entries.get(0).getKey().getEncodedRegionName().toStringUtf8());
    RegionCoprocessorHost coprocessorHost=region.getCoprocessorHost();
    List<Pair<HLogKey,WALEdit>> walEntries=new ArrayList<Pair<HLogKey,WALEdit>>();
    List<Pair<MutationType,Mutation>> mutations=new ArrayList<Pair<MutationType,Mutation>>();
    for (    WALEntry entry : entries) {
      Pair<HLogKey,WALEdit> walEntry=(coprocessorHost == null) ? null : new Pair<HLogKey,WALEdit>();
      List<Pair<MutationType,Mutation>> edits=HLogSplitter.getMutationsFromWALEntry(entry,cells,walEntry);
      if (coprocessorHost != null) {
        if (coprocessorHost.preWALRestore(region.getRegionInfo(),walEntry.getFirst(),walEntry.getSecond())) {
          continue;
        }
        walEntries.add(walEntry);
      }
      mutations.addAll(edits);
    }
    if (!mutations.isEmpty()) {
      OperationStatus[] result=doBatchOp(region,mutations,true);
      for (int i=0; result != null && i < result.length; i++) {
        if (result[i] != OperationStatus.SUCCESS) {
          throw new IOException(result[i].getExceptionMsg());
        }
      }
    }
    if (coprocessorHost != null) {
      for (      Pair<HLogKey,WALEdit> wal : walEntries) {
        coprocessorHost.postWALRestore(region.getRegionInfo(),wal.getFirst(),wal.getSecond());
      }
    }
    return ReplicateWALEntryResponse.newBuilder().build();
  }
 catch (  IOException ie) {
    throw new ServiceException(ie);
  }
 finally {
    metricsRegionServer.updateReplay(EnvironmentEdgeManager.currentTimeMillis() - before);
  }
}
