{
  try {
    startServiceThreads();
    this.serverManager.waitForRegionServers();
    if (!this.stopped) {
      if (this.freshClusterStartup) {
        clusterStarterInitializations(this.fileSystemManager,this.serverManager,this.catalogTracker,this.assignmentManager);
      }
 else {
        this.assignmentManager.processFailover();
      }
    }
    this.balancerChore=getAndStartBalancerChore(this);
    this.catalogJanitorChore=Threads.setDaemonThreadRunning(new CatalogJanitor(this,this));
    Sleeper sleeper=new Sleeper(1000,this);
    while (!this.stopped)     sleeper.sleep();
  }
 catch (  Throwable t) {
    abort("Unhandled exception. Starting shutdown.",t);
  }
  if (this.balancerChore != null)   this.balancerChore.interrupt();
  if (this.catalogJanitorChore != null)   this.catalogJanitorChore.interrupt();
  if (!this.abort && this.serverManager.isClusterShutdown()) {
    this.serverManager.letRegionServersShutdown();
  }
  stopServiceThreads();
  this.activeMasterManager.stop();
  HConnectionManager.deleteConnection(this.conf,true);
  this.zooKeeper.close();
  LOG.info("HMaster main thread exiting");
}
