{
  try {
    this.activeMasterManager=new ActiveMasterManager(zooKeeper,address,this);
    this.zooKeeper.registerListener(activeMasterManager);
    stallIfBackupMaster(this.conf,this.activeMasterManager);
    this.activeMasterManager.blockUntilBecomingActiveMaster();
    if (!this.stopped) {
      finishInitialization();
      loop();
    }
  }
 catch (  Throwable t) {
    abort("Unhandled exception. Starting shutdown.",t);
  }
 finally {
    stopChores();
    if (!this.abort && this.serverManager.isClusterShutdown()) {
      this.serverManager.letRegionServersShutdown();
    }
    stopServiceThreads();
    if (this.activeMasterManager != null)     this.activeMasterManager.stop();
    this.catalogTracker.stop();
    this.serverManager.stop();
    this.assignmentManager.stop();
    HConnectionManager.deleteConnection(this.conf,true);
    this.zooKeeper.close();
  }
  LOG.info("HMaster main thread exiting");
}
