{
  try {
    this.activeMasterManager=new ActiveMasterManager(zooKeeper,address,this);
    this.zooKeeper.registerListener(activeMasterManager);
    stallIfBackupMaster(this.conf,this.activeMasterManager);
    activeMasterManager.blockUntilBecomingActiveMaster();
    if (!this.stopped) {
      finishInitialization();
      loop();
      if (this.balancerChore != null) {
        this.balancerChore.interrupt();
      }
      if (this.catalogJanitorChore != null) {
        this.catalogJanitorChore.interrupt();
      }
      if (!this.abort && this.serverManager.isClusterShutdown()) {
        this.serverManager.letRegionServersShutdown();
      }
      stopServiceThreads();
    }
    this.activeMasterManager.stop();
    HConnectionManager.deleteConnection(this.conf,true);
    this.zooKeeper.close();
    LOG.info("HMaster main thread exiting");
  }
 catch (  Throwable t) {
    abort("Unhandled exception. Starting shutdown.",t);
  }
}
