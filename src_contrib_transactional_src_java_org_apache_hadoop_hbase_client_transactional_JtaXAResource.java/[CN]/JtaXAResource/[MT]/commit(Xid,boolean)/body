{
  LOG.trace("commit [" + xid.toString() + "] "+ (onePhase ? "one phase" : "two phase"));
  TransactionState state=xidToTransactionState.remove(xid);
  if (state == null) {
    throw new XAException(XAException.XAER_NOTA);
  }
  try {
    if (onePhase) {
      transactionManager.tryCommit(state);
    }
 else {
      transactionManager.doCommit(state);
    }
  }
 catch (  CommitUnsuccessfulException e) {
    throw new XAException(XAException.XA_RBROLLBACK);
  }
catch (  IOException e) {
    XAException xae=new XAException(XAException.XAER_RMERR);
    xae.initCause(e);
    throw xae;
  }
 finally {
    threadLocalTransactionState.remove();
  }
}
