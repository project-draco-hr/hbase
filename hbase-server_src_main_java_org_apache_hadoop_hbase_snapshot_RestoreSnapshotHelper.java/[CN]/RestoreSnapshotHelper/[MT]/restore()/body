{
  long startTime=EnvironmentEdgeManager.currentTimeMillis();
  LOG.debug("starting restore");
  Set<String> snapshotRegionNames=SnapshotReferenceUtil.getSnapshotRegionNames(fs,snapshotDir);
  if (snapshotRegionNames == null) {
    LOG.warn("Nothing to restore. Snapshot " + snapshotDesc + " looks empty");
    return;
  }
  List<HRegionInfo> tableRegions=getTableRegions();
  if (tableRegions != null) {
    monitor.rethrowException();
    List<HRegionInfo> regionsToRestore=new LinkedList<HRegionInfo>();
    List<HRegionInfo> regionsToRemove=new LinkedList<HRegionInfo>();
    for (    HRegionInfo regionInfo : tableRegions) {
      String regionName=regionInfo.getEncodedName();
      if (snapshotRegionNames.contains(regionName)) {
        LOG.info("region to restore: " + regionName);
        snapshotRegionNames.remove(regionInfo);
        regionsToRestore.add(regionInfo);
      }
 else {
        LOG.info("region to remove: " + regionName);
        regionsToRemove.add(regionInfo);
      }
    }
    monitor.rethrowException();
    restoreRegions(regionsToRestore);
    monitor.rethrowException();
    ModifyRegionUtils.deleteRegions(conf,fs,catalogTracker,regionsToRemove);
  }
  if (snapshotRegionNames.size() > 0) {
    List<HRegionInfo> regionsToAdd=new LinkedList<HRegionInfo>();
    monitor.rethrowException();
    for (    String regionName : snapshotRegionNames) {
      LOG.info("region to add: " + regionName);
      Path regionDir=new Path(snapshotDir,regionName);
      regionsToAdd.add(HRegion.loadDotRegionInfoFileContent(fs,regionDir));
    }
    monitor.rethrowException();
    cloneRegions(regionsToAdd);
  }
  monitor.rethrowException();
  restoreWALs();
}
