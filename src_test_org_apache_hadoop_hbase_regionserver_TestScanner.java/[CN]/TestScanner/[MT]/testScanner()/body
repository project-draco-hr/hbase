{
  try {
    r=createNewHRegion(REGION_INFO.getTableDesc(),null,null);
    region=new HRegionIncommon(r);
    BatchUpdate batchUpdate=new BatchUpdate(ROW_KEY,System.currentTimeMillis());
    ByteArrayOutputStream byteStream=new ByteArrayOutputStream();
    DataOutputStream s=new DataOutputStream(byteStream);
    HRegionInfo.rootRegionInfo.write(s);
    batchUpdate.put(HConstants.COL_REGIONINFO,byteStream.toByteArray());
    region.commit(batchUpdate);
    scan(false,null);
    getRegionInfo();
    r.close();
    r=openClosedRegion(r);
    region=new HRegionIncommon(r);
    scan(false,null);
    getRegionInfo();
    HServerAddress address=new HServerAddress("foo.bar.com:1234");
    batchUpdate=new BatchUpdate(ROW_KEY,System.currentTimeMillis());
    batchUpdate.put(HConstants.COL_SERVER,Writables.stringToBytes(address.toString()));
    batchUpdate.put(HConstants.COL_STARTCODE,Writables.longToBytes(START_CODE));
    region.commit(batchUpdate);
    scan(true,address.toString());
    getRegionInfo();
    region.flushcache();
    scan(true,address.toString());
    getRegionInfo();
    r.close();
    r=openClosedRegion(r);
    region=new HRegionIncommon(r);
    scan(true,address.toString());
    getRegionInfo();
    address=new HServerAddress("bar.foo.com:4321");
    batchUpdate=new BatchUpdate(ROW_KEY,System.currentTimeMillis());
    batchUpdate.put(HConstants.COL_SERVER,Writables.stringToBytes(address.toString()));
    region.commit(batchUpdate);
    scan(true,address.toString());
    getRegionInfo();
    region.flushcache();
    scan(true,address.toString());
    getRegionInfo();
    r.close();
    r=openClosedRegion(r);
    region=new HRegionIncommon(r);
    scan(true,address.toString());
    getRegionInfo();
    r.close();
    r.getLog().closeAndDelete();
  }
  finally {
    shutdownDfs(cluster);
  }
}
