{
  FileSystem fs=master.getMasterFileSystem().getFileSystem();
  Path snapshotDir=SnapshotDescriptionUtils.getCompletedSnapshotDir(reqSnapshot,rootDir);
  MasterCoprocessorHost cpHost=master.getMasterCoprocessorHost();
  if (!fs.exists(snapshotDir)) {
    LOG.error("A Snapshot named '" + reqSnapshot.getName() + "' does not exist.");
    throw new SnapshotDoesNotExistException(reqSnapshot);
  }
  SnapshotDescription snapshot=SnapshotDescriptionUtils.readSnapshotInfo(fs,snapshotDir);
  SnapshotManifest manifest=SnapshotManifest.open(master.getConfiguration(),fs,snapshotDir,snapshot);
  HTableDescriptor snapshotTableDesc=manifest.getTableDescriptor();
  TableName tableName=TableName.valueOf(reqSnapshot.getTable());
  cleanupSentinels();
  SnapshotReferenceUtil.verifySnapshot(master.getConfiguration(),fs,manifest);
  if (MetaTableAccessor.tableExists(master.getConnection(),tableName)) {
    if (master.getTableStateManager().isTableState(TableName.valueOf(snapshot.getTable()),TableState.State.ENABLED)) {
      throw new UnsupportedOperationException("Table '" + TableName.valueOf(snapshot.getTable()) + "' must be disabled in order to "+ "perform a restore operation"+ ".");
    }
    if (cpHost != null) {
      cpHost.preRestoreSnapshot(reqSnapshot,snapshotTableDesc);
    }
    int tableRegionCount=-1;
    try {
      tableRegionCount=getRegionCountOfTable(tableName);
      int snapshotRegionCount=manifest.getRegionManifestsMap().size();
      if (tableRegionCount > 0 && tableRegionCount < snapshotRegionCount) {
        checkAndUpdateNamespaceRegionQuota(snapshotRegionCount,tableName);
      }
      restoreSnapshot(snapshot,snapshotTableDesc);
      if (tableRegionCount > 0 && tableRegionCount > snapshotRegionCount) {
        checkAndUpdateNamespaceRegionQuota(snapshotRegionCount,tableName);
      }
    }
 catch (    QuotaExceededException e) {
      LOG.error("Region quota exceeded while restoring the snapshot " + snapshot.getName() + " as table "+ tableName.getNameAsString(),e);
      throw e;
    }
catch (    IOException e) {
      if (tableRegionCount > 0) {
        checkAndUpdateNamespaceRegionQuota(tableRegionCount,tableName);
      }
      LOG.error("Exception occurred while restoring the snapshot " + snapshot.getName() + " as table "+ tableName.getNameAsString(),e);
      throw e;
    }
    LOG.info("Restore snapshot=" + snapshot.getName() + " as table="+ tableName);
    if (cpHost != null) {
      cpHost.postRestoreSnapshot(reqSnapshot,snapshotTableDesc);
    }
  }
 else {
    HTableDescriptor htd=new HTableDescriptor(tableName,snapshotTableDesc);
    if (cpHost != null) {
      cpHost.preCloneSnapshot(reqSnapshot,htd);
    }
    try {
      checkAndUpdateNamespaceQuota(manifest,tableName);
      cloneSnapshot(snapshot,htd);
    }
 catch (    IOException e) {
      this.master.getMasterQuotaManager().removeTableFromNamespaceQuota(tableName);
      LOG.error("Exception occurred while cloning the snapshot " + snapshot.getName() + " as table "+ tableName.getNameAsString(),e);
      throw e;
    }
    LOG.info("Clone snapshot=" + snapshot.getName() + " as table="+ tableName);
    if (cpHost != null) {
      cpHost.postCloneSnapshot(reqSnapshot,htd);
    }
  }
}
