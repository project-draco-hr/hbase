{
  FileSystem fs=master.getMasterFileSystem().getFileSystem();
  Path snapshotDir=SnapshotDescriptionUtils.getCompletedSnapshotDir(reqSnapshot,rootDir);
  MasterCoprocessorHost cpHost=master.getMasterCoprocessorHost();
  if (!fs.exists(snapshotDir)) {
    LOG.error("A Snapshot named '" + reqSnapshot.getName() + "' does not exist.");
    throw new SnapshotDoesNotExistException(reqSnapshot);
  }
  SnapshotDescription fsSnapshot=SnapshotDescriptionUtils.readSnapshotInfo(fs,snapshotDir);
  SnapshotManifest manifest=SnapshotManifest.open(master.getConfiguration(),fs,snapshotDir,fsSnapshot);
  HTableDescriptor snapshotTableDesc=manifest.getTableDescriptor();
  TableName tableName=TableName.valueOf(reqSnapshot.getTable());
  cleanupSentinels();
  SnapshotReferenceUtil.verifySnapshot(master.getConfiguration(),fs,manifest);
  if (MetaTableAccessor.tableExists(master.getShortCircuitConnection(),tableName)) {
    if (master.getAssignmentManager().getTableStateManager().isTableState(TableName.valueOf(fsSnapshot.getTable()),ZooKeeperProtos.Table.State.ENABLED)) {
      throw new UnsupportedOperationException("Table '" + TableName.valueOf(fsSnapshot.getTable()) + "' must be disabled in order to "+ "perform a restore operation"+ ".");
    }
    if (cpHost != null) {
      cpHost.preRestoreSnapshot(reqSnapshot,snapshotTableDesc);
    }
    restoreSnapshot(fsSnapshot,snapshotTableDesc);
    LOG.info("Restore snapshot=" + fsSnapshot.getName() + " as table="+ tableName);
    if (cpHost != null) {
      cpHost.postRestoreSnapshot(reqSnapshot,snapshotTableDesc);
    }
  }
 else {
    HTableDescriptor htd=RestoreSnapshotHelper.cloneTableSchema(snapshotTableDesc,tableName);
    if (cpHost != null) {
      cpHost.preCloneSnapshot(reqSnapshot,htd);
    }
    cloneSnapshot(fsSnapshot,htd);
    LOG.info("Clone snapshot=" + fsSnapshot.getName() + " as table="+ tableName);
    if (cpHost != null) {
      cpHost.postCloneSnapshot(reqSnapshot,htd);
    }
  }
}
