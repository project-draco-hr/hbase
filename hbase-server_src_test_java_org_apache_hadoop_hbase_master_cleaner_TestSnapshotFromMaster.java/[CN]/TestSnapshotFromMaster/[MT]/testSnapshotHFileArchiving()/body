{
  Admin admin=UTIL.getHBaseAdmin();
  SnapshotTestingUtils.assertNoSnapshots(admin);
  UTIL.deleteTable(TABLE_NAME);
  HTableDescriptor htd=new HTableDescriptor(TABLE_NAME);
  htd.setCompactionEnabled(false);
  UTIL.createTable(htd,new byte[][]{TEST_FAM},null);
  for (int i=0; i < 5; i++) {
    UTIL.loadTable(UTIL.getConnection().getTable(TABLE_NAME),TEST_FAM);
    UTIL.flush(TABLE_NAME);
  }
  admin.disableTable(TABLE_NAME);
  htd.setCompactionEnabled(true);
  String snapshotName="snapshot";
  byte[] snapshotNameBytes=Bytes.toBytes(snapshotName);
  admin.snapshot(snapshotNameBytes,TABLE_NAME);
  LOG.info("After snapshot File-System state");
  FSUtils.logFileSystemState(fs,rootDir,LOG);
  SnapshotTestingUtils.assertOneSnapshotThatMatches(admin,snapshotNameBytes,TABLE_NAME);
  admin.modifyTable(TABLE_NAME,htd);
  admin.enableTable(TABLE_NAME);
  List<HRegion> regions=UTIL.getHBaseCluster().getRegions(TABLE_NAME);
  for (  HRegion region : regions) {
    region.waitForFlushesAndCompactions();
    region.compactStores();
  }
  LOG.info("After compaction File-System state");
  FSUtils.logFileSystemState(fs,rootDir,LOG);
  LOG.debug("Running hfile cleaners");
  ensureHFileCleanersRun();
  LOG.info("After cleaners File-System state: " + rootDir);
  FSUtils.logFileSystemState(fs,rootDir,LOG);
  Path snapshotTable=SnapshotDescriptionUtils.getCompletedSnapshotDir(snapshotName,rootDir);
  Set<String> snapshotHFiles=SnapshotReferenceUtil.getHFileNames(UTIL.getConfiguration(),fs,snapshotTable);
  LOG.debug("Have snapshot hfiles:");
  for (  String fileName : snapshotHFiles) {
    LOG.debug(fileName);
  }
  Collection<String> files=getArchivedHFiles(archiveDir,rootDir,fs,TABLE_NAME);
  for (  String fileName : snapshotHFiles) {
    assertTrue("Archived hfiles " + files + " is missing snapshot file:"+ fileName,files.contains(fileName));
  }
  admin.deleteSnapshot(snapshotNameBytes);
  SnapshotTestingUtils.assertNoSnapshots(admin);
  List<BaseHFileCleanerDelegate> delegates=UTIL.getMiniHBaseCluster().getMaster().getHFileCleaner().cleanersChain;
  for (  BaseHFileCleanerDelegate delegate : delegates) {
    if (delegate instanceof SnapshotHFileCleaner) {
      ((SnapshotHFileCleaner)delegate).getFileCacheForTesting().triggerCacheRefreshForTesting();
    }
  }
  LOG.debug("Running hfile cleaners");
  ensureHFileCleanersRun();
  LOG.info("After delete snapshot cleaners run File-System state");
  FSUtils.logFileSystemState(fs,rootDir,LOG);
  files=getArchivedHFiles(archiveDir,rootDir,fs,TABLE_NAME);
  assertEquals("Still have some hfiles in the archive, when their snapshot has been deleted.",0,files.size());
}
