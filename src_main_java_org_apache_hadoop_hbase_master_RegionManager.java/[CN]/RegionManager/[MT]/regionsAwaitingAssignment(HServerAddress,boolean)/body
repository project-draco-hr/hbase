{
  Set<RegionState> regionsToAssign=new HashSet<RegionState>();
  boolean isMetaServer=isMetaServer(addr);
  RegionState rootState=null;
synchronized (this.regionsInTransition) {
    rootState=regionsInTransition.get(HRegionInfo.ROOT_REGIONINFO.getRegionNameAsString());
  }
  if (rootState != null && rootState.isUnassigned()) {
    if (!isMetaServer || isSingleServer) {
      regionsToAssign.add(rootState);
    }
    return regionsToAssign;
  }
  boolean reassigningMetas=numberOfMetaRegions.get() != onlineMetaRegions.size();
  boolean isMetaOrRoot=isMetaServer || isRootServer(addr);
  if (reassigningMetas && isMetaOrRoot && !isSingleServer) {
    return regionsToAssign;
  }
synchronized (this.regionsInTransition) {
    for (    RegionState s : regionsInTransition.values()) {
      HRegionInfo i=s.getRegionInfo();
      if (i == null) {
        continue;
      }
      if (reassigningMetas && !i.isMetaRegion()) {
        continue;
      }
      if (!i.isMetaRegion() && !master.getServerManager().canAssignUserRegions()) {
        LOG.debug("user region " + i.getRegionNameAsString() + " is in transition but not enough servers yet");
        continue;
      }
      if (s.isUnassigned()) {
        regionsToAssign.add(s);
      }
    }
  }
  return regionsToAssign;
}
