{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Stopping rpc client");
  }
  if (!running.compareAndSet(true,false)) {
    return;
  }
  Set<Connection> connsToClose=null;
synchronized (connections) {
    for (    Connection conn : connections.values()) {
      conn.interrupt();
      if (conn.callSender != null) {
        conn.callSender.interrupt();
      }
      if (!conn.isAlive()) {
        if (connsToClose == null) {
          connsToClose=new HashSet<>();
        }
        connsToClose.add(conn);
      }
    }
  }
  if (connsToClose != null) {
    for (    Connection conn : connsToClose) {
      conn.markClosed(new InterruptedIOException("RpcClient is closing"));
      conn.close();
    }
  }
  while (!connections.isEmpty()) {
    try {
      Thread.sleep(10);
    }
 catch (    InterruptedException e) {
      LOG.info("Interrupted while stopping the client. We still have " + connections.size() + " connections.");
      Thread.currentThread().interrupt();
      return;
    }
  }
}
