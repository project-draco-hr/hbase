{
  long waitUntil=EnvironmentEdgeManager.currentTime() + minIdleTimeBeforeClose;
  while (true) {
    if (shouldCloseConnection.get()) {
      return WaitForWorkResult.CLOSED;
    }
    if (!running.get()) {
      if (markClosed(new IOException("stopped with " + calls.size() + " pending request(s)"))) {
        return WaitForWorkResult.CALLER_SHOULD_CLOSE;
      }
      return WaitForWorkResult.CLOSED;
    }
    if (!calls.isEmpty()) {
      return WaitForWorkResult.READ_RESPONSE;
    }
    if (EnvironmentEdgeManager.currentTime() >= waitUntil) {
      if (markClosed(new IOException("idle connection closed with " + calls.size() + " pending request(s)"))) {
        return WaitForWorkResult.CALLER_SHOULD_CLOSE;
      }
      return WaitForWorkResult.CLOSED;
    }
    wait(Math.min(minIdleTimeBeforeClose,1000));
  }
}
