{
  long waitUntil=EnvironmentEdgeManager.currentTime() + minIdleTimeBeforeClose;
  while (true) {
    if (shouldCloseConnection.get()) {
      return false;
    }
    if (!running.get()) {
      markClosed(new IOException("stopped with " + calls.size() + " pending request(s)"));
      return false;
    }
    if (!calls.isEmpty()) {
      return true;
    }
    if (EnvironmentEdgeManager.currentTime() >= waitUntil) {
      markClosed(new IOException("idle connection closed with " + calls.size() + " pending request(s)"));
      return false;
    }
    wait(Math.min(minIdleTimeBeforeClose,1000));
  }
}
