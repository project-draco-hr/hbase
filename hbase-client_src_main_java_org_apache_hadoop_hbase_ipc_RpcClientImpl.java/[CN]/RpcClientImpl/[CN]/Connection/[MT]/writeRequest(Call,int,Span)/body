{
  RequestHeader.Builder builder=RequestHeader.newBuilder();
  builder.setCallId(call.id);
  if (span != null) {
    builder.setTraceInfo(RPCTInfo.newBuilder().setParentId(span.getSpanId()).setTraceId(span.getTraceId()));
  }
  builder.setMethodName(call.md.getName());
  builder.setRequestParam(call.param != null);
  ByteBuffer cellBlock=cellBlockBuilder.buildCellBlock(this.codec,this.compressor,call.cells);
  if (cellBlock != null) {
    CellBlockMeta.Builder cellBlockBuilder=CellBlockMeta.newBuilder();
    cellBlockBuilder.setLength(cellBlock.limit());
    builder.setCellBlockMeta(cellBlockBuilder.build());
  }
  if (priority != PayloadCarryingRpcController.PRIORITY_UNSET) {
    builder.setPriority(priority);
  }
  builder.setTimeout(call.timeout);
  RequestHeader requestHeader=builder.build();
  setupIOstreams();
  checkIsOpen();
  IOException writeException=null;
synchronized (this.outLock) {
    if (Thread.interrupted()) {
      throw new InterruptedIOException();
    }
    calls.put(call.id,call);
    checkIsOpen();
    try {
      call.callStats.setRequestSizeBytes(IPCUtil.write(this.out,requestHeader,call.param,cellBlock));
    }
 catch (    IOException e) {
      shouldCloseConnection.set(true);
      writeException=e;
      interrupt();
    }
  }
  if (writeException != null) {
    markClosed(writeException);
    close();
  }
  doNotify();
  if (writeException != null) {
    throw writeException;
  }
}
