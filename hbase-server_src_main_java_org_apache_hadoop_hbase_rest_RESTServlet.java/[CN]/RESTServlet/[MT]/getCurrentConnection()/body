{
  String userName=effectiveUser.get().getUserName();
  ConnectionInfo connInfo=connections.get(userName);
  if (connInfo == null || !connInfo.updateAccessTime()) {
    Lock lock=locker.acquireLock(userName);
    try {
      connInfo=connections.get(userName);
      if (connInfo == null) {
        User user=userProvider.create(effectiveUser.get());
        HConnection conn=HConnectionManager.createConnection(conf,user);
        connInfo=new ConnectionInfo(conn,userName);
        connections.put(userName,connInfo);
      }
    }
  finally {
      lock.unlock();
    }
  }
  return connInfo;
}
