{
  LOG.info(getName() + ": starting");
  SERVER.set(HBaseServer.this);
  while (running) {
    try {
      Call call=myCallQueue.take();
      if (LOG.isDebugEnabled())       LOG.debug(getName() + ": has #" + call.id+ " from "+ call.connection);
      String errorClass=null;
      String error=null;
      Writable value=null;
      CurCall.set(call);
      try {
        if (!started)         throw new ServerNotRunningException("Server is not running yet");
        value=call(call.connection.protocol,call.param,call.timestamp);
      }
 catch (      Throwable e) {
        LOG.debug(getName() + ", call " + call+ ": error: "+ e,e);
        errorClass=e.getClass().getName();
        error=StringUtils.stringifyException(e);
      }
      CurCall.set(null);
      int size=BUFFER_INITIAL_SIZE;
      if (value instanceof WritableWithSize) {
        WritableWithSize ohint=(WritableWithSize)value;
        long hint=ohint.getWritableSize() + Bytes.SIZEOF_BYTE + Bytes.SIZEOF_INT;
        if (hint > 0) {
          if ((hint) > Integer.MAX_VALUE) {
            IOException ioe=new IOException("Result buffer size too large: " + hint);
            errorClass=ioe.getClass().getName();
            error=StringUtils.stringifyException(ioe);
          }
 else {
            size=(int)hint;
          }
        }
      }
      ByteBufferOutputStream buf=new ByteBufferOutputStream(size);
      DataOutputStream out=new DataOutputStream(buf);
      out.writeInt(call.id);
      out.writeBoolean(error != null);
      if (error == null) {
        value.write(out);
      }
 else {
        WritableUtils.writeString(out,errorClass);
        WritableUtils.writeString(out,error);
      }
      if (buf.size() > warnResponseSize) {
        LOG.warn(getName() + ", responseTooLarge for: " + call+ ": Size: "+ StringUtils.humanReadableInt(buf.size()));
      }
      call.setResponse(buf.getByteBuffer());
      responder.doRespond(call);
    }
 catch (    InterruptedException e) {
      if (running) {
        LOG.info(getName() + " caught: " + StringUtils.stringifyException(e));
      }
    }
catch (    OutOfMemoryError e) {
      if (errorHandler != null) {
        if (errorHandler.checkOOME(e)) {
          LOG.info(getName() + ": exiting on OOME");
          return;
        }
      }
 else {
        throw e;
      }
    }
catch (    Exception e) {
      LOG.warn(getName() + " caught: " + StringUtils.stringifyException(e));
    }
  }
  LOG.info(getName() + ": exiting");
}
