{
  int sleepMultiplier=1;
  if (this.currentNbEntries == 0) {
    LOG.warn("Was given 0 edits to ship");
    return;
  }
  while (this.isActive()) {
    if (!isPeerEnabled()) {
      if (sleepForRetries("Replication is disabled",sleepMultiplier)) {
        sleepMultiplier++;
      }
      continue;
    }
    try {
      AdminProtocol rrs=getRS();
      ReplicationProtbufUtil.replicateWALEntry(rrs,Arrays.copyOf(this.entriesArray,currentNbEntries));
      if (this.lastLoggedPosition != this.repLogReader.getPosition()) {
        this.manager.logPositionAndCleanOldLogs(this.currentPath,this.peerClusterZnode,this.repLogReader.getPosition(),queueRecovered,currentWALisBeingWrittenTo);
        this.lastLoggedPosition=this.repLogReader.getPosition();
      }
      this.totalReplicatedEdits+=currentNbEntries;
      this.metrics.shipBatch(this.currentNbOperations);
      this.metrics.setAgeOfLastShippedOp(this.entriesArray[currentNbEntries - 1].getKey().getWriteTime());
      break;
    }
 catch (    IOException ioe) {
      this.metrics.refreshAgeOfLastShippedOp();
      if (ioe instanceof RemoteException) {
        ioe=((RemoteException)ioe).unwrapRemoteException();
        LOG.warn("Can't replicate because of an error on the remote cluster: ",ioe);
      }
 else {
        if (ioe instanceof SocketTimeoutException) {
          sleepForRetries("Encountered a SocketTimeoutException. Since the " + "call to the remote cluster timed out, which is usually " + "caused by a machine failure or a massive slowdown",this.socketTimeoutMultiplier);
        }
 else         if (ioe instanceof ConnectException) {
          LOG.warn("Peer is unavailable, rechecking all sinks: ",ioe);
          chooseSinks();
        }
 else {
          LOG.warn("Can't replicate because of a local or network error: ",ioe);
        }
      }
      try {
        boolean down;
        do {
          down=isSlaveDown();
          if (down) {
            if (sleepForRetries("Since we are unable to replicate",sleepMultiplier)) {
              sleepMultiplier++;
            }
 else {
              chooseSinks();
            }
          }
        }
 while (this.isActive() && down);
      }
 catch (      InterruptedException e) {
        LOG.debug("Interrupted while trying to contact the peer cluster");
      }
    }
  }
}
