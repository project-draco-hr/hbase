{
  String tabName=entry.getKey().getTablename().getNameAsString();
  ArrayList<KeyValue> kvs=entry.getEdit().getKeyValues();
  Map<String,List<String>> tableCFs=null;
  try {
    tableCFs=this.replicationPeers.getTableCFs(peerId);
  }
 catch (  IllegalArgumentException e) {
    LOG.error("should not happen: can't get tableCFs for peer " + peerId + ", degenerate as if it's not configured by keeping tableCFs==null");
  }
  int size=kvs.size();
  if (tableCFs != null && !tableCFs.containsKey(tabName)) {
    kvs.clear();
  }
 else {
    NavigableMap<byte[],Integer> scopes=entry.getKey().getScopes();
    List<String> cfs=(tableCFs == null) ? null : tableCFs.get(tabName);
    for (int i=size - 1; i >= 0; i--) {
      KeyValue kv=kvs.get(i);
      if (scopes == null || !scopes.containsKey(kv.getFamily()) || (cfs != null && !cfs.contains(Bytes.toString(kv.getFamily())))) {
        kvs.remove(i);
      }
    }
  }
  if (kvs.size() < size / 2) {
    kvs.trimToSize();
  }
}
