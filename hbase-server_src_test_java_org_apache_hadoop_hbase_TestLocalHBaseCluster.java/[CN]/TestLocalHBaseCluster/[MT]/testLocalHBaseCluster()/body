{
  Configuration conf=TEST_UTIL.getConfiguration();
  MiniZooKeeperCluster zkCluster=TEST_UTIL.startMiniZKCluster();
  conf.set(HConstants.ZOOKEEPER_CLIENT_PORT,Integer.toString(zkCluster.getClientPort()));
  LocalHBaseCluster cluster=new LocalHBaseCluster(conf,1,1,MyHMaster.class,MyHRegionServer.class);
  try {
    ((MyHMaster)cluster.getMaster(0)).setZKCluster(zkCluster);
  }
 catch (  ClassCastException e) {
    fail("Could not cast master to our class");
  }
  try {
    ((MyHRegionServer)cluster.getRegionServer(0)).echo(42);
  }
 catch (  ClassCastException e) {
    fail("Could not cast regionserver to our class");
  }
  try {
    cluster.startup();
    waitForClusterUp(conf);
  }
 catch (  IOException e) {
    fail("LocalHBaseCluster did not start successfully");
  }
 finally {
    cluster.shutdown();
  }
}
