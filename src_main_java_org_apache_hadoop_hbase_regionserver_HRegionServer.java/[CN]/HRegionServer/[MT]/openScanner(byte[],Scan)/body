{
  checkOpen();
  NullPointerException npe=null;
  if (regionName == null) {
    npe=new NullPointerException("regionName is null");
  }
 else   if (scan == null) {
    npe=new NullPointerException("scan is null");
  }
  if (npe != null) {
    throw new IOException("Invalid arguments to openScanner",npe);
  }
  requestCount.incrementAndGet();
  try {
    HRegion r=getRegion(regionName);
    r.checkRow(scan.getStartRow(),"Scan");
    r.prepareScanner(scan);
    RegionScanner s=null;
    if (r.getCoprocessorHost() != null) {
      s=r.getCoprocessorHost().preScannerOpen(scan);
    }
    if (s == null) {
      s=r.getScanner(scan);
    }
    if (r.getCoprocessorHost() != null) {
      RegionScanner savedScanner=r.getCoprocessorHost().postScannerOpen(scan,s);
      if (savedScanner == null) {
        LOG.warn("PostScannerOpen impl returning null. " + "Check the RegionObserver implementation.");
      }
 else {
        s=savedScanner;
      }
    }
    return addScanner(s);
  }
 catch (  Throwable t) {
    throw convertThrowableToIOE(cleanup(t,"Failed openScanner"));
  }
}
