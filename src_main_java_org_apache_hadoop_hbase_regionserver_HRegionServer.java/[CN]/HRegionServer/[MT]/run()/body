{
  try {
    preRegistrationInitialization();
  }
 catch (  Exception e) {
    abort("Fatal exception during initialization",e);
  }
  try {
    while (keepLooping()) {
      MapWritable w=reportForDuty();
      if (w == null) {
        LOG.warn("reportForDuty failed; sleeping and then retrying.");
        this.sleeper.sleep();
      }
 else {
        handleReportForDutyResponse(w);
        break;
      }
    }
    long lastMsg=0;
    long oldRequestCount=-1;
    while (!this.stopped && isHealthy()) {
      if (!isClusterUp()) {
        if (isOnlineRegionsEmpty()) {
          stop("Exiting; cluster shutdown set and not carrying any regions");
        }
 else         if (!this.stopping) {
          this.stopping=true;
          LOG.info("Closing user regions");
          closeUserRegions(this.abortRequested);
        }
 else         if (this.stopping) {
          LOG.info("Stopping meta regions, if the HRegionServer hosts any");
          boolean allUserRegionsOffline=areAllUserRegionsOffline();
          if (allUserRegionsOffline) {
            if (oldRequestCount == this.requestCount.get()) {
              stop("Stopped; only catalog regions remaining online");
              break;
            }
            oldRequestCount=this.requestCount.get();
          }
          LOG.debug("Waiting on " + getOnlineRegionsAsPrintableString());
        }
      }
      long now=System.currentTimeMillis();
      if ((now - lastMsg) >= msgInterval) {
        doMetrics();
        tryRegionServerReport();
        lastMsg=System.currentTimeMillis();
      }
      if (!this.stopped)       this.sleeper.sleep();
    }
  }
 catch (  Throwable t) {
    if (!checkOOME(t)) {
      abort("Unhandled exception: " + t.getMessage(),t);
    }
  }
  this.leases.closeAfterLeasesExpire();
  this.rpcServer.stop();
  if (this.splitLogWorker != null) {
    splitLogWorker.stop();
  }
  if (this.infoServer != null) {
    LOG.info("Stopping infoServer");
    try {
      this.infoServer.stop();
    }
 catch (    Exception e) {
      e.printStackTrace();
    }
  }
  LruBlockCache c=(LruBlockCache)StoreFile.getBlockCache(this.conf);
  if (c != null) {
    c.shutdown();
  }
  if (this.cacheFlusher != null)   this.cacheFlusher.interruptIfNecessary();
  if (this.compactSplitThread != null)   this.compactSplitThread.interruptIfNecessary();
  if (this.hlogRoller != null)   this.hlogRoller.interruptIfNecessary();
  if (this.compactionChecker != null)   this.compactionChecker.interrupt();
  if (this.killed) {
  }
 else   if (abortRequested) {
    if (this.fsOk) {
      closeAllRegions(abortRequested);
      closeWAL(false);
    }
    LOG.info("aborting server " + this.serverNameFromMasterPOV);
  }
 else {
    closeAllRegions(abortRequested);
    closeWAL(true);
    closeAllScanners();
    LOG.info("stopping server " + this.serverNameFromMasterPOV);
  }
  if (this.catalogTracker != null)   this.catalogTracker.stop();
  if (this.fsOk)   waitOnAllRegionsToClose();
  if (this.hbaseMaster != null) {
    HBaseRPC.stopProxy(this.hbaseMaster);
    this.hbaseMaster=null;
  }
  this.leases.close();
  try {
    deleteMyEphemeralNode();
  }
 catch (  KeeperException e) {
    LOG.warn("Failed deleting my ephemeral node",e);
  }
  this.zooKeeper.close();
  if (!killed) {
    join();
  }
  LOG.info(Thread.currentThread().getName() + " exiting");
}
