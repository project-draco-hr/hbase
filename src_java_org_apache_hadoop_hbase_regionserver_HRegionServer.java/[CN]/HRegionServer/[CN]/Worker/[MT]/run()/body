{
  try {
    while (!stopRequested.get()) {
      ToDoEntry e=null;
      try {
        e=toDo.poll(threadWakeFrequency,TimeUnit.MILLISECONDS);
        if (e == null || stopRequested.get()) {
          continue;
        }
        LOG.info("Worker: " + e.msg);
        HRegionInfo info=e.msg.getRegionInfo();
switch (e.msg.getType()) {
case MSG_REGIONSERVER_QUIESCE:
          closeUserRegions();
        break;
case MSG_REGION_OPEN:
      if (!haveRootRegion.get() && !info.isRootRegion()) {
        LOG.info("putting region open request back into queue because" + " root region is not yet available");
        try {
          toDo.put(e);
        }
 catch (        InterruptedException ex) {
          LOG.warn("insertion into toDo queue was interrupted",ex);
          break;
        }
      }
    openRegion(info);
  break;
case MSG_REGION_CLOSE:
closeRegion(e.msg.getRegionInfo(),true);
break;
case MSG_REGION_CLOSE_WITHOUT_REPORT:
closeRegion(e.msg.getRegionInfo(),false);
break;
case MSG_REGION_SPLIT:
{
HRegion region=getRegion(info.getRegionName());
region.regionInfo.shouldSplit(true);
compactSplitThread.compactionRequested(region,"MSG_REGION_SPLIT");
}
break;
case MSG_REGION_COMPACT:
{
HRegion region=getRegion(info.getRegionName());
compactSplitThread.compactionRequested(region,"MSG_REGION_COMPACT");
}
break;
default :
throw new AssertionError("Impossible state during msg processing.  Instruction: " + e.msg.toString());
}
}
 catch (InterruptedException ex) {
}
catch (Exception ex) {
if (ex instanceof IOException) {
ex=RemoteExceptionHandler.checkIOException((IOException)ex);
}
if (e != null && e.tries < numRetries) {
LOG.warn(ex);
e.tries++;
try {
toDo.put(e);
}
 catch (InterruptedException ie) {
throw new RuntimeException("Putting into msgQueue was " + "interrupted.",ex);
}
}
 else {
LOG.error("unable to process message" + (e != null ? (": " + e.msg.toString()) : ""),ex);
if (!checkFileSystem()) {
break;
}
}
}
}
}
 catch (Throwable t) {
LOG.fatal("Unhandled exception",t);
}
 finally {
LOG.info("worker thread exiting");
}
}
