{
  this.metrics.regions.set(this.onlineRegions.size());
  this.metrics.incrementRequests(this.requestCount.get());
  int stores=0;
  int storefiles=0;
  long memcacheSize=0;
  long storefileIndexSize=0;
synchronized (this.onlineRegions) {
    for (    Map.Entry<Integer,HRegion> e : this.onlineRegions.entrySet()) {
      HRegion r=e.getValue();
      memcacheSize+=r.memcacheSize.get();
synchronized (r.stores) {
        stores+=r.stores.size();
        for (        Map.Entry<byte[],Store> ee : r.stores.entrySet()) {
          Store store=ee.getValue();
          storefiles+=store.getStorefilesCount();
          try {
            storefileIndexSize+=store.getStorefilesIndexSize();
          }
 catch (          IOException ex) {
            LOG.warn("error getting store file index size for " + store + ": "+ StringUtils.stringifyException(ex));
          }
        }
      }
    }
  }
  this.metrics.stores.set(stores);
  this.metrics.storefiles.set(storefiles);
  this.metrics.memcacheSizeMB.set((int)(memcacheSize / (1024 * 1024)));
  this.metrics.storefileIndexSizeMB.set((int)(storefileIndexSize / (1024 * 1024)));
  LruBlockCache lruBlockCache=(LruBlockCache)StoreFile.getBlockCache(conf);
  if (lruBlockCache != null) {
    this.metrics.blockCacheCount.set(lruBlockCache.size());
    this.metrics.blockCacheFree.set(lruBlockCache.getMemFree());
    this.metrics.blockCacheSize.set(lruBlockCache.getMemUsed());
    double ratio=lruBlockCache.getHitRatio();
    int percent=(int)(ratio * 100);
    this.metrics.blockCacheHitRatio.set(percent);
  }
}
