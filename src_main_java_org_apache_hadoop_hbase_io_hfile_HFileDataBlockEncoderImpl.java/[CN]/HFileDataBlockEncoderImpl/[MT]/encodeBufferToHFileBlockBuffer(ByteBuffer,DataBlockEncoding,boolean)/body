{
  ByteArrayOutputStream encodedStream=new ByteArrayOutputStream();
  DataOutputStream dataOut=new DataOutputStream(encodedStream);
  DataBlockEncoder encoder=algo.getEncoder();
  try {
    encodedStream.write(HFileBlock.DUMMY_HEADER);
    algo.writeIdInBytes(dataOut);
    encoder.compressKeyValues(dataOut,in,includesMemstoreTS);
  }
 catch (  IOException e) {
    throw new RuntimeException(String.format("Bug in data block encoder " + "'%s', it probably requested too much data",algo.toString()),e);
  }
  return ByteBuffer.wrap(encodedStream.toByteArray());
}
