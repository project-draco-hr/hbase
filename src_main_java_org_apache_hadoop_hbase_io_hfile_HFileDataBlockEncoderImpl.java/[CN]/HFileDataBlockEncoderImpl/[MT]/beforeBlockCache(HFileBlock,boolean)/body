{
  if (ignoreBlock(block)) {
    return block;
  }
  if (block.getBlockType() == BlockType.ENCODED_DATA) {
    if (block.getDataBlockEncodingId() == inCache.getId()) {
      return block;
    }
    throw new IllegalStateException(String.format("Expected the in-cache encoding ('%s') or no encoding, " + "but got encoding '%s'",inCache.toString(),DataBlockEncodings.getNameFromId(block.getDataBlockEncodingId())));
  }
  if (inCache != DataBlockEncodings.Algorithm.NONE) {
    HFileBlock encodedBlock=encodeDataBlock(block,inCache,includesMemstoreTS);
    block.passSchemaMetricsTo(encodedBlock);
    return encodedBlock;
  }
  return block;
}
