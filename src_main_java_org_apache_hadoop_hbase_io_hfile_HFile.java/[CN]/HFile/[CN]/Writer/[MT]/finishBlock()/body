{
  if (baosDos == null)   return;
  baosDos.flush();
  DataOutputStream compressStream=getCompressingStream();
  baos.writeTo(compressStream);
  int size=releaseCompressingStream(compressStream);
  long now=System.currentTimeMillis();
  blockKeys.add(firstKey);
  blockOffsets.add(Long.valueOf(blockBegin));
  blockDataSizes.add(Integer.valueOf(size));
  this.totalBytes+=size;
  writeTime+=System.currentTimeMillis() - now;
  writeOps++;
  if (blockCache != null) {
    byte[] bytes=baos.toByteArray();
    ByteBuffer blockToCache=ByteBuffer.wrap(bytes,DATABLOCKMAGIC.length,bytes.length - DATABLOCKMAGIC.length);
    String blockName=path.toString() + blockNumber;
    blockCache.cacheBlock(blockName,blockToCache);
  }
  baosDos.close();
  baosDos=null;
  baos=null;
  blockNumber++;
}
