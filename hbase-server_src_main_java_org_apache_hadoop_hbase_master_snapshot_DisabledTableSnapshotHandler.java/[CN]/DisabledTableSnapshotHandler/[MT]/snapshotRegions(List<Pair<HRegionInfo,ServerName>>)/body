{
  try {
    timeoutInjector.start();
    Path snapshotDir=SnapshotDescriptionUtils.getWorkingSnapshotDir(snapshot,rootDir);
    Set<HRegionInfo> regions=new HashSet<HRegionInfo>();
    for (    Pair<HRegionInfo,ServerName> p : regionsAndLocations) {
      regions.add(p.getFirst());
    }
    String msg="Starting to write region info and WALs for regions for offline snapshot:" + ClientSnapshotDescriptionUtils.toString(snapshot);
    LOG.info(msg);
    status.setStatus(msg);
    for (    HRegionInfo regionInfo : regions) {
      snapshotDisabledRegion(regionInfo);
    }
    LOG.info("Starting to copy tableinfo for offline snapshot: " + ClientSnapshotDescriptionUtils.toString(snapshot));
    TableInfoCopyTask tableInfoCopyTask=new TableInfoCopyTask(this.monitor,snapshot,fs,FSUtils.getRootDir(conf));
    tableInfoCopyTask.call();
    monitor.rethrowException();
    status.setStatus("Finished copying tableinfo for snapshot of table: " + snapshotTable);
  }
 catch (  Exception e) {
    String reason="Failed snapshot " + ClientSnapshotDescriptionUtils.toString(snapshot) + " due to exception:"+ e.getMessage();
    ForeignException ee=new ForeignException(reason,e);
    monitor.receive(ee);
    status.abort("Snapshot of table: " + snapshotTable + " failed because "+ e.getMessage());
  }
 finally {
    LOG.debug("Marking snapshot" + ClientSnapshotDescriptionUtils.toString(snapshot) + " as finished.");
    timeoutInjector.complete();
  }
}
