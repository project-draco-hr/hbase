{
  try {
    timeoutInjector.start();
    Path snapshotDir=SnapshotDescriptionUtils.getWorkingSnapshotDir(snapshot,rootDir);
    Set<String> serverNames=new HashSet<String>();
    Set<HRegionInfo> regions=new HashSet<HRegionInfo>();
    for (    Pair<HRegionInfo,ServerName> p : regionsAndLocations) {
      regions.add(p.getFirst());
      serverNames.add(p.getSecond().toString());
    }
    LOG.info("Starting to write region info and WALs for regions for offline snapshot:" + ClientSnapshotDescriptionUtils.toString(snapshot));
    for (    HRegionInfo regionInfo : regions) {
      HRegionFileSystem regionFs=HRegionFileSystem.createRegionOnFileSystem(conf,fs,snapshotDir,regionInfo);
      monitor.rethrowException();
      Path regionDir=HRegion.getRegionDir(rootDir,regionInfo);
      Path snapshotRegionDir=regionFs.getRegionDir();
      new CopyRecoveredEditsTask(snapshot,monitor,fs,regionDir,snapshotRegionDir).call();
      monitor.rethrowException();
      new ReferenceRegionHFilesTask(snapshot,monitor,regionDir,fs,snapshotRegionDir).call();
      monitor.rethrowException();
    }
    LOG.info("Starting to copy tableinfo for offline snapshot: " + ClientSnapshotDescriptionUtils.toString(snapshot));
    TableInfoCopyTask tableInfoCopyTask=new TableInfoCopyTask(this.monitor,snapshot,fs,FSUtils.getRootDir(conf));
    tableInfoCopyTask.call();
    monitor.rethrowException();
  }
 catch (  Exception e) {
    String reason="Failed snapshot " + ClientSnapshotDescriptionUtils.toString(snapshot) + " due to exception:"+ e.getMessage();
    ForeignException ee=new ForeignException(reason,e);
    monitor.receive(ee);
  }
 finally {
    LOG.debug("Marking snapshot" + ClientSnapshotDescriptionUtils.toString(snapshot) + " as finished.");
    timeoutInjector.complete();
  }
}
