{
  int compactionKVMax=conf.getInt(HConstants.COMPACTION_KV_MAX,HConstants.COMPACTION_KV_MAX_DEFAULT);
  List<KeyValue> kvs=new ArrayList<KeyValue>();
  boolean hasMore;
  long flushed=0;
  do {
    hasMore=scanner.next(kvs,compactionKVMax);
    if (!kvs.isEmpty()) {
      for (      KeyValue kv : kvs) {
        if (kv.getMvccVersion() <= smallestReadPoint) {
          kv=kv.shallowCopy();
          kv.setMvccVersion(0);
        }
        sink.append(kv);
        flushed+=MemStore.heapSizeChange(kv,true);
      }
      kvs.clear();
    }
  }
 while (hasMore);
  return flushed;
}
