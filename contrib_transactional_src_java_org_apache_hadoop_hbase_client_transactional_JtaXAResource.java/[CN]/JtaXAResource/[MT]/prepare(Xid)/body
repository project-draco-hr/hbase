{
  LOG.trace("prepare [" + xid.toString() + "] ");
  TransactionState state=xidToTransactionState.get(xid);
  int status;
  try {
    status=this.transactionManager.prepareCommit(state);
  }
 catch (  CommitUnsuccessfulException e) {
    XAException xae=new XAException(XAException.XA_HEURRB);
    xae.initCause(e);
    throw xae;
  }
catch (  IOException e) {
    XAException xae=new XAException(XAException.XAER_RMERR);
    xae.initCause(e);
    throw xae;
  }
switch (status) {
case TransactionalRegionInterface.COMMIT_OK:
    return XAResource.XA_OK;
case TransactionalRegionInterface.COMMIT_OK_READ_ONLY:
  return XAResource.XA_RDONLY;
default :
throw new XAException(XAException.XA_RBPROTO);
}
}
