{
  final String tableNameStr="testReplayEditsWrittenViaHRegion";
  final HRegionInfo hri=createBasic3FamilyHRegionInfo(tableNameStr);
  final Path basedir=new Path(this.hbaseRootDir,tableNameStr);
  deleteDir(basedir);
  final byte[] rowName=Bytes.toBytes(tableNameStr);
  final int countPerFamily=10;
  final HTableDescriptor htd=createBasic3FamilyHTD(tableNameStr);
  HRegion region3=HRegion.createHRegion(hri,hbaseRootDir,this.conf,htd);
  HRegion.closeHRegion(region3);
  HLog wal=createWAL(this.conf);
  HRegion region=new HRegion(basedir,wal,this.fs,this.conf,hri,htd,null);
  long seqid=region.initialize();
  wal.setSequenceNumber(seqid);
  boolean first=true;
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addRegionEdits(rowName,hcd.getName(),countPerFamily,this.ee,region,"x");
    if (first) {
      region.flushcache();
      first=false;
    }
  }
  final Get g=new Get(rowName);
  Result result=region.get(g);
  assertEquals(countPerFamily * htd.getFamilies().size(),result.size());
  region.close(true);
  wal.close();
  runWALSplit(this.conf);
  HLog wal2=createWAL(this.conf);
  HRegion region2=new HRegion(basedir,wal2,this.fs,this.conf,hri,htd,null);
  long seqid2=region2.initialize();
  wal2.setSequenceNumber(seqid2);
  assertTrue(seqid + result.size() < seqid2);
  final Result result1b=region2.get(g);
  assertEquals(result.size(),result1b.size());
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addRegionEdits(rowName,hcd.getName(),countPerFamily,this.ee,region2,"y");
  }
  final Result result2=region2.get(g);
  assertEquals(2 * result.size(),result2.size());
  wal2.sync();
  HBaseTestingUtility.setMaxRecoveryErrorCount(((FSHLog)wal2).getOutputStream(),1);
  final Configuration newConf=HBaseConfiguration.create(this.conf);
  User user=HBaseTestingUtility.getDifferentUser(newConf,tableNameStr);
  user.runAs(new PrivilegedExceptionAction(){
    public Object run() throws Exception {
      runWALSplit(newConf);
      FileSystem newFS=FileSystem.get(newConf);
      HLog wal3=createWAL(newConf);
      final AtomicInteger countOfRestoredEdits=new AtomicInteger(0);
      HRegion region3=new HRegion(basedir,wal3,newFS,newConf,hri,htd,null){
        @Override protected boolean restoreEdit(        Store s,        KeyValue kv){
          boolean b=super.restoreEdit(s,kv);
          countOfRestoredEdits.incrementAndGet();
          return b;
        }
      }
;
      long seqid3=region3.initialize();
      wal3.setSequenceNumber(seqid3);
      Result result3=region3.get(g);
      assertEquals(result2.size(),result3.size());
      assertEquals(htd.getFamilies().size() * countPerFamily,countOfRestoredEdits.get());
      region3.close();
      wal3.closeAndDelete();
      return null;
    }
  }
);
}
