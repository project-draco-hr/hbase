{
  final String tableNameStr="testReplayEditsWrittenViaHRegion";
  final HRegionInfo hri=createBasic3FamilyHRegionInfo(tableNameStr);
  final Path basedir=new Path(this.hbaseRootDir,tableNameStr);
  deleteDir(basedir);
  final HTableDescriptor htd=createBasic3FamilyHTD(tableNameStr);
  HRegion region2=HRegion.createHRegion(hri,hbaseRootDir,this.conf,htd);
  HRegion.closeHRegion(region2);
  HLog wal=createWAL(this.conf);
  HRegion region=HRegion.openHRegion(hri,htd,wal,this.conf);
  Path f=new Path(basedir,"hfile");
  HFile.Writer writer=HFile.getWriterFactoryNoCache(conf).withPath(fs,f).create();
  byte[] family=htd.getFamilies().iterator().next().getName();
  byte[] row=Bytes.toBytes(tableNameStr);
  writer.append(new KeyValue(row,family,family,row));
  writer.close();
  List<Pair<byte[],String>> hfs=new ArrayList<Pair<byte[],String>>(1);
  hfs.add(Pair.newPair(family,f.toString()));
  region.bulkLoadHFiles(hfs,true);
  region.put((new Put(row)).add(family,family,family));
  wal.sync();
  final Configuration newConf=HBaseConfiguration.create(this.conf);
  User user=HBaseTestingUtility.getDifferentUser(newConf,tableNameStr);
  user.runAs(new PrivilegedExceptionAction(){
    public Object run() throws Exception {
      runWALSplit(newConf);
      HLog wal2=createWAL(newConf);
      HRegion region2=HRegion.openHRegion(newConf,FileSystem.get(newConf),hbaseRootDir,hri,htd,wal2);
      long seqid2=region2.getOpenSeqNum();
      assertTrue(seqid2 > -1);
      region2.close();
      wal2.closeAndDelete();
      return null;
    }
  }
);
}
