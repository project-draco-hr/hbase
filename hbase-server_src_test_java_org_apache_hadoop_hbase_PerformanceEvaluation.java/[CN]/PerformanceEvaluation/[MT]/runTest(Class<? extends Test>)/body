{
  MiniHBaseCluster hbaseMiniCluster=null;
  MiniDFSCluster dfsCluster=null;
  MiniZooKeeperCluster zooKeeperCluster=null;
  Configuration conf=getConf();
  if (this.miniCluster) {
    dfsCluster=new MiniDFSCluster(conf,2,true,(String[])null);
    zooKeeperCluster=new MiniZooKeeperCluster(conf);
    int zooKeeperPort=zooKeeperCluster.startup(new File(System.getProperty("java.io.tmpdir")));
    FileSystem fs=dfsCluster.getFileSystem();
    FSUtils.setFsDefault(conf,new Path(fs.getUri()));
    conf.set(HConstants.ZOOKEEPER_CLIENT_PORT,Integer.toString(zooKeeperPort));
    Path parentdir=fs.getHomeDirectory();
    FSUtils.setRootDir(conf,parentdir);
    fs.mkdirs(parentdir);
    FSUtils.setVersion(fs,parentdir);
    hbaseMiniCluster=new MiniHBaseCluster(conf,N);
  }
  try {
    if (N == 1) {
      runNIsOne(cmd);
    }
 else {
      runNIsMoreThanOne(cmd);
    }
  }
  finally {
    if (this.miniCluster) {
      if (hbaseMiniCluster != null)       hbaseMiniCluster.shutdown();
      if (zooKeeperCluster != null)       zooKeeperCluster.shutdown();
      HBaseTestCase.shutdownDfs(dfsCluster);
    }
  }
}
