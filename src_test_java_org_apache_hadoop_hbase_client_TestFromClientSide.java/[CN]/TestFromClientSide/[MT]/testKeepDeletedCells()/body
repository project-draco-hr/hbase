{
  final byte[] TABLENAME=Bytes.toBytes("testKeepDeletesCells");
  final byte[] FAMILY=Bytes.toBytes("family");
  final byte[] C0=Bytes.toBytes("c0");
  final byte[] T1=Bytes.toBytes("T1");
  final byte[] T2=Bytes.toBytes("T2");
  final byte[] T3=Bytes.toBytes("T3");
  HColumnDescriptor hcd=new HColumnDescriptor(FAMILY,HColumnDescriptor.DEFAULT_MIN_VERSIONS,HColumnDescriptor.DEFAULT_VERSIONS,true,HColumnDescriptor.DEFAULT_COMPRESSION,HColumnDescriptor.DEFAULT_IN_MEMORY,HColumnDescriptor.DEFAULT_BLOCKCACHE,HColumnDescriptor.DEFAULT_BLOCKSIZE,HColumnDescriptor.DEFAULT_TTL,HColumnDescriptor.DEFAULT_BLOOMFILTER,HColumnDescriptor.DEFAULT_REPLICATION_SCOPE);
  HTableDescriptor desc=new HTableDescriptor(TABLENAME);
  desc.addFamily(hcd);
  TEST_UTIL.getHBaseAdmin().createTable(desc);
  Configuration c=TEST_UTIL.getConfiguration();
  HTable h=new HTable(c,TABLENAME);
  long ts=System.currentTimeMillis();
  Put p=new Put(T1,ts);
  p.add(FAMILY,C0,T1);
  h.put(p);
  p=new Put(T1,ts + 2);
  p.add(FAMILY,C0,T2);
  h.put(p);
  p=new Put(T1,ts + 4);
  p.add(FAMILY,C0,T3);
  h.put(p);
  Delete d=new Delete(T1,ts + 2,null);
  h.delete(d);
  d=new Delete(T1,ts + 3,null);
  d.deleteColumns(FAMILY,C0,ts + 3);
  h.delete(d);
  Get g=new Get(T1);
  g.setTimeRange(0,ts + 3);
  Result r=h.get(g);
  assertArrayEquals(T2,r.getValue(FAMILY,C0));
  Scan s=new Scan(T1);
  s.setTimeRange(0,ts + 3);
  s.setMaxVersions();
  ResultScanner scanner=h.getScanner(s);
  KeyValue[] kvs=scanner.next().raw();
  assertArrayEquals(T2,kvs[0].getValue());
  assertArrayEquals(T1,kvs[1].getValue());
  scanner.close();
  s=new Scan(T1);
  s.setRaw(true);
  s.setMaxVersions();
  scanner=h.getScanner(s);
  kvs=scanner.next().raw();
  assertTrue(kvs[0].isDeleteFamily());
  assertArrayEquals(T3,kvs[1].getValue());
  assertTrue(kvs[2].isDelete());
  assertArrayEquals(T2,kvs[3].getValue());
  assertArrayEquals(T1,kvs[4].getValue());
  scanner.close();
  h.close();
}
