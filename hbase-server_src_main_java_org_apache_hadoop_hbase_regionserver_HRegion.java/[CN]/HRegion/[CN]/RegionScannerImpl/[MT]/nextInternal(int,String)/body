{
  RpcCallContext rpcCall=HBaseServer.getCurrentCall();
  while (true) {
    if (rpcCall != null) {
      rpcCall.throwExceptionIfCallerDisconnected();
    }
    KeyValue current=this.storeHeap.peek();
    byte[] currentRow=null;
    int offset=0;
    short length=0;
    if (current != null) {
      currentRow=current.getBuffer();
      offset=current.getRowOffset();
      length=current.getRowLength();
    }
    if (isStopRow(currentRow,offset,length)) {
      if (filter != null && filter.hasFilterRow()) {
        filter.filterRow(results);
      }
      return false;
    }
 else     if (filterRowKey(currentRow,offset,length)) {
      nextRow(currentRow,offset,length);
    }
 else {
      KeyValue nextKv;
      do {
        this.storeHeap.next(results,limit - results.size(),metric);
        if (limit > 0 && results.size() == limit) {
          if (this.filter != null && filter.hasFilterRow()) {
            throw new IncompatibleFilterException("Filter whose hasFilterRow() returns true is incompatible with scan with limit!");
          }
          return true;
        }
        nextKv=this.storeHeap.peek();
      }
 while (nextKv != null && nextKv.matchingRow(currentRow,offset,length));
      final boolean stopRow=nextKv == null || isStopRow(nextKv.getBuffer(),nextKv.getRowOffset(),nextKv.getRowLength());
      if (filter != null && filter.hasFilterRow()) {
        filter.filterRow(results);
      }
      if (results.isEmpty()) {
        nextRow(currentRow,offset,length);
        if (!stopRow)         continue;
      }
      return !stopRow;
    }
  }
}
