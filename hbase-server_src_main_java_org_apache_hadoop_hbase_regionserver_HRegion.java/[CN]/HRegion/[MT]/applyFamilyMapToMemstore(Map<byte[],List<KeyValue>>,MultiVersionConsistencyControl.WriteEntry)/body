{
  long size=0;
  boolean freemvcc=false;
  try {
    if (localizedWriteEntry == null) {
      localizedWriteEntry=mvcc.beginMemstoreInsert();
      freemvcc=true;
    }
    for (    Map.Entry<byte[],List<KeyValue>> e : familyMap.entrySet()) {
      byte[] family=e.getKey();
      List<KeyValue> edits=e.getValue();
      HStore store=getStore(family);
      for (      KeyValue kv : edits) {
        kv.setMemstoreTS(localizedWriteEntry.getWriteNumber());
        size+=store.add(kv);
      }
    }
  }
  finally {
    if (freemvcc) {
      mvcc.completeMemstoreInsert(localizedWriteEntry);
    }
  }
  return size;
}
