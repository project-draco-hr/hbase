{
  for (  Map.Entry<byte[],List<Cell>> e : familyMap.entrySet()) {
    byte[] family=e.getKey();
    List<Cell> cells=e.getValue();
    Map<byte[],Integer> kvCount=new TreeMap<byte[],Integer>(Bytes.BYTES_COMPARATOR);
    for (    Cell cell : cells) {
      KeyValue kv=KeyValueUtil.ensureKeyValue(cell);
      if (kv.isLatestTimestamp() && kv.isDeleteType()) {
        byte[] qual=kv.getQualifier();
        if (qual == null)         qual=HConstants.EMPTY_BYTE_ARRAY;
        Integer count=kvCount.get(qual);
        if (count == null) {
          kvCount.put(qual,1);
        }
 else {
          kvCount.put(qual,count + 1);
        }
        count=kvCount.get(qual);
        Get get=new Get(kv.getRow());
        get.setMaxVersions(count);
        get.addColumn(family,qual);
        List<KeyValue> result=get(get,false);
        if (result.size() < count) {
          kv.updateLatestStamp(byteNow);
          continue;
        }
        if (result.size() > count) {
          throw new RuntimeException("Unexpected size: " + result.size());
        }
        KeyValue getkv=result.get(count - 1);
        Bytes.putBytes(kv.getBuffer(),kv.getTimestampOffset(),getkv.getBuffer(),getkv.getTimestampOffset(),Bytes.SIZEOF_LONG);
      }
 else {
        kv.updateLatestStamp(byteNow);
      }
    }
  }
}
