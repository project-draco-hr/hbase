{
  for (  Map.Entry<byte[],List<Cell>> e : familyMap.entrySet()) {
    byte[] family=e.getKey();
    List<Cell> cells=e.getValue();
    Map<byte[],Integer> kvCount=new TreeMap<byte[],Integer>(Bytes.BYTES_COMPARATOR);
    for (    Cell cell : cells) {
      KeyValue kv=KeyValueUtil.ensureKeyValue(cell);
      if (kv.isLatestTimestamp() && kv.isDeleteType()) {
        byte[] qual=CellUtil.cloneQualifier(kv);
        if (qual == null)         qual=HConstants.EMPTY_BYTE_ARRAY;
        Integer count=kvCount.get(qual);
        if (count == null) {
          kvCount.put(qual,1);
        }
 else {
          kvCount.put(qual,count + 1);
        }
        count=kvCount.get(qual);
        Get get=new Get(CellUtil.cloneRow(kv));
        get.setMaxVersions(count);
        get.addColumn(family,qual);
        if (coprocessorHost != null) {
          if (!coprocessorHost.prePrepareTimeStampForDeleteVersion(mutation,cell,byteNow,get)) {
            updateDeleteLatestVersionTimeStamp(kv,get,count,byteNow);
          }
        }
 else {
          updateDeleteLatestVersionTimeStamp(kv,get,count,byteNow);
        }
      }
 else {
        kv.updateLatestStamp(byteNow);
      }
    }
  }
}
