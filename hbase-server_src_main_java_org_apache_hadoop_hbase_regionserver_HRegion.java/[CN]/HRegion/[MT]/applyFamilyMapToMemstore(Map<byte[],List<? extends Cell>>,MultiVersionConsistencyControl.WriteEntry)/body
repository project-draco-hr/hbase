{
  long size=0;
  boolean freemvcc=false;
  try {
    if (localizedWriteEntry == null) {
      localizedWriteEntry=mvcc.beginMemstoreInsert();
      freemvcc=true;
    }
    for (    Map.Entry<byte[],List<? extends Cell>> e : familyMap.entrySet()) {
      byte[] family=e.getKey();
      List<? extends Cell> cells=e.getValue();
      Store store=getStore(family);
      for (      Cell cell : cells) {
        KeyValue kv=KeyValueUtil.ensureKeyValue(cell);
        kv.setMemstoreTS(localizedWriteEntry.getWriteNumber());
        size+=store.add(kv);
      }
    }
  }
  finally {
    if (freemvcc) {
      mvcc.completeMemstoreInsert(localizedWriteEntry);
    }
  }
  return size;
}
