{
  final TableName table=TableName.valueOf("fooTable");
  final int numRegions=3;
  final int numReplica=2;
  try {
    HTableDescriptor desc=new HTableDescriptor(table);
    desc.setRegionReplication(numReplica);
    desc.addFamily(new HColumnDescriptor("family"));
    admin.createTable(desc,Bytes.toBytes("A"),Bytes.toBytes("Z"),numRegions);
    TEST_UTIL.waitTableEnabled(table.getName());
    CatalogTracker ct=new CatalogTracker(TEST_UTIL.getConfiguration());
    validateNumberOfRowsInMeta(table,numRegions,ct);
    List<HRegionInfo> hris=MetaReader.getTableRegions(ct,table);
    assert(hris.size() == numRegions * numReplica);
    for (int i=0; i < numRegions; i++) {
      for (int j=0; j < numReplica; j++) {
        HRegionInfo replica=RegionReplicaUtil.getRegionInfoForReplica(hris.get(i),j);
        RegionState state=TEST_UTIL.getHBaseCluster().getMaster().getAssignmentManager().getRegionStates().getRegionState(replica);
        assert(state != null);
      }
    }
    admin.disableTable(table);
    assert(admin.isTableDisabled(table));
    desc.setRegionReplication(numReplica + 1);
    admin.modifyTable(table,desc);
    admin.enableTable(table);
    assert(admin.isTableEnabled(table));
    List<HRegionInfo> regions=TEST_UTIL.getMiniHBaseCluster().getMaster().getAssignmentManager().getRegionStates().getRegionsOfTable(table);
    assert(regions.size() == numRegions * (numReplica + 1));
    admin.disableTable(table);
    desc.setRegionReplication(numReplica);
    admin.modifyTable(table,desc);
    admin.enableTable(table);
    assert(admin.isTableEnabled(table));
    regions=TEST_UTIL.getMiniHBaseCluster().getMaster().getAssignmentManager().getRegionStates().getRegionsOfTable(table);
    assert(regions.size() == numRegions * numReplica);
    hris=MetaReader.getTableRegions(ct,table);
    assert(hris.size() == numRegions * numReplica);
    Map<HRegionInfo,Integer> defaultReplicas=new HashMap<HRegionInfo,Integer>();
    for (    HRegionInfo hri : hris) {
      Integer i;
      HRegionInfo regionReplica0=RegionReplicaUtil.getRegionInfoForDefaultReplica(hri);
      defaultReplicas.put(regionReplica0,(i=defaultReplicas.get(regionReplica0)) == null ? 1 : i + 1);
    }
    assert(defaultReplicas.size() == numRegions);
    Collection<Integer> counts=new HashSet<Integer>(defaultReplicas.values());
    assert(counts.size() == 1 && counts.contains(new Integer(numReplica)));
  }
  finally {
    admin.disableTable(table);
    admin.deleteTable(table);
  }
}
