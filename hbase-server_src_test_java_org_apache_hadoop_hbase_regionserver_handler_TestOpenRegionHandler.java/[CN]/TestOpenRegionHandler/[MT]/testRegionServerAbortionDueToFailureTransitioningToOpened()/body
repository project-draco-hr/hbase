{
  final Server server=new MockServer(HTU);
  final RegionServerServices rss=HTU.createMockRegionServerService();
  HTableDescriptor htd=TEST_HTD;
  final HRegionInfo hri=TEST_HRI;
  HRegion region=HRegion.createHRegion(hri,HTU.getDataTestDir(),HTU.getConfiguration(),htd);
  assertNotNull(region);
  try {
    ZkCoordinatedStateManager csm=new ZkCoordinatedStateManager();
    csm.initialize(server);
    csm.start();
    ZkOpenRegionCoordination.ZkOpenRegionDetails zkCrd=new ZkOpenRegionCoordination.ZkOpenRegionDetails();
    zkCrd.setServerName(server.getServerName());
    ZkOpenRegionCoordination openRegionCoordination=new ZkOpenRegionCoordination(csm,server.getZooKeeper()){
      @Override public boolean transitionToOpened(      final HRegion r,      OpenRegionDetails ord) throws IOException {
        ZooKeeperWatcher zkw=server.getZooKeeper();
        String node=ZKAssign.getNodeName(zkw,hri.getEncodedName());
        try {
          ZKUtil.deleteNodeFailSilent(zkw,node);
        }
 catch (        KeeperException e) {
          throw new RuntimeException("Ugh failed delete of " + node,e);
        }
        return super.transitionToOpened(r,ord);
      }
    }
;
    OpenRegionHandler handler=new OpenRegionHandler(server,rss,hri,htd,openRegionCoordination,zkCrd);
    rss.getRegionsInTransitionInRS().put(hri.getEncodedNameAsBytes(),Boolean.TRUE);
    handler.process();
    rss.getRegionsInTransitionInRS().put(hri.getEncodedNameAsBytes(),Boolean.TRUE);
    ZKAssign.createNodeOffline(server.getZooKeeper(),hri,server.getServerName());
    handler.process();
  }
 catch (  IOException ioe) {
  }
 finally {
    HRegion.closeHRegion(region);
  }
  assertTrue("region server should have aborted",server.isAborted());
}
