{
  KeyValueScanner[] scanners=new KeyValueScanner[filesToCompact.size()];
  for (int i=0; i < filesToCompact.size(); ++i) {
    CompactionReader r=filesToCompact.get(i).getCompactionReader();
    if (r == null) {
      LOG.warn("StoreFile " + filesToCompact.get(i) + " has a null Reader");
      continue;
    }
    scanners[i]=new StoreFileScanner(r.getScanner());
  }
  if (majorCompaction) {
    InternalScanner scanner=null;
    try {
      Scan scan=new Scan();
      scan.setMaxVersions(family.getMaxVersions());
      scanner=new StoreScanner(this,scan,null);
      ArrayList<KeyValue> row=new ArrayList<KeyValue>();
      boolean more=true;
      while (more) {
        more=scanner.next(row);
        for (        KeyValue kv : row) {
          writer.append(kv);
        }
        row.clear();
      }
    }
  finally {
      if (scanner != null)       scanner.close();
    }
  }
 else {
    MinorCompactingStoreScanner scanner=null;
    try {
      scanner=new MinorCompactingStoreScanner(this,scanners);
      while (scanner.next(writer)) {
      }
    }
  finally {
      if (scanner != null)       scanner.close();
    }
  }
}
