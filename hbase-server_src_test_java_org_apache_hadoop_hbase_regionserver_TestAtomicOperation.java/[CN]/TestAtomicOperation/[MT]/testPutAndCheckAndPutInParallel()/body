{
  final String tableName="testPutAndCheckAndPut";
  Configuration conf=HBaseConfiguration.create();
  conf.setClass(HConstants.REGION_IMPL,MockHRegion.class,HeapSize.class);
  final MockHRegion region=(MockHRegion)TestHRegion.initHRegion(Bytes.toBytes(tableName),tableName,conf,Bytes.toBytes(family));
  Put[] puts=new Put[1];
  Put put=new Put(Bytes.toBytes("r1"));
  put.add(Bytes.toBytes(family),Bytes.toBytes("q1"),Bytes.toBytes("10"));
  puts[0]=put;
  region.batchMutate(puts);
  MultithreadedTestUtil.TestContext ctx=new MultithreadedTestUtil.TestContext(conf);
  ctx.addThread(new PutThread(ctx,region));
  ctx.addThread(new CheckAndPutThread(ctx,region));
  ctx.startThreads();
  while (testStep != TestStep.CHECKANDPUT_COMPLETED) {
    Thread.sleep(100);
  }
  ctx.stop();
  Scan s=new Scan();
  RegionScanner scanner=region.getScanner(s);
  List<KeyValue> results=new ArrayList<KeyValue>();
  scanner.next(results,2);
  for (  KeyValue keyValue : results) {
    assertEquals("50",Bytes.toString(keyValue.getValue()));
  }
}
