{
  in.rewind();
  ByteBufferUtils.putInt(out,in.limit());
  FastDiffCompressionState previousState=new FastDiffCompressionState();
  FastDiffCompressionState currentState=new FastDiffCompressionState();
  while (in.hasRemaining()) {
    compressSingleKeyValue(previousState,currentState,out,in);
    afterEncodingKeyValue(in,out,encodingCtx);
    FastDiffCompressionState tmp=previousState;
    previousState=currentState;
    currentState=tmp;
  }
}
