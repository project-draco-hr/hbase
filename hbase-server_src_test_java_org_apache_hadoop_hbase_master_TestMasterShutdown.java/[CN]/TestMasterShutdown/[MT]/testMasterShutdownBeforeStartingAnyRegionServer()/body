{
  final int NUM_MASTERS=1;
  final int NUM_RS=0;
  Configuration conf=HBaseConfiguration.create();
  conf.setInt("hbase.ipc.client.failed.servers.expiry",200);
  conf.setInt(ServerManager.WAIT_ON_REGIONSERVERS_MINTOSTART,1);
  final HBaseTestingUtility TEST_UTIL=new HBaseTestingUtility(conf);
  TEST_UTIL.startMiniDFSCluster(3);
  TEST_UTIL.startMiniZKCluster();
  TEST_UTIL.createRootDir();
  final LocalHBaseCluster cluster=new LocalHBaseCluster(conf,NUM_MASTERS,NUM_RS,HMaster.class,MiniHBaseCluster.MiniHBaseClusterRegionServer.class);
  final MasterThread master=cluster.getMasters().get(0);
  master.start();
  Thread shutdownThread=new Thread(){
    public void run(){
      try {
        TEST_UTIL.getHBaseAdmin().shutdown();
        cluster.waitOnMaster(0);
      }
 catch (      Exception e) {
      }
    }
  }
;
  shutdownThread.start();
  master.join();
  shutdownThread.join();
  List<MasterThread> masterThreads=cluster.getMasters();
  assertEquals(0,masterThreads.size());
  TEST_UTIL.shutdownMiniZKCluster();
  TEST_UTIL.shutdownMiniDFSCluster();
  TEST_UTIL.cleanupTestDir();
}
