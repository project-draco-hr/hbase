{
  Configuration conf=util.getConfiguration();
  conf.setInt("hbase.hstore.compaction.min",2);
  generateRandomStartKeys(5);
  try {
    util.startMiniCluster();
    final FileSystem fs=util.getDFSCluster().getFileSystem();
    HBaseAdmin admin=new HBaseAdmin(conf);
    HTable table=util.createTable(TABLE_NAME,FAMILIES);
    assertEquals("Should start with empty table",0,util.countRows(table));
    final Path storePath=HStore.getStoreHomedir(HTableDescriptor.getTableDir(FSUtils.getRootDir(conf),TABLE_NAME),admin.getTableRegions(TABLE_NAME).get(0),FAMILIES[0]);
    assertEquals(0,fs.listStatus(storePath).length);
    conf.setBoolean("hbase.mapreduce.hfileoutputformat.compaction.exclude",true);
    util.startMiniMapReduceCluster();
    for (int i=0; i < 2; i++) {
      Path testDir=util.getDataTestDirOnTestFS("testExcludeAllFromMinorCompaction_" + i);
      runIncrementalPELoad(conf,table,testDir);
      new LoadIncrementalHFiles(conf).doBulkLoad(testDir,table);
    }
    int expectedRows=2 * NMapInputFormat.getNumMapTasks(conf) * ROWSPERSPLIT;
    assertEquals("LoadIncrementalHFiles should put expected data in table",expectedRows,util.countRows(table));
    assertEquals(2,fs.listStatus(storePath).length);
    admin.compact(TABLE_NAME);
    try {
      quickPoll(new Callable<Boolean>(){
        public Boolean call() throws Exception {
          return fs.listStatus(storePath).length == 1;
        }
      }
,5000);
      throw new IOException("SF# = " + fs.listStatus(storePath).length);
    }
 catch (    AssertionError ae) {
    }
    admin.majorCompact(TABLE_NAME);
    quickPoll(new Callable<Boolean>(){
      public Boolean call() throws Exception {
        return fs.listStatus(storePath).length == 1;
      }
    }
,5000);
  }
  finally {
    util.shutdownMiniMapReduceCluster();
    util.shutdownMiniCluster();
  }
}
