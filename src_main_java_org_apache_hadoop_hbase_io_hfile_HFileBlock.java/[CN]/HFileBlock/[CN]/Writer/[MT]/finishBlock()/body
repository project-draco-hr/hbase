{
  userDataStream.flush();
  uncompressedSizeWithoutHeader=userDataStream.size();
  onDiskBytesWithHeader=baosOnDisk.toByteArray();
  prevOffset=prevOffsetByType[blockType.ordinal()];
  putHeader(onDiskBytesWithHeader,0);
  if (cacheOnWrite && compressAlgo != NONE) {
    uncompressedBytesWithHeader=baosInMemory.toByteArray();
    if (uncompressedSizeWithoutHeader != uncompressedBytesWithHeader.length - HEADER_SIZE) {
      throw new IOException("Uncompressed size mismatch: " + uncompressedSizeWithoutHeader + " vs. "+ (uncompressedBytesWithHeader.length - HEADER_SIZE));
    }
    putHeader(uncompressedBytesWithHeader,0);
  }
}
