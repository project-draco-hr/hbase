{
  userDataStream.flush();
  uncompressedBytesWithHeader=baosInMemory.toByteArray();
  prevOffset=prevOffsetByType[blockType.getId()];
  state=State.BLOCK_READY;
  encodeDataBlockForDisk();
  doCompression();
  putHeader(uncompressedBytesWithHeader,0,onDiskBytesWithHeader.length,uncompressedBytesWithHeader.length);
  if (unencodedDataBlockForCaching != null) {
    unencodedDataBlockForCaching.onDiskSizeWithoutHeader=getOnDiskSizeWithoutHeader();
    unencodedDataBlockForCaching.overwriteHeader();
  }
}
