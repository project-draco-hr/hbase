{
  if (blockType != BlockType.DATA) {
    return;
  }
  ByteBuffer rawKeyValues=ByteBuffer.wrap(uncompressedBytesWithHeader,HEADER_SIZE,uncompressedBytesWithHeader.length - HEADER_SIZE).slice();
  Pair<ByteBuffer,BlockType> encodingResult=dataBlockEncoder.beforeWriteToDisk(rawKeyValues,includesMemstoreTS);
  BlockType encodedBlockType=encodingResult.getSecond();
  if (encodedBlockType == BlockType.ENCODED_DATA) {
    uncompressedBytesWithHeader=encodingResult.getFirst().array();
    blockType=BlockType.ENCODED_DATA;
  }
 else {
    if (encodedBlockType != BlockType.DATA) {
      throw new IOException("Unexpected block type coming out of data " + "block encoder: " + encodedBlockType);
    }
    if (userDataStream.size() != uncompressedBytesWithHeader.length - HEADER_SIZE) {
      throw new IOException("Uncompressed size mismatch: " + userDataStream.size() + " vs. "+ (uncompressedBytesWithHeader.length - HEADER_SIZE));
    }
  }
}
