{
  List<InputSplit> splits=inf.getSplits(job);
  ArrayList<K> samples=new ArrayList<K>(numSamples);
  int splitsToSample=Math.min(maxSplitsSampled,splits.size());
  Random r=new Random();
  long seed=r.nextLong();
  r.setSeed(seed);
  LOG.debug("seed: " + seed);
  for (int i=0; i < splits.size(); ++i) {
    InputSplit tmp=splits.get(i);
    int j=r.nextInt(splits.size());
    splits.set(i,splits.get(j));
    splits.set(j,tmp);
  }
  for (int i=0; i < splitsToSample || (i < splits.size() && samples.size() < numSamples); ++i) {
    TaskAttemptContext samplingContext=new TaskAttemptContext(job.getConfiguration(),new TaskAttemptID());
    RecordReader<K,V> reader=inf.createRecordReader(splits.get(i),samplingContext);
    reader.initialize(splits.get(i),samplingContext);
    while (reader.nextKeyValue()) {
      if (r.nextDouble() <= freq) {
        if (samples.size() < numSamples) {
          samples.add(ReflectionUtils.copy(job.getConfiguration(),reader.getCurrentKey(),null));
        }
 else {
          int ind=r.nextInt(numSamples);
          if (ind != numSamples) {
            samples.set(ind,ReflectionUtils.copy(job.getConfiguration(),reader.getCurrentKey(),null));
          }
          freq*=(numSamples - 1) / (double)numSamples;
        }
      }
    }
    reader.close();
  }
  return (K[])samples.toArray();
}
