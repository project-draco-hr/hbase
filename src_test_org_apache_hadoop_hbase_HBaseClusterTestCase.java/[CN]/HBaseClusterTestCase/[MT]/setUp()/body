{
  try {
    if (startDfs) {
      dfsCluster=new MiniDFSCluster(conf,2,true,(String[])null);
      FileSystem fs=dfsCluster.getFileSystem();
      conf.set("fs.default.name",fs.getUri().toString());
      Path parentdir=fs.getHomeDirectory();
      conf.set(HConstants.HBASE_DIR,parentdir.toString());
      fs.mkdirs(parentdir);
      FSUtils.setVersion(fs,parentdir);
    }
    super.setUp();
    preHBaseClusterSetup();
    HBaseClusterSetup();
    postHBaseClusterSetup();
  }
 catch (  Exception e) {
    LOG.error("Exception in setup!",e);
    if (cluster != null) {
      cluster.shutdown();
    }
    if (dfsCluster != null) {
      shutdownDfs(dfsCluster);
    }
    throw e;
  }
}
