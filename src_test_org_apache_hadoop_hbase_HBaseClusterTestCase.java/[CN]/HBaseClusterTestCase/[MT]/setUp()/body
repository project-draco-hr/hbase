{
  try {
    if (startDfs) {
      dfsCluster=new MiniDFSCluster(conf,2,true,(String[])null);
      FileSystem filesystem=dfsCluster.getFileSystem();
      conf.set("fs.default.name",filesystem.getUri().toString());
      Path parentdir=filesystem.getHomeDirectory();
      conf.set(HConstants.HBASE_DIR,parentdir.toString());
      filesystem.mkdirs(parentdir);
      FSUtils.setVersion(filesystem,parentdir);
    }
    super.setUp();
    preHBaseClusterSetup();
    hBaseClusterSetup();
    postHBaseClusterSetup();
  }
 catch (  Exception e) {
    LOG.error("Exception in setup!",e);
    if (cluster != null) {
      cluster.shutdown();
    }
    if (zooKeeperCluster != null) {
      zooKeeperCluster.shutdown();
    }
    if (dfsCluster != null) {
      shutdownDfs(dfsCluster);
    }
    throw e;
  }
}
