{
  if (isAboveHighWaterMark()) {
    lock.lock();
    try {
      while (isAboveHighWaterMark()) {
        wakeupFlushThread();
        flushOccurred.awaitUninterruptibly();
      }
    }
  finally {
      lock.unlock();
    }
  }
 else   if (isAboveLowWaterMark()) {
    wakeupFlushThread();
  }
}
