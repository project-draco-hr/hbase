{
  if (isAboveHighWaterMark()) {
    lock.lock();
    try {
      while (isAboveHighWaterMark() && !server.isStopped()) {
        wakeupFlushThread();
        try {
          flushOccurred.await(5,TimeUnit.SECONDS);
        }
 catch (        InterruptedException ie) {
          Thread.currentThread().interrupt();
        }
      }
    }
  finally {
      lock.unlock();
    }
  }
 else   if (isAboveLowWaterMark()) {
    wakeupFlushThread();
  }
}
