{
  LOG.info("testPerTableCFReplication");
  ReplicationAdmin replicationAdmin=new ReplicationAdmin(conf1);
  Connection connection1=ConnectionFactory.createConnection(conf1);
  Connection connection2=ConnectionFactory.createConnection(conf2);
  Connection connection3=ConnectionFactory.createConnection(conf3);
  try {
    Admin admin1=connection1.getAdmin();
    Admin admin2=connection2.getAdmin();
    Admin admin3=connection3.getAdmin();
    admin1.createTable(tabA);
    admin1.createTable(tabB);
    admin1.createTable(tabC);
    admin2.createTable(tabA);
    admin2.createTable(tabB);
    admin2.createTable(tabC);
    admin3.createTable(tabA);
    admin3.createTable(tabB);
    admin3.createTable(tabC);
    Table htab1A=connection1.getTable(tabAName);
    Table htab2A=connection2.getTable(tabAName);
    Table htab3A=connection3.getTable(tabAName);
    Table htab1B=connection1.getTable(tabBName);
    Table htab2B=connection2.getTable(tabBName);
    Table htab3B=connection3.getTable(tabBName);
    Table htab1C=connection1.getTable(tabCName);
    Table htab2C=connection2.getTable(tabCName);
    Table htab3C=connection3.getTable(tabCName);
    ReplicationPeerConfig rpc2=new ReplicationPeerConfig();
    rpc2.setClusterKey(utility2.getClusterKey());
    Map<TableName,List<String>> tableCFs=new HashMap<>();
    tableCFs.put(tabCName,null);
    tableCFs.put(tabBName,new ArrayList<String>());
    tableCFs.get(tabBName).add("f1");
    tableCFs.get(tabBName).add("f3");
    replicationAdmin.addPeer("2",rpc2,tableCFs);
    ReplicationPeerConfig rpc3=new ReplicationPeerConfig();
    rpc3.setClusterKey(utility3.getClusterKey());
    tableCFs.clear();
    tableCFs.put(tabAName,null);
    tableCFs.put(tabBName,new ArrayList<String>());
    tableCFs.get(tabBName).add("f1");
    tableCFs.get(tabBName).add("f2");
    replicationAdmin.addPeer("3",rpc3,tableCFs);
    putAndWaitWithFamily(row1,f1Name,htab1A,htab3A);
    ensureRowNotReplicated(row1,f1Name,htab2A);
    deleteAndWaitWithFamily(row1,f1Name,htab1A,htab3A);
    putAndWaitWithFamily(row1,f2Name,htab1A,htab3A);
    ensureRowNotReplicated(row1,f2Name,htab2A);
    deleteAndWaitWithFamily(row1,f2Name,htab1A,htab3A);
    putAndWaitWithFamily(row1,f3Name,htab1A,htab3A);
    ensureRowNotReplicated(row1,f3Name,htab2A);
    deleteAndWaitWithFamily(row1,f3Name,htab1A,htab3A);
    putAndWaitWithFamily(row1,f1Name,htab1B,htab2B,htab3B);
    deleteAndWaitWithFamily(row1,f1Name,htab1B,htab2B,htab3B);
    putAndWaitWithFamily(row1,f2Name,htab1B,htab3B);
    ensureRowNotReplicated(row1,f2Name,htab2B);
    deleteAndWaitWithFamily(row1,f2Name,htab1B,htab3B);
    putAndWaitWithFamily(row1,f3Name,htab1B,htab2B);
    ensureRowNotReplicated(row1,f3Name,htab3B);
    deleteAndWaitWithFamily(row1,f3Name,htab1B,htab2B);
    putAndWaitWithFamily(row1,f1Name,htab1C,htab2C);
    ensureRowNotReplicated(row1,f1Name,htab3C);
    deleteAndWaitWithFamily(row1,f1Name,htab1C,htab2C);
    putAndWaitWithFamily(row1,f2Name,htab1C,htab2C);
    ensureRowNotReplicated(row1,f2Name,htab3C);
    deleteAndWaitWithFamily(row1,f2Name,htab1C,htab2C);
    putAndWaitWithFamily(row1,f3Name,htab1C,htab2C);
    ensureRowNotReplicated(row1,f3Name,htab3C);
    deleteAndWaitWithFamily(row1,f3Name,htab1C,htab2C);
    tableCFs.clear();
    tableCFs.put(tabAName,new ArrayList<String>());
    tableCFs.get(tabAName).add("f1");
    tableCFs.get(tabAName).add("f2");
    tableCFs.put(tabCName,new ArrayList<String>());
    tableCFs.get(tabCName).add("f2");
    tableCFs.get(tabCName).add("f3");
    replicationAdmin.setPeerTableCFs("2",tableCFs);
    tableCFs.clear();
    tableCFs.put(tabBName,null);
    tableCFs.put(tabCName,new ArrayList<String>());
    tableCFs.get(tabCName).add("f3");
    replicationAdmin.setPeerTableCFs("3",tableCFs);
    putAndWaitWithFamily(row2,f1Name,htab1A,htab2A);
    ensureRowNotReplicated(row2,f1Name,htab3A);
    deleteAndWaitWithFamily(row2,f1Name,htab1A,htab2A);
    putAndWaitWithFamily(row2,f2Name,htab1A,htab2A);
    ensureRowNotReplicated(row2,f2Name,htab3A);
    deleteAndWaitWithFamily(row2,f2Name,htab1A,htab2A);
    putAndWaitWithFamily(row2,f3Name,htab1A);
    ensureRowNotReplicated(row2,f3Name,htab2A,htab3A);
    deleteAndWaitWithFamily(row2,f3Name,htab1A);
    putAndWaitWithFamily(row2,f1Name,htab1B,htab3B);
    ensureRowNotReplicated(row2,f1Name,htab2B);
    deleteAndWaitWithFamily(row2,f1Name,htab1B,htab3B);
    putAndWaitWithFamily(row2,f2Name,htab1B,htab3B);
    ensureRowNotReplicated(row2,f2Name,htab2B);
    deleteAndWaitWithFamily(row2,f2Name,htab1B,htab3B);
    putAndWaitWithFamily(row2,f3Name,htab1B,htab3B);
    ensureRowNotReplicated(row2,f3Name,htab2B);
    deleteAndWaitWithFamily(row2,f3Name,htab1B,htab3B);
    putAndWaitWithFamily(row2,f1Name,htab1C);
    ensureRowNotReplicated(row2,f1Name,htab2C,htab3C);
    deleteAndWaitWithFamily(row2,f1Name,htab1C);
    putAndWaitWithFamily(row2,f2Name,htab1C,htab2C);
    ensureRowNotReplicated(row2,f2Name,htab3C);
    deleteAndWaitWithFamily(row2,f2Name,htab1C,htab2C);
    putAndWaitWithFamily(row2,f3Name,htab1C,htab2C,htab3C);
    deleteAndWaitWithFamily(row2,f3Name,htab1C,htab2C,htab3C);
  }
  finally {
    connection1.close();
    connection2.close();
    connection3.close();
  }
}
