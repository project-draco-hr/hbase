{
  if (!shouldCloseConnection.get()) {
    LOG.error("The connection is not in the closed state");
    return;
  }
synchronized (connections) {
    if (connections.get(remoteId) == this) {
      connections.remove(remoteId);
    }
  }
  IOUtils.closeStream(out);
  IOUtils.closeStream(in);
  if (closeException == null) {
    if (!calls.isEmpty()) {
      LOG.warn("A connection is closed for no cause and calls are not empty");
      closeException=new IOException("Unexpected closed connection");
      cleanupCalls();
    }
  }
 else {
    if (LOG.isDebugEnabled()) {
      LOG.debug("closing ipc connection to " + remoteId.address + ": "+ closeException.getMessage(),closeException);
    }
    cleanupCalls();
  }
  if (LOG.isDebugEnabled())   LOG.debug(getName() + ": closed");
}
