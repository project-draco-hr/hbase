{
  HStoreKey searchKey=sk;
  HStoreKey readkey=new HStoreKey();
  ImmutableBytesWritable readval=new ImmutableBytesWritable();
  HStoreKey knownNoGoodKey=null;
  for (boolean foundCandidate=false; !foundCandidate; ) {
    readkey=(HStoreKey)map.getClosest(searchKey,readval,true);
    if (readkey == null) {
      break;
    }
    HStoreKey deletedOrExpiredRow=null;
    do {
      if (Bytes.equals(readkey.getRow(),searchKey.getRow())) {
        if (!HLogEdit.isDeleted(readval.get())) {
          if (ttl == HConstants.FOREVER || now < readkey.getTimestamp() + ttl) {
            candidateKeys.put(stripTimestamp(readkey),new Long(readkey.getTimestamp()));
            foundCandidate=true;
            continue;
          }
          if (LOG.isDebugEnabled()) {
            LOG.debug("rowAtOrBeforeCandidate 1:" + readkey + ": expired, skipped");
          }
        }
        if (deletedOrExpiredRow == null) {
          deletedOrExpiredRow=new HStoreKey(readkey);
        }
      }
 else       if (Bytes.compareTo(readkey.getRow(),searchKey.getRow()) > 0) {
        break;
      }
 else {
        if (!HLogEdit.isDeleted(readval.get())) {
          if (ttl == HConstants.FOREVER || now < readkey.getTimestamp() + ttl) {
            candidateKeys.put(stripTimestamp(readkey),new Long(readkey.getTimestamp()));
            foundCandidate=true;
            continue;
          }
          if (LOG.isDebugEnabled()) {
            LOG.debug("rowAtOrBeforeCandidate 2:" + readkey + ": expired, skipped");
          }
        }
        if (deletedOrExpiredRow == null) {
          deletedOrExpiredRow=new HStoreKey(readkey);
        }
      }
    }
 while (map.next(readkey,readval) && (knownNoGoodKey == null || readkey.compareTo(knownNoGoodKey) < 0));
    if (!foundCandidate && deletedOrExpiredRow != null) {
      knownNoGoodKey=deletedOrExpiredRow;
      searchKey=new BeforeThisStoreKey(deletedOrExpiredRow);
    }
 else {
      break;
    }
  }
}
