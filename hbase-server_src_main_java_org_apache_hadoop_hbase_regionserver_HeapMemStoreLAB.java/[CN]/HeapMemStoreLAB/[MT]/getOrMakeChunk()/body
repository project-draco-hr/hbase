{
  while (true) {
    Chunk c=curChunk.get();
    if (c != null) {
      return c;
    }
    c=(chunkPool != null) ? chunkPool.getChunk() : new Chunk(chunkSize);
    if (curChunk.compareAndSet(null,c)) {
      c.init();
      if (chunkQueue != null && !this.closed && !this.chunkQueue.offer(c)) {
        if (LOG.isTraceEnabled()) {
          LOG.trace("Chunk queue is full, won't reuse this new chunk. Current queue size: " + chunkQueue.size());
        }
      }
      return c;
    }
 else     if (chunkPool != null) {
      chunkPool.putbackChunk(c);
    }
  }
}
