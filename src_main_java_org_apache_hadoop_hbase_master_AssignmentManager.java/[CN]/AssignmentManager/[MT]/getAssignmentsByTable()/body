{
  Map<String,Map<ServerName,List<HRegionInfo>>> result=null;
synchronized (this.regions) {
    result=new HashMap<String,Map<ServerName,List<HRegionInfo>>>();
    if (!this.master.getConfiguration().getBoolean("hbase.master.loadbalance.bytable",true)) {
      result.put("ensemble",getAssignments());
    }
 else {
      for (      Map.Entry<ServerName,Set<HRegionInfo>> e : this.servers.entrySet()) {
        for (        HRegionInfo hri : e.getValue()) {
          if (hri.isMetaRegion() || hri.isRootRegion())           continue;
          String tablename=hri.getTableNameAsString();
          Map<ServerName,List<HRegionInfo>> svrToRegions=result.get(tablename);
          if (svrToRegions == null) {
            svrToRegions=new HashMap<ServerName,List<HRegionInfo>>(this.servers.size());
            result.put(tablename,svrToRegions);
          }
          List<HRegionInfo> regions=null;
          if (!svrToRegions.containsKey(e.getKey())) {
            regions=new ArrayList<HRegionInfo>();
            svrToRegions.put(e.getKey(),regions);
          }
 else {
            regions=svrToRegions.get(e.getKey());
          }
          regions.add(hri);
        }
      }
    }
  }
  Map<ServerName,ServerLoad> onlineSvrs=this.serverManager.getOnlineServers();
  for (  Map<ServerName,List<HRegionInfo>> map : result.values()) {
    for (    Map.Entry<ServerName,ServerLoad> svrEntry : onlineSvrs.entrySet()) {
      if (!map.containsKey(svrEntry.getKey())) {
        map.put(svrEntry.getKey(),new ArrayList<HRegionInfo>());
      }
    }
  }
  return result;
}
