{
  HTable table=TEST_UTIL.createTable(TABLE_NAME2,FAM_NAM);
  TEST_UTIL.createMultiRegions(table,FAM_NAM);
  Put put=new Put(ROW);
  put.add(FAM_NAM,ROW,ROW);
  table.put(put);
  HConnectionManager.HConnectionImplementation conn=(HConnectionManager.HConnectionImplementation)table.getConnection();
  HRegionLocation location=conn.getCachedLocation(TABLE_NAME2,ROW);
  assertNotNull(location);
  HRegionLocation anySource=new HRegionLocation(location.getRegionInfo(),new ServerName(location.getHostname(),location.getPort() - 1,0L));
  int nextPort=location.getPort() + 1;
  conn.updateCachedLocation(location.getRegionInfo(),location,new ServerName("127.0.0.1",nextPort,0),location.getSeqNum() - 1);
  location=conn.getCachedLocation(TABLE_NAME2,ROW);
  Assert.assertEquals(nextPort,location.getPort());
  nextPort=location.getPort() + 1;
  conn.updateCachedLocation(location.getRegionInfo(),location,new ServerName("127.0.0.1",nextPort,0),location.getSeqNum() - 1);
  location=conn.getCachedLocation(TABLE_NAME2,ROW);
  Assert.assertEquals(nextPort,location.getPort());
  nextPort=location.getPort() + 1;
  conn.updateCachedLocation(location.getRegionInfo(),anySource,new ServerName("127.0.0.1",nextPort,0),location.getSeqNum() + 1);
  location=conn.getCachedLocation(TABLE_NAME2,ROW);
  Assert.assertEquals(nextPort,location.getPort());
  nextPort=location.getPort() + 1;
  conn.updateCachedLocation(location.getRegionInfo(),anySource,new ServerName("127.0.0.1",nextPort,0),location.getSeqNum() - 1);
  location=conn.getCachedLocation(TABLE_NAME2,ROW);
  Assert.assertEquals(nextPort - 1,location.getPort());
}
