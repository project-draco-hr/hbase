{
  TableName tableName=TableName.valueOf("HCM-testConnectionIdle");
  TEST_UTIL.createTable(tableName,FAM_NAM).close();
  int idleTime=20000;
  boolean previousBalance=TEST_UTIL.getHBaseAdmin().setBalancerRunning(false,true);
  Configuration c2=new Configuration(TEST_UTIL.getConfiguration());
  c2.set(HConstants.HBASE_CLIENT_INSTANCE_ID,String.valueOf(-1));
  c2.setInt(HConstants.HBASE_CLIENT_RETRIES_NUMBER,1);
  c2.setInt(RpcClient.IDLE_TIME,idleTime);
  final Table table=new HTable(c2,tableName);
  Put put=new Put(ROW);
  put.add(FAM_NAM,ROW,ROW);
  table.put(put);
  ManualEnvironmentEdge mee=new ManualEnvironmentEdge();
  mee.setValue(System.currentTimeMillis());
  EnvironmentEdgeManager.injectEdge(mee);
  LOG.info("first get");
  table.get(new Get(ROW));
  LOG.info("first get - changing the time & sleeping");
  mee.incValue(idleTime + 1000);
  Thread.sleep(1500);
  LOG.info("second get - connection has been marked idle in the middle");
  table.get(new Get(ROW));
  mee.incValue(idleTime + 1000);
  LOG.info("third get - connection is idle, but the reader doesn't know yet");
  table.get(new Get(ROW));
  LOG.info("we're done - time will change back");
  table.close();
  EnvironmentEdgeManager.reset();
  TEST_UTIL.getHBaseAdmin().setBalancerRunning(previousBalance,true);
}
