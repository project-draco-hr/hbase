{
  Map<HConnectionKey,ConnectionImplementation> oldHBaseInstances=new HashMap<HConnectionKey,ConnectionImplementation>();
  oldHBaseInstances.putAll(ConnectionManager.CONNECTION_INSTANCES);
  ConnectionManager.CONNECTION_INSTANCES.clear();
  try {
    HConnection connection=ConnectionManager.getConnection(TEST_UTIL.getConfiguration());
    connection.abort("test abortingHConnectionRemovesItselfFromHCM",new Exception("test abortingHConnectionRemovesItselfFromHCM"));
    Assert.assertNotSame(connection,ConnectionManager.getConnection(TEST_UTIL.getConfiguration()));
  }
  finally {
    ConnectionManager.CONNECTION_INSTANCES.clear();
    ConnectionManager.CONNECTION_INSTANCES.putAll(oldHBaseInstances);
  }
}
