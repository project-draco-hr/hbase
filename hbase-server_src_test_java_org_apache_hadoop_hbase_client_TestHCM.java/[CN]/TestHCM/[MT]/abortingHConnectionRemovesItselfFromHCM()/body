{
  Map<HConnectionKey,HConnectionImplementation> oldHBaseInstances=new HashMap<HConnectionKey,HConnectionImplementation>();
  oldHBaseInstances.putAll(ConnectionManager.CONNECTION_INSTANCES);
  ConnectionManager.CONNECTION_INSTANCES.clear();
  try {
    HConnection connection=HConnectionManager.getConnection(TEST_UTIL.getConfiguration());
    connection.abort("test abortingHConnectionRemovesItselfFromHCM",new Exception("test abortingHConnectionRemovesItselfFromHCM"));
    Assert.assertNotSame(connection,HConnectionManager.getConnection(TEST_UTIL.getConfiguration()));
  }
  finally {
    ConnectionManager.CONNECTION_INSTANCES.clear();
    ConnectionManager.CONNECTION_INSTANCES.putAll(oldHBaseInstances);
  }
}
