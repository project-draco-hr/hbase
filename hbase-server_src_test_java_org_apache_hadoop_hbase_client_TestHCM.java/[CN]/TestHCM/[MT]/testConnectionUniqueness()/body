{
  int zkmaxconnections=TEST_UTIL.getConfiguration().getInt(HConstants.ZOOKEEPER_MAX_CLIENT_CNXNS,HConstants.DEFAULT_ZOOKEPER_MAX_CLIENT_CNXNS);
  int maxConnections=Math.min(zkmaxconnections - 1,20);
  List<HConnection> connections=new ArrayList<HConnection>(maxConnections);
  Connection previousConnection=null;
  try {
    for (int i=0; i < maxConnections; i++) {
      Configuration configuration=new Configuration(TEST_UTIL.getConfiguration());
      configuration.set("some_key",String.valueOf(_randy.nextInt()));
      configuration.set(HConstants.HBASE_CLIENT_INSTANCE_ID,String.valueOf(_randy.nextInt()));
      LOG.info("The hash code of the current configuration is: " + configuration.hashCode());
      HConnection currentConnection=HConnectionManager.getConnection(configuration);
      if (previousConnection != null) {
        assertTrue("Got the same connection even though its key changed!",previousConnection != currentConnection);
      }
      configuration.set("other_key",String.valueOf(_randy.nextInt()));
      previousConnection=currentConnection;
      LOG.info("The current HConnectionManager#HBASE_INSTANCES cache size is: " + getHConnectionManagerCacheSize());
      Thread.sleep(50);
      connections.add(currentConnection);
    }
  }
  finally {
    for (    Connection c : connections) {
      HConnectionManager.deleteConnection(c.getConfiguration());
    }
  }
}
