{
  if (replicatedScanner == null) {
    Configuration conf=context.getConfiguration();
    final Scan scan=new Scan();
    scan.setCaching(conf.getInt(TableInputFormat.SCAN_CACHEDROWS,1));
    long startTime=conf.getLong(NAME + ".startTime",0);
    long endTime=conf.getLong(NAME + ".endTime",Long.MAX_VALUE);
    String families=conf.get(NAME + ".families",null);
    if (families != null) {
      String[] fams=families.split(",");
      for (      String fam : fams) {
        scan.addFamily(Bytes.toBytes(fam));
      }
    }
    scan.setTimeRange(startTime,endTime);
    if (versions >= 0) {
      scan.setMaxVersions(versions);
    }
    final TableSplit tableSplit=(TableSplit)(context.getInputSplit());
    HConnectionManager.execute(new HConnectable<Void>(conf){
      @Override public Void connect(      HConnection conn) throws IOException {
        String zkClusterKey=conf.get(NAME + ".peerQuorumAddress");
        Configuration peerConf=HBaseConfiguration.create(conf);
        ZKUtil.applyClusterKeyToConf(peerConf,zkClusterKey);
        TableName tableName=TableName.valueOf(conf.get(NAME + ".tableName"));
        Table replicatedTable=new HTable(peerConf,tableName);
        scan.setStartRow(value.getRow());
        scan.setStopRow(tableSplit.getEndRow());
        replicatedScanner=replicatedTable.getScanner(scan);
        return null;
      }
    }
);
    currentCompareRowInPeerTable=replicatedScanner.next();
  }
  while (true) {
    if (currentCompareRowInPeerTable == null) {
      logFailRowAndIncreaseCounter(context,Counters.ONLY_IN_SOURCE_TABLE_ROWS,value);
      break;
    }
    int rowCmpRet=Bytes.compareTo(value.getRow(),currentCompareRowInPeerTable.getRow());
    if (rowCmpRet == 0) {
      try {
        Result.compareResults(value,currentCompareRowInPeerTable);
        context.getCounter(Counters.GOODROWS).increment(1);
      }
 catch (      Exception e) {
        logFailRowAndIncreaseCounter(context,Counters.CONTENT_DIFFERENT_ROWS,value);
      }
      currentCompareRowInPeerTable=replicatedScanner.next();
      break;
    }
 else     if (rowCmpRet < 0) {
      logFailRowAndIncreaseCounter(context,Counters.ONLY_IN_SOURCE_TABLE_ROWS,value);
      break;
    }
 else {
      logFailRowAndIncreaseCounter(context,Counters.ONLY_IN_PEER_TABLE_ROWS,currentCompareRowInPeerTable);
      currentCompareRowInPeerTable=replicatedScanner.next();
    }
  }
}
