{
  setupTestEnv();
  shutdown();
  File dir=new File(baseDir,"zookeeper").getAbsoluteFile();
  recreateDir(dir);
  int tickTimeToUse;
  if (this.tickTime > 0) {
    tickTimeToUse=this.tickTime;
  }
 else {
    tickTimeToUse=TICK_TIME;
  }
  ZooKeeperServer server=new ZooKeeperServer(dir,dir,tickTimeToUse);
  while (true) {
    try {
      standaloneServerFactory=new NIOServerCnxn.Factory(clientPort);
    }
 catch (    BindException e) {
      LOG.info("Faild binding ZK Server to client port: " + clientPort);
      clientPort++;
      continue;
    }
    break;
  }
  standaloneServerFactory.startup(server);
  if (!waitForServerUp(clientPort,CONNECTION_TIMEOUT)) {
    throw new IOException("Waiting for startup of standalone server");
  }
  started=true;
  return clientPort;
}
