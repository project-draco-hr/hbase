{
  MiniDFSCluster cluster=null;
  HRegion region=null;
  try {
    cluster=new MiniDFSCluster(conf,2,true,(String[])null);
    this.conf.set(HConstants.HBASE_DIR,cluster.getFileSystem().getHomeDirectory().toString());
    HTableDescriptor desc=new HTableDescriptor("test");
    desc.addFamily(new HColumnDescriptor(CONTENTS));
    desc.addFamily(new HColumnDescriptor(HConstants.COLUMN_FAMILY));
    region=createNewHRegion(desc,null,null);
    HRegionIncommon r=new HRegionIncommon(region);
    BatchUpdate batchUpdate=null;
    batchUpdate=new BatchUpdate(ROW_KEY,System.currentTimeMillis());
    batchUpdate.put(CONTENTS,CONTENTS);
    batchUpdate.put(HConstants.COL_REGIONINFO,Writables.getBytes(HRegionInfo.ROOT_REGIONINFO));
    r.commit(batchUpdate);
    batchUpdate=new BatchUpdate(ROW_KEY,System.currentTimeMillis());
    batchUpdate.put(HConstants.COL_SERVER,Bytes.toBytes(new HServerAddress(SERVER_ADDRESS).toString()));
    batchUpdate.put(HConstants.COL_STARTCODE,Bytes.toBytes(12345));
    batchUpdate.put(new Text(Bytes.toString(HConstants.COLUMN_FAMILY) + "region"),Bytes.toBytes("region"));
    r.commit(batchUpdate);
    verifyGet(r,SERVER_ADDRESS);
    region.close();
    region=openClosedRegion(region);
    r=new HRegionIncommon(region);
    verifyGet(r,SERVER_ADDRESS);
    batchUpdate=new BatchUpdate(ROW_KEY,System.currentTimeMillis());
    batchUpdate.put(new Text(Bytes.toString(HConstants.COLUMN_FAMILY) + "region"),"region2".getBytes(HConstants.UTF8_ENCODING));
    String otherServerName="bar.foo.com:4321";
    batchUpdate.put(HConstants.COL_SERVER,Bytes.toBytes(new HServerAddress(otherServerName).toString()));
    batchUpdate.put(new Text(Bytes.toString(HConstants.COLUMN_FAMILY) + "junk"),"junk".getBytes(HConstants.UTF8_ENCODING));
    r.commit(batchUpdate);
    verifyGet(r,otherServerName);
    region.close();
    region=openClosedRegion(region);
    r=new HRegionIncommon(region);
    verifyGet(r,otherServerName);
  }
  finally {
    if (region != null) {
      region.close();
      region.getLog().closeAndDelete();
    }
    if (cluster != null) {
      shutdownDfs(cluster);
    }
  }
}
