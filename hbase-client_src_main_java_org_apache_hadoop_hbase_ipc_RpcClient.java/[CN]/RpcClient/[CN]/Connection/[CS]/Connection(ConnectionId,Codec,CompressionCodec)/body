{
  if (remoteId.getAddress().isUnresolved()) {
    throw new UnknownHostException("unknown host: " + remoteId.getAddress().getHostName());
  }
  this.server=remoteId.getAddress();
  this.codec=codec;
  this.compressor=compressor;
  UserGroupInformation ticket=remoteId.getTicket().getUGI();
  SecurityInfo securityInfo=SecurityInfo.getInfo(remoteId.getServiceName());
  this.useSasl=userProvider.isHBaseSecurityEnabled();
  if (useSasl && securityInfo != null) {
    AuthenticationProtos.TokenIdentifier.Kind tokenKind=securityInfo.getTokenKind();
    if (tokenKind != null) {
      TokenSelector<? extends TokenIdentifier> tokenSelector=tokenHandlers.get(tokenKind);
      if (tokenSelector != null) {
        token=tokenSelector.selectToken(new Text(clusterId),ticket.getTokens());
      }
 else       if (LOG.isDebugEnabled()) {
        LOG.debug("No token selector found for type " + tokenKind);
      }
    }
    String serverKey=securityInfo.getServerPrincipal();
    if (serverKey == null) {
      throw new IOException("Can't obtain server Kerberos config key from SecurityInfo");
    }
    serverPrincipal=SecurityUtil.getServerPrincipal(conf.get(serverKey),server.getAddress().getCanonicalHostName().toLowerCase());
    if (LOG.isDebugEnabled()) {
      LOG.debug("RPC Server Kerberos principal name for service=" + remoteId.getServiceName() + " is "+ serverPrincipal);
    }
  }
  if (!useSasl) {
    authMethod=AuthMethod.SIMPLE;
  }
 else   if (token != null) {
    authMethod=AuthMethod.DIGEST;
  }
 else {
    authMethod=AuthMethod.KERBEROS;
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Use " + authMethod + " authentication for service "+ remoteId.serviceName+ ", sasl="+ useSasl);
  }
  reloginMaxBackoff=conf.getInt("hbase.security.relogin.maxbackoff",5000);
  this.remoteId=remoteId;
  ConnectionHeader.Builder builder=ConnectionHeader.newBuilder();
  builder.setServiceName(remoteId.getServiceName());
  UserInformation userInfoPB;
  if ((userInfoPB=getUserInfo(ticket)) != null) {
    builder.setUserInfo(userInfoPB);
  }
  if (this.codec != null) {
    builder.setCellBlockCodecClass(this.codec.getClass().getCanonicalName());
  }
  if (this.compressor != null) {
    builder.setCellBlockCompressorClass(this.compressor.getClass().getCanonicalName());
  }
  this.header=builder.build();
  this.setName("IPC Client (" + socketFactory.hashCode() + ") connection to "+ remoteId.getAddress().toString()+ ((ticket == null) ? " from an unknown user" : (" from " + ticket.getUserName())));
  this.setDaemon(true);
  if (conf.getBoolean(ALLOWS_INTERRUPTS,false)) {
    callSender=new CallSender(getName(),conf);
    callSender.start();
  }
 else {
    callSender=null;
  }
}
