{
  try {
    EnvironmentEdgeForMemstoreTest edge=new EnvironmentEdgeForMemstoreTest();
    EnvironmentEdgeManager.injectEdge(edge);
    HBaseTestingUtility hbaseUtility=new HBaseTestingUtility(conf);
    HRegion region=hbaseUtility.createTestRegion("foobar",new HColumnDescriptor("foo"));
    Map<byte[],Store> stores=region.getStores();
    assertTrue(stores.size() == 1);
    Store s=stores.entrySet().iterator().next().getValue();
    edge.setCurrentTimeMillis(1234);
    s.add(KeyValueTestUtil.create("r","f","q",100,"v"));
    edge.setCurrentTimeMillis(1234 + 100);
    assertTrue(region.shouldFlush() == false);
    edge.setCurrentTimeMillis(1234 + 10000);
    assertTrue(region.shouldFlush() == expected);
  }
  finally {
    EnvironmentEdgeManager.reset();
  }
}
