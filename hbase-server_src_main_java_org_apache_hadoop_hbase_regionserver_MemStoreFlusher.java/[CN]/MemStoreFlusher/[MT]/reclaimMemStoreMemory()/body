{
  if (isAboveHighWaterMark()) {
    lock.lock();
    try {
      boolean blocked=false;
      long startTime=0;
      while (isAboveHighWaterMark() && !server.isStopped()) {
        if (!blocked) {
          startTime=EnvironmentEdgeManager.currentTimeMillis();
          LOG.info("Blocking updates on " + server.toString() + ": the global memstore size "+ StringUtils.humanReadableInt(server.getRegionServerAccounting().getGlobalMemstoreSize())+ " is >= than blocking "+ StringUtils.humanReadableInt(globalMemStoreLimit)+ " size");
        }
        blocked=true;
        wakeupFlushThread();
        try {
          flushOccurred.await(5,TimeUnit.SECONDS);
        }
 catch (        InterruptedException ie) {
          Thread.currentThread().interrupt();
        }
      }
      if (blocked) {
        final long totalTime=EnvironmentEdgeManager.currentTimeMillis() - startTime;
        if (totalTime > 0) {
          this.updatesBlockedMsHighWater.add(totalTime);
        }
        LOG.info("Unblocking updates for server " + server.toString());
      }
    }
  finally {
      lock.unlock();
    }
  }
 else   if (isAboveLowWaterMark()) {
    wakeupFlushThread();
  }
}
