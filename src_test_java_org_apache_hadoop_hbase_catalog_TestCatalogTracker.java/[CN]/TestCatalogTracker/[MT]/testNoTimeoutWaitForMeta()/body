{
  final HRegionInterface implementation=Mockito.mock(HRegionInterface.class);
  HConnection connection=mockConnection(implementation,null);
  try {
    final Result result=getMetaTableRowResult();
    Mockito.when(connection.getRegionServerWithRetries((ServerCallable<Result>)Mockito.any())).thenReturn(result);
    Mockito.when(implementation.getRegionInfo((byte[])Mockito.any())).thenReturn(HRegionInfo.FIRST_META_REGIONINFO);
    final CatalogTracker ct=constructAndStartCatalogTracker(connection);
    ServerName hsa=ct.getMetaLocation();
    Assert.assertNull(hsa);
    Thread t=new WaitOnMetaThread(ct){
      @Override void doWaiting() throws InterruptedException {
        this.ct.waitForMeta();
      }
    }
;
    startWaitAliveThenWaitItLives(t,1000);
    String node=ct.getMetaNodeTracker().getNode();
    ZKUtil.createAndFailSilent(this.watcher,node);
    MetaEditor.updateMetaLocation(ct,HRegionInfo.FIRST_META_REGIONINFO,SN);
    ZKUtil.deleteNode(this.watcher,node);
    Assert.assertTrue(ct.waitForMeta(10000).equals(SN));
    t.join();
    Assert.assertTrue(ct.waitForMeta(10000).equals(SN));
  }
  finally {
    HConnectionManager.deleteConnection(UTIL.getConfiguration(),true);
  }
}
