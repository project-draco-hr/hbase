{
  TEST_UTIL.getConfiguration().setInt("hbase.hstore.compaction.min",3);
  String tableName="testAdvancedConfigOverride";
  byte[] TABLE=Bytes.toBytes(tableName);
  HTable hTable=TEST_UTIL.createTable(TABLE,FAMILY,10);
  HBaseAdmin admin=new HBaseAdmin(TEST_UTIL.getConfiguration());
  HConnection connection=HConnectionManager.getConnection(TEST_UTIL.getConfiguration());
  byte[] row=Bytes.toBytes(random.nextInt());
  performMultiplePutAndFlush(admin,hTable,row,FAMILY,3,100);
  HRegionLocation loc=hTable.getRegionLocation(row,true);
  byte[] regionName=loc.getRegionInfo().getRegionName();
  AdminProtocol server=connection.getAdmin(loc.getHostname(),loc.getPort());
  assertTrue(ProtobufUtil.getStoreFiles(server,regionName,FAMILY).size() > 1);
  admin.compact(TABLE);
  for (int i=0; i < 10 * 1000 / 40; ++i) {
    loc=hTable.getRegionLocation(row,true);
    if (!loc.getRegionInfo().isOffline()) {
      regionName=loc.getRegionInfo().getRegionName();
      server=connection.getAdmin(loc.getHostname(),loc.getPort());
      if (ProtobufUtil.getStoreFiles(server,regionName,FAMILY).size() <= 1) {
        break;
      }
    }
    Thread.sleep(40);
  }
  assertTrue(ProtobufUtil.getStoreFiles(server,regionName,FAMILY).size() <= 1);
  LOG.info("hbase.hstore.compaction.min should now be 5");
  HTableDescriptor htd=new HTableDescriptor(hTable.getTableDescriptor());
  htd.setValue("hbase.hstore.compaction.min",String.valueOf(5));
  admin.modifyTable(TABLE,htd);
  Pair<Integer,Integer> st;
  while (null != (st=admin.getAlterStatus(TABLE)) && st.getFirst() > 0) {
    LOG.debug(st.getFirst() + " regions left to update");
    Thread.sleep(40);
  }
  LOG.info("alter status finished");
  performMultiplePutAndFlush(admin,hTable,row,FAMILY,3,10);
  admin.compact(TABLE);
  Thread.sleep(10 * 1000);
  loc=hTable.getRegionLocation(row,true);
  regionName=loc.getRegionInfo().getRegionName();
  server=connection.getAdmin(loc.getHostname(),loc.getPort());
  int sfCount=ProtobufUtil.getStoreFiles(server,regionName,FAMILY).size();
  assertTrue(sfCount > 1);
  LOG.info("hbase.hstore.compaction.min should now be 2");
  HColumnDescriptor hcd=new HColumnDescriptor(htd.getFamily(FAMILY));
  hcd.setValue("hbase.hstore.compaction.min",String.valueOf(2));
  htd.addFamily(hcd);
  admin.modifyTable(TABLE,htd);
  while (null != (st=admin.getAlterStatus(TABLE)) && st.getFirst() > 0) {
    LOG.debug(st.getFirst() + " regions left to update");
    Thread.sleep(40);
  }
  LOG.info("alter status finished");
  admin.compact(TABLE);
  for (int i=0; i < 10 * 1000 / 40; ++i) {
    loc=hTable.getRegionLocation(row,true);
    regionName=loc.getRegionInfo().getRegionName();
    try {
      server=connection.getAdmin(loc.getHostname(),loc.getPort());
      if (ProtobufUtil.getStoreFiles(server,regionName,FAMILY).size() < sfCount) {
        break;
      }
    }
 catch (    Exception e) {
      LOG.debug("Waiting for region to come online: " + regionName);
    }
    Thread.sleep(40);
  }
  assertTrue(ProtobufUtil.getStoreFiles(server,regionName,FAMILY).size() < sfCount);
  LOG.info("Removing CF config value");
  LOG.info("hbase.hstore.compaction.min should now be 5");
  hcd=new HColumnDescriptor(htd.getFamily(FAMILY));
  hcd.setValue("hbase.hstore.compaction.min",null);
  htd.addFamily(hcd);
  admin.modifyTable(TABLE,htd);
  while (null != (st=admin.getAlterStatus(TABLE)) && st.getFirst() > 0) {
    LOG.debug(st.getFirst() + " regions left to update");
    Thread.sleep(40);
  }
  LOG.info("alter status finished");
  assertNull(hTable.getTableDescriptor().getFamily(FAMILY).getValue("hbase.hstore.compaction.min"));
}
