{
  int rowUpperLimit=rowLimit > 0 ? rowLimit : Integer.MAX_VALUE;
  HConnection connection=HConnectionManager.getConnection(configuration);
  byte[] startRow=tableName == null || tableName.length == 0 ? HConstants.EMPTY_START_ROW : HRegionInfo.createRegionName(tableName,row,HConstants.ZEROES,false);
  if (row != null) {
    HTable metaTable=new HTable(configuration,HConstants.META_TABLE_NAME);
    Result startRowResult=metaTable.getRowOrBefore(startRow,HConstants.CATALOG_FAMILY);
    if (startRowResult == null) {
      throw new TableNotFoundException("Cannot find row in .META. for table: " + Bytes.toString(tableName) + ", row="+ Bytes.toString(startRow));
    }
    byte[] value=startRowResult.getValue(HConstants.CATALOG_FAMILY,HConstants.REGIONINFO_QUALIFIER);
    if (value == null || value.length == 0) {
      throw new IOException("HRegionInfo was null or empty in Meta for " + Bytes.toString(tableName) + ", row="+ Bytes.toString(startRow));
    }
    HRegionInfo regionInfo=Writables.getHRegionInfo(value);
    byte[] rowBefore=regionInfo.getStartKey();
    startRow=HRegionInfo.createRegionName(tableName,rowBefore,HConstants.ZEROES,false);
  }
  ScannerCallable callable;
  int rows=Math.min(rowLimit,configuration.getInt("hbase.meta.scanner.caching",100));
  do {
    final Scan scan=new Scan(startRow).addFamily(HConstants.CATALOG_FAMILY);
    callable=new ScannerCallable(connection,HConstants.META_TABLE_NAME,scan);
    connection.getRegionServerWithRetries(callable);
    int processedRows=0;
    try {
      callable.setCaching(rows);
      done:       do {
        if (processedRows >= rowUpperLimit) {
          break;
        }
        Result[] rrs=connection.getRegionServerWithRetries(callable);
        if (rrs == null || rrs.length == 0 || rrs[0].size() == 0) {
          break;
        }
        for (        Result rr : rrs) {
          if (processedRows >= rowUpperLimit) {
            break done;
          }
          if (!visitor.processRow(rr))           break done;
          processedRows++;
        }
      }
 while (true);
      startRow=callable.getHRegionInfo().getEndKey();
    }
  finally {
      callable.setClose();
      connection.getRegionServerWithRetries(callable);
    }
  }
 while (Bytes.compareTo(startRow,HConstants.LAST_ROW) != 0);
}
