{
  if (key.getClass() != keyClass)   throw new IOException("wrong key class: " + key.getClass().getName() + " is not "+ keyClass);
  if (val.getClass() != valClass)   throw new IOException("wrong value class: " + val.getClass().getName() + " is not "+ valClass);
  buffer.reset();
  keySerializer.serialize(key);
  int keyLength=buffer.getLength();
  if (keyLength < 0)   throw new IOException("negative length keys not allowed: " + key);
  deflateFilter.resetState();
  compressedValSerializer.serialize(val);
  deflateOut.flush();
  deflateFilter.finish();
  checkAndWriteSync();
  out.writeInt(buffer.getLength());
  out.writeInt(keyLength);
  out.write(buffer.getData(),0,buffer.getLength());
}
