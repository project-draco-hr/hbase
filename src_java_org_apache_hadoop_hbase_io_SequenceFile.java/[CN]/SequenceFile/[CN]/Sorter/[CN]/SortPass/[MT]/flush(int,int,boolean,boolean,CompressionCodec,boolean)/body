{
  if (out == null) {
    outName=done ? outFile : outFile.suffix(".0");
    out=fs.create(outName);
    if (!done) {
      indexOut=fs.create(outName.suffix(".index"));
    }
  }
  long segmentStart=out.getPos();
  Writer writer=createWriter(conf,out,keyClass,valClass,isCompressed,isBlockCompressed,codec,new Metadata());
  if (!done) {
    writer.sync=null;
  }
  for (int i=0; i < count; i++) {
    int p=pointers[i];
    writer.appendRaw(rawBuffer,keyOffsets[p],keyLengths[p],rawValues[p]);
  }
  writer.close();
  if (!done) {
    WritableUtils.writeVLong(indexOut,segmentStart);
    WritableUtils.writeVLong(indexOut,(out.getPos() - segmentStart));
    indexOut.flush();
  }
}
