{
  byte[] b1="testUseRegionWithReplica".getBytes();
  openRegion(hriSecondary);
  try {
    Put p=new Put(b1);
    p.add(f,b1,b1);
    table.put(p);
    LOG.info("Put done");
    Get g=new Get(b1);
    Result r=table.get(g);
    Assert.assertFalse(r.isStale());
    Assert.assertFalse(r.getColumnCells(f,b1).isEmpty());
    LOG.info("get works and is not stale done");
    SlowMeCopro.sleepTime.set(2000);
    g=new Get(b1);
    r=table.get(g);
    Assert.assertFalse(r.isStale());
    Assert.assertFalse(r.getColumnCells(f,b1).isEmpty());
    SlowMeCopro.sleepTime.set(0);
    LOG.info("sleep and is not stale done");
    SlowMeCopro.cdl.set(new CountDownLatch(1));
    g=new Get(b1);
    g.setConsistency(Consistency.TIMELINE);
    r=table.get(g);
    Assert.assertTrue(r.isStale());
    Assert.assertTrue(r.getColumnCells(f,b1).isEmpty());
    SlowMeCopro.cdl.get().countDown();
    LOG.info("stale done");
    g=new Get(b1);
    g.setCheckExistenceOnly(true);
    r=table.get(g);
    Assert.assertFalse(r.isStale());
    Assert.assertTrue(r.getExists());
    LOG.info("exists not stale done");
    SlowMeCopro.cdl.set(new CountDownLatch(1));
    g=new Get(b1);
    g.setCheckExistenceOnly(true);
    g.setConsistency(Consistency.TIMELINE);
    r=table.get(g);
    Assert.assertTrue(r.isStale());
    Assert.assertFalse("The secondary has stale data",r.getExists());
    SlowMeCopro.cdl.get().countDown();
    LOG.info("exists stale before flush done");
    flushRegion(hriPrimary);
    flushRegion(hriSecondary);
    LOG.info("flush done");
    Thread.sleep(1000 + REFRESH_PERIOD * 2);
    SlowMeCopro.cdl.set(new CountDownLatch(1));
    g=new Get(b1);
    g.setConsistency(Consistency.TIMELINE);
    r=table.get(g);
    Assert.assertTrue(r.isStale());
    Assert.assertFalse(r.isEmpty());
    SlowMeCopro.cdl.get().countDown();
    LOG.info("stale done");
    SlowMeCopro.cdl.set(new CountDownLatch(1));
    g=new Get(b1);
    g.setCheckExistenceOnly(true);
    g.setConsistency(Consistency.TIMELINE);
    r=table.get(g);
    Assert.assertTrue(r.isStale());
    Assert.assertTrue(r.getExists());
    SlowMeCopro.cdl.get().countDown();
    LOG.info("exists stale after flush done");
  }
  finally {
    SlowMeCopro.cdl.get().countDown();
    SlowMeCopro.sleepTime.set(0);
    Delete d=new Delete(b1);
    table.delete(d);
    closeRegion(hriSecondary);
  }
}
