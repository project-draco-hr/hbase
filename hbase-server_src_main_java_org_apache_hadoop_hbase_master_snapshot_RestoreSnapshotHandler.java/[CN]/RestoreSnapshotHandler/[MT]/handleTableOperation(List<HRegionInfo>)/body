{
  MasterFileSystem fileSystemManager=masterServices.getMasterFileSystem();
  Connection conn=masterServices.getConnection();
  FileSystem fs=fileSystemManager.getFileSystem();
  Path rootDir=fileSystemManager.getRootDir();
  TableName tableName=hTableDescriptor.getTableName();
  try {
    this.masterServices.getTableDescriptors().add(hTableDescriptor);
    LOG.debug("Starting restore snapshot=" + ClientSnapshotDescriptionUtils.toString(snapshot));
    Path snapshotDir=SnapshotDescriptionUtils.getCompletedSnapshotDir(snapshot,rootDir);
    SnapshotManifest manifest=SnapshotManifest.open(masterServices.getConfiguration(),fs,snapshotDir,snapshot);
    RestoreSnapshotHelper restoreHelper=new RestoreSnapshotHelper(masterServices.getConfiguration(),fs,manifest,this.hTableDescriptor,rootDir,monitor,status);
    RestoreSnapshotHelper.RestoreMetaChanges metaChanges=restoreHelper.restoreHdfsRegions();
    forceRegionsOffline(metaChanges);
    status.setStatus("Preparing to restore each region");
    List<HRegionInfo> hrisToRemove=new LinkedList<HRegionInfo>();
    if (metaChanges.hasRegionsToRemove())     hrisToRemove.addAll(metaChanges.getRegionsToRemove());
    MetaTableAccessor.deleteRegions(conn,hrisToRemove);
    hris.clear();
    if (metaChanges.hasRegionsToAdd())     hris.addAll(metaChanges.getRegionsToAdd());
    MetaTableAccessor.addRegionsToMeta(conn,hris);
    if (metaChanges.hasRegionsToRestore()) {
      MetaTableAccessor.overwriteRegions(conn,metaChanges.getRegionsToRestore());
    }
    metaChanges.updateMetaParentRegions(this.server.getConnection(),hris);
    LOG.info("Restore snapshot=" + ClientSnapshotDescriptionUtils.toString(snapshot) + " on table="+ tableName+ " completed!");
  }
 catch (  IOException e) {
    String msg="restore snapshot=" + ClientSnapshotDescriptionUtils.toString(snapshot) + " failed. Try re-running the restore command.";
    LOG.error(msg,e);
    monitor.receive(new ForeignException(masterServices.getServerName().toString(),e));
    throw new RestoreSnapshotException(msg,e);
  }
}
