{
  long capacityNeeded=buf.position() + (long)extra;
  if (capacityNeeded > buf.limit()) {
    if (capacityNeeded > MAX_ARRAY_SIZE) {
      throw new BufferOverflowException();
    }
    long nextCapacity=Math.min(buf.capacity() * 2L,MAX_ARRAY_SIZE);
    nextCapacity=Math.max(nextCapacity,capacityNeeded);
    ByteBuffer newBuf=allocate((int)nextCapacity,buf.isDirect());
    buf.flip();
    ByteBufferUtils.copyFromBufferToBuffer(buf,newBuf);
    buf=newBuf;
  }
}
