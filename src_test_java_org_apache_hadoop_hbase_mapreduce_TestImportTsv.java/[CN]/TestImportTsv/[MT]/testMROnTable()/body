{
  String TABLE_NAME="TestTable";
  String FAMILY="FAM";
  String INPUT_FILE="InputFile.esv";
  String[] args=new String[]{"-D" + ImportTsv.COLUMNS_CONF_KEY + "=HBASE_ROW_KEY,FAM:A,FAM:B","-D" + ImportTsv.SEPARATOR_CONF_KEY + "=\u001b",TABLE_NAME,INPUT_FILE};
  HBaseTestingUtility htu1=new HBaseTestingUtility();
  MiniHBaseCluster cluster=htu1.startMiniCluster();
  GenericOptionsParser opts=new GenericOptionsParser(cluster.getConfiguration(),args);
  Configuration conf=opts.getConfiguration();
  args=opts.getRemainingArgs();
  try {
    FileSystem fs=FileSystem.get(conf);
    FSDataOutputStream op=fs.create(new Path(INPUT_FILE),true);
    String line="KEY\u001bVALUE1\u001bVALUE2\n";
    op.write(line.getBytes(HConstants.UTF8_ENCODING));
    op.close();
    final byte[] FAM=Bytes.toBytes(FAMILY);
    final byte[] TAB=Bytes.toBytes(TABLE_NAME);
    final byte[] QA=Bytes.toBytes("A");
    final byte[] QB=Bytes.toBytes("B");
    HTableDescriptor desc=new HTableDescriptor(TAB);
    desc.addFamily(new HColumnDescriptor(FAM));
    new HBaseAdmin(conf).createTable(desc);
    Job job=ImportTsv.createSubmittableJob(conf,args);
    job.waitForCompletion(false);
    assertTrue(job.isSuccessful());
    HTable table=new HTable(new Configuration(conf),TAB);
    boolean verified=false;
    long pause=conf.getLong("hbase.client.pause",5 * 1000);
    int numRetries=conf.getInt("hbase.client.retries.number",5);
    for (int i=0; i < numRetries; i++) {
      try {
        Scan scan=new Scan();
        scan.addFamily(FAM);
        ResultScanner resScanner=table.getScanner(scan);
        for (        Result res : resScanner) {
          assertTrue(res.size() == 2);
          List<KeyValue> kvs=res.list();
          assertEquals(toU8Str(kvs.get(0).getRow()),toU8Str(Bytes.toBytes("KEY")));
          assertEquals(toU8Str(kvs.get(1).getRow()),toU8Str(Bytes.toBytes("KEY")));
          assertEquals(toU8Str(kvs.get(0).getValue()),toU8Str(Bytes.toBytes("VALUE1")));
          assertEquals(toU8Str(kvs.get(1).getValue()),toU8Str(Bytes.toBytes("VALUE2")));
        }
        verified=true;
        break;
      }
 catch (      NullPointerException e) {
      }
      try {
        Thread.sleep(pause);
      }
 catch (      InterruptedException e) {
      }
    }
    assertTrue(verified);
  }
  finally {
    cluster.shutdown();
  }
}
