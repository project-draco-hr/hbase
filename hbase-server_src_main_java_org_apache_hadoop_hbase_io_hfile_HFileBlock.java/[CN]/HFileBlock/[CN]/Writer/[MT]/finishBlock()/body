{
  userDataStream.flush();
  uncompressedBytesWithHeader=baosInMemory.toByteArray();
  prevOffset=prevOffsetByType[blockType.getId()];
  state=State.BLOCK_READY;
  if (blockType == BlockType.DATA) {
    encodeDataBlockForDisk();
  }
 else {
    defaultBlockEncodingCtx.compressAfterEncoding(uncompressedBytesWithHeader,blockType);
    onDiskBytesWithHeader=defaultBlockEncodingCtx.getOnDiskBytesWithHeader();
  }
  int numBytes=(int)ChecksumUtil.numBytes(onDiskBytesWithHeader.length,bytesPerChecksum);
  putHeader(onDiskBytesWithHeader,0,onDiskBytesWithHeader.length + numBytes,uncompressedBytesWithHeader.length,onDiskBytesWithHeader.length);
  putHeader(uncompressedBytesWithHeader,0,onDiskBytesWithHeader.length + numBytes,uncompressedBytesWithHeader.length,onDiskBytesWithHeader.length);
  onDiskChecksum=new byte[numBytes];
  ChecksumUtil.generateChecksums(onDiskBytesWithHeader,0,onDiskBytesWithHeader.length,onDiskChecksum,0,checksumType,bytesPerChecksum);
}
