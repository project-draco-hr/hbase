{
  if (allowCustom && (logReaderClass == null)) {
    logReaderClass=conf.getClass("hbase.regionserver.hlog.reader.impl",ProtobufLogReader.class,Reader.class);
  }
  Class<? extends Reader> lrClass=allowCustom ? logReaderClass : ProtobufLogReader.class;
  try {
    long startWaiting=EnvironmentEdgeManager.currentTimeMillis();
    long openTimeout=conf.getInt("hbase.hlog.open.timeout",300000) + startWaiting;
    int nbAttempt=0;
    while (true) {
      try {
        if (lrClass != ProtobufLogReader.class) {
          HLog.Reader reader=lrClass.newInstance();
          reader.init(fs,path,conf,null);
          return reader;
        }
 else {
          FSDataInputStream stream=fs.open(path);
          byte[] magic=new byte[ProtobufLogReader.PB_WAL_MAGIC.length];
          boolean isPbWal=(stream.read(magic) == magic.length) && Arrays.equals(magic,ProtobufLogReader.PB_WAL_MAGIC);
          HLog.Reader reader=isPbWal ? new ProtobufLogReader() : new SequenceFileLogReader();
          reader.init(fs,path,conf,stream);
          return reader;
        }
      }
 catch (      IOException e) {
        String msg=e.getMessage();
        if (msg != null && msg.contains("Cannot obtain block length")) {
          if (++nbAttempt == 1) {
            LOG.warn("Lease should have recovered. This is not expected. Will retry",e);
          }
          if (reporter != null && !reporter.progress()) {
            throw new InterruptedIOException("Operation is cancelled");
          }
          if (nbAttempt > 2 && openTimeout < EnvironmentEdgeManager.currentTimeMillis()) {
            LOG.error("Can't open after " + nbAttempt + " attempts and "+ (EnvironmentEdgeManager.currentTimeMillis() - startWaiting)+ "ms "+ " for "+ path);
          }
 else {
            try {
              Thread.sleep(nbAttempt < 3 ? 500 : 1000);
              continue;
            }
 catch (            InterruptedException ie) {
              InterruptedIOException iioe=new InterruptedIOException();
              iioe.initCause(ie);
              throw iioe;
            }
          }
        }
        throw e;
      }
    }
  }
 catch (  IOException ie) {
    throw ie;
  }
catch (  Exception e) {
    throw new IOException("Cannot get log reader",e);
  }
}
