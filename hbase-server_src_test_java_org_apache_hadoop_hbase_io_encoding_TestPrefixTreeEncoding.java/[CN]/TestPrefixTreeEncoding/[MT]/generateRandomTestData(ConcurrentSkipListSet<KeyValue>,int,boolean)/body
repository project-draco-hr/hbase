{
  ByteArrayOutputStream baosInMemory=new ByteArrayOutputStream();
  DataOutputStream userDataStream=new DataOutputStream(baosInMemory);
  Random random=new Random();
  for (int i=0; i < NUM_ROWS_PER_BATCH; ++i) {
    if (random.nextInt(100) < 50)     continue;
    for (int j=0; j < NUM_COLS_PER_ROW; ++j) {
      if (random.nextInt(100) < 50)       continue;
      if (!useTags) {
        KeyValue kv=new KeyValue(getRowKey(batchId,i),CF_BYTES,getQualifier(j),getValue(batchId,i,j));
        kvset.add(kv);
      }
 else {
        KeyValue kv=new KeyValue(getRowKey(batchId,i),CF_BYTES,getQualifier(j),0l,getValue(batchId,i,j),new Tag[]{new Tag((byte)1,"metaValue1")});
        kvset.add(kv);
      }
    }
  }
  for (  KeyValue kv : kvset) {
    userDataStream.writeInt(kv.getKeyLength());
    userDataStream.writeInt(kv.getValueLength());
    userDataStream.write(kv.getBuffer(),kv.getKeyOffset(),kv.getKeyLength());
    userDataStream.write(kv.getBuffer(),kv.getValueOffset(),kv.getValueLength());
    if (useTags) {
      userDataStream.writeShort(kv.getTagsLength());
      userDataStream.write(kv.getBuffer(),kv.getValueOffset() + kv.getValueLength() + Bytes.SIZEOF_SHORT,kv.getTagsLength());
    }
  }
  return ByteBuffer.wrap(baosInMemory.toByteArray());
}
