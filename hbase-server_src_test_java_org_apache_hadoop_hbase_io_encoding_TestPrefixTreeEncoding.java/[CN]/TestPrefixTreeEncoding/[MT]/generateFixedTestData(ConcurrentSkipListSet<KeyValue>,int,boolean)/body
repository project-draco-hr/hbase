{
  ByteArrayOutputStream baosInMemory=new ByteArrayOutputStream();
  DataOutputStream userDataStream=new DataOutputStream(baosInMemory);
  for (int i=0; i < NUM_ROWS_PER_BATCH; ++i) {
    if (partial && i / 10 % 2 == 1)     continue;
    for (int j=0; j < NUM_COLS_PER_ROW; ++j) {
      KeyValue kv=new KeyValue(getRowKey(batchId,i),CF_BYTES,getQualifier(j),getValue(batchId,i,j));
      kvset.add(kv);
    }
  }
  for (  KeyValue kv : kvset) {
    userDataStream.writeInt(kv.getKeyLength());
    userDataStream.writeInt(kv.getValueLength());
    userDataStream.write(kv.getBuffer(),kv.getKeyOffset(),kv.getKeyLength());
    userDataStream.write(kv.getBuffer(),kv.getValueOffset(),kv.getValueLength());
  }
  return ByteBuffer.wrap(baosInMemory.toByteArray());
}
