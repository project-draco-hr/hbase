{
  SoftSortedMap<Text,HRegionLocation> tableLocations=cachedRegionLocations.get(tableName);
  if (tableLocations == null) {
    tableLocations=new SoftSortedMap<Text,HRegionLocation>();
    cachedRegionLocations.put(tableName,tableLocations);
  }
  if (!tableLocations.isEmpty()) {
    if (tableLocations.containsKey(row)) {
      HRegionLocation rl=tableLocations.get(row);
      if (rl != null && LOG.isDebugEnabled()) {
        LOG.debug("Cache hit in table locations for row <" + row + "> and tableName "+ tableName+ ": location server "+ rl.getServerAddress()+ ", location region name "+ rl.getRegionInfo().getRegionName());
      }
      return rl;
    }
    SoftSortedMap<Text,HRegionLocation> matchingRegions=tableLocations.headMap(row);
    if (!matchingRegions.isEmpty()) {
      HRegionLocation possibleRegion=matchingRegions.get(matchingRegions.lastKey());
      if (possibleRegion != null) {
        Text endKey=possibleRegion.getRegionInfo().getEndKey();
        if (endKey.equals(EMPTY_TEXT) || endKey.compareTo(row) > 0) {
          if (LOG.isDebugEnabled()) {
            LOG.debug("Found possible location for " + row + ", "+ possibleRegion);
          }
          return possibleRegion;
        }
      }
    }
  }
  return null;
}
