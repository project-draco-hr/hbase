{
  HRegionLocation location=null;
  if (useCache) {
    location=getCachedLocation(tableName,row);
    if (location != null) {
      return location;
    }
  }
 else {
    deleteCachedLocation(tableName,row);
  }
  byte[] metaKey=HRegionInfo.createRegionName(tableName,row,HConstants.NINES);
  for (int tries=0; true; tries++) {
    if (tries >= numRetries) {
      throw new NoServerForRegionException("Unable to find region for " + Bytes.toString(row) + " after "+ numRetries+ " tries.");
    }
    try {
      HRegionLocation metaLocation=locateRegion(parentTable,metaKey);
      HRegionInterface server=getHRegionConnection(metaLocation.getServerAddress());
      Result regionInfoRow=server.getClosestRowBefore(metaLocation.getRegionInfo().getRegionName(),metaKey,HConstants.CATALOG_FAMILY);
      if (regionInfoRow == null) {
        throw new TableNotFoundException(Bytes.toString(tableName));
      }
      byte[] value=regionInfoRow.getValue(CATALOG_FAMILY,REGIONINFO_QUALIFIER);
      if (value == null || value.length == 0) {
        throw new IOException("HRegionInfo was null or empty in " + Bytes.toString(parentTable));
      }
      HRegionInfo regionInfo=(HRegionInfo)Writables.getWritable(value,new HRegionInfo());
      if (!Bytes.equals(regionInfo.getTableDesc().getName(),tableName)) {
        throw new TableNotFoundException("Table '" + Bytes.toString(tableName) + "' was not found.");
      }
      if (regionInfo.isOffline()) {
        throw new RegionOfflineException("region offline: " + regionInfo.getRegionNameAsString());
      }
      value=regionInfoRow.getValue(CATALOG_FAMILY,SERVER_QUALIFIER);
      String serverAddress="";
      if (value != null) {
        serverAddress=Bytes.toString(value);
      }
      if (serverAddress.equals("")) {
        throw new NoServerForRegionException("No server address listed " + "in " + Bytes.toString(parentTable) + " for region "+ regionInfo.getRegionNameAsString());
      }
      location=new HRegionLocation(regionInfo,new HServerAddress(serverAddress));
      LOG.debug(location);
      cacheLocation(tableName,location);
      return location;
    }
 catch (    TableNotFoundException e) {
      throw e;
    }
catch (    IOException e) {
      if (e instanceof RemoteException) {
        e=RemoteExceptionHandler.decodeRemoteException((RemoteException)e);
      }
      if (tries < numRetries - 1) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("locateRegionInMeta attempt " + tries + " of "+ this.numRetries+ " failed; retrying after sleep of "+ getPauseTime(tries),e);
        }
        relocateRegion(parentTable,metaKey);
      }
 else {
        throw e;
      }
    }
    try {
      Thread.sleep(getPauseTime(tries));
    }
 catch (    InterruptedException e) {
    }
  }
}
