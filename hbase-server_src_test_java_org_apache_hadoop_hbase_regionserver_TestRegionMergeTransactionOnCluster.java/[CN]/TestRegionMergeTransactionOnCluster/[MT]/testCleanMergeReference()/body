{
  LOG.info("Starting testCleanMergeReference");
  admin.enableCatalogJanitor(false);
  try {
    final TableName tableName=TableName.valueOf("testCleanMergeReference");
    Table table=createTableAndLoadData(master,tableName);
    mergeRegionsAndVerifyRegionNum(master,tableName,0,1,INITIAL_REGION_NUM - 1);
    verifyRowCount(table,ROWSIZE);
    table.close();
    List<Pair<HRegionInfo,ServerName>> tableRegions=MetaTableAccessor.getTableRegionsAndLocations(master.getShortCircuitConnection(),tableName);
    HRegionInfo mergedRegionInfo=tableRegions.get(0).getFirst();
    HTableDescriptor tableDescritor=master.getTableDescriptors().get(tableName);
    Result mergedRegionResult=MetaTableAccessor.getRegionResult(master.getShortCircuitConnection(),mergedRegionInfo.getRegionName());
    assertTrue(mergedRegionResult.getValue(HConstants.CATALOG_FAMILY,HConstants.MERGEA_QUALIFIER) != null);
    assertTrue(mergedRegionResult.getValue(HConstants.CATALOG_FAMILY,HConstants.MERGEB_QUALIFIER) != null);
    HRegionInfo regionA=HRegionInfo.getHRegionInfo(mergedRegionResult,HConstants.MERGEA_QUALIFIER);
    HRegionInfo regionB=HRegionInfo.getHRegionInfo(mergedRegionResult,HConstants.MERGEB_QUALIFIER);
    FileSystem fs=master.getMasterFileSystem().getFileSystem();
    Path rootDir=master.getMasterFileSystem().getRootDir();
    Path tabledir=FSUtils.getTableDir(rootDir,mergedRegionInfo.getTable());
    Path regionAdir=new Path(tabledir,regionA.getEncodedName());
    Path regionBdir=new Path(tabledir,regionB.getEncodedName());
    assertTrue(fs.exists(regionAdir));
    assertTrue(fs.exists(regionBdir));
    admin.compactRegion(mergedRegionInfo.getRegionName());
    long timeout=System.currentTimeMillis() + waitTime;
    HRegionFileSystem hrfs=new HRegionFileSystem(TEST_UTIL.getConfiguration(),fs,tabledir,mergedRegionInfo);
    while (System.currentTimeMillis() < timeout) {
      if (!hrfs.hasReferences(tableDescritor)) {
        break;
      }
      Thread.sleep(50);
    }
    assertFalse(hrfs.hasReferences(tableDescritor));
    int cleaned=admin.runCatalogScan();
    assertTrue(cleaned > 0);
    assertFalse(fs.exists(regionAdir));
    assertFalse(fs.exists(regionBdir));
    mergedRegionResult=MetaTableAccessor.getRegionResult(master.getShortCircuitConnection(),mergedRegionInfo.getRegionName());
    assertFalse(mergedRegionResult.getValue(HConstants.CATALOG_FAMILY,HConstants.MERGEA_QUALIFIER) != null);
    assertFalse(mergedRegionResult.getValue(HConstants.CATALOG_FAMILY,HConstants.MERGEB_QUALIFIER) != null);
  }
  finally {
    admin.enableCatalogJanitor(true);
  }
}
