{
  if (this.isError)   return;
  if (t != null)   this.isError=true;
  BufferChain bc=null;
  try {
    ResponseHeader.Builder headerBuilder=ResponseHeader.newBuilder();
    Message result=(Message)m;
    headerBuilder.setCallId(this.id);
    if (t != null) {
      setExceptionResponse(t,errorMsg,headerBuilder);
    }
    List<ByteBuffer> cellBlock=null;
    int cellBlockSize=0;
    if (reservoir != null) {
      this.cellBlockStream=ipcUtil.buildCellBlockStream(this.connection.codec,this.connection.compressionCodec,cells,reservoir);
      if (this.cellBlockStream != null) {
        cellBlock=this.cellBlockStream.getByteBuffers();
        cellBlockSize=this.cellBlockStream.size();
      }
    }
 else {
      ByteBuffer b=ipcUtil.buildCellBlock(this.connection.codec,this.connection.compressionCodec,cells);
      if (b != null) {
        cellBlockSize=b.remaining();
        cellBlock=new ArrayList<ByteBuffer>(1);
        cellBlock.add(b);
      }
    }
    if (cellBlockSize > 0) {
      CellBlockMeta.Builder cellBlockBuilder=CellBlockMeta.newBuilder();
      cellBlockBuilder.setLength(cellBlockSize);
      headerBuilder.setCellBlockMeta(cellBlockBuilder.build());
    }
    Message header=headerBuilder.build();
    byte[] b=createHeaderAndMessageBytes(result,header,cellBlockSize);
    List<ByteBuffer> responseBufs=new ArrayList<ByteBuffer>((cellBlock == null ? 1 : cellBlock.size()) + 1);
    responseBufs.add(ByteBuffer.wrap(b));
    if (cellBlock != null)     responseBufs.addAll(cellBlock);
    bc=new BufferChain(responseBufs);
    if (connection.useWrap) {
      bc=wrapWithSasl(bc);
    }
  }
 catch (  IOException e) {
    LOG.warn("Exception while creating response " + e);
  }
  this.response=bc;
  if (this.callback != null) {
    try {
      this.callback.run();
    }
 catch (    Exception e) {
      LOG.warn("Exception while running the Rpc Callback.",e);
    }
  }
}
