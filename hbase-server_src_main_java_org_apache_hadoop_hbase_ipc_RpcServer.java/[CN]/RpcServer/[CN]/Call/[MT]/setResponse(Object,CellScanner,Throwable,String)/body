{
  if (this.isError)   return;
  if (t != null)   this.isError=true;
  BufferChain bc=null;
  try {
    ResponseHeader.Builder headerBuilder=ResponseHeader.newBuilder();
    Message result=(Message)m;
    headerBuilder.setCallId(this.id);
    if (t != null) {
      ExceptionResponse.Builder exceptionBuilder=ExceptionResponse.newBuilder();
      exceptionBuilder.setExceptionClassName(t.getClass().getName());
      exceptionBuilder.setStackTrace(errorMsg);
      exceptionBuilder.setDoNotRetry(t instanceof DoNotRetryIOException);
      if (t instanceof RegionMovedException) {
        RegionMovedException rme=(RegionMovedException)t;
        exceptionBuilder.setHostname(rme.getHostname());
        exceptionBuilder.setPort(rme.getPort());
      }
      headerBuilder.setException(exceptionBuilder.build());
    }
    this.cellBlock=ipcUtil.buildCellBlock(this.connection.codec,this.connection.compressionCodec,cells,reservoir);
    if (this.cellBlock != null) {
      CellBlockMeta.Builder cellBlockBuilder=CellBlockMeta.newBuilder();
      cellBlockBuilder.setLength(this.cellBlock.limit());
      headerBuilder.setCellBlockMeta(cellBlockBuilder.build());
    }
    Message header=headerBuilder.build();
    byte[] b=createHeaderAndMessageBytes(result,header);
    bc=new BufferChain(ByteBuffer.wrap(b),this.cellBlock);
    if (connection.useWrap) {
      bc=wrapWithSasl(bc);
    }
  }
 catch (  IOException e) {
    LOG.warn("Exception while creating response " + e);
  }
  this.response=bc;
  if (this.callback != null) {
    try {
      this.callback.run();
    }
 catch (    Exception e) {
      LOG.warn("Exception while running the Rpc Callback.",e);
    }
  }
}
