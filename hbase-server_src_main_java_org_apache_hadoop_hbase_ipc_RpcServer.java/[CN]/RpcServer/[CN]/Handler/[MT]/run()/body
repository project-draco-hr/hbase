{
  LOG.info(getName() + ": starting");
  status.setStatus("starting");
  SERVER.set(RpcServer.this);
  while (running) {
    try {
      status.pause("Waiting for a call");
      Call call=myCallQueue.take();
      status.setStatus("Setting up call");
      status.setConnection(call.connection.getHostAddress(),call.connection.getRemotePort());
      if (LOG.isDebugEnabled()) {
        UserGroupInformation remoteUser=call.connection.user;
        LOG.debug(call.toShortString() + " executing as " + ((remoteUser == null) ? "NULL principal" : remoteUser.getUserName()));
      }
      Throwable errorThrowable=null;
      String error=null;
      Pair<Message,CellScanner> resultPair=null;
      CurCall.set(call);
      Span currentRequestSpan=NullSpan.getInstance();
      try {
        if (!started) {
          throw new ServerNotRunningYetException("Server is not running yet");
        }
        if (call.tinfo != null) {
          currentRequestSpan=Trace.startSpan("handling " + call.toShortString(),call.tinfo,Sampler.ALWAYS);
        }
        RequestContext.set(User.create(call.connection.user),getRemoteIp(),call.connection.service);
        resultPair=call(call.service,call.md,call.param,call.cellScanner,call.timestamp,status);
      }
 catch (      Throwable e) {
        LOG.debug(getName() + ": " + call.toShortString(),e);
        errorThrowable=e;
        error=StringUtils.stringifyException(e);
      }
 finally {
        currentRequestSpan.stop();
        RequestContext.clear();
      }
      CurCall.set(null);
      callQueueSize.add(call.getSize() * -1);
      if (!call.isDelayed() || !call.isReturnValueDelayed()) {
        Message param=resultPair != null ? resultPair.getFirst() : null;
        CellScanner cells=resultPair != null ? resultPair.getSecond() : null;
        call.setResponse(param,cells,errorThrowable,error);
      }
      call.sendResponseIfReady();
      status.markComplete("Sent response");
    }
 catch (    InterruptedException e) {
      if (running) {
        LOG.info(getName() + ": caught: " + StringUtils.stringifyException(e));
      }
    }
catch (    OutOfMemoryError e) {
      if (errorHandler != null) {
        if (errorHandler.checkOOME(e)) {
          LOG.info(getName() + ": exiting on OutOfMemoryError");
          return;
        }
      }
 else {
        throw e;
      }
    }
catch (    ClosedChannelException cce) {
      LOG.warn(getName() + ": caught a ClosedChannelException, " + "this means that the server was processing a "+ "request but the client went away. The error message was: "+ cce.getMessage());
    }
catch (    Exception e) {
      LOG.warn(getName() + ": caught: " + StringUtils.stringifyException(e));
    }
  }
  LOG.info(getName() + ": exiting");
}
