{
  try {
    HRegionInfo hri=newState.getRegion();
    if (hri.isMetaRegion()) {
      try {
        MetaTableLocator.setMetaLocation(server.getZooKeeper(),newState.getServerName(),hri.getReplicaId(),newState.getState());
        return;
      }
 catch (      KeeperException e) {
        throw new IOException("Failed to update meta ZNode",e);
      }
    }
    if (!initialized || !shouldPersistStateChange(hri,newState,oldState)) {
      return;
    }
    ServerName oldServer=oldState != null ? oldState.getServerName() : null;
    ServerName serverName=newState.getServerName();
    State state=newState.getState();
    int replicaId=hri.getReplicaId();
    Put put=new Put(MetaTableAccessor.getMetaKeyForRegion(hri));
    StringBuilder info=new StringBuilder("Updating row ");
    info.append(hri.getRegionNameAsString()).append(" with state=").append(state);
    if (serverName != null && !serverName.equals(oldServer)) {
      put.addImmutable(HConstants.CATALOG_FAMILY,getServerNameColumn(replicaId),Bytes.toBytes(serverName.getServerName()));
      info.append("&sn=").append(serverName);
    }
    if (openSeqNum >= 0) {
      Preconditions.checkArgument(state == State.OPEN && serverName != null,"Open region should be on a server");
      MetaTableAccessor.addLocation(put,serverName,openSeqNum,replicaId);
      info.append("&openSeqNum=").append(openSeqNum);
      info.append("&server=").append(serverName);
    }
    put.addImmutable(HConstants.CATALOG_FAMILY,getStateColumn(replicaId),Bytes.toBytes(state.name()));
    LOG.info(info);
    if (metaRegion != null) {
      try {
        metaRegion.put(put);
        return;
      }
 catch (      Throwable t) {
synchronized (this) {
          if (metaRegion != null) {
            LOG.info("Meta region shortcut failed",t);
            if (multiHConnection == null) {
              multiHConnection=new MultiHConnection(server.getConfiguration(),1);
            }
            metaRegion=null;
          }
        }
      }
    }
    multiHConnection.processBatchCallback(Arrays.asList(put),TableName.META_TABLE_NAME,null,null);
  }
 catch (  IOException ioe) {
    LOG.error("Failed to persist region state " + newState,ioe);
    server.abort("Failed to update region location",ioe);
  }
}
