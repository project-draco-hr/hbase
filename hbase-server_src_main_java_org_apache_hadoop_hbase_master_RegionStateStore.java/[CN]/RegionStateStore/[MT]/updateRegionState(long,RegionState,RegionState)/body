{
  if (noPersistence || !initialized) {
    return;
  }
  HRegionInfo hri=newState.getRegion();
  if (!shouldPersistStateChange(hri,newState,oldState)) {
    return;
  }
  ServerName oldServer=oldState != null ? oldState.getServerName() : null;
  ServerName serverName=newState.getServerName();
  State state=newState.getState();
  try {
    int replicaId=hri.getReplicaId();
    Put put=new Put(MetaTableAccessor.getMetaKeyForRegion(hri));
    StringBuilder info=new StringBuilder("Updating row ");
    info.append(hri.getRegionNameAsString()).append(" with state=").append(state);
    if (serverName != null && !serverName.equals(oldServer)) {
      put.addImmutable(HConstants.CATALOG_FAMILY,getServerNameColumn(replicaId),Bytes.toBytes(serverName.getServerName()));
      info.append("&sn=").append(serverName);
    }
    if (openSeqNum >= 0) {
      Preconditions.checkArgument(state == State.OPEN && serverName != null,"Open region should be on a server");
      MetaTableAccessor.addLocation(put,serverName,openSeqNum,replicaId);
      info.append("&openSeqNum=").append(openSeqNum);
      info.append("&server=").append(serverName);
    }
    put.addImmutable(HConstants.CATALOG_FAMILY,getStateColumn(replicaId),Bytes.toBytes(state.name()));
    LOG.info(info);
    if (metaRegion != null) {
      try {
        metaRegion.put(put);
        return;
      }
 catch (      Throwable t) {
synchronized (this) {
          if (metaRegion != null) {
            LOG.info("Meta region shortcut failed",t);
            metaTable=new HTable(TableName.META_TABLE_NAME,server.getShortCircuitConnection());
            metaRegion=null;
          }
        }
      }
    }
synchronized (metaTable) {
      metaTable.put(put);
    }
  }
 catch (  IOException ioe) {
    LOG.error("Failed to persist region state " + newState,ioe);
    server.abort("Failed to update region location",ioe);
  }
}
