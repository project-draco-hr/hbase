{
  for (  InlineBlockWriter ibw : inlineBlockWriters) {
    while (ibw.shouldWriteBlock(closing)) {
      long offset=outputStream.getPos();
      boolean cacheThisBlock=ibw.cacheOnWrite();
      ibw.writeInlineBlock(fsBlockWriter.startWriting(ibw.getInlineBlockType()));
      fsBlockWriter.writeHeaderAndData(outputStream);
      ibw.blockWritten(offset,fsBlockWriter.getOnDiskSizeWithHeader(),fsBlockWriter.getUncompressedSizeWithoutHeader());
      totalUncompressedBytes+=fsBlockWriter.getUncompressedSizeWithHeader();
      if (cacheThisBlock) {
        HFileBlock cBlock=fsBlockWriter.getBlockForCaching();
        HFileBlock codedBlock=blockEncoder.beforeBlockCache(cBlock,includeMemstoreTS);
        passSchemaMetricsTo(codedBlock);
        cacheConf.getBlockCache().cacheBlock(HFile.getBlockCacheKey(name,offset),codedBlock);
      }
    }
  }
}
