{
  for (  InlineBlockWriter ibw : inlineBlockWriters) {
    while (ibw.shouldWriteBlock(closing)) {
      long offset=outputStream.getPos();
      boolean cacheThisBlock=ibw.cacheOnWrite();
      ibw.writeInlineBlock(fsBlockWriter.startWriting(ibw.getInlineBlockType(),cacheThisBlock));
      fsBlockWriter.writeHeaderAndData(outputStream);
      ibw.blockWritten(offset,fsBlockWriter.getOnDiskSizeWithHeader(),fsBlockWriter.getUncompressedSizeWithoutHeader());
      totalUncompressedBytes+=fsBlockWriter.getUncompressedSizeWithHeader();
      if (cacheThisBlock) {
        HFileBlock cBlock=fsBlockWriter.getBlockForCaching();
        passSchemaMetricsTo(cBlock);
        cacheConf.getBlockCache().cacheBlock(HFile.getBlockCacheKey(name,offset),cBlock);
      }
    }
  }
}
