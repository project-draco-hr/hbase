{
  final Configuration conf=HBaseConfiguration.create(CONF);
  conf.setInt("hbase.hstore.flush.retries.number",1);
  final User user=User.createUserForTesting(conf,this.name.getMethodName(),new String[]{"foo"});
  conf.setClass("fs.file.impl",FaultyFileSystem.class,FileSystem.class);
  user.runAs(new PrivilegedExceptionAction<Object>(){
    public Object run() throws Exception {
      FileSystem fs=FileSystem.get(conf);
      Assert.assertEquals(FaultyFileSystem.class,fs.getClass());
      FaultyFileSystem ffs=(FaultyFileSystem)fs;
      HRegion region=null;
      try {
        region=initHRegion(tableName,name.getMethodName(),conf,COLUMN_FAMILY_BYTES);
        long size=region.getMemstoreSize().get();
        Assert.assertEquals(0,size);
        Put p1=new Put(row);
        p1.add(new KeyValue(row,COLUMN_FAMILY_BYTES,qual1,1,(byte[])null));
        region.put(p1);
        final long sizeOfOnePut=region.getMemstoreSize().get();
        try {
          LOG.info("Flushing");
          region.flushcache();
          Assert.fail("Didn't bubble up IOE!");
        }
 catch (        DroppedSnapshotException dse) {
        }
        ffs.fault.set(false);
        Assert.assertEquals(sizeOfOnePut,region.getMemstoreSize().get());
        Put p2=new Put(row);
        p2.add(new KeyValue(row,COLUMN_FAMILY_BYTES,qual2,2,(byte[])null));
        p2.add(new KeyValue(row,COLUMN_FAMILY_BYTES,qual3,3,(byte[])null));
        region.put(p2);
        Assert.assertEquals(sizeOfOnePut * 3,region.getMemstoreSize().get());
        region.flushcache();
        Assert.assertEquals(sizeOfOnePut * 2,region.getMemstoreSize().get());
      }
  finally {
        HRegion.closeHRegion(region);
      }
      return null;
    }
  }
);
  FileSystem.closeAllForUGI(user.getUGI());
}
