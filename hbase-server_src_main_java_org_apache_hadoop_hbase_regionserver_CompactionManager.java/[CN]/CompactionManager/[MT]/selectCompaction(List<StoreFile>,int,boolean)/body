{
  CompactSelection candidateSelection=new CompactSelection(candidateFiles);
  if (!forceMajor) {
    if (comConf.shouldDeleteExpired() && (store.getTtl() != Long.MAX_VALUE)) {
      CompactSelection expiredSelection=selectExpiredSFs(candidateSelection,EnvironmentEdgeManager.currentTimeMillis() - store.getTtl());
      if (expiredSelection != null) {
        return expiredSelection;
      }
    }
    candidateSelection=skipLargeFiles(candidateSelection);
  }
  boolean isUserCompaction=(priority == Store.PRIORITY_USER);
  boolean majorCompaction=((forceMajor && isUserCompaction) || ((forceMajor || isMajorCompaction(candidateSelection.getFilesToCompact())) && (candidateSelection.getFilesToCompact().size() < comConf.getMaxFilesToCompact())) || store.hasReferences(candidateSelection.getFilesToCompact()));
  LOG.debug(store.getHRegion().regionInfo.getEncodedName() + " - " + store.getColumnFamilyName()+ ": Initiating "+ (majorCompaction ? "major" : "minor")+ "compaction");
  if (!majorCompaction) {
    candidateSelection=filterBulk(candidateSelection);
    candidateSelection=applyCompactionPolicy(candidateSelection);
    candidateSelection=checkMinFilesCriteria(candidateSelection);
  }
  candidateSelection=removeExcessFiles(candidateSelection,isUserCompaction,majorCompaction);
  return candidateSelection;
}
