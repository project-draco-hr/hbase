{
  Configuration conf=HBaseConfiguration.create();
  RpcClientImpl client=new RpcClientImpl(conf,HConstants.CLUSTER_ID_DEFAULT){
    @Override Codec getCodec(){
      return null;
    }
  }
;
  TestRpcServer rpcServer=new TestRpcServer();
  try {
    rpcServer.start();
    InetSocketAddress address=rpcServer.getListenerAddress();
    MethodDescriptor md=SERVICE.getDescriptorForType().findMethodByName("echo");
    final String message="hello";
    EchoRequestProto param=EchoRequestProto.newBuilder().setMessage(message).build();
    Pair<Message,CellScanner> r=client.call(null,md,param,null,md.getOutputType().toProto(),User.getCurrent(),address,0);
    assertTrue(r.getSecond() == null);
    assertTrue(r.getFirst().toString().contains(message));
  }
  finally {
    client.close();
    rpcServer.stop();
  }
}
