{
  Configuration conf=HBaseConfiguration.create();
  conf.set("hbase.client.rpc.compressor",GzipCodec.class.getCanonicalName());
  TestRpcServer rpcServer=new TestRpcServer();
  RpcClient client=new RpcClient(conf,HConstants.CLUSTER_ID_DEFAULT);
  List<Cell> cells=new ArrayList<Cell>();
  int count=3;
  for (int i=0; i < count; i++)   cells.add(CELL);
  try {
    rpcServer.start();
    InetSocketAddress address=rpcServer.getListenerAddress();
    MethodDescriptor md=SERVICE.getDescriptorForType().findMethodByName("echo");
    EchoRequestProto param=EchoRequestProto.newBuilder().setMessage("hello").build();
    Pair<Message,CellScanner> r=client.call(md,param,CellUtil.createCellScanner(cells),md.getOutputType().toProto(),User.getCurrent(),address,0);
    int index=0;
    while (r.getSecond().advance()) {
      assertTrue(CELL.equals(r.getSecond().current()));
      index++;
    }
    assertEquals(count,index);
  }
  finally {
    client.stop();
    rpcServer.stop();
  }
}
