{
  Configuration conf=HBaseConfiguration.create();
  TestRpcServer rpcServer=new TestRpcServer();
  AsyncRpcClient client=new AsyncRpcClient(conf,HConstants.CLUSTER_ID_DEFAULT,null,new ChannelInitializer<SocketChannel>(){
    @Override protected void initChannel(    SocketChannel ch) throws Exception {
      ch.pipeline().addFirst(new ChannelOutboundHandlerAdapter(){
        @Override public void write(        ChannelHandlerContext ctx,        Object msg,        ChannelPromise promise) throws Exception {
          promise.setFailure(new RuntimeException("Injected fault"));
        }
      }
);
    }
  }
);
  try {
    rpcServer.start();
    InetSocketAddress address=rpcServer.getListenerAddress();
    MethodDescriptor md=SERVICE.getDescriptorForType().findMethodByName("echo");
    EchoRequestProto param=EchoRequestProto.newBuilder().setMessage("hello").build();
    BlockingRpcChannel channel=client.createBlockingRpcChannel(ServerName.valueOf(address.getHostName(),address.getPort(),System.currentTimeMillis()),User.getCurrent(),0);
    channel.callBlockingMethod(md,new PayloadCarryingRpcController(),param,md.getOutputType().toProto());
    fail("Expected an exception to have been thrown!");
  }
 catch (  Exception e) {
    LOG.info("Caught expected exception: " + e.toString());
    assertTrue(StringUtils.stringifyException(e).contains("Injected fault"));
  }
 finally {
    client.close();
    rpcServer.stop();
  }
}
