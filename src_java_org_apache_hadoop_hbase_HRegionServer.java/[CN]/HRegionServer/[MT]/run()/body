{
  startAllServices();
  boolean masterRequestedStop=false;
  try {
    while (!stopRequested.get()) {
      long lastMsg=0;
      try {
        reportForDuty();
      }
 catch (      IOException e) {
        this.sleeper.sleep(lastMsg);
        continue;
      }
      for (int tries=0; !stopRequested.get(); ) {
        if ((System.currentTimeMillis() - lastMsg) >= msgInterval) {
          HMsg outboundArray[]=null;
synchronized (outboundMsgs) {
            outboundArray=this.outboundMsgs.toArray(new HMsg[outboundMsgs.size()]);
            this.outboundMsgs.clear();
          }
          try {
            this.serverInfo.setLoad(new HServerLoad(requestCount.get(),onlineRegions.size()));
            this.requestCount.set(0);
            HMsg msgs[]=this.hbaseMaster.regionServerReport(serverInfo,outboundArray);
            lastMsg=System.currentTimeMillis();
            boolean restart=false;
            for (int i=0; i < msgs.length && !stopRequested.get() && !restart; i++) {
switch (msgs[i].getMsg()) {
case HMsg.MSG_CALL_SERVER_STARTUP:
                if (LOG.isDebugEnabled()) {
                  LOG.debug("Got call server startup message");
                }
              if (checkFileSystem()) {
                closeAllRegions();
                restart=true;
              }
            break;
case HMsg.MSG_REGIONSERVER_STOP:
          if (LOG.isDebugEnabled()) {
            LOG.debug("Got regionserver stop message");
          }
        masterRequestedStop=true;
      stopRequested.set(true);
    break;
default :
  if (fsOk) {
    try {
      toDo.put(new ToDoEntry(msgs[i]));
    }
 catch (    InterruptedException e) {
      throw new RuntimeException("Putting into msgQueue was " + "interrupted.",e);
    }
  }
}
}
if (restart || this.stopRequested.get()) {
toDo.clear();
break;
}
tries=0;
}
 catch (IOException e) {
e=RemoteExceptionHandler.checkIOException(e);
if (tries < this.numRetries) {
LOG.warn("",e);
tries++;
}
 else {
LOG.error("Exceeded max retries: " + this.numRetries,e);
if (!checkFileSystem()) {
continue;
}
stop();
}
}
}
this.sleeper.sleep(lastMsg);
}
}
}
 catch (Throwable t) {
LOG.fatal("Unhandled exception. Aborting...",t);
abort();
}
leases.closeAfterLeasesExpire();
this.worker.stop();
this.server.stop();
synchronized (logRollerLock) {
this.logRollerThread.interrupt();
}
synchronized (cacheFlusherLock) {
this.cacheFlusherThread.interrupt();
}
synchronized (splitOrCompactLock) {
this.splitOrCompactCheckerThread.interrupt();
}
if (abortRequested) {
if (this.fsOk) {
try {
log.close();
LOG.info("On abort, closed hlog");
}
 catch (IOException e) {
LOG.error("Unable to close log in abort",RemoteExceptionHandler.checkIOException(e));
}
closeAllRegions();
}
LOG.info("aborting server at: " + serverInfo.getServerAddress().toString());
}
 else {
ArrayList<HRegion> closedRegions=closeAllRegions();
try {
log.closeAndDelete();
}
 catch (IOException e) {
LOG.error("",RemoteExceptionHandler.checkIOException(e));
}
try {
if (!masterRequestedStop && closedRegions != null) {
HMsg[] exitMsg=new HMsg[closedRegions.size() + 1];
exitMsg[0]=new HMsg(HMsg.MSG_REPORT_EXITING);
int i=1;
for (HRegion region : closedRegions) {
exitMsg[i++]=new HMsg(HMsg.MSG_REPORT_CLOSE,region.getRegionInfo());
}
LOG.info("telling master that region server is shutting down at: " + serverInfo.getServerAddress().toString());
hbaseMaster.regionServerReport(serverInfo,exitMsg);
}
}
 catch (IOException e) {
LOG.warn("",RemoteExceptionHandler.checkIOException(e));
}
LOG.info("stopping server at: " + serverInfo.getServerAddress().toString());
}
join();
LOG.info("main thread exiting");
}
