{
  this.abortRequested=false;
  this.fsOk=true;
  this.rootDir=rootDir;
  this.conf=conf;
  this.rand=new Random();
  this.onlineRegions=Collections.synchronizedSortedMap(new TreeMap<Text,HRegion>());
  this.outboundMsgs=new Vector<HMsg>();
  this.requestCount=new AtomicInteger();
  this.numRetries=conf.getInt("hbase.client.retries.number",2);
  this.threadWakeFrequency=conf.getInt(THREAD_WAKE_FREQUENCY,10 * 1000);
  this.msgInterval=conf.getInt("hbase.regionserver.msginterval",3 * 1000);
  this.cacheFlusherThread=new Flusher(this.threadWakeFrequency,stopRequested);
  this.splitOrCompactCheckerThread=new SplitOrCompactChecker(this.stopRequested);
  this.toDo=new LinkedBlockingQueue<ToDoEntry>();
  this.worker=new Worker();
  this.workerThread=new Thread(worker);
  this.sleeper=new Sleeper(this.msgInterval,this.stopRequested);
  try {
    this.server=RPC.getServer(this,address.getBindAddress(),address.getPort(),conf.getInt("hbase.regionserver.handler.count",10),false,conf);
    String realIP=DNS.getDefaultIP(conf.get("dfs.datanode.dns.interface","default"));
    this.serverInfo=new HServerInfo(new HServerAddress(new InetSocketAddress(realIP,server.getListenerAddress().getPort())),this.rand.nextLong());
    Path logdir=new Path(rootDir,"log" + "_" + realIP + "_"+ this.serverInfo.getServerAddress().getPort());
    if (LOG.isDebugEnabled()) {
      LOG.debug("Log dir " + logdir);
    }
    this.fs=FileSystem.get(conf);
    if (fs.exists(logdir)) {
      throw new RegionServerRunningException("region server already " + "running at " + this.serverInfo.getServerAddress().toString() + " because logdir "+ logdir.toString()+ " exists");
    }
    this.log=new HLog(fs,logdir,conf);
    this.logRollerThread=new LogRoller(this.threadWakeFrequency,stopRequested);
    this.hbaseMaster=(HMasterRegionInterface)RPC.waitForProxy(HMasterRegionInterface.class,HMasterRegionInterface.versionID,new HServerAddress(conf.get(MASTER_ADDRESS)).getInetSocketAddress(),conf);
  }
 catch (  IOException e) {
    this.stopRequested.set(true);
    throw RemoteExceptionHandler.checkIOException(e);
  }
}
