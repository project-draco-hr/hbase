{
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  DoubleOutputStream doubleOutputStream=new DoubleOutputStream(dos,baos);
  final int rawBlockSize=writeTestKeyValues(doubleOutputStream,blockId,includesMemstoreTS);
  ByteBuffer rawBuf=ByteBuffer.wrap(baos.toByteArray());
  rawBuf.rewind();
  final int encodedSize;
  final ByteBuffer encodedBuf;
  if (encoding == DataBlockEncoding.NONE) {
    encodedSize=rawBlockSize;
    encodedBuf=rawBuf;
  }
 else {
    ByteArrayOutputStream encodedOut=new ByteArrayOutputStream();
    encoding.getEncoder().compressKeyValues(new DataOutputStream(encodedOut),rawBuf.duplicate(),includesMemstoreTS);
    encodedSize=encodedOut.size() + DataBlockEncoding.ID_SIZE;
    encodedBuf=ByteBuffer.wrap(encodedOut.toByteArray());
  }
  encodedSizes.add(encodedSize);
  encodedBlocks.add(encodedBuf);
}
