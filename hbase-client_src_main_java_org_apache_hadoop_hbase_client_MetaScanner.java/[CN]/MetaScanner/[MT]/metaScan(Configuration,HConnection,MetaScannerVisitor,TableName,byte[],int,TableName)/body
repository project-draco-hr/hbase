{
  int rowUpperLimit=rowLimit > 0 ? rowLimit : Integer.MAX_VALUE;
  HTable metaTable;
  if (connection == null) {
    metaTable=new HTable(configuration,TableName.META_TABLE_NAME,null);
  }
 else {
    metaTable=new HTable(TableName.META_TABLE_NAME,connection,null);
  }
  byte[] startRow;
  ResultScanner scanner=null;
  try {
    if (row != null) {
      byte[] searchRow=HRegionInfo.createRegionName(tableName,row,HConstants.NINES,false);
      Result startRowResult=metaTable.getRowOrBefore(searchRow,HConstants.CATALOG_FAMILY);
      if (startRowResult == null) {
        throw new TableNotFoundException("Cannot find row in " + TableName.META_TABLE_NAME.getNameAsString() + " for table: "+ tableName+ ", row="+ Bytes.toStringBinary(searchRow));
      }
      HRegionInfo regionInfo=getHRegionInfo(startRowResult);
      if (regionInfo == null) {
        throw new IOException("HRegionInfo was null or empty in Meta for " + tableName + ", row="+ Bytes.toStringBinary(searchRow));
      }
      byte[] rowBefore=regionInfo.getStartKey();
      startRow=HRegionInfo.createRegionName(tableName,rowBefore,HConstants.ZEROES,false);
    }
 else     if (tableName == null || tableName.getName().length == 0) {
      startRow=HConstants.EMPTY_START_ROW;
    }
 else {
      startRow=HRegionInfo.createRegionName(tableName,HConstants.EMPTY_START_ROW,HConstants.ZEROES,false);
    }
    final Scan scan=new Scan(startRow).addFamily(HConstants.CATALOG_FAMILY);
    int scannerCaching=configuration.getInt(HConstants.HBASE_META_SCANNER_CACHING,HConstants.DEFAULT_HBASE_META_SCANNER_CACHING);
    if (rowUpperLimit <= scannerCaching) {
      scan.setSmall(true);
    }
    int rows=Math.min(rowLimit,scannerCaching);
    scan.setCaching(rows);
    if (LOG.isTraceEnabled()) {
      LOG.trace("Scanning " + metaTableName.getNameAsString() + " starting at row="+ Bytes.toStringBinary(startRow)+ " for max="+ rowUpperLimit+ " with caching="+ rows);
    }
    scanner=metaTable.getScanner(scan);
    Result result=null;
    int processedRows=0;
    while ((result=scanner.next()) != null) {
      if (visitor != null) {
        if (!visitor.processRow(result))         break;
      }
      processedRows++;
      if (processedRows >= rowUpperLimit)       break;
    }
  }
  finally {
    if (scanner != null) {
      try {
        scanner.close();
      }
 catch (      Throwable t) {
        LOG.debug("Got exception in closing the result scanner",t);
      }
    }
    if (visitor != null) {
      try {
        visitor.close();
      }
 catch (      Throwable t) {
        LOG.debug("Got exception in closing the meta scanner visitor",t);
      }
    }
    if (metaTable != null) {
      try {
        metaTable.close();
      }
 catch (      Throwable t) {
        LOG.debug("Got exception in closing the meta table",t);
      }
    }
  }
}
