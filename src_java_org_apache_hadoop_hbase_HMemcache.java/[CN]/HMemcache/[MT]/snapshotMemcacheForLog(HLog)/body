{
  this.lock.obtainWriteLock();
  try {
    if (snapshot != null) {
      throw new IOException("Snapshot in progress!");
    }
    if (memcache.size() == 0) {
      return null;
    }
    Snapshot retval=new Snapshot(memcache,Long.valueOf(log.startCacheFlush()));
    this.snapshot=memcache;
    history.add(memcache);
    memcache=new TreeMap<HStoreKey,byte[]>();
    this.size.set(0);
    return retval;
  }
  finally {
    this.lock.releaseWriteLock();
  }
}
