{
  Snapshot retval=new Snapshot();
  this.lock.writeLock().lock();
  try {
    if (snapshot != null) {
      throw new IOException("Snapshot in progress!");
    }
    if (memcache.size() == 0) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("memcache empty. Skipping snapshot");
      }
      return retval;
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("starting memcache snapshot");
    }
    retval.memcacheSnapshot=memcache;
    this.snapshot=memcache;
    history.add(memcache);
    memcache=new TreeMap<HStoreKey,BytesWritable>();
    retval.sequenceId=log.startCacheFlush();
    if (LOG.isDebugEnabled()) {
      LOG.debug("memcache snapshot complete");
    }
    return retval;
  }
  finally {
    this.lock.writeLock().unlock();
  }
}
