{
  Snapshot retval=new Snapshot();
  this.locker.writeLock().lock();
  try {
    if (snapshot != null) {
      throw new IOException("Snapshot in progress!");
    }
    if (memcache.size() == 0) {
      LOG.debug("memcache empty. Skipping snapshot");
      return retval;
    }
    LOG.debug("starting memcache snapshot");
    retval.memcacheSnapshot=memcache;
    this.snapshot=memcache;
    history.add(memcache);
    memcache=new TreeMap<HStoreKey,BytesWritable>();
    retval.sequenceId=log.startCacheFlush();
    LOG.debug("memcache snapshot complete");
    return retval;
  }
  finally {
    this.locker.writeLock().unlock();
  }
}
