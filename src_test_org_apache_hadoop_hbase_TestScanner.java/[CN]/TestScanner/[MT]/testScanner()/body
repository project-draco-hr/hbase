{
  MiniDFSCluster cluster=null;
  FileSystem fs=null;
  try {
    HBaseConfiguration conf=new HBaseConfiguration();
    cluster=new MiniDFSCluster(conf,2,true,(String[])null);
    fs=cluster.getFileSystem();
    Path dir=new Path("/hbase");
    fs.mkdirs(dir);
    Path regionDir=HRegion.getRegionDir(dir,HRegionInfo.encodeRegionName(REGION_INFO.getRegionName()));
    fs.mkdirs(regionDir);
    HLog log=new HLog(fs,new Path(regionDir,"log"),conf);
    r=new HRegion(dir,log,fs,conf,REGION_INFO,null);
    region=new HRegionIncommon(r);
    long lockid=region.startUpdate(ROW_KEY);
    ByteArrayOutputStream byteStream=new ByteArrayOutputStream();
    DataOutputStream s=new DataOutputStream(byteStream);
    HRegionInfo.rootRegionInfo.write(s);
    region.put(lockid,HConstants.COL_REGIONINFO,byteStream.toByteArray());
    region.commit(lockid,System.currentTimeMillis());
    scan(false,null);
    getRegionInfo();
    r.close();
    log.rollWriter();
    r=new HRegion(dir,log,fs,conf,REGION_INFO,null);
    region=new HRegionIncommon(r);
    scan(false,null);
    getRegionInfo();
    HServerAddress address=new HServerAddress("foo.bar.com:1234");
    lockid=region.startUpdate(ROW_KEY);
    region.put(lockid,HConstants.COL_SERVER,Writables.stringToBytes(address.toString()));
    region.put(lockid,HConstants.COL_STARTCODE,Writables.longToBytes(START_CODE));
    region.commit(lockid,System.currentTimeMillis());
    scan(true,address.toString());
    getRegionInfo();
    region.flushcache();
    scan(true,address.toString());
    getRegionInfo();
    r.close();
    log.rollWriter();
    r=new HRegion(dir,log,fs,conf,REGION_INFO,null);
    region=new HRegionIncommon(r);
    scan(true,address.toString());
    getRegionInfo();
    address=new HServerAddress("bar.foo.com:4321");
    lockid=region.startUpdate(ROW_KEY);
    region.put(lockid,HConstants.COL_SERVER,Writables.stringToBytes(address.toString()));
    region.commit(lockid,System.currentTimeMillis());
    scan(true,address.toString());
    getRegionInfo();
    region.flushcache();
    scan(true,address.toString());
    getRegionInfo();
    r.close();
    log.rollWriter();
    r=new HRegion(dir,log,fs,conf,REGION_INFO,null);
    region=new HRegionIncommon(r);
    scan(true,address.toString());
    getRegionInfo();
    r.close();
    log.closeAndDelete();
  }
  finally {
    StaticTestEnvironment.shutdownDfs(cluster);
  }
}
