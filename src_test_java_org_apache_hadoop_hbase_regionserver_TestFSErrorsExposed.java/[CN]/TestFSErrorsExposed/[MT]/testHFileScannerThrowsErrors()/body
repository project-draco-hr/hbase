{
  Path hfilePath=new Path(new Path(util.getDataTestDir("internalScannerExposesErrors"),"regionname"),"familyname");
  FaultyFileSystem fs=new FaultyFileSystem(util.getTestFileSystem());
  CacheConfig cacheConf=new CacheConfig(util.getConfiguration());
  StoreFile.Writer writer=StoreFile.createWriter(fs,hfilePath,2 * 1024,util.getConfiguration(),cacheConf);
  TestStoreFile.writeStoreFile(writer,Bytes.toBytes("cf"),Bytes.toBytes("qual"));
  StoreFile sf=new StoreFile(fs,writer.getPath(),util.getConfiguration(),cacheConf,StoreFile.BloomType.NONE,NoOpDataBlockEncoder.INSTANCE);
  StoreFile.Reader reader=sf.createReader();
  HFileScanner scanner=reader.getScanner(false,true);
  FaultyInputStream inStream=fs.inStreams.get(0).get();
  assertNotNull(inStream);
  scanner.seekTo();
  assertTrue(scanner.next());
  inStream.startFaults();
  try {
    int scanned=0;
    while (scanner.next()) {
      scanned++;
    }
    fail("Scanner didn't throw after faults injected");
  }
 catch (  IOException ioe) {
    LOG.info("Got expected exception",ioe);
    assertTrue(ioe.getMessage().contains("Fault"));
  }
  reader.close(true);
}
