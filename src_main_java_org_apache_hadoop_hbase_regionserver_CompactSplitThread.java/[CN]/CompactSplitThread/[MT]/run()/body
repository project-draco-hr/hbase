{
  while (!this.server.isStopped()) {
    CompactionRequest compactionRequest=null;
    HRegion r=null;
    try {
      compactionRequest=compactionQueue.poll(this.frequency,TimeUnit.MILLISECONDS);
      if (compactionRequest != null) {
        lock.lock();
        try {
          if (!this.server.isStopped()) {
            r=compactionRequest.getHRegion();
            byte[] midKey=r.compactStore(compactionRequest.getStore());
            if (r.getLastCompactInfo() != null) {
              this.server.getMetrics().addCompaction(r.getLastCompactInfo());
            }
            if (shouldSplitRegion() && midKey != null && !this.server.isStopped()) {
              split(r,midKey);
            }
          }
        }
  finally {
          lock.unlock();
        }
      }
    }
 catch (    InterruptedException ex) {
      continue;
    }
catch (    IOException ex) {
      LOG.error("Compaction/Split failed for region " + r.getRegionNameAsString(),RemoteExceptionHandler.checkIOException(ex));
      if (!server.checkFileSystem()) {
        break;
      }
    }
catch (    Exception ex) {
      LOG.error("Compaction failed" + (r != null ? (" for region " + r.getRegionNameAsString()) : ""),ex);
      if (!server.checkFileSystem()) {
        break;
      }
    }
  }
  compactionQueue.clear();
  LOG.info(getName() + " exiting");
}
