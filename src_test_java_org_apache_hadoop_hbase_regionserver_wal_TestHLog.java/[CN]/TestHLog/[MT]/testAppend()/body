{
  final int COL_COUNT=10;
  final byte[] tableName=Bytes.toBytes("tablename");
  final byte[] row=Bytes.toBytes("row");
  Reader reader=null;
  HLog log=new HLog(fs,dir,oldLogDir,conf);
  try {
    long timestamp=System.currentTimeMillis();
    WALEdit cols=new WALEdit();
    for (int i=0; i < COL_COUNT; i++) {
      cols.add(new KeyValue(row,Bytes.toBytes("column"),Bytes.toBytes(Integer.toString(i)),timestamp,new byte[]{(byte)(i + '0')}));
    }
    HRegionInfo hri=new HRegionInfo(tableName,HConstants.EMPTY_START_ROW,HConstants.EMPTY_END_ROW);
    HTableDescriptor htd=new HTableDescriptor();
    htd.addFamily(new HColumnDescriptor("column"));
    log.append(hri,tableName,cols,System.currentTimeMillis(),htd);
    long logSeqId=log.startCacheFlush(hri.getEncodedNameAsBytes());
    log.completeCacheFlush(hri.getEncodedNameAsBytes(),tableName,logSeqId,false);
    log.close();
    Path filename=log.computeFilename();
    log=null;
    reader=HLog.getReader(fs,filename,conf);
    HLog.Entry entry=reader.next();
    assertEquals(COL_COUNT,entry.getEdit().size());
    int idx=0;
    for (    KeyValue val : entry.getEdit().getKeyValues()) {
      assertTrue(Bytes.equals(hri.getEncodedNameAsBytes(),entry.getKey().getEncodedRegionName()));
      assertTrue(Bytes.equals(tableName,entry.getKey().getTablename()));
      assertTrue(Bytes.equals(row,val.getRow()));
      assertEquals((byte)(idx + '0'),val.getValue()[0]);
      System.out.println(entry.getKey() + " " + val);
      idx++;
    }
    entry=reader.next();
    assertEquals(1,entry.getEdit().size());
    for (    KeyValue val : entry.getEdit().getKeyValues()) {
      assertTrue(Bytes.equals(hri.getEncodedNameAsBytes(),entry.getKey().getEncodedRegionName()));
      assertTrue(Bytes.equals(tableName,entry.getKey().getTablename()));
      assertTrue(Bytes.equals(HLog.METAROW,val.getRow()));
      assertTrue(Bytes.equals(HLog.METAFAMILY,val.getFamily()));
      assertTrue(Bytes.startsWith(val.getValue(),HLog.COMPLETE_CACHE_FLUSH));
      System.out.println(entry.getKey() + " " + val);
    }
  }
  finally {
    if (log != null) {
      log.closeAndDelete();
    }
    if (reader != null) {
      reader.close();
    }
  }
}
