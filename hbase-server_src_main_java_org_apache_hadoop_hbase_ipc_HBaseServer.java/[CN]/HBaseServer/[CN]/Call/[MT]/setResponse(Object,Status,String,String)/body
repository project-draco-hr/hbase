{
  if (this.isError)   return;
  if (errorClass != null) {
    this.isError=true;
  }
  ByteBufferOutputStream buf=null;
  if (value != null) {
    buf=new ByteBufferOutputStream(((Message)value).getSerializedSize());
  }
 else {
    buf=new ByteBufferOutputStream(BUFFER_INITIAL_SIZE);
  }
  DataOutputStream out=new DataOutputStream(buf);
  try {
    RpcResponseHeader.Builder builder=RpcResponseHeader.newBuilder();
    builder.setCallId(this.id);
    builder.setStatus(status);
    builder.build().writeDelimitedTo(out);
    if (error != null) {
      RpcException.Builder b=RpcException.newBuilder();
      b.setExceptionName(errorClass);
      b.setStackTrace(error);
      b.build().writeDelimitedTo(out);
    }
 else {
      if (value != null) {
        ((Message)value).writeDelimitedTo(out);
      }
    }
    if (connection.useWrap) {
      wrapWithSasl(buf);
    }
  }
 catch (  IOException e) {
    LOG.warn("Exception while creating response " + e);
  }
  ByteBuffer bb=buf.getByteBuffer();
  bb.position(0);
  this.response=bb;
}
