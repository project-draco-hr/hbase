{
  boolean error=true;
  boolean done=false;
  int numElements;
  Call call=null;
  try {
synchronized (responseQueue) {
      numElements=responseQueue.size();
      if (numElements == 0) {
        error=false;
        return true;
      }
      call=responseQueue.peek();
      SocketChannel channel=call.connection.channel;
      if (LOG.isDebugEnabled()) {
        LOG.debug(getName() + ": responding to #" + call.id+ " from "+ call.connection);
      }
      int numBytes=channelWrite(channel,call.response);
      if (numBytes < 0) {
        return true;
      }
      if (!call.response.hasRemaining()) {
        responseQueue.poll();
        responseQueuesSizeThrottler.decrease(call.response.limit());
        responseQueueLen--;
        call.connection.decRpcCount();
        if (numElements == 1) {
          done=true;
        }
 else {
          done=false;
        }
        if (LOG.isDebugEnabled()) {
          LOG.debug(getName() + ": responding to #" + call.id+ " from "+ call.connection+ " Wrote "+ numBytes+ " bytes.");
        }
      }
 else {
        if (inHandler) {
          call.timestamp=System.currentTimeMillis();
          if (enqueueInSelector(call))           done=true;
        }
        if (LOG.isDebugEnabled()) {
          LOG.debug(getName() + ": responding to #" + call.id+ " from "+ call.connection+ " Wrote partial "+ numBytes+ " bytes.");
        }
      }
      error=false;
    }
  }
  finally {
    if (error && call != null) {
      LOG.warn(getName() + ", call " + call+ ": output error");
      done=true;
      closeConnection(call.connection);
    }
  }
  return done;
}
