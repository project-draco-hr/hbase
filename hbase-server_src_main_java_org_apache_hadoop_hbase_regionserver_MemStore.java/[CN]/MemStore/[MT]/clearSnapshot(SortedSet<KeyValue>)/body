{
  MemStoreLAB tmpAllocator=null;
  this.lock.writeLock().lock();
  try {
    if (this.snapshot != ss) {
      throw new UnexpectedException("Current snapshot is " + this.snapshot + ", was passed "+ ss);
    }
    if (!ss.isEmpty()) {
      this.snapshot=new KeyValueSkipListSet(this.comparator);
      this.snapshotTimeRangeTracker=new TimeRangeTracker();
    }
    if (this.snapshotAllocator != null) {
      tmpAllocator=this.snapshotAllocator;
      this.snapshotAllocator=null;
    }
  }
  finally {
    this.lock.writeLock().unlock();
  }
  if (tmpAllocator != null) {
    tmpAllocator.close();
  }
}
