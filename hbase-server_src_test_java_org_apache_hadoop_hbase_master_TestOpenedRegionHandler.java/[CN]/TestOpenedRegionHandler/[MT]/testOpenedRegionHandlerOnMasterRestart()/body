{
  log("Starting cluster");
  conf=HBaseConfiguration.create();
  conf.setBoolean("hbase.assignment.usezk",true);
  resetConf=conf;
  TEST_UTIL=new HBaseTestingUtility(conf);
  TEST_UTIL.startMiniCluster(NUM_MASTERS,NUM_RS);
  String tableName="testOpenedRegionHandlerOnMasterRestart";
  MiniHBaseCluster cluster=createRegions(tableName);
  abortMaster(cluster);
  HRegionServer regionServer=cluster.getRegionServer(0);
  HRegion region=getRegionBeingServed(cluster,regionServer);
  zkw=HBaseTestingUtility.createAndForceNodeToOpenedState(TEST_UTIL,region,regionServer.getServerName());
  log("Starting up a new master");
  cluster.startMaster().getMaster();
  log("Waiting for master to be ready");
  cluster.waitForActiveAndReadyMaster();
  log("Master is ready");
  log("Waiting for no more RIT");
  ZKAssign.blockUntilNoRIT(zkw);
}
