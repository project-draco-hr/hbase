{
  final int NUM_MASTERS=1;
  final int NUM_RS=2;
  Configuration conf=HBaseConfiguration.create();
  conf.setInt("hbase.master.assignment.timeoutmonitor.period",2000);
  conf.setInt("hbase.master.assignment.timeoutmonitor.timeout",4000);
  HBaseTestingUtility TEST_UTIL=new HBaseTestingUtility(conf);
  TEST_UTIL.startMiniCluster(NUM_MASTERS,NUM_RS);
  MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
  log("Cluster started");
  ZooKeeperWatcher zkw=new ZooKeeperWatcher(TEST_UTIL.getConfiguration(),"unittest",new Abortable(){
    @Override public void abort(    String why,    Throwable e){
      LOG.error("Fatal ZK Error: " + why,e);
      org.junit.Assert.assertFalse("Fatal ZK error",true);
    }
  }
);
  List<MasterThread> masterThreads=cluster.getMasterThreads();
  assertEquals(1,masterThreads.size());
  assertTrue(cluster.waitForActiveAndReadyMaster());
  HMaster master=masterThreads.get(0).getMaster();
  assertTrue(master.isActiveMaster());
  assertTrue(master.isInitialized());
  master.balanceSwitch(false);
  byte[] FAMILY=Bytes.toBytes("family");
  byte[][] SPLIT_KEYS=new byte[][]{new byte[0],Bytes.toBytes("aaa"),Bytes.toBytes("bbb"),Bytes.toBytes("ccc"),Bytes.toBytes("ddd"),Bytes.toBytes("eee"),Bytes.toBytes("fff"),Bytes.toBytes("ggg"),Bytes.toBytes("hhh"),Bytes.toBytes("iii"),Bytes.toBytes("jjj")};
  byte[] enabledTable=Bytes.toBytes("enabledTable");
  HTableDescriptor htdEnabled=new HTableDescriptor(enabledTable);
  htdEnabled.addFamily(new HColumnDescriptor(FAMILY));
  FileSystem filesystem=FileSystem.get(conf);
  Path rootdir=filesystem.makeQualified(new Path(conf.get(HConstants.HBASE_DIR)));
  FSUtils.createTableDescriptor(filesystem,rootdir,htdEnabled);
  HRegionInfo hriEnabled=new HRegionInfo(htdEnabled.getName(),null,null);
  HRegion.createHRegion(hriEnabled,rootdir,conf,htdEnabled);
  List<HRegionInfo> enabledRegions=TEST_UTIL.createMultiRegionsInMeta(TEST_UTIL.getConfiguration(),htdEnabled,SPLIT_KEYS);
  byte[] disabledTable=Bytes.toBytes("disabledTable");
  HTableDescriptor htdDisabled=new HTableDescriptor(disabledTable);
  htdDisabled.addFamily(new HColumnDescriptor(FAMILY));
  FSUtils.createTableDescriptor(filesystem,rootdir,htdDisabled);
  HRegionInfo hriDisabled=new HRegionInfo(htdDisabled.getName(),null,null);
  HRegion.createHRegion(hriDisabled,rootdir,conf,htdDisabled);
  List<HRegionInfo> disabledRegions=TEST_UTIL.createMultiRegionsInMeta(TEST_UTIL.getConfiguration(),htdDisabled,SPLIT_KEYS);
  log("Regions in META have been created");
  assertEquals(2,cluster.countServedRegions());
  HRegionServer hrs=cluster.getRegionServer(0);
  HRegionServer hrsDead=cluster.getRegionServer(1);
  ServerName deadServerName=hrsDead.getServerName();
  List<HRegionInfo> enabledAndAssignedRegions=new ArrayList<HRegionInfo>();
  enabledAndAssignedRegions.add(enabledRegions.remove(0));
  enabledAndAssignedRegions.add(enabledRegions.remove(0));
  List<HRegionInfo> disabledAndAssignedRegions=new ArrayList<HRegionInfo>();
  disabledAndAssignedRegions.add(disabledRegions.remove(0));
  disabledAndAssignedRegions.add(disabledRegions.remove(0));
  for (  HRegionInfo hri : enabledAndAssignedRegions) {
    master.assignmentManager.regionPlans.put(hri.getEncodedName(),new RegionPlan(hri,null,hrs.getServerName()));
    master.assignRegion(hri);
  }
  for (  HRegionInfo hri : disabledAndAssignedRegions) {
    master.assignmentManager.regionPlans.put(hri.getEncodedName(),new RegionPlan(hri,null,hrs.getServerName()));
    master.assignRegion(hri);
  }
  List<HRegionInfo> enabledAndOnDeadRegions=new ArrayList<HRegionInfo>();
  enabledAndOnDeadRegions.add(enabledRegions.remove(0));
  enabledAndOnDeadRegions.add(enabledRegions.remove(0));
  List<HRegionInfo> disabledAndOnDeadRegions=new ArrayList<HRegionInfo>();
  disabledAndOnDeadRegions.add(disabledRegions.remove(0));
  disabledAndOnDeadRegions.add(disabledRegions.remove(0));
  for (  HRegionInfo hri : enabledAndOnDeadRegions) {
    master.assignmentManager.regionPlans.put(hri.getEncodedName(),new RegionPlan(hri,null,deadServerName));
    master.assignRegion(hri);
  }
  for (  HRegionInfo hri : disabledAndOnDeadRegions) {
    master.assignmentManager.regionPlans.put(hri.getEncodedName(),new RegionPlan(hri,null,deadServerName));
    master.assignRegion(hri);
  }
  log("Waiting for assignment to finish");
  ZKAssign.blockUntilNoRIT(zkw);
  log("Assignment completed");
  log("Aborting master");
  cluster.abortMaster(0);
  cluster.waitOnMaster(0);
  log("Master has aborted");
  List<HRegionInfo> regionsThatShouldBeOnline=new ArrayList<HRegionInfo>();
  List<HRegionInfo> regionsThatShouldBeOffline=new ArrayList<HRegionInfo>();
  log("Beginning to mock scenarios");
  ZKTable zktable=new ZKTable(zkw);
  zktable.setDisabledTable(Bytes.toString(disabledTable));
  HRegionInfo region=enabledAndOnDeadRegions.remove(0);
  regionsThatShouldBeOnline.add(region);
  ZKAssign.createNodeClosing(zkw,region,deadServerName);
  LOG.debug("\n\nRegion of enabled table was CLOSING on dead RS\n" + region + "\n\n");
  region=disabledAndOnDeadRegions.remove(0);
  regionsThatShouldBeOffline.add(region);
  ZKAssign.createNodeClosing(zkw,region,deadServerName);
  LOG.debug("\n\nRegion of disabled table was CLOSING on dead RS\n" + region + "\n\n");
  region=enabledAndOnDeadRegions.remove(0);
  regionsThatShouldBeOnline.add(region);
  int version=ZKAssign.createNodeClosing(zkw,region,deadServerName);
  ZKAssign.transitionNodeClosed(zkw,region,deadServerName,version);
  LOG.debug("\n\nRegion of enabled table was CLOSED on dead RS\n" + region + "\n\n");
  region=disabledAndOnDeadRegions.remove(0);
  regionsThatShouldBeOffline.add(region);
  version=ZKAssign.createNodeClosing(zkw,region,deadServerName);
  ZKAssign.transitionNodeClosed(zkw,region,deadServerName,version);
  LOG.debug("\n\nRegion of disabled table was CLOSED on dead RS\n" + region + "\n\n");
  region=enabledRegions.remove(0);
  regionsThatShouldBeOnline.add(region);
  ZKAssign.createNodeOffline(zkw,region,deadServerName);
  ZKAssign.transitionNodeOpening(zkw,region,deadServerName);
  LOG.debug("\n\nRegion of enabled table was OPENING on dead RS\n" + region + "\n\n");
  region=disabledRegions.remove(0);
  regionsThatShouldBeOffline.add(region);
  ZKAssign.createNodeOffline(zkw,region,deadServerName);
  ZKAssign.transitionNodeOpening(zkw,region,deadServerName);
  LOG.debug("\n\nRegion of disabled table was OPENING on dead RS\n" + region + "\n\n");
  region=enabledRegions.remove(0);
  regionsThatShouldBeOnline.add(region);
  ZKAssign.createNodeOffline(zkw,region,deadServerName);
  hrsDead.openRegion(region);
  while (true) {
    RegionTransitionData rtd=ZKAssign.getData(zkw,region.getEncodedName());
    if (rtd != null && rtd.getEventType() == EventType.RS_ZK_REGION_OPENED) {
      break;
    }
    Thread.sleep(100);
  }
  LOG.debug("\n\nRegion of enabled table was OPENED on dead RS\n" + region + "\n\n");
  region=disabledRegions.remove(0);
  regionsThatShouldBeOffline.add(region);
  ZKAssign.createNodeOffline(zkw,region,deadServerName);
  hrsDead.openRegion(region);
  while (true) {
    RegionTransitionData rtd=ZKAssign.getData(zkw,region.getEncodedName());
    if (rtd != null && rtd.getEventType() == EventType.RS_ZK_REGION_OPENED) {
      break;
    }
    Thread.sleep(100);
  }
  LOG.debug("\n\nRegion of disabled table was OPENED on dead RS\n" + region + "\n\n");
  region=enabledRegions.remove(0);
  regionsThatShouldBeOnline.add(region);
  ZKAssign.createNodeOffline(zkw,region,deadServerName);
  hrsDead.openRegion(region);
  while (true) {
    RegionTransitionData rtd=ZKAssign.getData(zkw,region.getEncodedName());
    if (rtd != null && rtd.getEventType() == EventType.RS_ZK_REGION_OPENED) {
      ZKAssign.deleteOpenedNode(zkw,region.getEncodedName());
      break;
    }
    Thread.sleep(100);
  }
  LOG.debug("\n\nRegion of enabled table was open at steady-state on dead RS" + "\n" + region + "\n\n");
  region=disabledRegions.remove(0);
  regionsThatShouldBeOffline.add(region);
  ZKAssign.createNodeOffline(zkw,region,deadServerName);
  hrsDead.openRegion(region);
  while (true) {
    RegionTransitionData rtd=ZKAssign.getData(zkw,region.getEncodedName());
    if (rtd != null && rtd.getEventType() == EventType.RS_ZK_REGION_OPENED) {
      ZKAssign.deleteOpenedNode(zkw,region.getEncodedName());
      break;
    }
    Thread.sleep(100);
  }
  LOG.debug("\n\nRegion of disabled table was open at steady-state on dead RS" + "\n" + region + "\n\n");
  log("Done mocking data up in ZK");
  log("Killing RS " + deadServerName);
  hrsDead.abort("Killing for unit test");
  log("RS " + deadServerName + " killed");
  log("Starting up a new master");
  master=cluster.startMaster().getMaster();
  log("Waiting for master to be ready");
  assertTrue(cluster.waitForActiveAndReadyMaster());
  log("Master is ready");
  region=enabledRegions.remove(0);
  regionsThatShouldBeOnline.add(region);
  master.assignmentManager.regionsInTransition.put(region.getEncodedName(),new RegionState(region,RegionState.State.PENDING_OPEN,0,null));
  ZKAssign.createNodeOffline(zkw,region,master.getServerName());
  region=disabledRegions.remove(0);
  regionsThatShouldBeOffline.add(region);
  master.assignmentManager.regionsInTransition.put(region.getEncodedName(),new RegionState(region,RegionState.State.PENDING_OPEN,0,null));
  ZKAssign.createNodeOffline(zkw,region,master.getServerName());
  log("Waiting for no more RIT");
  ZKAssign.blockUntilNoRIT(zkw);
  log("No more RIT in ZK");
  long now=System.currentTimeMillis();
  final long maxTime=120000;
  boolean done=master.assignmentManager.waitUntilNoRegionsInTransition(maxTime);
  if (!done) {
    LOG.info("rit=" + master.assignmentManager.getRegionsInTransition());
  }
  long elapsed=System.currentTimeMillis() - now;
  assertTrue("Elapsed=" + elapsed + ", maxTime="+ maxTime+ ", done="+ done,elapsed < maxTime);
  log("No more RIT in RIT map, doing final test verification");
  Set<HRegionInfo> onlineRegions=new TreeSet<HRegionInfo>();
  for (  JVMClusterUtil.RegionServerThread rst : cluster.getRegionServerThreads()) {
    try {
      onlineRegions.addAll(rst.getRegionServer().getOnlineRegions());
    }
 catch (    org.apache.hadoop.hbase.regionserver.RegionServerStoppedException e) {
      LOG.info("Got RegionServerStoppedException",e);
    }
  }
  for (  HRegionInfo hri : regionsThatShouldBeOnline) {
    assertTrue("region=" + hri.getRegionNameAsString(),onlineRegions.contains(hri));
  }
  for (  HRegionInfo hri : regionsThatShouldBeOffline) {
    assertFalse(onlineRegions.contains(hri));
  }
  log("Done with verification, all passed, shutting down cluster");
  TEST_UTIL.shutdownMiniCluster();
}
