{
  final int NUM_MASTERS=3;
  final int NUM_RS=3;
  Configuration conf=HBaseConfiguration.create();
  HBaseTestingUtility TEST_UTIL=new HBaseTestingUtility(conf);
  TEST_UTIL.startMiniCluster(NUM_MASTERS,NUM_RS);
  MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
  List<MasterThread> masterThreads=cluster.getMasterThreads();
  for (  MasterThread mt : masterThreads) {
    assertTrue(mt.isAlive());
  }
  int numActive=0;
  int activeIndex=-1;
  ServerName activeName=null;
  for (int i=0; i < masterThreads.size(); i++) {
    if (masterThreads.get(i).getMaster().isActiveMaster()) {
      numActive++;
      activeIndex=i;
      activeName=masterThreads.get(i).getMaster().getServerName();
    }
  }
  assertEquals(1,numActive);
  assertEquals(NUM_MASTERS,masterThreads.size());
  LOG.debug("\n\nStopping a backup master\n");
  int backupIndex=(activeIndex == 0 ? 1 : activeIndex - 1);
  cluster.stopMaster(backupIndex,false);
  cluster.waitOnMaster(backupIndex);
  for (int i=0; i < masterThreads.size(); i++) {
    if (masterThreads.get(i).getMaster().isActiveMaster()) {
      assertTrue(activeName.equals(masterThreads.get(i).getMaster().getServerName()));
      activeIndex=i;
    }
  }
  assertEquals(1,numActive);
  assertEquals(2,masterThreads.size());
  int rsCount=masterThreads.get(activeIndex).getMaster().getClusterStatus().getServersSize();
  LOG.info("Active master managing " + rsCount + " regions servers");
  assertEquals(3,rsCount);
  LOG.debug("\n\nStopping the active master\n");
  cluster.stopMaster(activeIndex,false);
  cluster.waitOnMaster(activeIndex);
  assertTrue(cluster.waitForActiveAndReadyMaster());
  LOG.debug("\n\nVerifying backup master is now active\n");
  assertEquals(1,masterThreads.size());
  HMaster active=masterThreads.get(0).getMaster();
  int rss=active.getClusterStatus().getServersSize();
  LOG.info("Active master managing " + rss + " regions servers");
  assertTrue(active.isActiveMaster());
  assertEquals(3,rss);
  TEST_UTIL.shutdownMiniCluster();
}
