{
  LOG.info("Starting testShouldCheckMasterFailOverWhenMETAIsInOpenedState");
  final int NUM_MASTERS=1;
  final int NUM_RS=2;
  Configuration conf=HBaseConfiguration.create();
  conf.setInt("hbase.master.assignment.timeoutmonitor.period",2000);
  conf.setInt("hbase.master.assignment.timeoutmonitor.timeout",8000);
  HBaseTestingUtility TEST_UTIL=new HBaseTestingUtility(conf);
  TEST_UTIL.startMiniCluster(NUM_MASTERS,NUM_RS);
  MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
  List<RegionServerThread> regionServerThreads=cluster.getRegionServerThreads();
  int count=-1;
  HRegion metaRegion=null;
  for (  RegionServerThread regionServerThread : regionServerThreads) {
    HRegionServer regionServer=regionServerThread.getRegionServer();
    metaRegion=regionServer.getOnlineRegion(HRegionInfo.FIRST_META_REGIONINFO.getRegionName());
    count++;
    regionServer.abort("");
    if (null != metaRegion)     break;
  }
  HRegionServer regionServer=cluster.getRegionServer(count);
  TEST_UTIL.shutdownMiniHBaseCluster();
  ZooKeeperWatcher zkw=HBaseTestingUtility.createAndForceNodeToOpenedState(TEST_UTIL,metaRegion,regionServer.getServerName());
  LOG.info("Staring cluster for second time");
  TEST_UTIL.startMiniHBaseCluster(NUM_MASTERS,NUM_RS);
  log("Waiting for no more RIT");
  ZKAssign.blockUntilNoRIT(zkw);
  zkw.close();
  TEST_UTIL.shutdownMiniCluster();
}
