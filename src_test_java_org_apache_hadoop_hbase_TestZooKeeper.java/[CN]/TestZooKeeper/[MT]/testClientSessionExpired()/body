{
  LOG.info("testClientSessionExpired");
  Configuration c=new Configuration(TEST_UTIL.getConfiguration());
  new HTable(c,HConstants.META_TABLE_NAME);
  String quorumServers=ZKConfig.getZKQuorumServersString(c);
  int sessionTimeout=5 * 1000;
  HConnection connection=HConnectionManager.getConnection(c);
  ZooKeeperWatcher connectionZK=connection.getZooKeeperWatcher();
  long sessionID=connectionZK.getRecoverableZooKeeper().getSessionId();
  byte[] password=connectionZK.getRecoverableZooKeeper().getSessionPasswd();
  ZooKeeper zk=new ZooKeeper(quorumServers,sessionTimeout,EmptyWatcher.instance,sessionID,password);
  LOG.info("Session timeout=" + zk.getSessionTimeout() + ", original="+ sessionTimeout+ ", id="+ zk.getSessionId());
  zk.close();
  Thread.sleep(sessionTimeout * 3L);
  ZKUtil.dump(connectionZK);
  System.err.println("ZooKeeper should have timed out");
  String state=connectionZK.getRecoverableZooKeeper().getState().toString();
  LOG.info("state=" + connectionZK.getRecoverableZooKeeper().getState());
  Assert.assertTrue(connectionZK.getRecoverableZooKeeper().getState().equals(States.CLOSED));
  ZooKeeperWatcher newConnectionZK=connection.getZooKeeperWatcher();
  LOG.info("state=" + newConnectionZK.getRecoverableZooKeeper().getState());
  Assert.assertTrue(newConnectionZK.getRecoverableZooKeeper().getState().equals(States.CONNECTED));
}
