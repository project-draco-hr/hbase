{
  long startTime=System.currentTimeMillis();
  IOException ioe;
  int reconnectAttempts=0;
  while (true) {
    try {
      return getProxy(protocol,clientVersion,addr,conf);
    }
 catch (    ConnectException se) {
      ioe=se;
      if (maxAttempts >= 0 && ++reconnectAttempts >= maxAttempts) {
        LOG.info("Server at " + addr + " could not be reached after "+ reconnectAttempts+ " tries, giving up.");
        throw new RetriesExhaustedException("Failed setting up proxy " + protocol + " to "+ addr.toString()+ " after attempts="+ reconnectAttempts,se);
      }
    }
catch (    SocketTimeoutException te) {
      LOG.info("Problem connecting to server: " + addr);
      ioe=te;
    }
    if (System.currentTimeMillis() - timeout >= startTime) {
      throw ioe;
    }
    try {
      Thread.sleep(1000);
    }
 catch (    InterruptedException ie) {
    }
  }
}
