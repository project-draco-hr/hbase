{
  LOG.info("Starting testShouldCheckMasterFailOverWhenMETAIsInOpenedState");
  final int NUM_MASTERS=1;
  final int NUM_RS=2;
  HBaseTestingUtility TEST_UTIL=new HBaseTestingUtility();
  Configuration conf=TEST_UTIL.getConfiguration();
  conf.setInt("hbase.master.info.port",-1);
  conf.setBoolean("hbase.assignment.usezk",true);
  TEST_UTIL.startMiniCluster(NUM_MASTERS,NUM_RS);
  MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
  HRegionServer regionServer=cluster.getMaster();
  HRegion metaRegion=regionServer.getOnlineRegion(HRegionInfo.FIRST_META_REGIONINFO.getRegionName());
  TEST_UTIL.shutdownMiniHBaseCluster();
  ZooKeeperWatcher zkw=HBaseTestingUtility.createAndForceNodeToOpenedState(TEST_UTIL,metaRegion,regionServer.getServerName());
  LOG.info("Staring cluster for second time");
  TEST_UTIL.startMiniHBaseCluster(NUM_MASTERS,NUM_RS);
  HMaster master=TEST_UTIL.getHBaseCluster().getMaster();
  while (!master.isInitialized()) {
    Thread.sleep(100);
  }
  log("Waiting for no more RIT");
  ZKAssign.blockUntilNoRIT(zkw);
  zkw.close();
  TEST_UTIL.shutdownMiniCluster();
}
