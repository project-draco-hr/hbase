{
  List<ToDoEntry> toDoList=new ArrayList<ToDoEntry>();
  Set<HRegionInfo> regions=new HashSet<HRegionInfo>();
  List<byte[]> emptyRows=new ArrayList<byte[]>();
  try {
    while (true) {
      RowResult values=null;
      try {
        values=server.next(scannerId);
      }
 catch (      IOException e) {
        LOG.error("Shutdown scanning of meta region",RemoteExceptionHandler.checkIOException(e));
        break;
      }
      if (values == null || values.size() == 0) {
        break;
      }
      byte[] row=values.getRow();
      String serverAddress=Writables.cellToString(values.get(COL_SERVER));
      long startCode=Writables.cellToLong(values.get(COL_STARTCODE));
      String serverName=null;
      if (serverAddress != null && serverAddress.length() > 0) {
        serverName=HServerInfo.getServerName(serverAddress,startCode);
      }
      if (serverName == null || !deadServer.equals(serverName)) {
        continue;
      }
      if (LOG.isDebugEnabled() && row != null) {
        LOG.debug("Shutdown scanner for " + serverName + " processing "+ Bytes.toString(row));
      }
      HRegionInfo info=master.getHRegionInfo(row,values);
      if (info == null) {
        emptyRows.add(row);
        continue;
      }
synchronized (master.regionManager) {
        if (info.isMetaTable()) {
          if (LOG.isDebugEnabled()) {
            LOG.debug("removing meta region " + Bytes.toString(info.getRegionName()) + " from online meta regions");
          }
          master.regionManager.offlineMetaRegion(info.getStartKey());
        }
        ToDoEntry todo=new ToDoEntry(row,info);
        toDoList.add(todo);
        if (master.regionManager.isOfflined(info.getRegionNameAsString()) || info.isOffline()) {
          master.regionManager.removeRegion(info);
          if (!info.isOffline()) {
            todo.regionOffline=true;
          }
        }
 else {
          if (!info.isOffline() && !info.isSplit()) {
            regions.add(info);
          }
        }
      }
    }
  }
  finally {
    if (scannerId != -1L) {
      try {
        server.close(scannerId);
      }
 catch (      IOException e) {
        LOG.error("Closing scanner",RemoteExceptionHandler.checkIOException(e));
      }
    }
  }
  if (emptyRows.size() > 0) {
    LOG.warn("Found " + emptyRows.size() + " rows with empty HRegionInfo while scanning meta region "+ Bytes.toString(regionName));
    master.deleteEmptyMetaRows(server,regionName,emptyRows);
  }
  for (  ToDoEntry e : toDoList) {
    if (e.regionOffline) {
      HRegion.offlineRegionInMETA(server,regionName,e.info);
    }
  }
  for (  HRegionInfo info : regions) {
    master.regionManager.setUnassigned(info,true);
  }
}
