{
  StripeStoreFileManager manager=createManager();
  StoreFile l0File=createFile(), l0File2=createFile();
  manager.insertNewFiles(al(l0File));
  manager.insertNewFiles(al(l0File2));
  Iterator<StoreFile> sfs=manager.getCandidateFilesForRowKeyBefore(KV_B);
  sfs.next();
  sfs.remove();
  sfs=manager.updateCandidateFilesForRowKeyBefore(sfs,KV_B,KV_A);
  assertTrue(sfs.hasNext());
  MockStoreFile stripe0a=createFile(0,100,OPEN_KEY,KEY_B), stripe1=createFile(KEY_B,OPEN_KEY);
  manager.addCompactionResults(al(l0File),al(stripe0a,stripe1));
  ArrayList<StoreFile> sfsDump=dumpIterator(manager.getCandidateFilesForRowKeyBefore(KV_A));
  assertEquals(2,sfsDump.size());
  assertTrue(sfsDump.contains(stripe0a));
  assertFalse(sfsDump.contains(stripe1));
  sfsDump=dumpIterator(manager.getCandidateFilesForRowKeyBefore(KV_B));
  assertEquals(3,sfsDump.size());
  assertTrue(sfsDump.contains(stripe1));
  sfsDump=dumpIterator(manager.getCandidateFilesForRowKeyBefore(KV_D));
  assertEquals(3,sfsDump.size());
  sfs=manager.getCandidateFilesForRowKeyBefore(KV_D);
  sfs.next();
  sfs.remove();
  sfs=manager.updateCandidateFilesForRowKeyBefore(sfs,KV_D,KV_C);
  assertEquals(stripe1,sfs.next());
  assertFalse(sfs.hasNext());
  StoreFile stripe0b=createFile(0,101,OPEN_KEY,KEY_B);
  manager.addCompactionResults(al(l0File2),al(stripe0b));
  sfs=manager.getCandidateFilesForRowKeyBefore(KV_A);
  assertEquals(stripe0b,sfs.next());
  sfs.remove();
  sfs=manager.updateCandidateFilesForRowKeyBefore(sfs,KV_A,KV_A);
  assertEquals(stripe0a,sfs.next());
}
