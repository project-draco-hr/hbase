{
  KeyValue firstKv=KeyValueUtil.createFirstOnRow(row,family,qualifier);
  SortedSet<KeyValue> snSs=snapshot.tailSet(firstKv);
  if (!snSs.isEmpty()) {
    KeyValue snKv=snSs.first();
    if (CellUtil.matchingRow(snKv,firstKv) && CellUtil.matchingQualifier(snKv,firstKv)) {
      if (snKv.getTimestamp() == now) {
        now+=1;
      }
    }
  }
  SortedSet<KeyValue> ss=kvset.tailSet(firstKv);
  for (  KeyValue kv : ss) {
    if (!CellUtil.matchingColumn(kv,family,qualifier) || !CellUtil.matchingRow(kv,firstKv)) {
      break;
    }
    if (kv.getTypeByte() == KeyValue.Type.Put.getCode() && kv.getTimestamp() > now && CellUtil.matchingQualifier(firstKv,kv)) {
      now=kv.getTimestamp();
    }
  }
  List<Cell> cells=new ArrayList<Cell>(1);
  cells.add(new KeyValue(row,family,qualifier,now,Bytes.toBytes(newValue)));
  return upsert(cells,1L);
}
