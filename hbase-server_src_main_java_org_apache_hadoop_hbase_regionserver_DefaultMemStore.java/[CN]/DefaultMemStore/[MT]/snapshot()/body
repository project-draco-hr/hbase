{
  if (!getSnapshot().isEmpty()) {
    LOG.warn("Snapshot called again without clearing previous. " + "Doing nothing. Another ongoing flush or did we fail last attempt?");
  }
 else {
    this.snapshotId=EnvironmentEdgeManager.currentTime();
    if (!getActive().isEmpty()) {
      ImmutableSegment immutableSegment=SegmentFactory.instance().createImmutableSegment(getActive());
      setSnapshot(immutableSegment);
      setSnapshotSize(keySize());
      resetCellSet();
    }
  }
  return new MemStoreSnapshot(this.snapshotId,getSnapshot());
}
