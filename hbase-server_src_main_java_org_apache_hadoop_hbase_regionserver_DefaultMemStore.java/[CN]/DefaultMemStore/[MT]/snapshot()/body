{
  if (!this.snapshot.isEmpty()) {
    LOG.warn("Snapshot called again without clearing previous. " + "Doing nothing. Another ongoing flush or did we fail last attempt?");
  }
 else {
    this.snapshotId=EnvironmentEdgeManager.currentTime();
    this.snapshotSize=keySize();
    if (!this.kvset.isEmpty()) {
      this.snapshot=this.kvset;
      this.kvset=new KeyValueSkipListSet(this.comparator);
      this.snapshotTimeRangeTracker=this.timeRangeTracker;
      this.timeRangeTracker=new TimeRangeTracker();
      this.size.set(DEEP_OVERHEAD);
      this.snapshotAllocator=this.allocator;
      if (allocator != null) {
        String className=conf.get(MSLAB_CLASS_NAME,HeapMemStoreLAB.class.getName());
        this.allocator=ReflectionUtils.instantiateWithCustomCtor(className,new Class[]{Configuration.class},new Object[]{conf});
      }
      timeOfOldestEdit=Long.MAX_VALUE;
    }
  }
  return new MemStoreSnapshot(this.snapshotId,snapshot.size(),this.snapshotSize,this.snapshotTimeRangeTracker,new CollectionBackedScanner(snapshot,this.comparator));
}
