{
  TEST_UTIL.startMiniZKCluster();
  TEST_UTIL.startMiniDFSCluster(1);
  Path testdir=TEST_UTIL.getDataTestDir("TestMetaMigrationConvertToPB");
  File untar=untar(new File(testdir.toString()));
  Configuration conf=TEST_UTIL.getConfiguration();
  FsShell shell=new FsShell(conf);
  FileSystem fs=FileSystem.get(conf);
  Path hbaseRootDir=TEST_UTIL.getDefaultRootDirPath();
  if (!fs.isDirectory(hbaseRootDir.getParent())) {
    fs.mkdirs(hbaseRootDir.getParent());
  }
  doFsCommand(shell,new String[]{"-put",untar.toURI().toString(),hbaseRootDir.toString()});
  doFsCommand(shell,new String[]{"-mv",new Path(hbaseRootDir,"-META-").toString(),new Path(hbaseRootDir,".META.").toString()});
  doFsCommand(shell,new String[]{"-lsr","/"});
  Configuration toolConf=TEST_UTIL.getConfiguration();
  conf.set(HConstants.HBASE_DIR,TEST_UTIL.getDefaultRootDirPath().toString());
  ToolRunner.run(toolConf,new NamespaceUpgrade(),new String[]{"--upgrade"});
  TEST_UTIL.startMiniHBaseCluster(1,1);
  HTable t=new HTable(TEST_UTIL.getConfiguration(),TESTTABLE);
  ResultScanner scanner=t.getScanner(new Scan());
  int count=0;
  while (scanner.next() != null) {
    count++;
  }
  Assert.assertEquals(ROW_COUNT,count);
  scanner.close();
  t.close();
}
