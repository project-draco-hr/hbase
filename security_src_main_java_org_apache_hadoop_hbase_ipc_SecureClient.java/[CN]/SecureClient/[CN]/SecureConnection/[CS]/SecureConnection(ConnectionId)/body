{
  super(remoteId);
  this.server=remoteId.getAddress();
  User ticket=remoteId.getTicket();
  Class<?> protocol=remoteId.getProtocol();
  this.useSasl=User.isSecurityEnabled();
  if (useSasl && protocol != null) {
    TokenInfo tokenInfo=protocol.getAnnotation(TokenInfo.class);
    if (tokenInfo != null) {
      TokenSelector<? extends TokenIdentifier> tokenSelector=tokenHandlers.get(tokenInfo.value());
      if (tokenSelector != null) {
        token=tokenSelector.selectToken(new Text(clusterId),ticket.getUGI().getTokens());
      }
 else       if (LOG.isDebugEnabled()) {
        LOG.debug("No token selector found for type " + tokenInfo.value());
      }
    }
    KerberosInfo krbInfo=protocol.getAnnotation(KerberosInfo.class);
    if (krbInfo != null) {
      String serverKey=krbInfo.serverPrincipal();
      if (serverKey == null) {
        throw new IOException("Can't obtain server Kerberos config key from KerberosInfo");
      }
      serverPrincipal=SecurityUtil.getServerPrincipal(conf.get(serverKey),server.getAddress().getCanonicalHostName().toLowerCase());
      if (LOG.isDebugEnabled()) {
        LOG.debug("RPC Server Kerberos principal name for protocol=" + protocol.getCanonicalName() + " is "+ serverPrincipal);
      }
    }
  }
  if (!useSasl) {
    authMethod=AuthMethod.SIMPLE;
  }
 else   if (token != null) {
    authMethod=AuthMethod.DIGEST;
  }
 else {
    authMethod=AuthMethod.KERBEROS;
  }
  header=new SecureConnectionHeader(protocol == null ? null : protocol.getName(),ticket,authMethod);
  if (LOG.isDebugEnabled())   LOG.debug("Use " + authMethod + " authentication for protocol "+ protocol.getSimpleName());
  reloginMaxBackoff=conf.getInt("hbase.security.relogin.maxbackoff",5000);
}
