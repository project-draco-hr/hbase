{
  HTable table=null;
  try {
    TableName tableName=TableName.valueOf("testFlushAndCompactionWithoutTags");
    byte[] fam=Bytes.toBytes("info");
    byte[] row=Bytes.toBytes("rowa");
    byte[] qual=Bytes.toBytes("qual");
    byte[] row1=Bytes.toBytes("rowb");
    byte[] row2=Bytes.toBytes("rowc");
    HTableDescriptor desc=new HTableDescriptor(tableName);
    HColumnDescriptor colDesc=new HColumnDescriptor(fam);
    colDesc.setBlockCacheEnabled(true);
    colDesc.setDataBlockEncoding(DataBlockEncoding.PREFIX_TREE);
    desc.addFamily(colDesc);
    HBaseAdmin admin=TEST_UTIL.getHBaseAdmin();
    admin.createTable(desc);
    table=new HTable(TEST_UTIL.getConfiguration(),tableName);
    Put put=new Put(row);
    byte[] value=Bytes.toBytes("value");
    put.add(fam,qual,HConstants.LATEST_TIMESTAMP,value);
    table.put(put);
    admin.flush(tableName.getName());
    List<HRegion> regions=TEST_UTIL.getHBaseCluster().getRegions(tableName.getName());
    for (    HRegion region : regions) {
      Store store=region.getStore(fam);
      while (!(store.getStorefilesCount() > 0)) {
        Thread.sleep(10);
      }
    }
    Put put1=new Put(row1);
    byte[] value1=Bytes.toBytes("1000dfsdf");
    put1.add(fam,qual,HConstants.LATEST_TIMESTAMP,value1);
    table.put(put1);
    admin.flush(tableName.getName());
    regions=TEST_UTIL.getHBaseCluster().getRegions(tableName.getName());
    for (    HRegion region : regions) {
      Store store=region.getStore(fam);
      while (!(store.getStorefilesCount() > 1)) {
        Thread.sleep(10);
      }
    }
    Put put2=new Put(row2);
    byte[] value2=Bytes.toBytes("1000dfsdf");
    put2.add(fam,qual,HConstants.LATEST_TIMESTAMP,value2);
    table.put(put2);
    admin.flush(tableName.getName());
    regions=TEST_UTIL.getHBaseCluster().getRegions(tableName.getName());
    for (    HRegion region : regions) {
      Store store=region.getStore(fam);
      while (!(store.getStorefilesCount() > 2)) {
        Thread.sleep(10);
      }
    }
    Scan s=new Scan(row);
    ResultScanner scanner=table.getScanner(s);
    try {
      Result[] next=scanner.next(3);
      for (      Result result : next) {
        CellScanner cellScanner=result.cellScanner();
        boolean advance=cellScanner.advance();
        KeyValue current=(KeyValue)cellScanner.current();
        assertTrue(current.getValueOffset() + current.getValueLength() == current.getLength());
      }
    }
  finally {
      if (scanner != null)       scanner.close();
    }
    admin.compact(tableName.getName());
    while (admin.getCompactionState(tableName.getName()) != CompactionState.NONE) {
      Thread.sleep(10);
    }
    s=new Scan(row);
    scanner=table.getScanner(s);
    try {
      Result[] next=scanner.next(3);
      for (      Result result : next) {
        CellScanner cellScanner=result.cellScanner();
        boolean advance=cellScanner.advance();
        KeyValue current=(KeyValue)cellScanner.current();
        assertTrue(current.getValueOffset() + current.getValueLength() == current.getLength());
      }
    }
  finally {
      if (scanner != null) {
        scanner.close();
      }
    }
  }
  finally {
    if (table != null) {
      table.close();
    }
  }
}
