{
  MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
  cluster.startRegionServer();
  HMaster m=cluster.getMaster();
  ZooKeeperWatcher zkw=m.getZooKeeperWatcher();
  int expectedNumOfListeners=zkw.getNumberOfListeners();
  HBaseAdmin admin=new HBaseAdmin(TEST_UTIL.getConfiguration());
  try {
    byte[][] SPLIT_KEYS=new byte[][]{Bytes.toBytes("a"),Bytes.toBytes("b"),Bytes.toBytes("c"),Bytes.toBytes("d"),Bytes.toBytes("e"),Bytes.toBytes("f"),Bytes.toBytes("g"),Bytes.toBytes("h"),Bytes.toBytes("i"),Bytes.toBytes("j")};
    String tableName="testRegionAssignmentAfterMasterRecoveryDueToZKExpiry";
    admin.createTable(new HTableDescriptor(tableName),SPLIT_KEYS);
    ZooKeeperWatcher zooKeeperWatcher=HBaseTestingUtility.getZooKeeperWatcher(TEST_UTIL);
    ZKAssign.blockUntilNoRIT(zooKeeperWatcher);
    m.getZooKeeperWatcher().close();
    MockLoadBalancer.retainAssignCalled=false;
    m.abort("Test recovery from zk session expired",new KeeperException.SessionExpiredException());
    assertFalse(m.isStopped());
    assertFalse("Retain assignment should not be called",MockLoadBalancer.retainAssignCalled);
  }
  finally {
    admin.close();
  }
}
