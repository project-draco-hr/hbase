{
  Configuration conf=UTIL.getConfiguration();
  conf.setInt("hbase.hstore.compaction.min",2);
  UTIL.startMiniCluster();
  String tableName="testRegionObserverCompactionTimeStacking";
  byte[] ROW=Bytes.toBytes("testRow");
  byte[] A=Bytes.toBytes("A");
  HTableDescriptor desc=new HTableDescriptor(tableName);
  desc.addFamily(new HColumnDescriptor(A));
  desc.addCoprocessor(EmptyRegionObsever.class.getName(),null,Coprocessor.PRIORITY_USER,null);
  desc.addCoprocessor(NoDataFromCompaction.class.getName(),null,Coprocessor.PRIORITY_HIGHEST,null);
  HBaseAdmin admin=UTIL.getHBaseAdmin();
  admin.createTable(desc);
  HTable table=new HTable(conf,desc.getName());
  Put put=new Put(ROW);
  put.add(A,A,A);
  table.put(put);
  table.flushCommits();
  HRegionServer rs=UTIL.getRSForFirstRegionInTable(desc.getName());
  List<HRegion> regions=rs.getOnlineRegions(desc.getName());
  assertEquals("More than 1 region serving test table with 1 row",1,regions.size());
  HRegion region=regions.get(0);
  admin.flush(region.getRegionName());
  put=new Put(Bytes.toBytes("anotherrow"));
  put.add(A,A,A);
  table.put(put);
  table.flushCommits();
  admin.flush(region.getRegionName());
  Store s=region.getStores().get(A);
  CountDownLatch latch=new CountDownLatch(1);
  WaitableCompactionRequest request=new WaitableCompactionRequest(s.getStorefiles(),latch);
  rs.compactSplitThread.requestCompaction(region,s,"compact for testRegionObserverCompactionTimeStacking",Store.PRIORITY_USER,request);
  latch.await();
  Get get=new Get(ROW);
  Result r=table.get(get);
  assertNull("Got an unexpected number of rows - no data should be returned with the NoDataFromScan coprocessor. Found: " + r,r.list());
  get=new Get(Bytes.toBytes("anotherrow"));
  r=table.get(get);
  assertNull("Got an unexpected number of rows - no data should be returned with the NoDataFromScan coprocessor Found: " + r,r.list());
  table.close();
  UTIL.shutdownMiniCluster();
}
