{
  final String threadName="HMaster";
  Thread.currentThread().setName(threadName);
  verifyClusterState();
  startServiceThreads();
  try {
    while (!closed.get()) {
      if (shutdownRequested.get()) {
        regionManager.stopScanners();
        if (serverManager.numServers() == 0) {
          startShutdown();
          break;
        }
      }
      if (!processToDoQueue()) {
        break;
      }
    }
  }
 catch (  Throwable t) {
    LOG.fatal("Unhandled exception. Starting shutdown.",t);
    closed.set(true);
  }
  serverManager.letRegionServersShutdown();
  RegionHistorian.getInstance().offline();
  if (this.infoServer != null) {
    LOG.info("Stopping infoServer");
    try {
      this.infoServer.stop();
    }
 catch (    Exception ex) {
      ex.printStackTrace();
    }
  }
  server.stop();
  regionManager.stop();
  zooKeeperWrapper.close();
  LOG.info("HMaster main thread exiting");
}
