{
  final String threadName="HMaster";
  Thread.currentThread().setName(threadName);
  startServiceThreads();
  try {
    while (!closed.get()) {
      if (shutdownRequested && serverManager.numServers() == 0) {
        startShutdown();
        break;
      }
      if (!processToDoQueue()) {
        break;
      }
    }
  }
 catch (  Throwable t) {
    LOG.fatal("Unhandled exception. Starting shutdown.",t);
    closed.set(true);
  }
  regionManager.stopScanners();
  serverManager.letRegionServersShutdown();
  RegionHistorian.getInstance().offline();
  if (this.infoServer != null) {
    LOG.info("Stopping infoServer");
    try {
      this.infoServer.stop();
    }
 catch (    InterruptedException ex) {
      ex.printStackTrace();
    }
  }
  server.stop();
  regionManager.stop();
  LOG.info("HMaster main thread exiting");
}
