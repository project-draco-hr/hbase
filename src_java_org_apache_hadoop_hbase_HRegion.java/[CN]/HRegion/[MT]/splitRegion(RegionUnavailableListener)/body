{
  Text midKey=new Text();
  if (!needsSplit(midKey)) {
    return null;
  }
  long startTime=System.currentTimeMillis();
  Path splits=getSplitsDir();
  HRegionInfo regionAInfo=new HRegionInfo(this.regionInfo.getTableDesc(),this.regionInfo.getStartKey(),midKey);
  Path dirA=getSplitRegionDir(splits,HRegionInfo.encodeRegionName(regionAInfo.getRegionName()));
  if (fs.exists(dirA)) {
    throw new IOException("Cannot split; target file collision at " + dirA);
  }
  HRegionInfo regionBInfo=new HRegionInfo(this.regionInfo.getTableDesc(),midKey,null);
  Path dirB=getSplitRegionDir(splits,HRegionInfo.encodeRegionName(regionBInfo.getRegionName()));
  if (this.fs.exists(dirB)) {
    throw new IOException("Cannot split; target file collision at " + dirB);
  }
  if (listener != null) {
    listener.closing(getRegionName());
  }
  List<HStoreFile> hstoreFilesToSplit=close();
  if (hstoreFilesToSplit == null) {
    LOG.warn("Close came back null (Implement abort of close?)");
    throw new RuntimeException("close returned empty vector of HStoreFiles");
  }
  if (listener != null) {
    listener.closed(this.getRegionName());
  }
  for (  HStoreFile h : hstoreFilesToSplit) {
    HStoreFile.Reference aReference=new HStoreFile.Reference(this.encodedRegionName,h.getFileId(),new HStoreKey(midKey),HStoreFile.Range.bottom);
    HStoreFile a=new HStoreFile(this.conf,splits,HRegionInfo.encodeRegionName(regionAInfo.getRegionName()),h.getColFamily(),Math.abs(rand.nextLong()),aReference);
    HStoreFile.Reference bReference=new HStoreFile.Reference(this.encodedRegionName,h.getFileId(),new HStoreKey(midKey),HStoreFile.Range.top);
    HStoreFile b=new HStoreFile(this.conf,splits,HRegionInfo.encodeRegionName(regionBInfo.getRegionName()),h.getColFamily(),Math.abs(rand.nextLong()),bReference);
    h.splitStoreFile(a,b,this.fs);
  }
  HRegion regionA=new HRegion(rootDir,log,fs,conf,regionAInfo,dirA,null);
  HRegion regionB=new HRegion(rootDir,log,fs,conf,regionBInfo,dirB,null);
  boolean deleted=fs.delete(splits);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Cleaned up " + splits.toString() + " "+ deleted);
  }
  HRegion regions[]=new HRegion[]{regionA,regionB};
  LOG.info("Region split of " + this.regionInfo.getRegionName() + " complete; "+ "new regions: "+ regions[0].getRegionName()+ ", "+ regions[1].getRegionName()+ ". Split took "+ StringUtils.formatTimeDiff(System.currentTimeMillis(),startTime));
  return regions;
}
