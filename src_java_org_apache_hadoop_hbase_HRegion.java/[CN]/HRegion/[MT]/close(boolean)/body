{
  if (isClosed()) {
    LOG.info("region " + this.regionInfo.regionName + " already closed");
    return new Vector<HStoreFile>();
  }
  lock.obtainWriteLock();
  try {
    boolean shouldClose=false;
synchronized (writestate) {
      while (writestate.writesOngoing) {
        try {
          writestate.wait();
        }
 catch (        InterruptedException iex) {
        }
      }
      writestate.writesOngoing=true;
      shouldClose=true;
    }
    if (!shouldClose) {
      return null;
    }
    LOG.info("closing region " + this.regionInfo.regionName);
    waitOnRowLocks();
    Vector<HStoreFile> allHStoreFiles=null;
    if (!abort) {
      allHStoreFiles=internalFlushcache();
    }
    for (    HStore store : stores.values()) {
      store.close();
    }
    try {
      return allHStoreFiles;
    }
  finally {
synchronized (writestate) {
        writestate.writesOngoing=false;
      }
      this.closed.set(true);
      LOG.info("region " + this.regionInfo.regionName + " closed");
    }
  }
  finally {
    lock.releaseWriteLock();
  }
}
