{
  Text regionName=this.regionInfo.getRegionName();
  if (isClosed()) {
    LOG.info("region " + regionName + " already closed");
    return null;
  }
synchronized (splitLock) {
synchronized (writestate) {
      while (writestate.compacting || writestate.flushing) {
        LOG.debug("waiting for" + (writestate.compacting ? " compaction" : "") + (writestate.flushing ? (writestate.compacting ? "," : "") + " cache flush" : "")+ " to complete for region "+ regionName);
        try {
          writestate.wait();
        }
 catch (        InterruptedException iex) {
        }
      }
      writestate.writesEnabled=false;
      LOG.debug("compactions and cache flushes disabled for region " + regionName);
    }
    lock.writeLock().lock();
    LOG.debug("new updates and scanners for region " + regionName + " disabled");
    try {
synchronized (activeScannerCount) {
        while (activeScannerCount.get() != 0) {
          LOG.debug("waiting for " + activeScannerCount.get() + " scanners to finish");
          try {
            activeScannerCount.wait();
          }
 catch (          InterruptedException e) {
          }
        }
      }
      LOG.debug("no more active scanners for region " + regionName);
      waitOnRowLocks();
      LOG.debug("no more row locks outstanding on region " + regionName);
      if (listener != null) {
        listener.closing(getRegionName());
      }
      if (!abort) {
        internalFlushcache(snapshotMemcaches());
      }
      List<HStoreFile> result=new ArrayList<HStoreFile>();
      for (      HStore store : stores.values()) {
        result.addAll(store.close());
      }
      this.closed.set(true);
      if (listener != null) {
        listener.closed(getRegionName());
      }
      LOG.info("closed " + this.regionInfo.getRegionName());
      return result;
    }
  finally {
      lock.writeLock().unlock();
    }
  }
}
