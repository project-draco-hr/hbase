{
  long startTime=-1;
  if (LOG.isDebugEnabled()) {
    startTime=System.currentTimeMillis();
    LOG.debug("Started memcache flush for region " + this.regionInfo.getRegionName() + ". Size "+ StringUtils.humanReadableInt(this.memcache.getSize()));
  }
  HMemcache.Snapshot retval=memcache.snapshotMemcacheForLog(log);
  if (retval == null || retval.memcacheSnapshot == null) {
    LOG.debug("Finished memcache flush; empty snapshot");
    return;
  }
  try {
    long logCacheFlushId=retval.sequenceId;
    if (LOG.isDebugEnabled()) {
      LOG.debug("Snapshotted memcache for region " + this.regionInfo.getRegionName() + " with sequence id "+ retval.sequenceId+ " and entries "+ retval.memcacheSnapshot.size());
    }
    try {
      for (      HStore hstore : stores.values()) {
        hstore.flushCache(retval.memcacheSnapshot,retval.sequenceId);
      }
    }
 catch (    IOException e) {
      this.log.abortCacheFlush();
      throw new DroppedSnapshotException(e.getMessage());
    }
    this.log.completeCacheFlush(this.regionInfo.getRegionName(),regionInfo.getTableDesc().getName(),logCacheFlushId);
  }
  finally {
    this.memcache.deleteSnapshot();
  }
synchronized (this) {
    notifyAll();
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Finished memcache flush for region " + this.regionInfo.getRegionName() + " in "+ (System.currentTimeMillis() - startTime)+ "ms");
  }
}
