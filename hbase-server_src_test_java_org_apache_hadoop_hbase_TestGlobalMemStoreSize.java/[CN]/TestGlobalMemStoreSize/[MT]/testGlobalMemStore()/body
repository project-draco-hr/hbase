{
  LOG.info("Starting cluster");
  Configuration conf=HBaseConfiguration.create();
  conf.setInt("hbase.master.assignment.timeoutmonitor.period",2000);
  conf.setInt("hbase.master.assignment.timeoutmonitor.timeout",5000);
  TEST_UTIL=new HBaseTestingUtility(conf);
  TEST_UTIL.startMiniCluster(1,regionServerNum);
  cluster=TEST_UTIL.getHBaseCluster();
  LOG.info("Waiting for active/ready master");
  cluster.waitForActiveAndReadyMaster();
  byte[] table=Bytes.toBytes("TestGlobalMemStoreSize");
  byte[] family=Bytes.toBytes("family");
  LOG.info("Creating table with " + regionNum + " regions");
  HTable ht=TEST_UTIL.createTable(table,family);
  int numRegions=TEST_UTIL.createMultiRegions(conf,ht,family,regionNum);
  assertEquals(regionNum,numRegions);
  waitForAllRegionsAssigned();
  for (  HRegionServer server : getOnlineRegionServers()) {
    long globalMemStoreSize=0;
    for (    HRegionInfo regionInfo : ProtobufUtil.getOnlineRegions(server.getRSRpcServices())) {
      globalMemStoreSize+=server.getFromOnlineRegions(regionInfo.getEncodedName()).getMemstoreSize().get();
    }
    assertEquals(server.getRegionServerAccounting().getGlobalMemstoreSize(),globalMemStoreSize);
  }
  int i=0;
  for (  HRegionServer server : getOnlineRegionServers()) {
    LOG.info("Starting flushes on " + server.getServerName() + ", size="+ server.getRegionServerAccounting().getGlobalMemstoreSize());
    for (    HRegionInfo regionInfo : ProtobufUtil.getOnlineRegions(server.getRSRpcServices())) {
      HRegion r=server.getFromOnlineRegions(regionInfo.getEncodedName());
      flush(r,server);
    }
    LOG.info("Post flush on " + server.getServerName());
    long now=System.currentTimeMillis();
    long timeout=now + 1000;
    while (server.getRegionServerAccounting().getGlobalMemstoreSize() != 0 && timeout < System.currentTimeMillis()) {
      Threads.sleep(10);
    }
    long size=server.getRegionServerAccounting().getGlobalMemstoreSize();
    if (size > 0) {
      for (      HRegionInfo regionInfo : ProtobufUtil.getOnlineRegions(server.getRSRpcServices())) {
        HRegion r=server.getFromOnlineRegions(regionInfo.getEncodedName());
        long l=r.getMemstoreSize().longValue();
        if (l > 0) {
          assertTrue(regionInfo.isMetaRegion());
          LOG.info(r.toString() + " " + l+ ", reflushing");
          r.flushcache();
        }
      }
    }
    size=server.getRegionServerAccounting().getGlobalMemstoreSize();
    assertEquals("Server=" + server.getServerName() + ", i="+ i++,0,size);
  }
  ht.close();
  TEST_UTIL.shutdownMiniCluster();
}
