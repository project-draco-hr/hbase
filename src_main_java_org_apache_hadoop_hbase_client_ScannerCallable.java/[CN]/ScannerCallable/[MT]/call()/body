{
  if (closed) {
    if (scannerId != -1) {
      close();
    }
  }
 else {
    if (scannerId == -1L) {
      this.scannerId=openScanner();
    }
 else {
      Result[] rrs=null;
      try {
        incRPCcallsMetrics();
        ScanRequest request=RequestConverter.buildScanRequest(scannerId,caching,false);
        try {
          ScanResponse response=server.scan(null,request);
          rrs=ResponseConverter.getResults(response);
          if (response.hasMoreResults() && !response.getMoreResults()) {
            scannerId=-1L;
            closed=true;
            return null;
          }
        }
 catch (        ServiceException se) {
          throw ProtobufUtil.getRemoteException(se);
        }
        updateResultsMetrics(rrs);
      }
 catch (      IOException e) {
        IOException ioe=e;
        if (e instanceof RemoteException) {
          ioe=RemoteExceptionHandler.decodeRemoteException((RemoteException)e);
        }
        if (ioe instanceof NotServingRegionException) {
          if (this.scanMetrics != null) {
            this.scanMetrics.countOfNSRE.inc();
          }
          throw new DoNotRetryIOException("Reset scanner",ioe);
        }
 else         if (ioe instanceof RegionServerStoppedException) {
          throw new DoNotRetryIOException("Reset scanner",ioe);
        }
 else {
          throw ioe;
        }
      }
      return rrs;
    }
  }
  return null;
}
