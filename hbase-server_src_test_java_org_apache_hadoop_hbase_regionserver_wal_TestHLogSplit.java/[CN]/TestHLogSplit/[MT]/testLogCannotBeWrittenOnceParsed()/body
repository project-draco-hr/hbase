{
  final AtomicLong counter=new AtomicLong(0);
  AtomicBoolean stop=new AtomicBoolean(false);
  final String region=REGIONS.get(0);
  Thread zombie=new ZombieLastLogWriterRegionServer(this.conf,counter,stop,region);
  try {
    long startCount=counter.get();
    zombie.start();
    while (startCount == counter.get())     Threads.sleep(1);
    Threads.sleep(1000);
    final Configuration conf2=HBaseConfiguration.create(this.conf);
    final User robber=User.createUserForTesting(conf2,ROBBER,GROUP);
    int count=robber.runAs(new PrivilegedExceptionAction<Integer>(){
      @Override public Integer run() throws Exception {
        FileSystem fs=FileSystem.get(conf2);
        HLogSplitter logSplitter=HLogSplitter.createLogSplitter(conf2,HBASEDIR,HLOGDIR,OLDLOGDIR,fs);
        logSplitter.splitLog();
        Path logfile=getLogForRegion(HBASEDIR,TABLE_NAME,region);
        return countHLog(logfile,fs,conf2);
      }
    }
);
    LOG.info("zombie=" + counter.get() + ", robber="+ count);
    assertTrue("The log file could have at most 1 extra log entry, but can't have less. Zombie could write " + counter.get() + " and logfile had only "+ count,counter.get() == count || counter.get() + 1 == count);
  }
  finally {
    stop.set(true);
    zombie.interrupt();
    Threads.threadDumpingIsAlive(zombie);
  }
}
