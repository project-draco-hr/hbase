{
  conf.setBoolean(HBASE_SKIP_ERRORS,false);
  generateHLogs(-1);
  fs.initialize(fs.getUri(),conf);
  FileStatus[] logfiles=fs.listStatus(HLOGDIR);
  assertTrue("There should be some log file",logfiles != null && logfiles.length > 0);
  HLogSplitter logSplitter=new HLogSplitter(conf,HBASEDIR,fs,null,null,null){
    protected HLog.Writer createWriter(    FileSystem fs,    Path logfile,    Configuration conf) throws IOException {
      HLog.Writer mockWriter=Mockito.mock(HLog.Writer.class);
      Mockito.doThrow(new IOException("Injected")).when(mockWriter).append(Mockito.<HLog.Entry>any());
      return mockWriter;
    }
  }
;
  final AtomicBoolean stop=new AtomicBoolean(false);
  final Thread someOldThread=new Thread("Some-old-thread"){
    @Override public void run(){
      while (!stop.get())       Threads.sleep(10);
    }
  }
;
  someOldThread.setDaemon(true);
  someOldThread.start();
  final Thread t=new Thread("Background-thread-dumper"){
    public void run(){
      try {
        Threads.threadDumpingIsAlive(someOldThread);
      }
 catch (      InterruptedException e) {
        e.printStackTrace();
      }
    }
  }
;
  t.setDaemon(true);
  t.start();
  try {
    logSplitter.splitLogFile(logfiles[0],null);
    fail("Didn't throw!");
  }
 catch (  IOException ioe) {
    assertTrue(ioe.toString().contains("Injected"));
  }
 finally {
    stop.set(true);
  }
}
