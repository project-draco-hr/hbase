{
  HServerInfo info=new HServerInfo(serverInfo);
  if (isDead(info.getServerName())) {
    throw new Leases.LeaseStillHeldException(info.getServerName());
  }
  if (msgs.length > 0) {
    if (msgs[0].isType(HMsg.Type.MSG_REPORT_EXITING)) {
      processRegionServerExit(info,msgs);
      return EMPTY_HMSG_ARRAY;
    }
 else     if (msgs[0].isType(HMsg.Type.MSG_REPORT_QUIESCED)) {
      LOG.info("Region server " + info.getServerName() + " quiesced");
      quiescedServers.incrementAndGet();
    }
  }
  if (master.shutdownRequested.get()) {
    if (quiescedServers.get() >= serversToServerInfo.size()) {
      LOG.info("All user tables quiesced. Proceeding with shutdown");
      master.startShutdown();
    }
    if (!master.closed.get()) {
      if (msgs.length > 0 && msgs[0].isType(HMsg.Type.MSG_REPORT_QUIESCED)) {
        return EMPTY_HMSG_ARRAY;
      }
      return new HMsg[]{REGIONSERVER_QUIESCE};
    }
  }
  if (master.closed.get()) {
    return new HMsg[]{REGIONSERVER_STOP};
  }
  HServerInfo storedInfo=serversToServerInfo.get(info.getServerName());
  if (storedInfo == null) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("received server report from unknown server: " + info.getServerName());
    }
    return new HMsg[]{CALL_SERVER_STARTUP};
  }
 else   if (storedInfo.getStartCode() != info.getStartCode()) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("region server race condition detected: " + info.getServerName());
    }
synchronized (serversToServerInfo) {
      removeServerInfo(info.getServerName());
      serversToServerInfo.notifyAll();
    }
    return new HMsg[]{REGIONSERVER_STOP};
  }
 else {
    return processRegionServerAllsWell(info,mostLoadedRegions,msgs);
  }
}
