{
  ArrayList<HMsg> returnMsgs=new ArrayList<HMsg>();
  Map<Text,HRegionInfo> regionsToKill=master.regionManager.getMarkedClosedNoReopen(serverName);
  for (int i=0; i < incomingMsgs.length; i++) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Received " + incomingMsgs[i].toString() + " from "+ serverName);
    }
    HRegionInfo region=incomingMsgs[i].getRegionInfo();
switch (incomingMsgs[i].getMsg()) {
case HMsg.MSG_REPORT_PROCESS_OPEN:
      master.regionManager.updateAssignmentDeadline(region);
    break;
case HMsg.MSG_REPORT_OPEN:
  processRegionOpen(serverName,serverInfo,incomingMsgs[i].getRegionInfo(),returnMsgs);
break;
case HMsg.MSG_REPORT_CLOSE:
LOG.info(serverInfo.getServerAddress().toString() + " no longer serving " + region.getRegionName());
if (region.isRootRegion()) {
if (region.isOffline()) {
LOG.fatal("root region is marked offline");
master.shutdown();
}
master.regionManager.unassignRootRegion();
}
 else {
boolean reassignRegion=!region.isOffline();
boolean deleteRegion=false;
if (master.regionManager.isClosing(region.getRegionName())) {
master.regionManager.noLongerClosing(region.getRegionName());
reassignRegion=false;
}
if (master.regionManager.isMarkedForDeletion(region.getRegionName())) {
master.regionManager.regionDeleted(region.getRegionName());
reassignRegion=false;
deleteRegion=true;
}
if (region.isMetaTable()) {
master.regionManager.offlineMetaRegion(region.getStartKey());
}
master.regionManager.noLongerUnassigned(region);
try {
master.toDoQueue.put(new ProcessRegionClose(master,region,reassignRegion,deleteRegion));
}
 catch (InterruptedException e) {
throw new RuntimeException("Putting into toDoQueue was interrupted.",e);
}
}
break;
case HMsg.MSG_REPORT_SPLIT:
processSplitRegion(serverName,serverInfo,region,incomingMsgs[++i],incomingMsgs[++i],returnMsgs);
break;
default :
throw new IOException("Impossible state during msg processing.  Instruction: " + incomingMsgs[i].getMsg());
}
}
if (regionsToKill != null) {
for (HRegionInfo i : regionsToKill.values()) {
returnMsgs.add(new HMsg(HMsg.MSG_REGION_CLOSE,i));
master.regionManager.setClosing(i.getRegionName());
}
}
master.regionManager.assignRegions(serverInfo,serverName,returnMsgs);
return returnMsgs.toArray(new HMsg[returnMsgs.size()]);
}
