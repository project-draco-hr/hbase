{
  long now=System.currentTimeMillis();
  long elapsed=now - lastUpdated;
  lastUpdated=now;
  tokens+=elapsed * rate;
  if (tokens > size) {
    tokens=size;
  }
  return tokens;
}
