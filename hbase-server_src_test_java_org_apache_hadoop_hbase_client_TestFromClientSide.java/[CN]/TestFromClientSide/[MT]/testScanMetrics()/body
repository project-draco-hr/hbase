{
  TableName TABLENAME=TableName.valueOf("testScanMetrics");
  HTable ht=TEST_UTIL.createMultiRegionTable(TABLENAME,FAMILY);
  int numOfRegions=-1;
  try (RegionLocator r=ht.getRegionLocator()){
    numOfRegions=r.getStartKeys().length;
  }
   Put put1=new Put(Bytes.toBytes("zzz1"));
  put1.add(FAMILY,QUALIFIER,VALUE);
  Put put2=new Put(Bytes.toBytes("zzz2"));
  put2.add(FAMILY,QUALIFIER,VALUE);
  Put put3=new Put(Bytes.toBytes("zzz3"));
  put3.add(FAMILY,QUALIFIER,VALUE);
  ht.put(Arrays.asList(put1,put2,put3));
  Scan scan1=new Scan();
  int numRecords=0;
  for (  Result result : ht.getScanner(scan1)) {
    numRecords++;
  }
  LOG.info("test data has " + numRecords + " records.");
  assertEquals(null,scan1.getAttribute(Scan.SCAN_ATTRIBUTES_METRICS_DATA));
  Scan scan=new Scan();
  scan.setAttribute(Scan.SCAN_ATTRIBUTES_METRICS_ENABLE,Bytes.toBytes(Boolean.TRUE));
  scan.setCaching(numRecords + 1);
  ResultScanner scanner=ht.getScanner(scan);
  for (  Result result : scanner.next(numRecords - 1)) {
  }
  scanner.close();
  assertNotNull(scan.getAttribute(Scan.SCAN_ATTRIBUTES_METRICS_DATA));
  scan=new Scan();
  scan.setAttribute(Scan.SCAN_ATTRIBUTES_METRICS_ENABLE,Bytes.toBytes(Boolean.TRUE));
  scan.setCaching(1);
  scanner=ht.getScanner(scan);
  for (  Result result : scanner.next(numRecords - 1)) {
  }
  scanner.close();
  ScanMetrics scanMetrics=getScanMetrics(scan);
  assertEquals("Did not access all the regions in the table",numOfRegions,scanMetrics.countOfRegions.get());
  Scan scanWithoutClose=new Scan();
  scanWithoutClose.setCaching(1);
  scanWithoutClose.setAttribute(Scan.SCAN_ATTRIBUTES_METRICS_ENABLE,Bytes.toBytes(Boolean.TRUE));
  ResultScanner scannerWithoutClose=ht.getScanner(scanWithoutClose);
  for (  Result result : scannerWithoutClose.next(numRecords + 1)) {
  }
  ScanMetrics scanMetricsWithoutClose=getScanMetrics(scanWithoutClose);
  assertEquals("Did not access all the regions in the table",numOfRegions,scanMetricsWithoutClose.countOfRegions.get());
  Scan scanWithClose=new Scan();
  scanWithClose.setCaching(numRecords);
  scanWithClose.setAttribute(Scan.SCAN_ATTRIBUTES_METRICS_ENABLE,Bytes.toBytes(Boolean.TRUE));
  ResultScanner scannerWithClose=ht.getScanner(scanWithClose);
  for (  Result result : scannerWithClose.next(numRecords + 1)) {
  }
  scannerWithClose.close();
  ScanMetrics scanMetricsWithClose=getScanMetrics(scanWithClose);
  assertEquals("Did not access all the regions in the table",numOfRegions,scanMetricsWithClose.countOfRegions.get());
}
