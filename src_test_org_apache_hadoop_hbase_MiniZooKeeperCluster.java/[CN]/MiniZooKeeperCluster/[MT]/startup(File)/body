{
  setupTestEnv();
  shutdown();
  File dir=new File(baseDir,"zookeeper").getAbsoluteFile();
  recreateDir(dir);
  ZooKeeperServer server=new ZooKeeperServer(dir,dir,TICK_TIME);
  while (true) {
    try {
      standaloneServerFactory=new NIOServerCnxn.Factory(clientPort);
    }
 catch (    BindException e) {
      LOG.info("Faild binding ZK Server to client port: " + clientPort);
      clientPort++;
      continue;
    }
    break;
  }
  standaloneServerFactory.startup(server);
  if (!waitForServerUp(clientPort,CONNECTION_TIMEOUT)) {
    throw new IOException("Waiting for startup of standalone server");
  }
  started=true;
  return clientPort;
}
