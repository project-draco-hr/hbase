{
  RpcEngine engine=PROTOCOL_ENGINES.get(protocol);
  if (engine == null) {
    Class<?> defaultEngine=conf.getClass(RPC_ENGINE_PROP,ProtobufRpcEngine.class);
    Class<?> impl=conf.getClass(RPC_ENGINE_PROP + "." + protocol.getName(),defaultEngine);
    LOG.debug("Using " + impl.getName() + " for "+ protocol.getName());
    engine=(RpcEngine)ReflectionUtils.newInstance(impl,conf);
    if (protocol.isInterface())     PROXY_ENGINES.put(Proxy.getProxyClass(protocol.getClassLoader(),protocol),engine);
    PROTOCOL_ENGINES.put(protocol,engine);
  }
  return engine;
}
