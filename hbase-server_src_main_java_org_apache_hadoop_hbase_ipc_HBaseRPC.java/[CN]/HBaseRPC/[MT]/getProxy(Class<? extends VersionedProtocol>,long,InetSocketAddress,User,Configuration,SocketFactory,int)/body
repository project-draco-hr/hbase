{
  RpcEngine engine=getProtocolEngine(protocol,conf);
  VersionedProtocol proxy=engine.getProxy(protocol,clientVersion,addr,ticket,conf,factory,Math.min(rpcTimeout,HBaseRPC.getRpcTimeout()));
  if (engine instanceof WritableRpcEngine) {
    long serverVersion=proxy.getProtocolVersion(protocol.getName(),clientVersion);
    if (serverVersion == clientVersion) {
      return proxy;
    }
    throw new VersionMismatch(protocol.getName(),clientVersion,serverVersion);
  }
  return proxy;
}
