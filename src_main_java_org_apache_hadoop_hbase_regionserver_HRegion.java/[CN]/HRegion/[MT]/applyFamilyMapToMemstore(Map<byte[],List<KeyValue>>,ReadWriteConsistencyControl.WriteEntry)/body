{
  long size=0;
  boolean freerwcc=false;
  try {
    if (localizedWriteEntry == null) {
      localizedWriteEntry=rwcc.beginMemstoreInsert();
      freerwcc=true;
    }
    for (    Map.Entry<byte[],List<KeyValue>> e : familyMap.entrySet()) {
      byte[] family=e.getKey();
      List<KeyValue> edits=e.getValue();
      Store store=getStore(family);
      for (      KeyValue kv : edits) {
        kv.setMemstoreTS(localizedWriteEntry.getWriteNumber());
        size+=store.add(kv);
      }
    }
  }
  finally {
    if (freerwcc) {
      rwcc.completeMemstoreInsert(localizedWriteEntry);
    }
  }
  return size;
}
