{
  checkRow(row);
  startRegionOperation();
  try {
synchronized (lockedRows) {
      while (lockedRows.contains(row)) {
        if (!waitForLock) {
          return null;
        }
        try {
          lockedRows.wait();
        }
 catch (        InterruptedException ie) {
        }
      }
      byte[] prev=null;
      Integer lockId=null;
      do {
        lockId=new Integer(lockIdGenerator++);
        prev=lockIds.put(lockId,row);
        if (prev != null) {
          lockIds.put(lockId,prev);
          lockIdGenerator=rand.nextInt();
        }
      }
 while (prev != null);
      lockedRows.add(row);
      lockedRows.notifyAll();
      return lockId;
    }
  }
  finally {
    closeRegionOperation();
  }
}
