{
  long now=EnvironmentEdgeManager.currentTimeMillis();
  byte[] byteNow=Bytes.toBytes(now);
  boolean flush=false;
  this.updatesLock.readLock().lock();
  try {
    if (coprocessorHost != null) {
      familyMap=coprocessorHost.prePut(familyMap);
    }
    checkFamilies(familyMap.keySet());
    updateKVTimestamps(familyMap.values(),byteNow);
    if (writeToWAL) {
      WALEdit walEdit=new WALEdit();
      addFamilyMapToWALEdit(familyMap,walEdit);
      this.log.append(regionInfo,regionInfo.getTableDesc().getName(),walEdit,now);
    }
    long addedSize=applyFamilyMapToMemstore(familyMap);
    flush=isFlushSize(memstoreSize.addAndGet(addedSize));
    if (coprocessorHost != null) {
      coprocessorHost.postPut(familyMap);
    }
  }
  finally {
    this.updatesLock.readLock().unlock();
  }
  if (flush) {
    requestFlush();
  }
}
