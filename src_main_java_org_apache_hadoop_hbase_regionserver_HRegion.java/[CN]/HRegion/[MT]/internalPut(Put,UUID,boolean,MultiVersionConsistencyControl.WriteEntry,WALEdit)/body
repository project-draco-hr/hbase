{
  Map<byte[],List<KeyValue>> familyMap=put.getFamilyMap();
  WALEdit localWalEdit=walEdit == null ? new WALEdit() : walEdit;
  if (coprocessorHost != null && walEdit == null) {
    if (coprocessorHost.prePut(put,localWalEdit,writeToWAL)) {
      return;
    }
  }
  long now=EnvironmentEdgeManager.currentTimeMillis();
  byte[] byteNow=Bytes.toBytes(now);
  boolean flush=false;
  this.updatesLock.readLock().lock();
  try {
    checkFamilies(familyMap.keySet());
    checkTimestamps(familyMap,now);
    updateKVTimestamps(familyMap.values(),byteNow);
    if (writeToWAL) {
      addFamilyMapToWALEdit(familyMap,localWalEdit);
      this.log.append(regionInfo,this.htableDescriptor.getName(),localWalEdit,clusterId,now,this.htableDescriptor);
    }
    long addedSize=applyFamilyMapToMemstore(familyMap,writeEntry);
    flush=isFlushSize(this.addAndGetGlobalMemstoreSize(addedSize));
  }
  finally {
    this.updatesLock.readLock().unlock();
  }
  if (coprocessorHost != null && walEdit == null) {
    coprocessorHost.postPut(put,localWalEdit,writeToWAL);
  }
  final long after=EnvironmentEdgeManager.currentTimeMillis();
  final String metricPrefix=SchemaMetrics.generateSchemaMetricsPrefix(this.getTableDesc().getNameAsString(),familyMap.keySet());
  if (!metricPrefix.isEmpty()) {
    HRegion.incrTimeVaryingMetric(metricPrefix + "put_",after - now);
  }
  if (flush) {
    requestFlush();
  }
}
