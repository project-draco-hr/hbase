{
  LOG.info("Running testAddingServerBeforeOldIsDead2413");
  MiniHBaseCluster cluster=TEST_UTIL.getHBaseCluster();
  int count=count();
  int metaIndex=cluster.getServerWithMeta();
  MiniHBaseClusterRegionServer metaHRS=(MiniHBaseClusterRegionServer)cluster.getRegionServer(metaIndex);
  int port=metaHRS.getServerInfo().getServerAddress().getPort();
  Configuration c=TEST_UTIL.getConfiguration();
  String oldPort=c.get(HConstants.REGIONSERVER_PORT,"0");
  try {
    LOG.info("KILLED=" + metaHRS);
    metaHRS.kill();
    c.set(HConstants.REGIONSERVER_PORT,Integer.toString(port));
    HRegionServer hrs=null;
    while (true) {
      try {
        hrs=cluster.startRegionServer().getRegionServer();
        break;
      }
 catch (      IOException e) {
        if (e.getCause() != null && e.getCause() instanceof InvocationTargetException) {
          InvocationTargetException ee=(InvocationTargetException)e.getCause();
          if (ee.getCause() != null && ee.getCause() instanceof BindException) {
            LOG.info("BindException; retrying: " + e.toString());
          }
        }
      }
    }
    LOG.info("STARTED=" + hrs);
    while (hrs.getOnlineRegions().size() < 3)     Threads.sleep(100);
    LOG.info(hrs.toString() + " has " + hrs.getOnlineRegions().size()+ " regions");
    assertEquals(count,count());
  }
  finally {
    c.set(HConstants.REGIONSERVER_PORT,oldPort);
  }
}
