{
  MiniHBaseCluster cluster=utility1.startMiniCluster(1,2);
  HBaseAdmin admin=utility1.getHBaseAdmin();
  HTableDescriptor table=new HTableDescriptor(TableName.valueOf(Bytes.toBytes("zk")));
  HColumnDescriptor fam=new HColumnDescriptor(famName);
  fam.setScope(HConstants.REPLICATION_SCOPE_GLOBAL);
  table.addFamily(fam);
  admin.createTable(table);
  ReplicationAdmin replicationAdmin=new ReplicationAdmin(conf1);
  ReplicationPeerConfig rpc=new ReplicationPeerConfig();
  rpc.setClusterKey(utility2.getClusterKey());
  replicationAdmin.addPeer("cluster2",rpc,null);
  HRegionServer rs=cluster.getRegionServer(0);
  ReplicationQueuesZKImpl zk=new ReplicationQueuesZKImpl(rs.getZooKeeper(),conf1,rs);
  zk.init(rs.getServerName().toString());
  List<String> replicators=zk.getListOfReplicators();
  assertEquals(2,replicators.size());
  String zNode=cluster.getRegionServer(1).getServerName().toString();
  assertTrue(zk.lockOtherRS(zNode));
  assertTrue(zk.checkLockExists(zNode));
  Thread.sleep(10000);
  assertTrue(zk.checkLockExists(zNode));
  cluster.abortRegionServer(0);
  Thread.sleep(10000);
  HRegionServer rs1=cluster.getRegionServer(1);
  zk=new ReplicationQueuesZKImpl(rs1.getZooKeeper(),conf1,rs1);
  zk.init(rs1.getServerName().toString());
  assertFalse(zk.checkLockExists(zNode));
  utility1.shutdownMiniCluster();
}
