{
  MiniHBaseCluster cluster=utility1.startMiniCluster(1,1);
  HBaseAdmin admin=utility1.getHBaseAdmin();
  admin.createTable(table);
  ReplicationAdmin replicationAdmin=new ReplicationAdmin(conf1);
  ReplicationPeerConfig rpc=new ReplicationPeerConfig();
  rpc.setClusterKey(utility2.getClusterKey());
  replicationAdmin.addPeer("2",rpc,null);
  HRegionServer rs=cluster.getRegionServer(0);
  ReplicationQueuesZKImpl zk=new ReplicationQueuesZKImpl(rs.getZooKeeper(),conf1,rs);
  zk.init(rs.getServerName().toString());
  List<String> replicators=zk.getListOfReplicators();
  assertEquals(2,replicators.size());
  String zNode=cluster.getMaster().getServerName().toString();
  assertTrue(zk.lockOtherRS(zNode));
  assertTrue(zk.checkLockExists(zNode));
  Thread.sleep(10000);
  assertTrue(zk.checkLockExists(zNode));
  cluster.abortRegionServer(0);
  Thread.sleep(10000);
  HRegionServer rs1=cluster.getMaster();
  zk=new ReplicationQueuesZKImpl(rs1.getZooKeeper(),conf1,rs1);
  zk.init(rs1.getServerName().toString());
  assertFalse(zk.checkLockExists(zNode));
  utility1.shutdownMiniCluster();
}
