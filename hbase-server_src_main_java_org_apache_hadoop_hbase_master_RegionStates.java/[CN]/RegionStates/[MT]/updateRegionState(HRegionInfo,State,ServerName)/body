{
  ServerName newServerName=serverName;
  if (serverName != null && (state == State.CLOSED || state == State.OFFLINE)) {
    LOG.info(hri.getShortNameToLog() + " is " + state+ ", reset server info from "+ serverName+ " to null");
    newServerName=null;
  }
  if (state == State.FAILED_CLOSE || state == State.FAILED_OPEN) {
    LOG.warn("Failed to transition " + hri.getShortNameToLog() + " on "+ serverName+ ", set to "+ state);
  }
  String encodedName=hri.getEncodedName();
  RegionState regionState=new RegionState(hri,state,System.currentTimeMillis(),newServerName);
  RegionState oldState=regionStates.put(encodedName,regionState);
  if (oldState == null || oldState.getState() != regionState.getState()) {
    LOG.info("Transitioned " + oldState + " to "+ regionState);
  }
  if (newServerName != null || (state != State.PENDING_CLOSE && state != State.CLOSING)) {
    regionsInTransition.put(encodedName,regionState);
  }
  if ((state == State.CLOSED || state == State.MERGED || state == State.SPLIT) && lastAssignments.containsKey(encodedName)) {
    ServerName oldServerName=oldState == null ? null : oldState.getServerName();
    ServerName last=lastAssignments.get(encodedName);
    if (last.equals(oldServerName)) {
      lastAssignments.remove(encodedName);
    }
 else {
      LOG.warn(encodedName + " moved to " + state+ " on "+ oldServerName+ ", expected "+ last);
    }
  }
  this.notifyAll();
  return regionState;
}
