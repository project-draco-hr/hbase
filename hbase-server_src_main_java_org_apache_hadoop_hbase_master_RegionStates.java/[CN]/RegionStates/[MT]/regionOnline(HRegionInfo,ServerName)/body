{
  if (!serverManager.isServerOnline(serverName)) {
    LOG.warn("Ignored, " + hri.getEncodedName() + " was opened on a dead server: "+ serverName);
    return;
  }
  String encodedName=hri.getEncodedName();
  RegionState oldState=regionStates.get(encodedName);
  if (oldState == null) {
    LOG.warn("Online region not in RegionStates: " + hri.getShortNameToLog());
  }
 else {
    ServerName sn=oldState.getServerName();
    if (!oldState.isReadyToOnline() || sn == null || !sn.equals(serverName)) {
      LOG.debug("Online " + hri.getShortNameToLog() + " with current state="+ oldState.getState()+ ", expected state=OPEN/MERGING_NEW/SPLITTING_NEW"+ ", assigned to server: "+ sn+ " expected "+ serverName);
    }
  }
  updateRegionState(hri,State.OPEN,serverName);
  regionsInTransition.remove(encodedName);
  lastAssignments.put(encodedName,serverName);
  ServerName oldServerName=regionAssignments.put(hri,serverName);
  if (!serverName.equals(oldServerName)) {
    LOG.info("Onlined " + hri.getShortNameToLog() + " on "+ serverName);
    Set<HRegionInfo> regions=serverHoldings.get(serverName);
    if (regions == null) {
      regions=new HashSet<HRegionInfo>();
      serverHoldings.put(serverName,regions);
    }
    regions.add(hri);
    if (oldServerName != null) {
      LOG.info("Offlined " + hri.getShortNameToLog() + " from "+ oldServerName);
      Set<HRegionInfo> oldRegions=serverHoldings.get(oldServerName);
      oldRegions.remove(hri);
      if (oldRegions.isEmpty()) {
        serverHoldings.remove(oldServerName);
      }
    }
  }
}
