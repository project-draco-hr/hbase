{
  MutationProto.Builder builder=getMutationBuilderAndSetCommonFields(type,mutation);
  ColumnValue.Builder columnBuilder=ColumnValue.newBuilder();
  QualifierValue.Builder valueBuilder=QualifierValue.newBuilder();
  for (  Map.Entry<byte[],List<Cell>> family : mutation.getFamilyCellMap().entrySet()) {
    columnBuilder.setFamily(ZeroCopyLiteralByteString.wrap(family.getKey()));
    columnBuilder.clearQualifierValue();
    for (    Cell cell : family.getValue()) {
      KeyValue kv=KeyValueUtil.ensureKeyValue(cell);
      valueBuilder.setQualifier(ZeroCopyLiteralByteString.wrap(kv.getQualifier()));
      valueBuilder.setValue(ZeroCopyLiteralByteString.wrap(kv.getValue()));
      valueBuilder.setTimestamp(kv.getTimestamp());
      if (cell.getTagsLength() > 0) {
        valueBuilder.setTags(ByteString.copyFrom(CellUtil.getTagArray(kv)));
      }
      if (type == MutationType.DELETE) {
        KeyValue.Type keyValueType=KeyValue.Type.codeToType(kv.getType());
        valueBuilder.setDeleteType(toDeleteType(keyValueType));
      }
      columnBuilder.addQualifierValue(valueBuilder.build());
    }
    builder.addColumnValue(columnBuilder.build());
  }
  return builder.build();
}
