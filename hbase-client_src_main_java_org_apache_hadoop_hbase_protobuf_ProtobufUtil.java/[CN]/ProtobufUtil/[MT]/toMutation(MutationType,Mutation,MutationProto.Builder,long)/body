{
  builder=getMutationBuilderAndSetCommonFields(type,mutation,builder);
  if (nonce != HConstants.NO_NONCE) {
    builder.setNonce(nonce);
  }
  ColumnValue.Builder columnBuilder=ColumnValue.newBuilder();
  QualifierValue.Builder valueBuilder=QualifierValue.newBuilder();
  for (  Map.Entry<byte[],List<Cell>> family : mutation.getFamilyCellMap().entrySet()) {
    columnBuilder.clear();
    columnBuilder.setFamily(ByteStringer.wrap(family.getKey()));
    for (    Cell cell : family.getValue()) {
      KeyValue kv=KeyValueUtil.ensureKeyValue(cell);
      valueBuilder.setQualifier(ByteStringer.wrap(kv.getQualifierArray(),kv.getQualifierOffset(),kv.getQualifierLength()));
      valueBuilder.setValue(ByteStringer.wrap(kv.getValueArray(),kv.getValueOffset(),kv.getValueLength()));
      valueBuilder.setTimestamp(kv.getTimestamp());
      if (cell.getTagsLength() > 0) {
        valueBuilder.setTags(ByteStringer.wrap(kv.getTagsArray(),kv.getTagsOffset(),kv.getTagsLength()));
      }
      if (type == MutationType.DELETE || (type == MutationType.PUT && CellUtil.isDelete(kv))) {
        KeyValue.Type keyValueType=KeyValue.Type.codeToType(kv.getType());
        valueBuilder.setDeleteType(toDeleteType(keyValueType));
      }
      columnBuilder.addQualifierValue(valueBuilder.build());
    }
    builder.addColumnValue(columnBuilder.build());
  }
  return builder.build();
}
