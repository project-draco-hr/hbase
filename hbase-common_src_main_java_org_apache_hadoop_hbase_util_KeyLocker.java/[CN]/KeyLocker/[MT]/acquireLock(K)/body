{
  if (key == null)   throw new IllegalArgumentException("key must not be null");
  Pair<KeyLock<K>,AtomicInteger> lock;
synchronized (this) {
    lock=locks.get(key);
    if (lock == null) {
      lock=new Pair<KeyLock<K>,AtomicInteger>(new KeyLock<K>(this,key),new AtomicInteger(1));
      locks.put(key,lock);
    }
 else {
      lock.getSecond().incrementAndGet();
    }
  }
  lock.getFirst().lock();
  return lock.getFirst();
}
