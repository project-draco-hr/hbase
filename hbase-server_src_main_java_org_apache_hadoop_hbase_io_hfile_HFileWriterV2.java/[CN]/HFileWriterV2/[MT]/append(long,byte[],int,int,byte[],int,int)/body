{
  boolean dupKey=checkKey(key,koffset,klength);
  checkValue(value,voffset,vlength);
  if (!dupKey) {
    checkBlockBoundary();
  }
  if (!fsBlockWriter.isWriting())   newBlock();
{
    DataOutputStream out=fsBlockWriter.getUserDataStream();
    out.writeInt(klength);
    totalKeyLength+=klength;
    out.writeInt(vlength);
    totalValueLength+=vlength;
    out.write(key,koffset,klength);
    out.write(value,voffset,vlength);
    if (this.hFileContext.isIncludesMvcc()) {
      WritableUtils.writeVLong(out,memstoreTS);
    }
  }
  if (firstKeyInBlock == null) {
    firstKeyInBlock=new byte[klength];
    System.arraycopy(key,koffset,firstKeyInBlock,0,klength);
  }
  lastKeyBuffer=key;
  lastKeyOffset=koffset;
  lastKeyLength=klength;
  entryCount++;
}
