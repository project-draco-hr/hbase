{
  ExceptionDispatcherFactory<ExceptionListener> factory=Mockito.spy(new ExceptionDispatcherFactory<ExceptionListener>(TestFaultInjecting.VISITOR));
  ExceptionDispatcher<ExceptionListener,Exception> dispatcher=new ExceptionDispatcher<ExceptionListener,Exception>();
  Mockito.when(factory.buildErrorHandler(VISITOR)).thenReturn(dispatcher);
  String info="info";
  ExceptionOrchestratorFactory.addFaultInjector(new StringFaultInjector(info));
  ExceptionCheckable<Exception> monitor=factory.createErrorHandler();
  assertNotSame(dispatcher,monitor);
  assertTrue("Monitor didn't get an injected error",monitor.checkForError());
  try {
    monitor.failOnError();
    fail("Monitor didn't get an exception from the fault injected in the factory.");
  }
 catch (  ExceptionForTesting e) {
    LOG.debug("Correctly got an exception from the test!");
  }
catch (  Exception e) {
    fail("Got an unexpected exception:" + e);
  }
}
