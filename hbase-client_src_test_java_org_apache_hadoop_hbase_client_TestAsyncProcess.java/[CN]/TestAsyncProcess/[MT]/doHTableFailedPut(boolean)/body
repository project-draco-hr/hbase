{
  HTable ht=new HTable();
  HConnection hc=createHConnection();
  MyCB mcb=new MyCB();
  ht.ap=new MyAsyncProcess<Object>(hc,mcb,conf);
  ht.setAutoFlush(true,true);
  if (bufferOn) {
    ht.setWriteBufferSize(1024L * 1024L);
  }
 else {
    ht.setWriteBufferSize(0L);
  }
  Put put=createPut(1,false);
  Assert.assertEquals(0L,ht.currentWriteBufferSize);
  try {
    ht.put(put);
    if (bufferOn) {
      ht.flushCommits();
    }
    Assert.fail();
  }
 catch (  RetriesExhaustedException expected) {
  }
  Assert.assertEquals(0L,ht.currentWriteBufferSize);
  Assert.assertEquals(0,mcb.successCalled.get());
  Assert.assertEquals(2,mcb.retriableFailure.get());
  Assert.assertEquals(1,mcb.failureCalled.get());
  ht.close();
}
