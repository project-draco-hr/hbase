{
  assertTrue("This test requires HLog file replication set to 2.",fs.getDefaultReplication() == 2);
  LOG.info("Replication=" + fs.getDefaultReplication());
  this.server=cluster.getRegionServer(0);
  this.log=server.getWAL();
  String tableName=getName();
  HTableDescriptor desc=new HTableDescriptor(tableName);
  desc.addFamily(new HColumnDescriptor(HConstants.CATALOG_FAMILY));
  admin.createTable(desc);
  HTable table=new HTable(TEST_UTIL.getConfiguration(),tableName);
  assertTrue(table.isAutoFlush());
  server=TEST_UTIL.getRSForFirstRegionInTable(Bytes.toBytes(tableName));
  this.log=server.getWAL();
  assertTrue("Need HDFS-826 for this test",log.canGetCurReplicas());
  assertTrue("Need append support for this test",FSUtils.isAppendSupported(TEST_UTIL.getConfiguration()));
  List<DataNode> existingNodes=dfsCluster.getDataNodes();
  int numDataNodes=3;
  dfsCluster.startDataNodes(TEST_UTIL.getConfiguration(),numDataNodes,true,null,null);
  List<DataNode> allNodes=dfsCluster.getDataNodes();
  for (int i=allNodes.size() - 1; i >= 0; i--) {
    if (existingNodes.contains(allNodes.get(i))) {
      dfsCluster.stopDataNode(i);
    }
  }
  assertTrue("DataNodes " + dfsCluster.getDataNodes().size() + " default replication "+ fs.getDefaultReplication(),dfsCluster.getDataNodes().size() >= fs.getDefaultReplication() + 1);
  writeData(table,2);
  long curTime=System.currentTimeMillis();
  long oldFilenum=log.getFilenum();
  assertTrue("Log should have a timestamp older than now",curTime > oldFilenum && oldFilenum != -1);
  assertTrue("The log shouldn't have rolled yet",oldFilenum == log.getFilenum());
  final DatanodeInfo[] pipeline=getPipeline(log);
  assertTrue(pipeline.length == fs.getDefaultReplication());
  assertTrue(dfsCluster.stopDataNode(pipeline[0].getName()) != null);
  writeData(table,2);
  long newFilenum=log.getFilenum();
  assertTrue("Missing datanode should've triggered a log roll",newFilenum > oldFilenum && newFilenum > curTime);
  writeData(table,3);
  assertTrue("The log should not roll again.",log.getFilenum() == newFilenum);
  assertTrue(dfsCluster.stopDataNode(pipeline[1].getName()) != null);
  batchWriteAndWait(table,3,false,10000);
  assertTrue("LowReplication Roller should've been disabled",!log.isLowReplicationRollEnabled());
  dfsCluster.startDataNodes(TEST_UTIL.getConfiguration(),1,true,null,null);
  log.rollWriter(true);
  batchWriteAndWait(table,13,true,10000);
  assertTrue("New log file should have the default replication instead of " + log.getLogReplication(),log.getLogReplication() == fs.getDefaultReplication());
  assertTrue("LowReplication Roller should've been enabled",log.isLowReplicationRollEnabled());
}
