{
  ch.pipeline().addLast("frameDecoder",new LengthFieldBasedFrameDecoder(Integer.MAX_VALUE,0,4,0,4));
  ch.pipeline().addLast(new AsyncServerResponseHandler(this));
  ch.closeFuture().addListener(new GenericFutureListener<ChannelFuture>(){
    @Override public void operationComplete(    ChannelFuture future) throws Exception {
      close(null);
    }
  }
);
  try {
    writeChannelHeader(ch).addListener(new GenericFutureListener<ChannelFuture>(){
      @Override public void operationComplete(      ChannelFuture future) throws Exception {
        if (!future.isSuccess()) {
          close(future.cause());
          return;
        }
        List<AsyncCall> callsToWrite;
synchronized (pendingCalls) {
          connected=true;
          callsToWrite=new ArrayList<AsyncCall>(pendingCalls.values());
        }
        for (        AsyncCall call : callsToWrite) {
          writeRequest(call);
        }
      }
    }
);
  }
 catch (  IOException e) {
    close(e);
  }
}
