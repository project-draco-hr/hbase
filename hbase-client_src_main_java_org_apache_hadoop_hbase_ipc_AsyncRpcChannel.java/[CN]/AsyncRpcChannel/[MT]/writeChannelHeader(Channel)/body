{
  RPCProtos.ConnectionHeader.Builder headerBuilder=RPCProtos.ConnectionHeader.newBuilder().setServiceName(serviceName);
  RPCProtos.UserInformation userInfoPB=buildUserInfo(ticket.getUGI(),authMethod);
  if (userInfoPB != null) {
    headerBuilder.setUserInfo(userInfoPB);
  }
  if (client.codec != null) {
    headerBuilder.setCellBlockCodecClass(client.codec.getClass().getCanonicalName());
  }
  if (client.compressor != null) {
    headerBuilder.setCellBlockCompressorClass(client.compressor.getClass().getCanonicalName());
  }
  headerBuilder.setVersionInfo(ProtobufUtil.getVersionInfo());
  RPCProtos.ConnectionHeader header=headerBuilder.build();
  int totalSize=IPCUtil.getTotalSizeWhenWrittenDelimited(header);
  ByteBuf b=channel.alloc().directBuffer(totalSize);
  b.writeInt(header.getSerializedSize());
  b.writeBytes(header.toByteArray());
  return channel.writeAndFlush(b);
}
