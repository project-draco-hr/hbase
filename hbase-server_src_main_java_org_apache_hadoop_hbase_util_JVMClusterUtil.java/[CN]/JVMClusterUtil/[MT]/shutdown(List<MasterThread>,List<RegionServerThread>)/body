{
  LOG.debug("Shutting down HBase Cluster");
  if (masters != null) {
    JVMClusterUtil.MasterThread activeMaster=null;
    for (    JVMClusterUtil.MasterThread t : masters) {
      if (!t.master.isActiveMaster()) {
        t.master.stopMaster();
      }
 else {
        activeMaster=t;
      }
    }
    if (activeMaster != null)     activeMaster.master.shutdown();
  }
  if (regionservers != null) {
    for (    RegionServerThread t : regionservers) {
      if (t.isAlive()) {
        try {
          t.getRegionServer().stop("Shutdown requested");
          t.join();
        }
 catch (        InterruptedException e) {
        }
      }
    }
  }
  if (masters != null) {
    for (    JVMClusterUtil.MasterThread t : masters) {
      while (t.master.isAlive()) {
        try {
          Threads.threadDumpingIsAlive(t.master.getThread());
        }
 catch (        InterruptedException e) {
        }
      }
    }
  }
  LOG.info("Shutdown of " + ((masters != null) ? masters.size() : "0") + " master(s) and "+ ((regionservers != null) ? regionservers.size() : "0")+ " regionserver(s) complete");
}
