{
  final Server server=new MockServer(HTU,false);
  final RegionServerServices rss=new MockRegionServerServices();
  HTableDescriptor htd=TEST_HTD;
  final HRegionInfo hri=new HRegionInfo(htd.getTableName(),HConstants.EMPTY_END_ROW,HConstants.EMPTY_END_ROW);
  HRegion region=HRegion.createHRegion(hri,HTU.getDataTestDir(),HTU.getConfiguration(),htd);
  try {
    assertNotNull(region);
    HRegion spy=Mockito.spy(region);
    final boolean abort=false;
    Mockito.when(spy.close(abort)).thenThrow(new RuntimeException("Mocked failed close!"));
    rss.addToOnlineRegions(spy);
    assertFalse(server.isStopped());
    CloseRegionHandler handler=new CloseRegionHandler(server,rss,hri,false,false,-1);
    boolean throwable=false;
    try {
      handler.process();
    }
 catch (    Throwable t) {
      throwable=true;
    }
 finally {
      assertTrue(throwable);
      assertTrue(server.isStopped());
    }
  }
  finally {
    HRegion.closeHRegion(region);
  }
}
