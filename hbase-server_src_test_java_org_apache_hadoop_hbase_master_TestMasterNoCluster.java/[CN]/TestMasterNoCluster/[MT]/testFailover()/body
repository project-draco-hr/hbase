{
  final long now=System.currentTimeMillis();
  final ServerName sn0=new ServerName("0.example.org",0,now);
  final ServerName sn1=new ServerName("1.example.org",1,now);
  final ServerName sn2=new ServerName("2.example.org",2,now);
  final ServerName[] sns=new ServerName[]{sn0,sn1,sn2};
  final Configuration conf=TESTUTIL.getConfiguration();
  final MockRegionServer rs0=new MockRegionServer(conf,sn0);
  final MockRegionServer rs1=new MockRegionServer(conf,sn1);
  final MockRegionServer rs2=new MockRegionServer(conf,sn2);
  MetaRegionTracker.setMetaLocation(rs0.getZooKeeper(),rs0.getServerName());
  final byte[] tableName=Bytes.toBytes("t");
  Result[] results=new Result[]{MetaMockingUtil.getMetaTableRowResult(new HRegionInfo(tableName,HConstants.EMPTY_START_ROW,HBaseTestingUtility.KEYS[1]),rs2.getServerName()),MetaMockingUtil.getMetaTableRowResult(new HRegionInfo(tableName,HBaseTestingUtility.KEYS[1],HBaseTestingUtility.KEYS[2]),rs2.getServerName()),MetaMockingUtil.getMetaTableRowResult(new HRegionInfo(tableName,HBaseTestingUtility.KEYS[2],HConstants.EMPTY_END_ROW),rs2.getServerName())};
  rs1.setNextResults(HRegionInfo.FIRST_META_REGIONINFO.getRegionName(),results);
  HMaster master=new HMaster(conf){
    InetAddress getRemoteInetAddress(    final int port,    final long serverStartCode) throws UnknownHostException {
      ServerName sn=sns[port];
      return InetAddress.getByAddress(sn.getHostname(),new byte[]{10,0,0,(byte)sn.getPort()});
    }
    @Override ServerManager createServerManager(    Server master,    MasterServices services) throws IOException {
      ServerManager sm=super.createServerManager(master,services);
      ServerManager spy=Mockito.spy(sm);
      Mockito.doReturn(RegionOpeningState.OPENED).when(spy).sendRegionOpen((ServerName)Mockito.any(),(HRegionInfo)Mockito.any(),Mockito.anyInt(),Mockito.anyListOf(ServerName.class));
      return spy;
    }
    @Override CatalogTracker createCatalogTracker(    ZooKeeperWatcher zk,    Configuration conf,    Abortable abortable) throws IOException {
      HConnection connection=HConnectionTestingUtility.getMockedConnectionAndDecorate(TESTUTIL.getConfiguration(),rs0,rs0,rs0.getServerName(),HRegionInfo.ROOT_REGIONINFO);
      return new CatalogTracker(zk,conf,connection,abortable);
    }
  }
;
  master.start();
  try {
    while (!master.isRpcServerOpen())     Threads.sleep(10);
    for (int i=0; i < sns.length; i++) {
      RegionServerReportRequest.Builder request=RegionServerReportRequest.newBuilder();
      ;
      ServerName sn=ServerName.parseVersionedServerName(sns[i].getVersionedBytes());
      request.setServer(ProtobufUtil.toServerName(sn));
      request.setLoad(ServerLoad.EMPTY_SERVERLOAD.obtainServerLoadPB());
      master.regionServerReport(null,request.build());
    }
    while (!master.isInitialized()) {
      Threads.sleep(10);
    }
    assertTrue(master.isInitialized());
  }
  finally {
    rs0.stop("Test is done");
    rs1.stop("Test is done");
    rs2.stop("Test is done");
    master.stopMaster();
    master.join();
  }
}
