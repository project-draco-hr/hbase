{
  ExecutorService executor=startupMasterExecutor("testSSHWhenSplitRegionInProgress");
  CatalogTracker ct=Mockito.mock(CatalogTracker.class);
  ZKAssign.deleteAllNodes(this.watcher);
  AssignmentManagerWithExtrasForTesting am=setUpMockedAssignmentManager(this.server,this.serverManager);
  am.regionOnline(REGIONINFO,SERVERNAME_A);
  am.getRegionStates().updateRegionState(REGIONINFO,State.SPLITTING,SERVERNAME_A);
  am.getTableStateManager().setTableState(REGIONINFO.getTable(),Table.State.ENABLED);
  RegionTransition data=RegionTransition.createRegionTransition(EventType.RS_ZK_REGION_SPLITTING,REGIONINFO.getRegionName(),SERVERNAME_A);
  String node=ZKAssign.getNodeName(this.watcher,REGIONINFO.getEncodedName());
  ZKUtil.createAndWatch(this.watcher,node,data.toByteArray());
  try {
    processServerShutdownHandler(ct,am,regionSplitDone);
    if (regionSplitDone) {
      assertFalse("Region state of region in SPLITTING should be removed from rit.",am.getRegionStates().isRegionsInTransition());
    }
 else {
      while (!am.assignInvoked) {
        Thread.sleep(1);
      }
      assertTrue("Assign should be invoked.",am.assignInvoked);
    }
  }
  finally {
    REGIONINFO.setOffline(false);
    REGIONINFO.setSplit(false);
    executor.shutdown();
    am.shutdown();
    ZKAssign.deleteAllNodes(this.watcher);
  }
}
