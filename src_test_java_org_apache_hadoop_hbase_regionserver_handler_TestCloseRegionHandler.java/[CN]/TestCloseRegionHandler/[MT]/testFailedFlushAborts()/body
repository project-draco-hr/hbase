{
  final Server server=new MockServer(HTU,false);
  final RegionServerServices rss=new MockRegionServerServices();
  HTableDescriptor htd=new HTableDescriptor("testFailedFlushAborts");
  final HRegionInfo hri=new HRegionInfo(htd.getName(),HConstants.EMPTY_END_ROW,HConstants.EMPTY_END_ROW);
  HRegion region=HRegion.createHRegion(hri,HBaseTestingUtility.getTestDir(),HTU.getConfiguration(),htd);
  assertNotNull(region);
  HRegion spy=Mockito.spy(region);
  final boolean abort=false;
  Mockito.when(spy.close(abort)).thenThrow(new RuntimeException("Mocked failed close!"));
  rss.addToOnlineRegions(spy);
  assertFalse(server.isStopped());
  CloseRegionHandler handler=new CloseRegionHandler(server,rss,hri,false,false);
  boolean throwable=false;
  try {
    handler.process();
  }
 catch (  Throwable t) {
    throwable=true;
  }
 finally {
    assertTrue(throwable);
    assertTrue(server.isStopped());
  }
}
