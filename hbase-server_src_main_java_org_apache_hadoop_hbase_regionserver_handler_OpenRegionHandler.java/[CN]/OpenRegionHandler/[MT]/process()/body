{
  boolean openSuccessful=false;
  final String regionName=regionInfo.getRegionNameAsString();
  try {
    if (this.server.isStopped() || this.rsServices.isStopping()) {
      return;
    }
    final String encodedName=regionInfo.getEncodedName();
    if (this.rsServices.getFromOnlineRegions(encodedName) != null) {
      LOG.error("Region " + encodedName + " was already online when we started processing the opening. "+ "Marking this new attempt as failed");
      tryTransitionFromOfflineToFailedOpen(this.rsServices,regionInfo,this.version);
      return;
    }
    if (!isRegionStillOpening()) {
      LOG.error("Region " + encodedName + " opening cancelled");
      tryTransitionFromOfflineToFailedOpen(this.rsServices,regionInfo,this.version);
      return;
    }
    if (!transitionZookeeperOfflineToOpening(encodedName,versionOfOfflineNode)) {
      LOG.warn("Region was hijacked? Opening cancelled for encodedName=" + encodedName);
      tryTransitionFromOfflineToFailedOpen(this.rsServices,regionInfo,this.version);
      return;
    }
    HRegion region=openRegion();
    if (region == null) {
      tryTransitionFromOpeningToFailedOpen(regionInfo);
      return;
    }
    boolean failed=true;
    if (tickleOpening("post_region_open")) {
      if (updateMeta(region)) {
        failed=false;
      }
    }
    if (failed || this.server.isStopped() || this.rsServices.isStopping()) {
      cleanupFailedOpen(region);
      tryTransitionFromOpeningToFailedOpen(regionInfo);
      return;
    }
    if (!isRegionStillOpening() || !transitionToOpened(region)) {
      cleanupFailedOpen(region);
      tryTransitionFromOpeningToFailedOpen(regionInfo);
      return;
    }
    this.rsServices.addToOnlineRegions(region);
    openSuccessful=true;
    LOG.debug("Opened " + regionName + " on server:"+ this.server.getServerName());
  }
  finally {
    final Boolean current=this.rsServices.getRegionsInTransitionInRS().remove(this.regionInfo.getEncodedNameAsBytes());
    if (openSuccessful) {
      if (current == null) {
        LOG.error("Bad state: we've just opened a region that was NOT in transition. Region=" + regionName);
      }
 else       if (Boolean.FALSE.equals(current)) {
        LOG.error("Race condition: we've finished to open a region, while a close was requested " + " on region=" + regionName + ". It can be a critical error, as a region that"+ " should be closed is now opened.");
      }
    }
  }
}
