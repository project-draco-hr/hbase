{
  if (Bytes.equals(scan.getStopRow(),HConstants.EMPTY_END_ROW)) {
    this.stopRow=null;
  }
 else {
    this.stopRow=scan.getStopRow();
  }
  List<KeyValueScanner> scanners=new ArrayList<KeyValueScanner>();
  try {
    for (    Map.Entry<byte[],NavigableSet<byte[]>> entry : scan.getFamilyMap().entrySet()) {
      Store store=stores.get(entry.getKey());
      scanners.add(store.getScanner(scan,entry.getValue()));
    }
  }
 catch (  IOException e) {
    for (    KeyValueScanner scanner : scanners) {
      if (scanner != null) {
        close(scanner);
      }
    }
    throw e;
  }
  this.storeHeap=new KeyValueHeap(scanners.toArray(new KeyValueScanner[0]),comparator);
  activeScannerCount.incrementAndGet();
}
