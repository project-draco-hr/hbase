{
synchronized (splitLock) {
    if (closed.get()) {
      return null;
    }
    byte[] startKey=this.regionInfo.getStartKey();
    byte[] endKey=this.regionInfo.getEndKey();
    if (HStoreKey.equalsTwoRowKeys(this.regionInfo,startKey,midKey)) {
      LOG.debug("Startkey (" + startKey + ") and midkey + ("+ midKey+ ") are same, not splitting");
      return null;
    }
    if (HStoreKey.equalsTwoRowKeys(this.regionInfo,midKey,endKey)) {
      LOG.debug("Endkey and midkey are same, not splitting");
      return null;
    }
    LOG.info("Starting split of region " + this);
    Path splits=new Path(this.regiondir,SPLITDIR);
    if (!this.fs.exists(splits)) {
      this.fs.mkdirs(splits);
    }
    long rid=System.currentTimeMillis();
    if (rid < this.regionInfo.getRegionId()) {
      LOG.warn("Clock skew; parent regions id is " + this.regionInfo.getRegionId() + " but current time here is "+ rid);
      rid=this.regionInfo.getRegionId() + 1;
    }
    HRegionInfo regionAInfo=new HRegionInfo(this.regionInfo.getTableDesc(),startKey,midKey,false,rid);
    Path dirA=new Path(splits,Integer.toString(regionAInfo.getEncodedName()));
    if (fs.exists(dirA)) {
      throw new IOException("Cannot split; target file collision at " + dirA);
    }
    HRegionInfo regionBInfo=new HRegionInfo(this.regionInfo.getTableDesc(),midKey,endKey,false,rid);
    Path dirB=new Path(splits,Integer.toString(regionBInfo.getEncodedName()));
    if (this.fs.exists(dirB)) {
      throw new IOException("Cannot split; target file collision at " + dirB);
    }
    List<HStoreFile> hstoreFilesToSplit=close(false);
    if (hstoreFilesToSplit == null) {
      LOG.warn("Close came back null (Implement abort of close?)");
      throw new RuntimeException("close returned empty vector of HStoreFiles");
    }
    for (    HStoreFile h : hstoreFilesToSplit) {
      HStoreFile.Reference aReference=new HStoreFile.Reference(this.regionInfo.getEncodedName(),h.getFileId(),new HStoreKey(midKey,this.regionInfo),HStoreFile.Range.bottom);
      HStoreFile a=new HStoreFile(this.conf,fs,splits,regionAInfo,h.getColFamily(),-1,aReference);
      HStoreFile.Reference bReference=new HStoreFile.Reference(this.regionInfo.getEncodedName(),h.getFileId(),new HStoreKey(midKey),HStoreFile.Range.top);
      HStoreFile b=new HStoreFile(this.conf,fs,splits,regionBInfo,h.getColFamily(),-1,bReference);
      h.splitStoreFile(a,b,this.fs);
    }
    HRegion regionA=new HRegion(basedir,log,fs,conf,regionAInfo,null);
    regionA.initialize(dirA,null);
    regionA.close();
    HRegion regionB=new HRegion(basedir,log,fs,conf,regionBInfo,null);
    regionB.initialize(dirB,null);
    regionB.close();
    boolean deleted=fs.delete(splits,true);
    if (LOG.isDebugEnabled()) {
      LOG.debug("Cleaned up " + FSUtils.getPath(splits) + " "+ deleted);
    }
    HRegion regions[]=new HRegion[]{regionA,regionB};
    this.historian.addRegionSplit(this.regionInfo,regionA.getRegionInfo(),regionB.getRegionInfo());
    return regions;
  }
}
