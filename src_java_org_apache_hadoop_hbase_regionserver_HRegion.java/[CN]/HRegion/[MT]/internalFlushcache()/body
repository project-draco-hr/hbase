{
  final long startTime=System.currentTimeMillis();
  this.lastFlushTime=startTime;
  if (this.memcacheSize.get() <= 0) {
    return false;
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Started memcache flush for region " + this + ". Current region memcache size "+ StringUtils.humanReadableInt(this.memcacheSize.get()));
  }
  long sequenceId=-1L;
  long completeSequenceId=-1L;
  this.updatesLock.writeLock().lock();
  final long currentMemcacheSize=this.memcacheSize.get();
  try {
    for (    Store s : stores.values()) {
      s.snapshot();
    }
    sequenceId=log.startCacheFlush();
    completeSequenceId=this.getCompleteCacheFlushSequenceId(sequenceId);
  }
  finally {
    this.updatesLock.writeLock().unlock();
  }
  boolean compactionRequested=false;
  try {
    for (    Store hstore : stores.values()) {
      boolean needsCompaction=hstore.flushCache(completeSequenceId);
      if (needsCompaction) {
        compactionRequested=true;
      }
    }
    this.memcacheSize.addAndGet(-currentMemcacheSize);
  }
 catch (  Throwable t) {
    this.log.abortCacheFlush();
    DroppedSnapshotException dse=new DroppedSnapshotException("region: " + Bytes.toString(getRegionName()));
    dse.initCause(t);
    throw dse;
  }
  this.log.completeCacheFlush(getRegionName(),regionInfo.getTableDesc().getName(),completeSequenceId);
synchronized (this) {
    notifyAll();
  }
  if (LOG.isDebugEnabled()) {
    long now=System.currentTimeMillis();
    String timeTaken=StringUtils.formatTimeDiff(now,startTime);
    LOG.debug("Finished memcache flush of ~" + StringUtils.humanReadableInt(currentMemcacheSize) + " for region "+ this+ " in "+ (now - startTime)+ "ms, sequence id="+ sequenceId+ ", compaction requested="+ compactionRequested);
    if (!regionInfo.isMetaRegion()) {
      this.historian.addRegionFlush(regionInfo,timeTaken);
    }
  }
  return compactionRequested;
}
