{
  if (isClosed()) {
    LOG.warn("region " + this + " already closed");
    return null;
  }
synchronized (splitLock) {
synchronized (writestate) {
      writestate.writesEnabled=false;
      LOG.debug("Closing " + this + ": compactions & flushes disabled ");
      while (writestate.compacting || writestate.flushing) {
        LOG.debug("waiting for" + (writestate.compacting ? " compaction" : "") + (writestate.flushing ? (writestate.compacting ? "," : "") + " cache flush" : "")+ " to complete for region "+ this);
        try {
          writestate.wait();
        }
 catch (        InterruptedException iex) {
        }
      }
    }
    newScannerLock.writeLock().lock();
    try {
synchronized (activeScannerCount) {
        while (activeScannerCount.get() != 0) {
          LOG.debug("waiting for " + activeScannerCount.get() + " scanners to finish");
          try {
            activeScannerCount.wait();
          }
 catch (          InterruptedException e) {
          }
        }
      }
      splitsAndClosesLock.writeLock().lock();
      LOG.debug("Updates disabled for region, no outstanding scanners on " + this);
      try {
        waitOnRowLocks();
        LOG.debug("No more row locks outstanding on region " + this);
        if (!abort) {
          internalFlushcache();
        }
        List<HStoreFile> result=new ArrayList<HStoreFile>();
        for (        HStore store : stores.values()) {
          result.addAll(store.close());
        }
        this.closed.set(true);
        LOG.info("Closed " + this);
        return result;
      }
  finally {
        splitsAndClosesLock.writeLock().unlock();
      }
    }
  finally {
      newScannerLock.writeLock().unlock();
    }
  }
}
