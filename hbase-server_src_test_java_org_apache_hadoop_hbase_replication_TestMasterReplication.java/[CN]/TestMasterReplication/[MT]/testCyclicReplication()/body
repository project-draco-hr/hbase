{
  LOG.info("testCyclicReplication");
  utility1.startMiniCluster();
  utility2.startMiniCluster();
  utility3.startMiniCluster();
  ReplicationAdmin admin1=new ReplicationAdmin(conf1);
  ReplicationAdmin admin2=new ReplicationAdmin(conf2);
  ReplicationAdmin admin3=new ReplicationAdmin(conf3);
  new HBaseAdmin(conf1).createTable(table);
  new HBaseAdmin(conf2).createTable(table);
  new HBaseAdmin(conf3).createTable(table);
  HTable htable1=new HTable(conf1,tableName);
  htable1.setWriteBufferSize(1024);
  HTable htable2=new HTable(conf2,tableName);
  htable2.setWriteBufferSize(1024);
  HTable htable3=new HTable(conf3,tableName);
  htable3.setWriteBufferSize(1024);
  admin1.addPeer("1",utility2.getClusterKey());
  admin2.addPeer("1",utility3.getClusterKey());
  admin3.addPeer("1",utility1.getClusterKey());
  putAndWait(row,famName,htable1,htable3);
  check(row,famName,htable2);
  putAndWait(row1,famName,htable2,htable1);
  check(row,famName,htable3);
  putAndWait(row2,famName,htable3,htable2);
  check(row,famName,htable1);
  deleteAndWait(row,htable1,htable3);
  deleteAndWait(row1,htable2,htable1);
  deleteAndWait(row2,htable3,htable2);
  assertEquals("Puts were replicated back ",3,getCount(htable1,put));
  assertEquals("Puts were replicated back ",3,getCount(htable2,put));
  assertEquals("Puts were replicated back ",3,getCount(htable3,put));
  assertEquals("Deletes were replicated back ",3,getCount(htable1,delete));
  assertEquals("Deletes were replicated back ",3,getCount(htable2,delete));
  assertEquals("Deletes were replicated back ",3,getCount(htable3,delete));
  admin2.disablePeer("1");
  putAndWait(row3,famName,htable1,htable2);
  Put put=new Put(row4);
  put.add(famName,row4,row4);
  htable2.put(put);
  admin2.enablePeer("1");
  wait(row4,htable1);
  utility3.shutdownMiniCluster();
  utility2.shutdownMiniCluster();
  utility1.shutdownMiniCluster();
}
