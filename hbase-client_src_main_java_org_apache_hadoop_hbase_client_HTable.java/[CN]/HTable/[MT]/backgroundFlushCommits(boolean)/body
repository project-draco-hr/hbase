{
  try {
    do {
      ap.submit(writeAsyncBuffer,true);
    }
 while (synchronous && !writeAsyncBuffer.isEmpty());
    if (synchronous) {
      ap.waitUntilDone();
    }
    if (ap.hasError()) {
      LOG.debug(tableName + ": One or more of the operations have failed -" + " waiting for all operation in progress to finish (successfully or not)");
      while (!writeAsyncBuffer.isEmpty()) {
        ap.submit(writeAsyncBuffer,true);
      }
      ap.waitUntilDone();
      if (!clearBufferOnFail) {
        writeAsyncBuffer.addAll(ap.getFailedOperations());
      }
      RetriesExhaustedWithDetailsException e=ap.getErrors();
      ap.clearErrors();
      throw e;
    }
  }
  finally {
    currentWriteBufferSize=0;
    for (    Row mut : writeAsyncBuffer) {
      if (mut instanceof Mutation) {
        currentWriteBufferSize+=((Mutation)mut).heapSize();
      }
    }
  }
}
