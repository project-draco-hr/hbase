{
  try {
    if (writeAsyncBuffer.size() > 0 && !ap.hasError()) {
      ap.submit(writeAsyncBuffer,true);
    }
    if (synchronous || ap.hasError()) {
      if (ap.hasError() && LOG.isDebugEnabled()) {
        LOG.debug(tableName + ": One or more of the operations have failed -" + " waiting for all operation in progress to finish (successfully or not)");
      }
      ap.waitUntilDone();
    }
    if (ap.hasError()) {
      if (!clearBufferOnFail) {
        writeAsyncBuffer.addAll(ap.getFailedOperations());
      }
      RetriesExhaustedWithDetailsException e=ap.getErrors();
      ap.clearErrors();
      throw e;
    }
  }
  finally {
    currentWriteBufferSize=0;
    for (    Row mut : writeAsyncBuffer) {
      if (mut instanceof Mutation) {
        currentWriteBufferSize+=((Mutation)mut).heapSize();
      }
    }
  }
}
