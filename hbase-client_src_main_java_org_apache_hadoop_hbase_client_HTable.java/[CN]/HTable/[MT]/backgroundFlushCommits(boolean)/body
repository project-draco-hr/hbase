{
  try {
    if (!synchronous) {
      ap.submit(tableName,writeAsyncBuffer,true,null,false);
      if (ap.hasError()) {
        LOG.debug(tableName + ": One or more of the operations have failed -" + " waiting for all operation in progress to finish (successfully or not)");
      }
    }
    if (synchronous || ap.hasError()) {
      while (!writeAsyncBuffer.isEmpty()) {
        ap.submit(tableName,writeAsyncBuffer,true,null,false);
      }
      List<Row> failedRows=clearBufferOnFail ? null : writeAsyncBuffer;
      RetriesExhaustedWithDetailsException error=ap.waitForAllPreviousOpsAndReset(failedRows);
      if (error != null) {
        throw error;
      }
    }
  }
  finally {
    currentWriteBufferSize=0;
    for (    Row mut : writeAsyncBuffer) {
      if (mut instanceof Mutation) {
        currentWriteBufferSize+=((Mutation)mut).heapSize();
      }
    }
  }
}
