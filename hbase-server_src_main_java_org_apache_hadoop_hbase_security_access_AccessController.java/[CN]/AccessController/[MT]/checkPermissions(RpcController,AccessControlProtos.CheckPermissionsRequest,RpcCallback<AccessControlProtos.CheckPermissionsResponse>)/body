{
  Permission[] permissions=new Permission[request.getPermissionCount()];
  for (int i=0; i < request.getPermissionCount(); i++) {
    permissions[i]=ProtobufUtil.toPermission(request.getPermission(i));
  }
  AccessControlProtos.CheckPermissionsResponse response=null;
  try {
    TableName tableName=regionEnv.getRegion().getTableDesc().getTableName();
    for (    Permission permission : permissions) {
      if (permission instanceof TablePermission) {
        TablePermission tperm=(TablePermission)permission;
        for (        Permission.Action action : permission.getActions()) {
          if (!tperm.getTable().equals(tableName)) {
            throw new CoprocessorException(AccessController.class,String.format("This method " + "can only execute at the table specified in TablePermission. " + "Table of the region:%s , requested table:%s",tableName,tperm.getTable()));
          }
          Map<byte[],Set<byte[]>> familyMap=Maps.newTreeMap(Bytes.BYTES_COMPARATOR);
          if (tperm.getFamily() != null) {
            if (tperm.getQualifier() != null) {
              Set<byte[]> qualifiers=Sets.newTreeSet(Bytes.BYTES_COMPARATOR);
              qualifiers.add(tperm.getQualifier());
              familyMap.put(tperm.getFamily(),qualifiers);
            }
 else {
              familyMap.put(tperm.getFamily(),null);
            }
          }
          requirePermission("checkPermissions",action,regionEnv,familyMap);
        }
      }
 else {
        for (        Permission.Action action : permission.getActions()) {
          requirePermission("checkPermissions",action);
        }
      }
    }
    response=AccessControlProtos.CheckPermissionsResponse.getDefaultInstance();
  }
 catch (  IOException ioe) {
    ResponseConverter.setControllerException(controller,ioe);
  }
  done.run(response);
}
