{
  long bytesWritten=0;
  long bytesWrittenProgress=0;
  List<Cell> cells=new ArrayList<Cell>();
  long closeCheckInterval=HStore.getCloseCheckInterval();
  long lastMillis=0;
  if (LOG.isDebugEnabled()) {
    lastMillis=EnvironmentEdgeManager.currentTime();
  }
  long now=0;
  boolean hasMore;
  do {
    hasMore=scanner.next(cells,compactionKVMax);
    if (LOG.isDebugEnabled()) {
      now=EnvironmentEdgeManager.currentTime();
    }
    for (    Cell c : cells) {
      if (cleanSeqId && c.getSequenceId() <= smallestReadPoint) {
        CellUtil.setSequenceId(c,0);
      }
      writer.append(c);
      int len=KeyValueUtil.length(c);
      ++progress.currentCompactedKVs;
      progress.totalCompactedSize+=len;
      if (LOG.isDebugEnabled()) {
        bytesWrittenProgress+=len;
      }
      if (closeCheckInterval > 0) {
        bytesWritten+=len;
        if (bytesWritten > closeCheckInterval) {
          bytesWritten=0;
          if (!store.areWritesEnabled()) {
            progress.cancel();
            return false;
          }
        }
      }
    }
    if (LOG.isDebugEnabled()) {
      if ((now - lastMillis) >= 60 * 1000) {
        LOG.debug("Compaction progress: " + progress + String.format(", rate=%.2f kB/sec",(bytesWrittenProgress / 1024.0) / ((now - lastMillis) / 1000.0)));
        lastMillis=now;
        bytesWrittenProgress=0;
      }
    }
    cells.clear();
  }
 while (hasMore);
  progress.complete();
  return true;
}
