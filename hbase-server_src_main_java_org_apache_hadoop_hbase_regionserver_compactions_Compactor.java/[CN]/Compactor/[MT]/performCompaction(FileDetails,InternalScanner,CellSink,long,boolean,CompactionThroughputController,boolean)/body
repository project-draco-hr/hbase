{
  long bytesWrittenProgressForCloseCheck=0;
  long bytesWrittenProgressForLog=0;
  long bytesWrittenProgressForShippedCall=0;
  List<Cell> cells=new ArrayList<Cell>();
  long closeCheckSizeLimit=HStore.getCloseCheckInterval();
  long lastMillis=0;
  if (LOG.isDebugEnabled()) {
    lastMillis=EnvironmentEdgeManager.currentTime();
  }
  String compactionName=generateCompactionName();
  long now=0;
  boolean hasMore;
  ScannerContext scannerContext=ScannerContext.newBuilder().setBatchLimit(compactionKVMax).build();
  throughputController.start(compactionName);
  KeyValueScanner kvs=(scanner instanceof KeyValueScanner) ? (KeyValueScanner)scanner : null;
  int minFilesToCompact=Math.max(2,conf.getInt(CompactionConfiguration.HBASE_HSTORE_COMPACTION_MIN_KEY,conf.getInt("hbase.hstore.compactionThreshold",3)));
  long shippedCallSizeLimit=minFilesToCompact * HConstants.DEFAULT_BLOCKSIZE;
  try {
    do {
      hasMore=scanner.next(cells,scannerContext);
      if (LOG.isDebugEnabled()) {
        now=EnvironmentEdgeManager.currentTime();
      }
      for (      Cell c : cells) {
        if (cleanSeqId && c.getSequenceId() <= smallestReadPoint) {
          CellUtil.setSequenceId(c,0);
        }
        writer.append(c);
        int len=KeyValueUtil.length(c);
        ++progress.currentCompactedKVs;
        progress.totalCompactedSize+=len;
        bytesWrittenProgressForShippedCall+=len;
        if (LOG.isDebugEnabled()) {
          bytesWrittenProgressForLog+=len;
        }
        throughputController.control(compactionName,len);
        if (closeCheckSizeLimit > 0) {
          bytesWrittenProgressForCloseCheck+=len;
          if (bytesWrittenProgressForCloseCheck > closeCheckSizeLimit) {
            bytesWrittenProgressForCloseCheck=0;
            if (!store.areWritesEnabled()) {
              progress.cancel();
              return false;
            }
          }
        }
        if (kvs != null && bytesWrittenProgressForShippedCall > shippedCallSizeLimit) {
          kvs.shipped();
          bytesWrittenProgressForShippedCall=0;
        }
      }
      if (LOG.isDebugEnabled()) {
        if ((now - lastMillis) >= COMPACTION_PROGRESS_LOG_INTERVAL) {
          LOG.debug("Compaction progress: " + compactionName + " "+ progress+ String.format(", rate=%.2f kB/sec",(bytesWrittenProgressForLog / 1024.0) / ((now - lastMillis) / 1000.0))+ ", throughputController is "+ throughputController);
          lastMillis=now;
          bytesWrittenProgressForLog=0;
        }
      }
      cells.clear();
    }
 while (hasMore);
  }
 catch (  InterruptedException e) {
    progress.cancel();
    throw new InterruptedIOException("Interrupted while control throughput of compacting " + compactionName);
  }
 finally {
    throughputController.finish(compactionName);
  }
  progress.complete();
  return true;
}
