{
  int bytesWritten=0;
  List<KeyValue> kvs=new ArrayList<KeyValue>();
  int closeCheckInterval=HStore.getCloseCheckInterval();
  boolean hasMore;
  peakCompactionsThrottle.startCompaction();
  do {
    hasMore=scanner.next(kvs,compactionKVMax);
    for (    KeyValue kv : kvs) {
      if (kv.getMemstoreTS() <= smallestReadPoint) {
        kv.setMemstoreTS(0);
      }
      writer.append(kv);
      ++progress.currentCompactedKVs;
      if (closeCheckInterval > 0) {
        bytesWritten+=kv.getLength();
        if (bytesWritten > closeCheckInterval) {
          bytesWritten=0;
          if (!store.areWritesEnabled()) {
            progress.cancel();
            return false;
          }
        }
      }
      peakCompactionsThrottle.throttle(kv.getLength());
    }
    kvs.clear();
  }
 while (hasMore);
  peakCompactionsThrottle.finishCompaction(this.store.getRegionInfo().getRegionNameAsString(),this.store.getFamily().getNameAsString());
  progress.complete();
  return true;
}
