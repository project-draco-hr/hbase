{
  LOG.debug("In-Memory compaction does pay off - The estimated number of cells " + "after compaction is " + numOfCells + ", while number of cells before is "+ versionedList.getNumOfCells()+ ". The fraction of remaining cells should be: "+ fraction);
  ImmutableSegment result=null;
  MemStoreCompactorIterator iterator=new MemStoreCompactorIterator(versionedList.getStoreSegments(),compactingMemStore.getComparator(),compactionKVMax,compactingMemStore.getStore());
  try {
switch (type) {
case COMPACT_TO_SKIPLIST_MAP:
      result=SegmentFactory.instance().createImmutableSegment(compactingMemStore.getConfiguration(),compactingMemStore.getComparator(),iterator);
    break;
case COMPACT_TO_ARRAY_MAP:
  result=SegmentFactory.instance().createImmutableSegment(compactingMemStore.getConfiguration(),compactingMemStore.getComparator(),iterator,numOfCells,ImmutableSegment.Type.ARRAY_MAP_BASED);
break;
default :
throw new RuntimeException("Unknown type " + type);
}
}
  finally {
iterator.close();
}
return result;
}
