{
  Put put=null;
  Delete del=null;
  Cell lastKV=null;
  for (  Cell kv : val.getCells()) {
    if (WALEdit.isMetaEditFamily(CellUtil.cloneFamily(kv))) {
      continue;
    }
    if (lastKV == null || lastKV.getTypeByte() != kv.getTypeByte() || !CellUtil.matchingRow(lastKV,kv)) {
      if (put != null) {
        applyAction(htable,put);
      }
      if (del != null) {
        applyAction(htable,del);
      }
      if (CellUtil.isDelete(kv)) {
        del=new Delete(CellUtil.cloneRow(kv));
      }
 else {
        put=new Put(CellUtil.cloneRow(kv));
      }
    }
    if (CellUtil.isDelete(kv)) {
      del.addDeleteMarker(kv);
    }
 else {
      put.add(kv);
    }
    lastKV=kv;
  }
  if (put != null) {
    applyAction(htable,put);
  }
  if (del != null) {
    applyAction(htable,del);
  }
}
