{
  Class<?> implClass=null;
  try {
    implClass=getClass().getClassLoader().loadClass(className);
  }
 catch (  ClassNotFoundException e) {
    LOG.info("Class " + className + " needs to be loaded from a file - "+ path.toString()+ ".");
  }
  if (implClass == null) {
    if (!path.toString().endsWith(".jar")) {
      throw new IOException(path.toString() + ": not a jar file?");
    }
    FileSystem fs=path.getFileSystem(HBaseConfiguration.create());
    Path dst=new Path(System.getProperty("java.io.tmpdir") + java.io.File.separator + "."+ pathPrefix+ "."+ className+ "."+ System.currentTimeMillis()+ ".jar");
    fs.copyToLocalFile(path,dst);
    fs.deleteOnExit(dst);
    String cp=System.getProperty("java.class.path");
    List<URL> paths=new ArrayList<URL>();
    paths.add(new File(dst.toString()).getCanonicalFile().toURL());
    JarFile jarFile=new JarFile(dst.toString());
    Enumeration<JarEntry> entries=jarFile.entries();
    while (entries.hasMoreElements()) {
      JarEntry entry=entries.nextElement();
      if (entry.getName().matches("/lib/[^/]+\\.jar")) {
        File file=new File(System.getProperty("java.io.tmpdir") + java.io.File.separator + "."+ pathPrefix+ "."+ className+ "."+ System.currentTimeMillis()+ "."+ entry.getName().substring(5));
        IOUtils.copyBytes(jarFile.getInputStream(entry),new FileOutputStream(file),conf,true);
        file.deleteOnExit();
        paths.add(file.toURL());
      }
    }
    StringTokenizer st=new StringTokenizer(cp,File.pathSeparator);
    while (st.hasMoreTokens()) {
      paths.add((new File(st.nextToken())).getCanonicalFile().toURL());
    }
    ClassLoader cl=new URLClassLoader(paths.toArray(new URL[]{}),this.getClass().getClassLoader());
    Thread.currentThread().setContextClassLoader(cl);
    try {
      implClass=cl.loadClass(className);
    }
 catch (    ClassNotFoundException e) {
      throw new IOException(e);
    }
  }
  return loadInstance(implClass,priority,conf);
}
