{
  isActiveMaster=true;
  status.setStatus("Initializing Master file system");
  this.masterActiveTime=System.currentTimeMillis();
  this.fileSystemManager=new MasterFileSystem(this,this,metricsMaster,masterRecovery);
  this.tableDescriptors=new FSTableDescriptors(this.fileSystemManager.getFileSystem(),this.fileSystemManager.getRootDir());
  status.setStatus("Publishing Cluster ID in ZooKeeper");
  ZKClusterId.setClusterId(this.zooKeeper,fileSystemManager.getClusterId());
  if (!masterRecovery) {
    this.executorService=new ExecutorService(getServerName().toString());
    this.serverManager=createServerManager(this,this);
  }
  this.tableLockManager=TableLockManager.createTableLockManager(conf,zooKeeper,serverName);
  if (!masterRecovery) {
    this.tableLockManager.reapWriteLocks();
  }
  status.setStatus("Initializing ZK system trackers");
  initializeZKBasedSystemTrackers();
  if (!masterRecovery) {
    status.setStatus("Initializing master coprocessors");
    this.cpHost=new MasterCoprocessorHost(this,this.conf);
    spanReceiverHost=new SpanReceiverHost(getConfiguration());
    spanReceiverHost.loadSpanReceivers();
    status.setStatus("Initializing master service threads");
    startServiceThreads();
  }
  this.serverManager.waitForRegionServers(status);
  for (  ServerName sn : this.regionServerTracker.getOnlineServers()) {
    if (!this.serverManager.isServerOnline(sn) && serverManager.checkAlreadySameHostPortAndRecordNewServer(sn,ServerLoad.EMPTY_SERVERLOAD)) {
      LOG.info("Registered server found up in zk but who has not yet " + "reported in: " + sn);
    }
  }
  if (!masterRecovery) {
    this.assignmentManager.startTimeOutMonitor();
  }
  Set<ServerName> previouslyFailedServers=this.fileSystemManager.getFailedServersFromLogFolders();
  this.fileSystemManager.removeStaleRecoveringRegionsFromZK(previouslyFailedServers);
  ServerName oldMetaServerLocation=this.catalogTracker.getMetaLocation();
  if (oldMetaServerLocation != null && previouslyFailedServers.contains(oldMetaServerLocation)) {
    splitMetaLogBeforeAssignment(oldMetaServerLocation);
  }
  this.initializationBeforeMetaAssignment=true;
  status.setStatus("Assigning Meta Region");
  assignMeta(status);
  if (this.stopped)   return;
  if (this.distributedLogReplay && oldMetaServerLocation != null && previouslyFailedServers.contains(oldMetaServerLocation)) {
    status.setStatus("replaying log for Meta Region");
    this.fileSystemManager.splitMetaLog(oldMetaServerLocation);
  }
  enableServerShutdownHandler();
  status.setStatus("Submitting log splitting work for previously failed region servers");
  for (  ServerName tmpServer : previouslyFailedServers) {
    this.serverManager.processDeadServer(tmpServer,true);
  }
  org.apache.hadoop.hbase.catalog.MetaMigrationConvertingToPB.updateMetaIfNecessary(this);
  this.balancer.setMasterServices(this);
  status.setStatus("Starting assignment manager");
  this.assignmentManager.joinCluster();
  this.balancer.setClusterStatus(getClusterStatus());
  if (!masterRecovery) {
    status.setStatus("Starting balancer and catalog janitor");
    this.clusterStatusChore=getAndStartClusterStatusChore(this);
    this.balancerChore=getAndStartBalancerChore(this);
    this.catalogJanitorChore=new CatalogJanitor(this,this);
    startCatalogJanitorChore();
  }
  status.markComplete("Initialization successful");
  LOG.info("Master has completed initialization");
  initialized=true;
  this.serverManager.clearDeadServersWithSameHostNameAndPortOfOnlineServer();
  if (!masterRecovery) {
    if (this.cpHost != null) {
      try {
        this.cpHost.postStartMaster();
      }
 catch (      IOException ioe) {
        LOG.error("Coprocessor postStartMaster() hook failed",ioe);
      }
    }
  }
}
