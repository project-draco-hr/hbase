{
  boolean oldValue=this.loadBalancerTracker.isBalancerOn();
  boolean newValue=b;
  try {
    if (this.cpHost != null) {
      newValue=this.cpHost.preBalanceSwitch(newValue);
    }
    try {
      if (mode == BalanceSwitchMode.SYNC) {
synchronized (this.balancer) {
          this.loadBalancerTracker.setBalancerOn(newValue);
        }
      }
 else {
        this.loadBalancerTracker.setBalancerOn(newValue);
      }
    }
 catch (    KeeperException ke) {
      throw new IOException(ke);
    }
    LOG.info("BalanceSwitch=" + newValue);
    if (this.cpHost != null) {
      this.cpHost.postBalanceSwitch(oldValue,newValue);
    }
  }
 catch (  IOException ioe) {
    LOG.warn("Error flipping balance switch",ioe);
  }
  return oldValue;
}
