{
  SnapshotDescription reqSnapshot=request.getSnapshot();
  FileSystem fs=this.getMasterFileSystem().getFileSystem();
  Path rootDir=this.getMasterFileSystem().getRootDir();
  Path snapshotDir=SnapshotDescriptionUtils.getCompletedSnapshotDir(request.getSnapshot(),rootDir);
  try {
    if (!fs.exists(snapshotDir)) {
      LOG.error("A Snapshot named '" + reqSnapshot.getName() + "' does not exist.");
      throw new SnapshotDoesNotExistException(reqSnapshot);
    }
    SnapshotDescription snapshot=SnapshotDescriptionUtils.readSnapshotInfo(fs,snapshotDir);
    HTableDescriptor snapshotTableDesc=FSTableDescriptors.getTableDescriptor(fs,snapshotDir);
    String tableName=reqSnapshot.getTable();
    if (MetaReader.tableExists(catalogTracker,tableName)) {
      if (this.assignmentManager.getZKTable().isEnabledTable(snapshot.getTable())) {
        throw new ServiceException(new UnsupportedOperationException("Table '" + snapshot.getTable() + "' must be disabled in order to perform a restore operation."));
      }
      if (cpHost != null) {
        cpHost.preRestoreSnapshot(snapshot,snapshotTableDesc);
      }
      snapshotManager.restoreSnapshot(snapshot,snapshotTableDesc);
      LOG.info("Restore snapshot=" + snapshot.getName() + " as table="+ tableName);
      if (cpHost != null) {
        cpHost.postRestoreSnapshot(snapshot,snapshotTableDesc);
      }
    }
 else {
      HTableDescriptor htd=RestoreSnapshotHelper.cloneTableSchema(snapshotTableDesc,Bytes.toBytes(tableName));
      if (cpHost != null) {
        cpHost.preCloneSnapshot(snapshot,htd);
      }
      snapshotManager.cloneSnapshot(snapshot,htd);
      LOG.info("Clone snapshot=" + snapshot.getName() + " as table="+ tableName);
      if (cpHost != null) {
        cpHost.postCloneSnapshot(snapshot,htd);
      }
    }
    return RestoreSnapshotResponse.newBuilder().build();
  }
 catch (  IOException e) {
    throw new ServiceException(e);
  }
}
