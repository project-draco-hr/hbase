{
  int numDataNodes=numSlaves;
  if (dataNodeHosts != null && dataNodeHosts.length != 0) {
    numDataNodes=dataNodeHosts.length;
  }
  LOG.info("Starting up minicluster with " + numMasters + " master(s) and "+ numSlaves+ " regionserver(s) and "+ numDataNodes+ " datanode(s)");
  String testBuildPath=conf.get(TEST_DIRECTORY_KEY,null);
  isRunningCluster(testBuildPath);
  if (testBuildPath != null) {
    LOG.info("Using passed path: " + testBuildPath);
  }
  this.clusterTestBuildDir=testBuildPath == null ? setupClusterTestBuildDir() : new File(testBuildPath);
  System.setProperty(TEST_DIRECTORY_KEY,this.clusterTestBuildDir.getPath());
  startMiniDFSCluster(numDataNodes,this.clusterTestBuildDir,dataNodeHosts);
  this.dfsCluster.waitClusterUp();
  if (this.zkCluster == null) {
    startMiniZKCluster(this.clusterTestBuildDir);
  }
  return startMiniHBaseCluster(numMasters,numSlaves);
}
