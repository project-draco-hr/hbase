{
  for (  HRegion r : cluster.getRegionThreads().get(0).getRegionServer().getOnlineRegions()) {
    HRegionIncommon region=new HRegionIncommon(r);
    region.flushcache();
  }
  Path localDir=new Path(getUnitTestdir(getName()),"index_" + Integer.toString(new Random().nextInt()));
  this.fs.copyToLocalFile(new Path(INDEX_DIR),localDir);
  FileSystem localfs=FileSystem.getLocal(conf);
  FileStatus[] indexDirs=localfs.listStatus(localDir);
  Searcher searcher=null;
  Scanner scanner=null;
  try {
    if (indexDirs.length == 1) {
      searcher=new IndexSearcher((new File(indexDirs[0].getPath().toUri())).getAbsolutePath());
    }
 else     if (indexDirs.length > 1) {
      Searchable[] searchers=new Searchable[indexDirs.length];
      for (int i=0; i < indexDirs.length; i++) {
        searchers[i]=new IndexSearcher((new File(indexDirs[i].getPath().toUri()).getAbsolutePath()));
      }
      searcher=new MultiSearcher(searchers);
    }
 else {
      throw new IOException("no index directory found");
    }
    HTable table=new HTable(conf,TABLE_NAME);
    scanner=table.getScanner(columns,HConstants.EMPTY_START_ROW);
    IndexConfiguration indexConf=new IndexConfiguration();
    String content=conf.get("hbase.index.conf");
    if (content != null) {
      indexConf.addFromXML(content);
    }
    String rowkeyName=indexConf.getRowkeyName();
    int count=0;
    for (    RowResult r : scanner) {
      String value=Bytes.toString(r.getRow());
      Term term=new Term(rowkeyName,value);
      int hitCount=searcher.search(new TermQuery(term)).length();
      assertEquals("check row " + value,1,hitCount);
      count++;
    }
    LOG.debug("Searcher.maxDoc: " + searcher.maxDoc());
    LOG.debug("IndexReader.numDocs: " + ((IndexSearcher)searcher).getIndexReader().numDocs());
    int maxDoc=((IndexSearcher)searcher).getIndexReader().numDocs();
    assertEquals("check number of rows",maxDoc,count);
  }
  finally {
    if (null != searcher)     searcher.close();
    if (null != scanner)     scanner.close();
  }
}
