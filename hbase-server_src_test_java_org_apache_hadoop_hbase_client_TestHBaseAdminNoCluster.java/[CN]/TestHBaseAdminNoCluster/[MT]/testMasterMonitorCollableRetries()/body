{
  Configuration configuration=HBaseConfiguration.create();
  configuration.setLong(HConstants.HBASE_CLIENT_PAUSE,1);
  final int count=10;
  configuration.setInt(HConstants.HBASE_CLIENT_RETRIES_NUMBER,count);
  HConnection connection=HConnectionTestingUtility.getMockedConnection(configuration);
  MasterAdminKeepAliveConnection masterAdmin=Mockito.mock(MasterAdminKeepAliveConnection.class);
  Mockito.when(masterAdmin.createTable((RpcController)Mockito.any(),(MasterAdminProtos.CreateTableRequest)Mockito.any())).thenThrow(new ServiceException("Test fail").initCause(new PleaseHoldException("test")));
  Mockito.when(connection.getKeepAliveMasterAdminService()).thenReturn(masterAdmin);
  HBaseAdmin admin=new HBaseAdmin(configuration);
  try {
    HTableDescriptor htd=new HTableDescriptor(TableName.valueOf("testMasterMonitorCollableRetries"));
    try {
      admin.createTable(htd,HBaseTestingUtility.KEYS_FOR_HBA_CREATE_TABLE);
      fail();
    }
 catch (    RetriesExhaustedException e) {
      Log.info("Expected fail",e);
    }
    Mockito.verify(masterAdmin,Mockito.atLeast(count)).createTable((RpcController)Mockito.any(),(MasterAdminProtos.CreateTableRequest)Mockito.any());
  }
  finally {
    admin.close();
    if (connection != null)     HConnectionManager.deleteConnection(configuration);
  }
}
