{
  this.conf=conf;
  try {
    try {
      if (System.getProperty(StaticTestEnvironment.TEST_DIRECTORY_KEY) == null) {
        File testDir=new File(new File("").getAbsolutePath(),"build/contrib/hbase/test");
        String dir=testDir.getAbsolutePath();
        LOG.info("Setting test.build.data to " + dir);
        System.setProperty(StaticTestEnvironment.TEST_DIRECTORY_KEY,dir);
      }
      if (miniHdfsFilesystem) {
        this.cluster=new MiniDFSCluster(this.conf,2,true,(String[])null);
      }
      this.fs=FileSystem.get(conf);
      this.parentdir=new Path(conf.get(HREGION_DIR,DEFAULT_HREGION_DIR));
      fs.mkdirs(parentdir);
    }
 catch (    Throwable e) {
      LOG.error("Failed setup of FileSystem",e);
      throw e;
    }
    if (this.conf.get(MASTER_ADDRESS) == null) {
      this.conf.set(MASTER_ADDRESS,"localhost:0");
    }
    this.master=new HMaster(conf);
    this.masterThread=new Thread(this.master,"HMaster");
    LOG.info("Starting HMaster");
    masterThread.start();
    String address=master.getMasterAddress().toString();
    this.conf.set(MASTER_ADDRESS,address);
    if (this.conf.get(REGIONSERVER_ADDRESS) == null) {
      this.conf.set(REGIONSERVER_ADDRESS,"localhost:0");
    }
    LOG.info("Starting HRegionServers");
    startRegionServers(this.conf,nRegionNodes);
  }
 catch (  Throwable e) {
    e.printStackTrace();
    shutdown();
  }
}
