{
  try {
    try {
      this.fs=FileSystem.get(conf);
      this.parentdir=new Path(conf.get(HBASE_DIR,DEFAULT_HBASE_DIR));
      fs.mkdirs(parentdir);
    }
 catch (    IOException e) {
      LOG.error("Failed setup of FileSystem",e);
      throw e;
    }
    if (this.conf.get(MASTER_ADDRESS) == null) {
      this.conf.set(MASTER_ADDRESS,"localhost:0");
    }
    this.master=new HMaster(conf);
    this.masterThread=new Thread(this.master,"HMaster");
    LOG.info("Starting HMaster");
    masterThread.start();
    String address=master.getMasterAddress().toString();
    this.conf.set(MASTER_ADDRESS,address);
    if (this.conf.get(REGIONSERVER_ADDRESS) == null || nRegionNodes > 1) {
      this.conf.set(REGIONSERVER_ADDRESS,DEFAULT_HOST + ":0");
    }
    LOG.info("Starting HRegionServers");
    startRegionServers(this.conf,nRegionNodes);
  }
 catch (  IOException e) {
    shutdown();
    throw e;
  }
}
