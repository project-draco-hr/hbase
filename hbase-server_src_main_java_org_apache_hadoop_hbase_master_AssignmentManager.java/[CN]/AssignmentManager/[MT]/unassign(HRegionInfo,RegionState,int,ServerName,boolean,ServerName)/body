{
  ServerName server=src;
  if (state != null) {
    server=state.getServerName();
  }
  long maxWaitTime=-1;
  for (int i=1; i <= this.maximumAttempts; i++) {
    if (this.server.isStopped() || this.server.isAborted()) {
      LOG.debug("Server stopped/aborted; skipping unassign of " + region);
      return;
    }
    if (!serverManager.isServerOnline(server)) {
      LOG.debug("Offline " + region.getRegionNameAsString() + ", no need to unassign since it's on a dead server: "+ server);
      if (transitionInZK) {
        deleteClosingOrClosedNode(region,server);
      }
      if (state != null) {
        regionOffline(region);
      }
      return;
    }
    try {
      if (serverManager.sendRegionClose(server,region,versionOfClosingNode,dest,transitionInZK)) {
        LOG.debug("Sent CLOSE to " + server + " for region "+ region.getRegionNameAsString());
        if (!transitionInZK && state != null) {
          unassign(region,state,versionOfClosingNode,dest,transitionInZK,src);
        }
        return;
      }
      LOG.warn("Server " + server + " region CLOSE RPC returned false for "+ region.getRegionNameAsString());
    }
 catch (    Throwable t) {
      if (t instanceof RemoteException) {
        t=((RemoteException)t).unwrapRemoteException();
      }
      if (t instanceof NotServingRegionException || t instanceof RegionServerStoppedException || t instanceof ServerNotRunningYetException|| t instanceof FailedServerException) {
        LOG.debug("Offline " + region.getRegionNameAsString() + ", it's not any more on "+ server,t);
        if (transitionInZK) {
          deleteClosingOrClosedNode(region,server);
        }
        if (state != null) {
          regionOffline(region);
        }
        return;
      }
 else       if (state != null && t instanceof RegionAlreadyInTransitionException) {
        LOG.debug("update " + state + " the timestamp.");
        state.updateTimestampToNow();
        if (maxWaitTime < 0) {
          maxWaitTime=EnvironmentEdgeManager.currentTimeMillis() + this.server.getConfiguration().getLong(ALREADY_IN_TRANSITION_WAITTIME,DEFAULT_ALREADY_IN_TRANSITION_WAITTIME);
        }
        try {
          long now=EnvironmentEdgeManager.currentTimeMillis();
          if (now < maxWaitTime) {
            LOG.debug("Region is already in transition; " + "waiting up to " + (maxWaitTime - now) + "ms",t);
            Thread.sleep(100);
            i--;
          }
        }
 catch (        InterruptedException ie) {
          LOG.warn("Failed to unassign " + region.getRegionNameAsString() + " since interrupted",ie);
          Thread.currentThread().interrupt();
          if (!tomActivated) {
            regionStates.updateRegionState(region,State.FAILED_CLOSE);
          }
          return;
        }
      }
 else {
        LOG.info("Server " + server + " returned "+ t+ " for "+ region.getRegionNameAsString()+ ", try="+ i+ " of "+ this.maximumAttempts,t);
      }
    }
  }
  if (!tomActivated && state != null) {
    regionStates.updateRegionState(region,State.FAILED_CLOSE);
  }
}
