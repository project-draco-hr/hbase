{
  ZKAssign.deleteAllNodes(watcher);
  ZKUtil.listChildrenAndWatchForNewChildren(this.watcher,this.watcher.assignmentZNode);
  failoverCleanupDone();
  Set<TableName> disabledOrDisablingOrEnabling=ZKTable.getDisabledOrDisablingTables(watcher);
  disabledOrDisablingOrEnabling.addAll(ZKTable.getEnablingTables(watcher));
  Map<HRegionInfo,ServerName> allRegions;
  if (this.shouldAssignRegionsWithFavoredNodes) {
    allRegions=FavoredNodeAssignmentHelper.fullScan(catalogTracker,disabledOrDisablingOrEnabling,true,(FavoredNodeLoadBalancer)balancer);
  }
 else {
    allRegions=MetaReader.fullScan(catalogTracker,disabledOrDisablingOrEnabling,true);
  }
  if (allRegions == null)   return;
  for (Iterator<HRegionInfo> iter=allRegions.keySet().iterator(); iter.hasNext(); ) {
    if (iter.next().getTableName().isSystemTable()) {
      iter.remove();
    }
  }
  if (allRegions.isEmpty())   return;
  boolean retainAssignment=server.getConfiguration().getBoolean("hbase.master.startup.retainassign",true);
  if (retainAssignment) {
    assign(allRegions);
  }
 else {
    List<HRegionInfo> regions=new ArrayList<HRegionInfo>(allRegions.keySet());
    assign(regions);
  }
  for (  HRegionInfo hri : allRegions.keySet()) {
    TableName tableName=hri.getTableName();
    if (!zkTable.isEnabledTable(tableName)) {
      setEnabledTable(tableName);
    }
  }
}
