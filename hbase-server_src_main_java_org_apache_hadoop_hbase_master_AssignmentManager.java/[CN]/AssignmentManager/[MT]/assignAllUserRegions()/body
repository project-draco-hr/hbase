{
  ZKAssign.deleteAllNodes(watcher);
  ZKUtil.listChildrenAndWatchForNewChildren(this.watcher,this.watcher.assignmentZNode);
  failoverCleanupDone();
  Set<String> disabledOrDisablingOrEnabling=ZKTable.getDisabledOrDisablingTables(watcher);
  disabledOrDisablingOrEnabling.addAll(ZKTable.getEnablingTables(watcher));
  Map<HRegionInfo,ServerName> allRegions=MetaReader.fullScan(catalogTracker,disabledOrDisablingOrEnabling,true);
  if (allRegions == null || allRegions.isEmpty())   return;
  boolean retainAssignment=server.getConfiguration().getBoolean("hbase.master.startup.retainassign",true);
  if (retainAssignment) {
    List<ServerName> servers=serverManager.createDestinationServersList();
    if (servers == null || servers.isEmpty()) {
      throw new IOException("Found no destination server to assign region(s)");
    }
    Map<ServerName,List<HRegionInfo>> bulkPlan=balancer.retainAssignment(allRegions,servers);
    LOG.info("Bulk assigning " + allRegions.size() + " region(s) across "+ servers.size()+ " server(s), retainAssignment=true");
    BulkAssigner ba=new GeneralBulkAssigner(this.server,bulkPlan,this);
    ba.bulkAssign();
    LOG.info("Bulk assigning done");
  }
 else {
    List<HRegionInfo> regions=new ArrayList<HRegionInfo>(allRegions.keySet());
    assign(regions);
  }
  for (  HRegionInfo hri : allRegions.keySet()) {
    setEnabledTable(hri);
  }
}
