{
  final byte[] tableName=Bytes.toBytes("testGrantRevokeAtQualifierLevel");
  final byte[] family1=Bytes.toBytes("f1");
  final byte[] family2=Bytes.toBytes("f2");
  final byte[] qualifier=Bytes.toBytes("q");
  HBaseAdmin admin=TEST_UTIL.getHBaseAdmin();
  if (admin.tableExists(tableName)) {
    admin.disableTable(tableName);
    admin.deleteTable(tableName);
  }
  HTableDescriptor htd=new HTableDescriptor(tableName);
  htd.addFamily(new HColumnDescriptor(family1));
  htd.addFamily(new HColumnDescriptor(family2));
  htd.setOwnerString(USER_OWNER.getShortName());
  admin.createTable(htd);
  User user=User.createUserForTesting(TEST_UTIL.getConfiguration(),"user",new String[0]);
  HTable acl=new HTable(conf,AccessControlLists.ACL_TABLE_NAME);
  AccessControllerProtocol protocol=acl.coprocessorProxy(AccessControllerProtocol.class,tableName);
  PrivilegedExceptionAction getQualifierAction=new PrivilegedExceptionAction(){
    public Object run() throws Exception {
      Get g=new Get(Bytes.toBytes("random_row"));
      g.addColumn(family1,qualifier);
      HTable t=new HTable(conf,tableName);
      t.get(g);
      return null;
    }
  }
;
  PrivilegedExceptionAction putQualifierAction=new PrivilegedExceptionAction(){
    public Object run() throws Exception {
      Put p=new Put(Bytes.toBytes("random_row"));
      p.add(family1,qualifier,Bytes.toBytes("v1"));
      HTable t=new HTable(conf,tableName);
      t.put(p);
      return null;
    }
  }
;
  PrivilegedExceptionAction deleteQualifierAction=new PrivilegedExceptionAction(){
    public Object run() throws Exception {
      Delete d=new Delete(Bytes.toBytes("random_row"));
      d.deleteColumn(family1,qualifier);
      HTable t=new HTable(conf,tableName);
      t.delete(d);
      return null;
    }
  }
;
  protocol.revoke(new UserPermission(Bytes.toBytes(user.getShortName()),tableName,family1));
  verifyDenied(user,getQualifierAction);
  verifyDenied(user,putQualifierAction);
  verifyDenied(user,deleteQualifierAction);
  protocol.grant(new UserPermission(Bytes.toBytes(user.getShortName()),tableName,family1,qualifier,Permission.Action.READ));
  Thread.sleep(100);
  verifyAllowed(user,getQualifierAction);
  verifyDenied(user,putQualifierAction);
  verifyDenied(user,deleteQualifierAction);
  protocol.grant(new UserPermission(Bytes.toBytes(user.getShortName()),tableName,family1,qualifier,Permission.Action.WRITE));
  Thread.sleep(100);
  verifyDenied(user,getQualifierAction);
  verifyAllowed(user,putQualifierAction);
  verifyAllowed(user,deleteQualifierAction);
  protocol.grant(new UserPermission(Bytes.toBytes(user.getShortName()),tableName,family1,qualifier,Permission.Action.READ,Permission.Action.WRITE));
  Thread.sleep(100);
  verifyAllowed(user,getQualifierAction);
  verifyAllowed(user,putQualifierAction);
  verifyAllowed(user,deleteQualifierAction);
  protocol.revoke(new UserPermission(Bytes.toBytes(user.getShortName()),tableName,family1,qualifier));
  Thread.sleep(100);
  verifyDenied(user,getQualifierAction);
  verifyDenied(user,putQualifierAction);
  verifyDenied(user,deleteQualifierAction);
  admin.disableTable(tableName);
  admin.deleteTable(tableName);
}
