{
  conf=TEST_UTIL.getConfiguration();
  conf.set("hbase.master.hfilecleaner.plugins","org.apache.hadoop.hbase.master.cleaner.HFileLinkCleaner," + "org.apache.hadoop.hbase.master.snapshot.SnapshotHFileCleaner");
  conf.set("hbase.master.logcleaner.plugins","org.apache.hadoop.hbase.master.snapshot.SnapshotLogCleaner");
  SecureTestUtil.enableSecurity(conf);
  TEST_UTIL.startMiniCluster();
  MasterCoprocessorHost cpHost=TEST_UTIL.getMiniHBaseCluster().getMaster().getCoprocessorHost();
  cpHost.load(AccessController.class,Coprocessor.PRIORITY_HIGHEST,conf);
  ACCESS_CONTROLLER=(AccessController)cpHost.findCoprocessor(AccessController.class.getName());
  CP_ENV=cpHost.createEnvironment(AccessController.class,ACCESS_CONTROLLER,Coprocessor.PRIORITY_HIGHEST,1,conf);
  RegionServerCoprocessorHost rsHost=TEST_UTIL.getMiniHBaseCluster().getRegionServer(0).getCoprocessorHost();
  RSCP_ENV=rsHost.createEnvironment(AccessController.class,ACCESS_CONTROLLER,Coprocessor.PRIORITY_HIGHEST,1,conf);
  TEST_UTIL.waitTableEnabled(AccessControlLists.ACL_TABLE_NAME);
  SUPERUSER=User.createUserForTesting(conf,"admin",new String[]{"supergroup"});
  USER_ADMIN=User.createUserForTesting(conf,"admin2",new String[0]);
  USER_RW=User.createUserForTesting(conf,"rwuser",new String[0]);
  USER_RO=User.createUserForTesting(conf,"rouser",new String[0]);
  USER_OWNER=User.createUserForTesting(conf,"owner",new String[0]);
  USER_CREATE=User.createUserForTesting(conf,"tbl_create",new String[0]);
  USER_NONE=User.createUserForTesting(conf,"nouser",new String[0]);
  HBaseAdmin admin=TEST_UTIL.getHBaseAdmin();
  HTableDescriptor htd=new HTableDescriptor(TEST_TABLE);
  htd.addFamily(new HColumnDescriptor(TEST_FAMILY));
  htd.setOwner(USER_OWNER);
  admin.createTable(htd);
  HRegion region=TEST_UTIL.getHBaseCluster().getRegions(TEST_TABLE).get(0);
  RegionCoprocessorHost rcpHost=region.getCoprocessorHost();
  RCP_ENV=rcpHost.createEnvironment(AccessController.class,ACCESS_CONTROLLER,Coprocessor.PRIORITY_HIGHEST,1,conf);
  HTable acl=new HTable(conf,AccessControlLists.ACL_TABLE_NAME);
  try {
    BlockingRpcChannel service=acl.coprocessorService(TEST_TABLE);
    AccessControlService.BlockingInterface protocol=AccessControlService.newBlockingStub(service);
    protocol.grant(null,RequestConverter.buildGrantRequest(USER_ADMIN.getShortName(),null,null,null,AccessControlProtos.Permission.Action.ADMIN,AccessControlProtos.Permission.Action.CREATE,AccessControlProtos.Permission.Action.READ,AccessControlProtos.Permission.Action.WRITE));
    protocol.grant(null,RequestConverter.buildGrantRequest(USER_RW.getShortName(),TEST_TABLE,TEST_FAMILY,null,AccessControlProtos.Permission.Action.READ,AccessControlProtos.Permission.Action.WRITE));
    protocol.grant(null,RequestConverter.buildGrantRequest(USER_RO.getShortName(),TEST_TABLE,TEST_FAMILY,null,AccessControlProtos.Permission.Action.READ));
    protocol.grant(null,RequestConverter.buildGrantRequest(USER_CREATE.getShortName(),TEST_TABLE,null,null,AccessControlProtos.Permission.Action.CREATE));
  }
  finally {
    acl.close();
  }
}
