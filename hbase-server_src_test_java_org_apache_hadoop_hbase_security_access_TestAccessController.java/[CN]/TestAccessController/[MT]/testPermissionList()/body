{
  final byte[] tableName=Bytes.toBytes("testPermissionList");
  final byte[] family1=Bytes.toBytes("f1");
  final byte[] family2=Bytes.toBytes("f2");
  final byte[] qualifier=Bytes.toBytes("q");
  HBaseAdmin admin=TEST_UTIL.getHBaseAdmin();
  if (admin.tableExists(tableName)) {
    admin.disableTable(tableName);
    admin.deleteTable(tableName);
  }
  HTableDescriptor htd=new HTableDescriptor(tableName);
  htd.addFamily(new HColumnDescriptor(family1));
  htd.addFamily(new HColumnDescriptor(family2));
  htd.setOwner(USER_OWNER);
  admin.createTable(htd);
  HTable acl=new HTable(conf,AccessControlLists.ACL_TABLE_NAME);
  BlockingRpcChannel service=acl.coprocessorService(tableName);
  AccessControlService.BlockingInterface protocol=AccessControlService.newBlockingStub(service);
  List<UserPermission> perms=ProtobufUtil.getUserPermissions(protocol,tableName);
  UserPermission ownerperm=new UserPermission(Bytes.toBytes(USER_OWNER.getName()),tableName,null,Action.values());
  assertTrue("Owner should have all permissions on table",hasFoundUserPermission(ownerperm,perms));
  User user=User.createUserForTesting(TEST_UTIL.getConfiguration(),"user",new String[0]);
  byte[] userName=Bytes.toBytes(user.getShortName());
  UserPermission up=new UserPermission(userName,tableName,family1,qualifier,Permission.Action.READ);
  assertFalse("User should not be granted permission: " + up.toString(),hasFoundUserPermission(up,perms));
  ProtobufUtil.grant(protocol,user.getShortName(),tableName,family1,qualifier,Permission.Action.READ);
  perms=ProtobufUtil.getUserPermissions(protocol,tableName);
  UserPermission upToVerify=new UserPermission(userName,tableName,family1,qualifier,Permission.Action.READ);
  assertTrue("User should be granted permission: " + upToVerify.toString(),hasFoundUserPermission(upToVerify,perms));
  upToVerify=new UserPermission(userName,tableName,family1,qualifier,Permission.Action.WRITE);
  assertFalse("User should not be granted permission: " + upToVerify.toString(),hasFoundUserPermission(upToVerify,perms));
  ProtobufUtil.grant(protocol,user.getShortName(),tableName,family1,qualifier,Permission.Action.WRITE,Permission.Action.READ);
  perms=ProtobufUtil.getUserPermissions(protocol,tableName);
  upToVerify=new UserPermission(userName,tableName,family1,qualifier,Permission.Action.WRITE,Permission.Action.READ);
  assertTrue("User should be granted permission: " + upToVerify.toString(),hasFoundUserPermission(upToVerify,perms));
  ProtobufUtil.revoke(protocol,user.getShortName(),tableName,family1,qualifier,Permission.Action.WRITE,Permission.Action.READ);
  perms=ProtobufUtil.getUserPermissions(protocol,tableName);
  assertFalse("User should not be granted permission: " + upToVerify.toString(),hasFoundUserPermission(upToVerify,perms));
  admin.disableTable(tableName);
  User newOwner=User.createUserForTesting(conf,"new_owner",new String[]{});
  htd.setOwner(newOwner);
  admin.modifyTable(tableName,htd);
  perms=ProtobufUtil.getUserPermissions(protocol,tableName);
  UserPermission newOwnerperm=new UserPermission(Bytes.toBytes(newOwner.getName()),tableName,null,Action.values());
  assertTrue("New owner should have all permissions on table",hasFoundUserPermission(newOwnerperm,perms));
  admin.deleteTable(tableName);
}
