{
  final byte[] tableName=Bytes.toBytes("changeTableSchemaOnlineFailure");
  TEST_UTIL.getMiniHBaseCluster().getMaster().getConfiguration().setBoolean("hbase.online.schema.update.enable",false);
  HTableDescriptor[] tables=admin.listTables();
  int numTables=tables.length;
  TEST_UTIL.createTable(tableName,HConstants.CATALOG_FAMILY).close();
  tables=this.admin.listTables();
  assertEquals(numTables + 1,tables.length);
  HTableDescriptor htd=this.admin.getTableDescriptor(tableName);
  HTableDescriptor copy=new HTableDescriptor(htd);
  assertTrue(htd.equals(copy));
  long newFlushSize=htd.getMemStoreFlushSize() / 2;
  copy.setMemStoreFlushSize(newFlushSize);
  final String key="anyoldkey";
  assertTrue(htd.getValue(key) == null);
  copy.setValue(key,key);
  boolean expectedException=false;
  try {
    modifyTable(tableName,copy);
  }
 catch (  TableNotDisabledException re) {
    expectedException=true;
  }
  assertTrue("Online schema update should not happen.",expectedException);
}
