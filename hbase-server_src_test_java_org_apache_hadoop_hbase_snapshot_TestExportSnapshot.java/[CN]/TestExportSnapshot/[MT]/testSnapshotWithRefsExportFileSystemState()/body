{
  Configuration conf=TEST_UTIL.getConfiguration();
  final byte[] tableWithRefsName=Bytes.toBytes("tableWithRefs");
  final String snapshotName="tableWithRefs";
  final String TEST_FAMILY=Bytes.toString(FAMILY);
  final String TEST_HFILE="abc";
  final SnapshotDescription sd=SnapshotDescription.newBuilder().setName(snapshotName).setTable(Bytes.toString(tableWithRefsName)).build();
  FileSystem fs=TEST_UTIL.getHBaseCluster().getMaster().getMasterFileSystem().getFileSystem();
  Path rootDir=TEST_UTIL.getHBaseCluster().getMaster().getMasterFileSystem().getRootDir();
  Path archiveDir=new Path(rootDir,HConstants.HFILE_ARCHIVE_DIRECTORY);
  HRegionInfo hri=new HRegionInfo(tableWithRefsName);
  HRegionFileSystem r0fs=HRegionFileSystem.createRegionOnFileSystem(conf,fs,new Path(archiveDir,hri.getTableNameAsString()),hri);
  Path storeFile=new Path(rootDir,TEST_HFILE);
  FSDataOutputStream out=fs.create(storeFile);
  out.write(Bytes.toBytes("Test Data"));
  out.close();
  r0fs.commitStoreFile(TEST_FAMILY,storeFile);
  hri=new HRegionInfo(tableWithRefsName);
  HRegionFileSystem r1fs=HRegionFileSystem.createRegionOnFileSystem(conf,fs,new Path(archiveDir,hri.getTableNameAsString()),hri);
  storeFile=new Path(rootDir,TEST_HFILE + '.' + r0fs.getRegionInfo().getEncodedName());
  out=fs.create(storeFile);
  out.write(Bytes.toBytes("Test Data"));
  out.close();
  r1fs.commitStoreFile(TEST_FAMILY,storeFile);
  Path tableDir=HTableDescriptor.getTableDir(archiveDir,tableWithRefsName);
  Path snapshotDir=SnapshotDescriptionUtils.getCompletedSnapshotDir(snapshotName,rootDir);
  FileUtil.copy(fs,tableDir,fs,snapshotDir,false,conf);
  SnapshotDescriptionUtils.writeSnapshotInfo(sd,snapshotDir,fs);
  testExportFileSystemState(tableWithRefsName,Bytes.toBytes(snapshotName),2);
}
