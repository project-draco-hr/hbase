{
  final byte[] tableName=Bytes.toBytes("testShutdownFixupWhenDaughterHasSplit");
  HTable t=TESTING_UTIL.createTable(tableName,HConstants.CATALOG_FAMILY);
  List<HRegion> regions=cluster.getRegions(tableName);
  HRegionInfo hri=getAndCheckSingleTableRegion(regions);
  int tableRegionIndex=ensureTableRegionNotOnSameServerAsMeta(admin,hri);
  this.admin.setBalancerRunning(false,true);
  cluster.getMaster().setCatalogJanitorEnabled(false);
  try {
    TESTING_UTIL.loadTable(t,HConstants.CATALOG_FAMILY);
    HRegionServer server=cluster.getRegionServer(tableRegionIndex);
    printOutRegions(server,"Initial regions: ");
    int regionCount=ProtobufUtil.getOnlineRegions(server).size();
    split(hri,server,regionCount);
    List<HRegion> daughters=checkAndGetDaughters(tableName);
    regionCount=ProtobufUtil.getOnlineRegions(server).size();
    HRegionInfo daughter=daughters.get(0).getRegionInfo();
    this.admin.compact(daughter.getRegionName());
    daughters=cluster.getRegions(tableName);
    HRegion daughterRegion=null;
    for (    HRegion r : daughters) {
      if (r.getRegionInfo().equals(daughter))       daughterRegion=r;
    }
    assertTrue(daughterRegion != null);
    while (true) {
      if (!daughterRegion.hasReferences())       break;
      Threads.sleep(100);
    }
    split(daughter,server,regionCount);
    daughters=cluster.getRegions(tableName);
    cluster.abortRegionServer(tableRegionIndex);
    waitUntilRegionServerDead();
    while (cluster.getRegions(tableName).size() < daughters.size()) {
      LOG.info("Waiting for repair to happen");
      Thread.sleep(1000);
    }
    regions=cluster.getRegions(tableName);
    assertEquals(daughters.size(),regions.size());
    for (    HRegion r : regions) {
      assertTrue(daughters.contains(r));
    }
  }
  finally {
    admin.setBalancerRunning(true,false);
    cluster.getMaster().setCatalogJanitorEnabled(true);
  }
}
