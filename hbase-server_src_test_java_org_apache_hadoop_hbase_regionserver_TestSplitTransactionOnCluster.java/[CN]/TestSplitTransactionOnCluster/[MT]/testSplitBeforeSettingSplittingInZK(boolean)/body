{
  final byte[] tableName=Bytes.toBytes("testSplitBeforeSettingSplittingInZK");
  HBaseAdmin admin=TESTING_UTIL.getHBaseAdmin();
  try {
    HTableDescriptor htd=new HTableDescriptor(tableName);
    htd.addFamily(new HColumnDescriptor("cf"));
    admin.createTable(htd);
    List<HRegion> regions=cluster.getRegions(tableName);
    int regionServerIndex=cluster.getServerWith(regions.get(0).getRegionName());
    HRegionServer regionServer=cluster.getRegionServer(regionServerIndex);
    SplitTransaction st=null;
    if (nodeCreated) {
      st=new MockedSplitTransaction(regions.get(0),null){
        @Override int transitionNodeSplitting(        ZooKeeperWatcher zkw,        HRegionInfo parent,        ServerName serverName,        int version) throws KeeperException, IOException {
          throw new IOException();
        }
      }
;
    }
 else {
      st=new MockedSplitTransaction(regions.get(0),null){
        @Override int createNodeSplitting(        ZooKeeperWatcher zkw,        HRegionInfo region,        ServerName serverName) throws KeeperException, IOException {
          throw new IOException();
        }
      }
;
    }
    try {
      st.execute(regionServer,regionServer);
    }
 catch (    IOException e) {
      String node=ZKAssign.getNodeName(regionServer.getZooKeeper(),regions.get(0).getRegionInfo().getEncodedName());
      if (nodeCreated) {
        assertFalse(ZKUtil.checkExists(regionServer.getZooKeeper(),node) == -1);
      }
 else {
        assertTrue(ZKUtil.checkExists(regionServer.getZooKeeper(),node) == -1);
      }
      assertTrue(st.rollback(regionServer,regionServer));
      assertTrue(ZKUtil.checkExists(regionServer.getZooKeeper(),node) == -1);
    }
  }
  finally {
    if (admin.isTableAvailable(tableName) && admin.isTableEnabled(tableName)) {
      admin.disableTable(tableName);
      admin.deleteTable(tableName);
    }
  }
}
