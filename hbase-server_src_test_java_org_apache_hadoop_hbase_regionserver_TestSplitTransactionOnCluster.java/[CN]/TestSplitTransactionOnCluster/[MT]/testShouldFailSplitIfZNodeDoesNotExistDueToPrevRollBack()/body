{
  final byte[] tableName=Bytes.toBytes("testShouldFailSplitIfZNodeDoesNotExistDueToPrevRollBack");
  HBaseAdmin admin=new HBaseAdmin(TESTING_UTIL.getConfiguration());
  try {
    HTable t=TESTING_UTIL.createTable(tableName,Bytes.toBytes("cf"));
    final List<HRegion> regions=cluster.getRegions(tableName);
    HRegionInfo hri=getAndCheckSingleTableRegion(regions);
    int regionServerIndex=cluster.getServerWith(regions.get(0).getRegionName());
    final HRegionServer regionServer=cluster.getRegionServer(regionServerIndex);
    insertData(tableName,admin,t);
    this.admin.setBalancerRunning(false,false);
    cluster.getMaster().setCatalogJanitorEnabled(false);
    new Thread(){
      public void run(){
        SplitTransaction st=null;
        st=new MockedSplitTransaction(regions.get(0),Bytes.toBytes("row2"));
        try {
          st.prepare();
          st.execute(regionServer,regionServer);
        }
 catch (        IOException e) {
        }
      }
    }
.start();
    for (int i=0; !callRollBack && i < 100; i++) {
      Thread.sleep(100);
    }
    assertTrue("Waited too long for rollback",callRollBack);
    SplitTransaction st=null;
    st=new MockedSplitTransaction(regions.get(0),Bytes.toBytes("row2"));
    try {
      secondSplit=true;
      st.prepare();
      st.execute(regionServer,regionServer);
    }
 catch (    IOException e) {
      LOG.debug("Rollback started :" + e.getMessage());
      st.rollback(regionServer,regionServer);
    }
    for (int i=0; !firstSplitCompleted && i < 100; i++) {
      Thread.sleep(100);
    }
    assertTrue("fist split did not complete",firstSplitCompleted);
    RegionStates regionStates=cluster.getMaster().getAssignmentManager().getRegionStates();
    Map<String,RegionState> rit=regionStates.getRegionsInTransition();
    for (int i=0; rit.containsKey(hri.getTableNameAsString()) && i < 100; i++) {
      Thread.sleep(100);
    }
    assertFalse("region still in transition",rit.containsKey(rit.containsKey(hri.getTableNameAsString())));
    List<HRegion> onlineRegions=regionServer.getOnlineRegions(tableName);
    assertEquals("The parent region should be splitted",2,onlineRegions.size());
    List<HRegionInfo> regionsOfTable=cluster.getMaster().getAssignmentManager().getRegionStates().getRegionsOfTable(tableName);
    assertEquals("No of regions in master",2,regionsOfTable.size());
  }
  finally {
    admin.setBalancerRunning(true,false);
    secondSplit=false;
    firstSplitCompleted=false;
    callRollBack=false;
    cluster.getMaster().setCatalogJanitorEnabled(true);
    if (admin.isTableAvailable(tableName) && admin.isTableEnabled(tableName)) {
      admin.disableTable(tableName);
      admin.deleteTable(tableName);
      admin.close();
    }
  }
}
