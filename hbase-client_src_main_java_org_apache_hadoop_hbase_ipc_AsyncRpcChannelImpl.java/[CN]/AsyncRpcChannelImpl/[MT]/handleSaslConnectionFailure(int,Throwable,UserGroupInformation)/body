{
  user.doAs(new PrivilegedExceptionAction<Void>(){
    @Override public Void run() throws IOException, InterruptedException {
      if (shouldAuthenticateOverKrb()) {
        if (currRetries < MAX_SASL_RETRIES) {
          LOG.debug("Exception encountered while connecting to the server : " + ex);
          if (UserGroupInformation.isLoginKeytabBased()) {
            UserGroupInformation.getLoginUser().reloginFromKeytab();
          }
 else {
            UserGroupInformation.getLoginUser().reloginFromTicketCache();
          }
          return null;
        }
 else {
          String msg="Couldn't setup connection for " + UserGroupInformation.getLoginUser().getUserName() + " to "+ serverPrincipal;
          LOG.warn(msg,ex);
          throw (IOException)new IOException(msg).initCause(ex);
        }
      }
 else {
        LOG.warn("Exception encountered while connecting to " + "the server : " + ex);
      }
      if (ex instanceof RemoteException) {
        throw (RemoteException)ex;
      }
      if (ex instanceof SaslException) {
        String msg="SASL authentication failed." + " The most likely cause is missing or invalid credentials." + " Consider 'kinit'.";
        LOG.fatal(msg,ex);
        throw new RuntimeException(msg,ex);
      }
      throw new IOException(ex);
    }
  }
);
}
