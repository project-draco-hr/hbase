{
  ArrayList<ToDoEntry> toDoList=new ArrayList<ToDoEntry>();
  HashSet<HRegionInfo> regions=new HashSet<HRegionInfo>();
  try {
    while (true) {
      HbaseMapWritable values=null;
      try {
        values=server.next(scannerId);
      }
 catch (      IOException e) {
        LOG.error("Shutdown scanning of meta region",RemoteExceptionHandler.checkIOException(e));
        break;
      }
      if (values == null || values.size() == 0) {
        break;
      }
      SortedMap<Text,byte[]> results=new TreeMap<Text,byte[]>();
      Text row=null;
      for (      Map.Entry<Writable,Writable> e : values.entrySet()) {
        HStoreKey key=(HStoreKey)e.getKey();
        Text thisRow=key.getRow();
        if (row == null) {
          row=thisRow;
        }
 else {
          if (!row.equals(thisRow)) {
            LOG.error("Multiple rows in same scanner result set. firstRow=" + row + ", currentRow="+ thisRow);
          }
        }
        results.put(key.getColumn(),((ImmutableBytesWritable)e.getValue()).get());
      }
      if (LOG.isDebugEnabled() && row != null) {
        LOG.debug("shutdown scanner looking at " + row.toString());
      }
      String serverName;
      try {
        serverName=Writables.bytesToString(results.get(COL_SERVER));
      }
 catch (      UnsupportedEncodingException e) {
        LOG.error("Server name",e);
        break;
      }
      if (serverName.length() > 0 && deadServerName.compareTo(serverName) != 0) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Server name " + serverName + " is not same as "+ deadServerName+ ": Passing");
        }
        continue;
      }
      HRegionInfo info=null;
      try {
        info=(HRegionInfo)Writables.getWritable(results.get(COL_REGIONINFO),new HRegionInfo());
      }
 catch (      IOException e) {
        LOG.error("Read fields",e);
        break;
      }
      LOG.info(info.getRegionName() + " was on shutdown server <" + serverName+ "> (or server is null). Marking unassigned if "+ "meta and clearing pendingRegions");
      if (info.isMetaTable()) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("removing meta region " + info.getRegionName() + " from online meta regions");
        }
        onlineMetaRegions.remove(info.getStartKey());
      }
      ToDoEntry todo=new ToDoEntry(row,info);
      toDoList.add(todo);
      if (killList.containsKey(deadServerName)) {
        HashMap<Text,HRegionInfo> regionsToKill=new HashMap<Text,HRegionInfo>();
synchronized (killList) {
          regionsToKill.putAll(killList.get(deadServerName));
        }
        if (regionsToKill.containsKey(info.getRegionName())) {
          regionsToKill.remove(info.getRegionName());
          killList.put(deadServerName,regionsToKill);
          unassignedRegions.remove(info);
synchronized (regionsToDelete) {
            if (regionsToDelete.contains(info.getRegionName())) {
              regionsToDelete.remove(info.getRegionName());
              todo.deleteRegion=true;
            }
 else {
              todo.regionOffline=true;
            }
          }
        }
      }
 else {
        regions.add(info);
        pendingRegions.remove(info.getRegionName());
      }
    }
  }
  finally {
    if (scannerId != -1L) {
      try {
        server.close(scannerId);
      }
 catch (      IOException e) {
        LOG.error("Closing scanner",RemoteExceptionHandler.checkIOException(e));
      }
    }
  }
  for (  ToDoEntry e : toDoList) {
    BatchUpdate b=new BatchUpdate(rand.nextLong());
    long lockid=b.startUpdate(e.row);
    if (e.deleteRegion) {
      b.delete(lockid,COL_REGIONINFO);
    }
 else     if (e.regionOffline) {
      e.info.setOffline(true);
      b.put(lockid,COL_REGIONINFO,Writables.getBytes(e.info));
    }
    b.delete(lockid,COL_SERVER);
    b.delete(lockid,COL_STARTCODE);
    server.batchUpdate(regionName,System.currentTimeMillis(),b);
  }
  for (  HRegionInfo info : regions) {
    unassignedRegions.put(info,ZERO_L);
  }
}
