{
  for (int tries=0; tries < numRetries; tries++) {
    if (closed.get()) {
      return true;
    }
    LOG.info("region closed: " + regionInfo.regionName);
    Text metaRegionName;
    HRegionInterface server;
    if (rootRegion) {
      if (rootRegionLocation.get() == null || !rootScanned) {
        return false;
      }
      metaRegionName=HGlobals.rootRegionInfo.regionName;
      server=connection.getHRegionConnection(rootRegionLocation.get());
      onlineMetaRegions.remove(regionInfo.getStartKey());
    }
 else {
      if (!rootScanned || numberOfMetaRegions.get() != onlineMetaRegions.size()) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Requeuing close because rootScanned=" + rootScanned + ", numberOfMetaRegions="+ numberOfMetaRegions.get()+ ", onlineMetaRegions.size()="+ onlineMetaRegions.size());
        }
        return false;
      }
      MetaRegion r=null;
      if (onlineMetaRegions.containsKey(regionInfo.getRegionName())) {
        r=onlineMetaRegions.get(regionInfo.getRegionName());
      }
 else {
        r=onlineMetaRegions.get(onlineMetaRegions.headMap(regionInfo.getRegionName()).lastKey());
      }
      metaRegionName=r.getRegionName();
      server=connection.getHRegionConnection(r.getServer());
    }
    try {
      BatchUpdate b=new BatchUpdate(rand.nextLong());
      long lockid=b.startUpdate(regionInfo.regionName);
      if (deleteRegion) {
        b.delete(lockid,COL_REGIONINFO);
      }
 else       if (!reassignRegion) {
        regionInfo.offLine=true;
        b.put(lockid,COL_REGIONINFO,Writables.getBytes(regionInfo));
      }
      b.delete(lockid,COL_SERVER);
      b.delete(lockid,COL_STARTCODE);
      server.batchUpdate(metaRegionName,System.currentTimeMillis(),b);
      break;
    }
 catch (    IOException e) {
      if (tries == numRetries - 1) {
        throw RemoteExceptionHandler.checkIOException(e);
      }
      continue;
    }
  }
  if (reassignRegion) {
    LOG.info("reassign region: " + regionInfo.regionName);
    unassignedRegions.put(regionInfo.regionName,regionInfo);
    assignAttempts.put(regionInfo.regionName,Long.valueOf(0L));
  }
 else   if (deleteRegion) {
    try {
      HRegion.deleteRegion(fs,dir,regionInfo.regionName);
    }
 catch (    IOException e) {
      e=RemoteExceptionHandler.checkIOException(e);
      LOG.error("failed delete region " + regionInfo.regionName,e);
      throw e;
    }
  }
  return true;
}
