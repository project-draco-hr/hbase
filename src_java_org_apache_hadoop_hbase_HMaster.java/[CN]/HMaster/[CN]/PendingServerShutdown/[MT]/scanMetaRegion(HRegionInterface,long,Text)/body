{
  ArrayList<ToDoEntry> toDoList=new ArrayList<ToDoEntry>();
  TreeMap<Text,HRegionInfo> regions=new TreeMap<Text,HRegionInfo>();
  DataInputBuffer inbuf=new DataInputBuffer();
  try {
    while (true) {
      KeyedData[] values=null;
      try {
        values=server.next(scannerId);
      }
 catch (      IOException e) {
        if (e instanceof RemoteException) {
          e=RemoteExceptionHandler.decodeRemoteException((RemoteException)e);
        }
        LOG.error(e);
        break;
      }
      if (values == null || values.length == 0) {
        break;
      }
      TreeMap<Text,byte[]> results=new TreeMap<Text,byte[]>();
      Text row=null;
      for (int i=0; i < values.length; i++) {
        if (row == null) {
          row=values[i].getKey().getRow();
        }
 else {
          if (!row.equals(values[i].getKey().getRow())) {
            LOG.error("Multiple rows in same scanner result set. firstRow=" + row + ", currentRow="+ values[i].getKey().getRow());
          }
        }
        results.put(values[i].getKey().getColumn(),values[i].getData());
      }
      byte[] bytes=results.get(COL_SERVER);
      String serverName=null;
      if (bytes == null || bytes.length == 0) {
        continue;
      }
      try {
        serverName=new String(bytes,UTF8_ENCODING);
      }
 catch (      UnsupportedEncodingException e) {
        LOG.error(e);
        break;
      }
      if (deadServerName.compareTo(serverName) != 0) {
        continue;
      }
      bytes=results.get(COL_STARTCODE);
      if (bytes == null || bytes.length == 0) {
        continue;
      }
      long startCode=-1L;
      try {
        startCode=Long.valueOf(new String(bytes,UTF8_ENCODING)).longValue();
      }
 catch (      UnsupportedEncodingException e) {
        LOG.error(e);
        break;
      }
      if (oldStartCode != startCode) {
        continue;
      }
      bytes=results.get(COL_REGIONINFO);
      if (bytes == null || bytes.length == 0) {
        throw new IOException("no value for " + COL_REGIONINFO);
      }
      inbuf.reset(bytes,bytes.length);
      HRegionInfo info=new HRegionInfo();
      try {
        info.readFields(inbuf);
      }
 catch (      IOException e) {
        if (e instanceof RemoteException) {
          e=RemoteExceptionHandler.decodeRemoteException((RemoteException)e);
        }
        LOG.error(e);
        break;
      }
      LOG.info(serverName + " was serving " + info.toString());
      if (info.tableDesc.getName().equals(META_TABLE_NAME)) {
        onlineMetaRegions.remove(info.getStartKey());
      }
      ToDoEntry todo=new ToDoEntry(row,info);
      toDoList.add(todo);
      if (killList.containsKey(deadServerName)) {
        TreeMap<Text,HRegionInfo> regionsToKill=killList.get(deadServerName);
        if (regionsToKill.containsKey(info.regionName)) {
          regionsToKill.remove(info.regionName);
          killList.put(deadServerName,regionsToKill);
          unassignedRegions.remove(info.regionName);
          assignAttempts.remove(info.regionName);
          if (regionsToDelete.contains(info.regionName)) {
            regionsToDelete.remove(info.regionName);
            todo.deleteRegion=true;
          }
 else {
            todo.regionOffline=true;
          }
        }
      }
 else {
        regions.put(info.regionName,info);
      }
    }
  }
  finally {
    if (scannerId != -1L) {
      try {
        server.close(scannerId);
      }
 catch (      IOException e) {
        if (e instanceof RemoteException) {
          e=RemoteExceptionHandler.decodeRemoteException((RemoteException)e);
        }
        LOG.error(e);
      }
    }
  }
  long clientId=rand.nextLong();
  for (  ToDoEntry e : toDoList) {
    long lockid=server.startUpdate(regionName,clientId,e.row);
    if (e.deleteRegion) {
      server.delete(regionName,clientId,lockid,COL_REGIONINFO);
    }
 else     if (e.regionOffline) {
      e.info.offLine=true;
      ByteArrayOutputStream byteValue=new ByteArrayOutputStream();
      DataOutputStream s=new DataOutputStream(byteValue);
      e.info.write(s);
      server.put(regionName,clientId,lockid,COL_REGIONINFO,byteValue.toByteArray());
    }
    server.delete(regionName,clientId,lockid,COL_SERVER);
    server.delete(regionName,clientId,lockid,COL_STARTCODE);
    server.commit(regionName,clientId,lockid,System.currentTimeMillis());
  }
  for (  Map.Entry<Text,HRegionInfo> e : regions.entrySet()) {
    Text region=e.getKey();
    HRegionInfo regionInfo=e.getValue();
    unassignedRegions.put(region,regionInfo);
    assignAttempts.put(region,Long.valueOf(0L));
  }
}
