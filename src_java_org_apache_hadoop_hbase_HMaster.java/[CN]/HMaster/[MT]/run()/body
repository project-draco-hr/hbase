{
  final String threadName="HMaster";
  Thread.currentThread().setName(threadName);
  startServiceThreads();
  try {
    for (RegionServerOperation op=null; !closed.get(); ) {
      if (rootRegionLocation.get() != null) {
        op=this.delayedToDoQueue.poll();
      }
      if (op == null) {
        try {
          op=toDoQueue.poll(threadWakeFrequency,TimeUnit.MILLISECONDS);
        }
 catch (        InterruptedException e) {
        }
      }
      if (op == null || closed.get()) {
        continue;
      }
      try {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Main processing loop: " + op.toString());
        }
        if (!op.process()) {
          if (toDoQueue.size() == 0) {
            sleeper.sleep();
          }
          try {
            if (LOG.isDebugEnabled()) {
              LOG.debug("Put " + op.toString() + " back on queue");
            }
            toDoQueue.put(op);
          }
 catch (          InterruptedException e) {
            throw new RuntimeException("Putting into toDoQueue was interrupted.",e);
          }
        }
      }
 catch (      Exception ex) {
        if (ex instanceof RemoteException) {
          try {
            ex=RemoteExceptionHandler.decodeRemoteException((RemoteException)ex);
          }
 catch (          IOException e) {
            ex=e;
            LOG.warn("main processing loop: " + op.toString(),e);
          }
        }
        if (!checkFileSystem()) {
          break;
        }
        LOG.warn("Processing pending operations: " + op.toString(),ex);
        try {
          toDoQueue.put(op);
        }
 catch (        InterruptedException e) {
          throw new RuntimeException("Putting into toDoQueue was interrupted.",e);
        }
      }
    }
  }
 catch (  Throwable t) {
    LOG.fatal("Unhandled exception",t);
  }
  letRegionServersShutdown();
synchronized (rootScannerLock) {
    rootScannerThread.interrupt();
  }
synchronized (metaScannerLock) {
    metaScannerThread.interrupt();
  }
  if (this.infoServer != null) {
    LOG.info("Stopping infoServer");
    try {
      this.infoServer.stop();
    }
 catch (    InterruptedException ex) {
      ex.printStackTrace();
    }
  }
  server.stop();
  serverLeases.close();
  try {
    if (rootScannerThread.isAlive()) {
      rootScannerThread.join();
    }
  }
 catch (  Exception iex) {
    LOG.warn("root scanner",iex);
  }
  try {
    if (metaScannerThread.isAlive()) {
      metaScannerThread.join();
    }
  }
 catch (  Exception iex) {
    LOG.warn("meta scanner",iex);
  }
  LOG.info("HMaster main thread exiting");
}
