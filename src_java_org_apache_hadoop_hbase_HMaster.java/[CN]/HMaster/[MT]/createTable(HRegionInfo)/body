{
  Text tableName=newRegion.tableDesc.getName();
synchronized (tableInCreation) {
    if (tableInCreation.contains(tableName)) {
      throw new TableExistsException("Table " + tableName + " in process "+ "of being created");
    }
    tableInCreation.add(tableName);
  }
  try {
    MetaRegion m=(onlineMetaRegions.containsKey(newRegion.regionName) ? onlineMetaRegions.get(newRegion.regionName) : onlineMetaRegions.get(onlineMetaRegions.headMap(newRegion.getTableDesc().getName()).lastKey()));
    Text metaRegionName=m.regionName;
    HRegionInterface r=connection.getHRegionConnection(m.server);
    long scannerid=r.openScanner(metaRegionName,COL_REGIONINFO_ARRAY,tableName,System.currentTimeMillis(),null);
    try {
      KeyedData[] data=r.next(scannerid);
      if (data != null && data.length > 0 && HRegionInfo.getTableNameFromRegionName(data[0].getKey().getRow()).equals(tableName)) {
        throw new TableExistsException(tableName.toString());
      }
    }
  finally {
      r.close(scannerid);
    }
    HRegion region=HRegion.createHRegion(newRegion.regionId,newRegion.getTableDesc(),this.dir,this.conf);
    HRegionInfo info=region.getRegionInfo();
    Text regionName=region.getRegionName();
    ByteArrayOutputStream byteValue=new ByteArrayOutputStream();
    DataOutputStream s=new DataOutputStream(byteValue);
    info.write(s);
    long clientId=rand.nextLong();
    long lockid=r.startUpdate(metaRegionName,clientId,regionName);
    r.put(metaRegionName,clientId,lockid,COL_REGIONINFO,byteValue.toByteArray());
    r.commit(metaRegionName,clientId,lockid,System.currentTimeMillis());
    region.close();
    region.getLog().closeAndDelete();
    unassignedRegions.put(regionName,info);
    assignAttempts.put(regionName,Long.valueOf(0L));
  }
  finally {
synchronized (tableInCreation) {
      tableInCreation.remove(newRegion.getTableDesc().getName());
    }
  }
}
