{
  Text tableName=newRegion.tableDesc.getName();
synchronized (tableInCreation) {
    if (tableInCreation.contains(tableName)) {
      throw new TableExistsException("Table " + tableName + " in process "+ "of being created");
    }
    tableInCreation.add(tableName);
  }
  try {
    MetaRegion m=(onlineMetaRegions.containsKey(newRegion.regionName) ? onlineMetaRegions.get(newRegion.regionName) : onlineMetaRegions.get(onlineMetaRegions.headMap(newRegion.getTableDesc().getName()).lastKey()));
    Text metaRegionName=m.getRegionName();
    HRegionInterface server=connection.getHRegionConnection(m.getServer());
    long scannerid=server.openScanner(metaRegionName,COL_REGIONINFO_ARRAY,tableName,System.currentTimeMillis(),null);
    try {
      MapWritable data=server.next(scannerid);
      if (data != null && data.size() > 0) {
        for (        Writable k : data.keySet()) {
          if (HRegionInfo.getTableNameFromRegionName(((HStoreKey)k).getRow()).equals(tableName)) {
            throw new TableExistsException(tableName.toString());
          }
        }
      }
    }
  finally {
      server.close(scannerid);
    }
    HRegion region=HRegion.createHRegion(newRegion,this.dir,this.conf,null);
    HRegionInfo info=region.getRegionInfo();
    Text regionName=region.getRegionName();
    BatchUpdate b=new BatchUpdate(rand.nextLong());
    long lockid=b.startUpdate(regionName);
    b.put(lockid,COL_REGIONINFO,Writables.getBytes(info));
    server.batchUpdate(metaRegionName,System.currentTimeMillis(),b);
    region.close();
    region.getLog().closeAndDelete();
    this.unassignedRegions.put(regionName,info);
    this.assignAttempts.put(regionName,Long.valueOf(0L));
  }
  finally {
synchronized (tableInCreation) {
      tableInCreation.remove(newRegion.getTableDesc().getName());
    }
  }
}
