{
  if (!isMasterRunning()) {
    throw new MasterNotRunningException();
  }
  HRegionInfo newRegion=new HRegionInfo(rand.nextLong(),desc,null,null);
  for (int tries=0; tries < numRetries; tries++) {
    try {
      if (metaScanner.waitForMetaScanOrClose()) {
        return;
      }
      MetaRegion m=(knownMetaRegions.containsKey(newRegion.regionName)) ? knownMetaRegions.get(newRegion.regionName) : knownMetaRegions.get(knownMetaRegions.headMap(newRegion.regionName).lastKey());
      Text metaRegionName=m.regionName;
      HRegionInterface server=client.getHRegionConnection(m.server);
      byte[] infoBytes=server.get(metaRegionName,desc.getName(),COL_REGIONINFO);
      if (infoBytes != null && infoBytes.length != 0) {
        DataInputBuffer inbuf=new DataInputBuffer();
        inbuf.reset(infoBytes,infoBytes.length);
        HRegionInfo info=new HRegionInfo();
        info.readFields(inbuf);
        if (info.tableDesc.getName().compareTo(desc.getName()) == 0) {
          throw new IOException("table already exists");
        }
      }
      HRegion r=HRegion.createHRegion(newRegion.regionId,desc,this.dir,this.conf);
      HRegionInfo info=r.getRegionInfo();
      Text regionName=r.getRegionName();
      ByteArrayOutputStream byteValue=new ByteArrayOutputStream();
      DataOutputStream s=new DataOutputStream(byteValue);
      info.write(s);
      long clientId=rand.nextLong();
      long lockid=server.startUpdate(metaRegionName,clientId,regionName);
      server.put(metaRegionName,clientId,lockid,COL_REGIONINFO,byteValue.toByteArray());
      server.commit(metaRegionName,clientId,lockid,System.currentTimeMillis());
      r.close();
      unassignedRegions.put(regionName,info);
      assignAttempts.put(regionName,Long.valueOf(0L));
      break;
    }
 catch (    IOException e) {
      if (tries == numRetries - 1) {
        if (e instanceof RemoteException) {
          e=RemoteExceptionHandler.decodeRemoteException((RemoteException)e);
        }
        throw e;
      }
    }
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("created table " + desc.getName());
  }
}
