{
  Path curCompactStore=HStoreFile.getHStoreDir(compactdir,regionName,familyName);
  this.lock.obtainWriteLock();
  try {
    Path doneFile=new Path(curCompactStore,COMPACTION_DONE);
    if (!fs.exists(doneFile)) {
      LOG.warn("Redoing a failed compaction");
      return;
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("Process ready compaction starting");
    }
    Vector<HStoreFile> toCompactFiles=new Vector<HStoreFile>();
    Path filesToReplace=new Path(curCompactStore,COMPACTION_TO_REPLACE);
    DataInputStream in=new DataInputStream(fs.open(filesToReplace));
    try {
      int numfiles=in.readInt();
      for (int i=0; i < numfiles; i++) {
        HStoreFile hsf=new HStoreFile(conf);
        hsf.readFields(in);
        toCompactFiles.add(hsf);
      }
    }
  finally {
      in.close();
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("loaded " + toCompactFiles.size() + " file(s) to be deleted");
    }
    Iterator<HStoreFile> it2=mapFiles.values().iterator();
    for (Iterator<MapFile.Reader> it=maps.values().iterator(); it.hasNext(); ) {
      MapFile.Reader curReader=it.next();
      HStoreFile curMapFile=it2.next();
      if (toCompactFiles.contains(curMapFile)) {
        curReader.close();
        it.remove();
      }
    }
    for (Iterator<HStoreFile> it=mapFiles.values().iterator(); it.hasNext(); ) {
      HStoreFile curMapFile=it.next();
      if (toCompactFiles.contains(curMapFile)) {
        it.remove();
      }
    }
    for (    HStoreFile hsf : toCompactFiles) {
      fs.delete(hsf.getMapFilePath());
      fs.delete(hsf.getInfoFilePath());
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("old file(s) deleted");
    }
    HStoreFile compactedFile=new HStoreFile(conf,compactdir,regionName,familyName,-1);
    HStoreFile finalCompactedFile=HStoreFile.obtainNewHStoreFile(conf,dir,regionName,familyName,fs);
    if (LOG.isDebugEnabled()) {
      LOG.debug("moving " + compactedFile.getMapFilePath().toString() + " to "+ finalCompactedFile.getMapFilePath().toString());
    }
    fs.rename(compactedFile.getMapFilePath(),finalCompactedFile.getMapFilePath());
    fs.rename(compactedFile.getInfoFilePath(),finalCompactedFile.getInfoFilePath());
    Long orderVal=Long.valueOf(finalCompactedFile.loadInfo(fs));
    mapFiles.put(orderVal,finalCompactedFile);
    maps.put(orderVal,getMapFileReader(finalCompactedFile.getMapFilePath().toString()));
  }
  finally {
    this.lock.releaseWriteLock();
  }
}
