{
  byte flag=source.readByte();
  int prevKeyLength=state.keyLength;
  if ((flag & FLAG_SAME_KEY_LENGTH) == 0) {
    state.keyLength=ByteBufferUtils.readCompressedInt(source);
  }
  if ((flag & FLAG_SAME_VALUE_LENGTH) == 0) {
    state.valueLength=ByteBufferUtils.readCompressedInt(source);
  }
  int commonLength=ByteBufferUtils.readCompressedInt(source);
  ByteBufferUtils.ensureSpace(buffer,state.keyLength + state.valueLength + KeyValue.ROW_OFFSET);
  int kvPos=buffer.position();
  if (!state.isFirst()) {
    int common;
    int prevOffset;
    if ((flag & FLAG_SAME_VALUE_LENGTH) == 0) {
      buffer.putInt(state.keyLength);
      buffer.putInt(state.valueLength);
      prevOffset=state.prevOffset + KeyValue.ROW_OFFSET;
      common=commonLength;
    }
 else {
      if ((flag & FLAG_SAME_KEY_LENGTH) != 0) {
        prevOffset=state.prevOffset;
        common=commonLength + KeyValue.ROW_OFFSET;
      }
 else {
        buffer.putInt(state.keyLength);
        prevOffset=state.prevOffset + KeyValue.KEY_LENGTH_SIZE;
        common=commonLength + KeyValue.KEY_LENGTH_SIZE;
      }
    }
    ByteBufferUtils.copyFromBuffer(buffer,buffer,prevOffset,common);
    int keyRestLength;
    if (commonLength < state.rowLength + KeyValue.ROW_LENGTH_SIZE) {
      int rowWithSizeLength;
      int rowRestLength;
      if (commonLength < KeyValue.ROW_LENGTH_SIZE) {
        ByteBufferUtils.copyFromStream(source,buffer,KeyValue.ROW_LENGTH_SIZE - commonLength);
        rowWithSizeLength=buffer.getShort(buffer.position() - KeyValue.ROW_LENGTH_SIZE) + KeyValue.ROW_LENGTH_SIZE;
        rowRestLength=rowWithSizeLength - KeyValue.ROW_LENGTH_SIZE;
      }
 else {
        rowWithSizeLength=buffer.getShort(kvPos + KeyValue.ROW_OFFSET) + KeyValue.ROW_LENGTH_SIZE;
        rowRestLength=rowWithSizeLength - commonLength;
      }
      ByteBufferUtils.copyFromStream(source,buffer,rowRestLength);
      ByteBufferUtils.copyFromBuffer(buffer,buffer,state.prevOffset + KeyValue.ROW_OFFSET + KeyValue.ROW_LENGTH_SIZE+ state.rowLength,state.familyLength + KeyValue.FAMILY_LENGTH_SIZE);
      state.rowLength=(short)(rowWithSizeLength - KeyValue.ROW_LENGTH_SIZE);
      keyRestLength=state.keyLength - rowWithSizeLength - state.familyLength- (KeyValue.FAMILY_LENGTH_SIZE + KeyValue.TIMESTAMP_TYPE_SIZE);
    }
 else {
      keyRestLength=state.keyLength - commonLength - KeyValue.TIMESTAMP_TYPE_SIZE;
    }
    ByteBufferUtils.copyFromStream(source,buffer,keyRestLength);
    int prefixTimestamp=(flag & MASK_TIMESTAMP_LENGTH) >>> SHIFT_TIMESTAMP_LENGTH;
    ByteBufferUtils.copyFromBuffer(buffer,buffer,state.prevTimestampOffset,prefixTimestamp);
    state.prevTimestampOffset=buffer.position() - prefixTimestamp;
    ByteBufferUtils.copyFromStream(source,buffer,KeyValue.TIMESTAMP_SIZE - prefixTimestamp);
    if ((flag & FLAG_SAME_TYPE) != 0) {
      buffer.put(state.type);
      if ((flag & FLAG_SAME_VALUE) != 0) {
        ByteBufferUtils.copyFromBuffer(buffer,buffer,state.prevOffset + KeyValue.ROW_OFFSET + prevKeyLength,state.valueLength);
      }
 else {
        ByteBufferUtils.copyFromStream(source,buffer,state.valueLength);
      }
    }
 else {
      if ((flag & FLAG_SAME_VALUE) != 0) {
        ByteBufferUtils.copyFromStream(source,buffer,KeyValue.TYPE_SIZE);
        ByteBufferUtils.copyFromBuffer(buffer,buffer,state.prevOffset + KeyValue.ROW_OFFSET + prevKeyLength,state.valueLength);
      }
 else {
        ByteBufferUtils.copyFromStream(source,buffer,state.valueLength + KeyValue.TYPE_SIZE);
      }
      state.type=buffer.get(state.prevTimestampOffset + KeyValue.TIMESTAMP_SIZE);
    }
  }
 else {
    buffer.putInt(state.keyLength);
    buffer.putInt(state.valueLength);
    state.prevTimestampOffset=buffer.position() + state.keyLength - KeyValue.TIMESTAMP_TYPE_SIZE;
    ByteBufferUtils.copyFromStream(source,buffer,state.keyLength + state.valueLength);
    state.rowLength=buffer.getShort(kvPos + KeyValue.ROW_OFFSET);
    state.familyLength=buffer.get(kvPos + KeyValue.ROW_OFFSET + KeyValue.ROW_LENGTH_SIZE+ state.rowLength);
    state.type=buffer.get(state.prevTimestampOffset + KeyValue.TIMESTAMP_SIZE);
  }
  state.prevOffset=kvPos;
}
