{
  currentState.prevOffset=in.position();
  int keyLength=in.getInt();
  int valueOffset=currentState.prevOffset + keyLength + KeyValue.ROW_OFFSET;
  int valueLength=in.getInt();
  byte flag=0;
  if (previousState.isFirst()) {
    ByteBufferUtils.copyToStream(out,flag);
    ByteBufferUtils.putCompressedInt(out,keyLength);
    ByteBufferUtils.putCompressedInt(out,valueLength);
    ByteBufferUtils.putCompressedInt(out,0);
    currentState.readKey(in,keyLength,valueLength);
    ByteBufferUtils.copyToStream(out,in,keyLength + valueLength);
  }
 else {
    int commonPrefix=ByteBufferUtils.findCommonPrefix(in,in.position(),previousState.prevOffset + KeyValue.ROW_OFFSET,keyLength - KeyValue.TIMESTAMP_TYPE_SIZE);
    currentState.readKey(in,keyLength,valueLength,commonPrefix,previousState);
    if (keyLength == previousState.keyLength) {
      flag|=FLAG_SAME_KEY_LENGTH;
    }
    if (valueLength == previousState.valueLength) {
      flag|=FLAG_SAME_VALUE_LENGTH;
    }
    if (currentState.type == previousState.type) {
      flag|=FLAG_SAME_TYPE;
    }
    int prefixTimestamp=findCommonTimestampPrefix(currentState,previousState);
    flag|=(prefixTimestamp) << SHIFT_TIMESTAMP_LENGTH;
    if (ByteBufferUtils.arePartsEqual(in,previousState.prevOffset + previousState.keyLength + KeyValue.ROW_OFFSET,previousState.valueLength,valueOffset,valueLength)) {
      flag|=FLAG_SAME_VALUE;
    }
    ByteBufferUtils.copyToStream(out,flag);
    if ((flag & FLAG_SAME_KEY_LENGTH) == 0) {
      ByteBufferUtils.putCompressedInt(out,keyLength);
    }
    if ((flag & FLAG_SAME_VALUE_LENGTH) == 0) {
      ByteBufferUtils.putCompressedInt(out,valueLength);
    }
    ByteBufferUtils.putCompressedInt(out,commonPrefix);
    ByteBufferUtils.skip(in,commonPrefix);
    if (commonPrefix < currentState.rowLength + KeyValue.ROW_LENGTH_SIZE) {
      ByteBufferUtils.copyToStream(out,in,currentState.rowLength + KeyValue.ROW_LENGTH_SIZE - commonPrefix);
      ByteBufferUtils.skip(in,currentState.familyLength + KeyValue.FAMILY_LENGTH_SIZE);
      ByteBufferUtils.copyToStream(out,in,currentState.qualifierLength);
    }
 else {
      int restKeyLength=keyLength - commonPrefix - KeyValue.TIMESTAMP_TYPE_SIZE;
      ByteBufferUtils.copyToStream(out,in,restKeyLength);
    }
    ByteBufferUtils.skip(in,prefixTimestamp);
    ByteBufferUtils.copyToStream(out,in,KeyValue.TIMESTAMP_SIZE - prefixTimestamp);
    if ((flag & FLAG_SAME_TYPE) == 0) {
      valueOffset-=KeyValue.TYPE_SIZE;
      valueLength+=KeyValue.TYPE_SIZE;
    }
    ByteBufferUtils.skip(in,KeyValue.TYPE_SIZE + currentState.valueLength);
    if ((flag & FLAG_SAME_VALUE) == 0) {
      ByteBufferUtils.copyToStream(out,in,valueOffset,valueLength);
    }
 else {
      if ((flag & FLAG_SAME_TYPE) == 0) {
        ByteBufferUtils.copyToStream(out,currentState.type);
      }
    }
  }
}
