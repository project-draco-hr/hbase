{
  if (numZooKeeperServers <= 0)   return -1;
  setupTestEnv();
  shutdown();
  int tentativePort=selectClientPort();
  for (int i=0; i < numZooKeeperServers; i++) {
    File dir=new File(baseDir,"zookeeper_" + i).getAbsoluteFile();
    recreateDir(dir);
    int tickTimeToUse;
    if (this.tickTime > 0) {
      tickTimeToUse=this.tickTime;
    }
 else {
      tickTimeToUse=TICK_TIME;
    }
    ZooKeeperServer server=new ZooKeeperServer(dir,dir,tickTimeToUse);
    NIOServerCnxnFactory standaloneServerFactory;
    while (true) {
      try {
        standaloneServerFactory=new NIOServerCnxnFactory();
        standaloneServerFactory.configure(new InetSocketAddress(tentativePort),configuration.getInt(HConstants.ZOOKEEPER_MAX_CLIENT_CNXNS,1000));
      }
 catch (      BindException e) {
        LOG.debug("Failed binding ZK Server to client port: " + tentativePort);
        tentativePort=selectClientPort();
        continue;
      }
      break;
    }
    standaloneServerFactory.startup(server);
    if (!waitForServerUp(tentativePort,CONNECTION_TIMEOUT)) {
      throw new IOException("Waiting for startup of standalone server");
    }
    clientPortList.add(tentativePort);
    standaloneServerFactoryList.add(standaloneServerFactory);
    zooKeeperServers.add(server);
    tentativePort++;
  }
  activeZKServerIndex=0;
  started=true;
  clientPort=clientPortList.get(activeZKServerIndex);
  LOG.info("Started MiniZK Cluster and connect 1 ZK server " + "on client port: " + clientPort);
  return clientPort;
}
