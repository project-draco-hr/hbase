{
  TEST_UTIL.startMiniCluster(NB_SLAVES);
  TEST_UTIL.getConfiguration().setBoolean("hbase.master.enabletable.roundrobin",true);
  ZooKeeperWatcher zkw=HBaseTestingUtility.getZooKeeperWatcher(TEST_UTIL);
  HTableDescriptor htd=new HTableDescriptor(TABLENAME);
  htd.addFamily(new HColumnDescriptor(FAMILY));
  TEST_UTIL.createMultiRegionsInMeta(TEST_UTIL.getConfiguration(),htd,HBaseTestingUtility.KEYS);
  FileSystem fs=FileSystem.get(TEST_UTIL.getConfiguration());
  FSTableDescriptors.createTableDescriptor(fs,FSUtils.getRootDir(TEST_UTIL.getConfiguration()),htd);
  HBaseAdmin admin=new HBaseAdmin(TEST_UTIL.getConfiguration());
  MiniHBaseCluster cluster=TEST_UTIL.getMiniHBaseCluster();
  admin.disableTable(TABLENAME);
  admin.enableTable(TABLENAME);
  boolean ready=false;
  while (!ready) {
    ZKAssign.blockUntilNoRIT(zkw);
    int i=0;
    ready=true;
    while (i < NB_SLAVES && ready) {
      HRegionServer hrs=cluster.getRegionServer(i);
      if (ProtobufUtil.getOnlineRegions(hrs).isEmpty()) {
        ready=false;
      }
      i++;
    }
    if (!ready) {
      admin.balancer();
      Thread.sleep(100);
    }
  }
}
