{
  Configuration conf=HBaseConfiguration.create();
  AbstractRpcClient client=createRpcClientNoCodec(conf);
  TestRpcServer rpcServer=new TestRpcServer();
  try {
    rpcServer.start();
    MethodDescriptor md=SERVICE.getDescriptorForType().findMethodByName("echo");
    final String message="hello";
    EchoRequestProto param=EchoRequestProto.newBuilder().setMessage(message).build();
    InetSocketAddress address=rpcServer.getListenerAddress();
    if (address == null) {
      throw new IOException("Listener channel is closed");
    }
    Pair<Message,CellScanner> r=client.call(null,md,param,md.getOutputType().toProto(),User.getCurrent(),address,new MetricsConnection.CallStats());
    assertTrue(r.getSecond() == null);
    assertTrue(r.getFirst().toString().contains(message));
  }
  finally {
    client.close();
    rpcServer.stop();
  }
}
