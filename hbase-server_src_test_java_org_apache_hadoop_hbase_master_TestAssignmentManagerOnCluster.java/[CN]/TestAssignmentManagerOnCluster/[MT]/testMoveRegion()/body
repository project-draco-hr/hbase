{
  String table="testMoveRegion";
  try {
    HRegionInfo hri=createTableAndGetOneRegion(table);
    RegionStates regionStates=TEST_UTIL.getHBaseCluster().getMaster().getAssignmentManager().getRegionStates();
    ServerName serverName=regionStates.getRegionServerOfRegion(hri);
    ServerName destServerName=null;
    for (int i=0; i < 3; i++) {
      HRegionServer destServer=TEST_UTIL.getHBaseCluster().getRegionServer(i);
      if (!destServer.getServerName().equals(serverName)) {
        destServerName=destServer.getServerName();
        break;
      }
    }
    assertTrue(destServerName != null && !destServerName.equals(serverName));
    TEST_UTIL.getHBaseAdmin().move(hri.getEncodedNameAsBytes(),Bytes.toBytes(destServerName.getServerName()));
    long timeoutTime=System.currentTimeMillis() + 800;
    while (true) {
      ServerName sn=regionStates.getRegionServerOfRegion(hri);
      if (sn != null && sn.equals(destServerName)) {
        TEST_UTIL.assertRegionOnServer(hri,sn,200);
        break;
      }
      long now=System.currentTimeMillis();
      if (now > timeoutTime) {
        fail("Failed to move the region in time");
      }
      regionStates.waitForUpdate(50);
    }
  }
  finally {
    TEST_UTIL.deleteTable(Bytes.toBytes(table));
  }
}
