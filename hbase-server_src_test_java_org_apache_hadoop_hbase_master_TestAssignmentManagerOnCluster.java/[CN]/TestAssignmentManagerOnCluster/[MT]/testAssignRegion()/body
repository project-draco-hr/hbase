{
  String table="testAssignRegion";
  try {
    HTableDescriptor desc=new HTableDescriptor(TableName.valueOf(table));
    desc.addFamily(new HColumnDescriptor(FAMILY));
    admin.createTable(desc);
    Table meta=new HTable(conf,TableName.META_TABLE_NAME);
    HRegionInfo hri=new HRegionInfo(desc.getTableName(),Bytes.toBytes("A"),Bytes.toBytes("Z"));
    MetaTableAccessor.addRegionToMeta(meta,hri);
    HMaster master=TEST_UTIL.getHBaseCluster().getMaster();
    master.assignRegion(hri);
    AssignmentManager am=master.getAssignmentManager();
    am.waitForAssignment(hri);
    RegionStates regionStates=am.getRegionStates();
    ServerName serverName=regionStates.getRegionServerOfRegion(hri);
    TEST_UTIL.assertRegionOnServer(hri,serverName,200);
    RegionState oldState=regionStates.getRegionState(hri);
    TEST_UTIL.getHBaseAdmin().assign(hri.getRegionName());
    master.getAssignmentManager().waitForAssignment(hri);
    RegionState newState=regionStates.getRegionState(hri);
    assertTrue(newState.isOpened() && newState.getStamp() != oldState.getStamp());
  }
  finally {
    TEST_UTIL.deleteTable(Bytes.toBytes(table));
  }
}
