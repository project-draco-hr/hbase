{
  serversToIndex=new HashMap<String,Integer>();
  tablesToIndex=new HashMap<String,Integer>();
  tables=new ArrayList<String>();
  numRegions=0;
  int serverIndex=0;
  for (  ServerName sn : clusterState.keySet()) {
    if (serversToIndex.get(sn.getHostAndPort()) == null) {
      serversToIndex.put(sn.getHostAndPort(),serverIndex++);
    }
  }
  for (  Entry<ServerName,List<HRegionInfo>> entry : clusterState.entrySet()) {
    numRegions+=entry.getValue().size();
  }
  numServers=serversToIndex.size();
  regionsPerServer=new int[serversToIndex.size()][];
  servers=new ServerName[numServers];
  regions=new HRegionInfo[numRegions];
  regionIndexToServerIndex=new int[numRegions];
  initialRegionIndexToServerIndex=new int[numRegions];
  regionIndexToTableIndex=new int[numRegions];
  regionLoads=new List[numRegions];
  regionLocations=new int[numRegions][];
  serverIndicesSortedByRegionCount=new Integer[numServers];
  int tableIndex=0, regionIndex=0, regionPerServerIndex=0;
  for (  Entry<ServerName,List<HRegionInfo>> entry : clusterState.entrySet()) {
    serverIndex=serversToIndex.get(entry.getKey().getHostAndPort());
    if (servers[serverIndex] == null || servers[serverIndex].getStartcode() < entry.getKey().getStartcode()) {
      servers[serverIndex]=entry.getKey();
    }
    regionsPerServer[serverIndex]=new int[entry.getValue().size()];
    serverIndicesSortedByRegionCount[serverIndex]=serverIndex;
  }
  for (  Entry<ServerName,List<HRegionInfo>> entry : clusterState.entrySet()) {
    serverIndex=serversToIndex.get(entry.getKey().getHostAndPort());
    regionPerServerIndex=0;
    for (    HRegionInfo region : entry.getValue()) {
      String tableName=region.getTableNameAsString();
      Integer idx=tablesToIndex.get(tableName);
      if (idx == null) {
        tables.add(tableName);
        idx=tableIndex;
        tablesToIndex.put(tableName,tableIndex++);
      }
      regions[regionIndex]=region;
      regionIndexToServerIndex[regionIndex]=serverIndex;
      initialRegionIndexToServerIndex[regionIndex]=serverIndex;
      regionIndexToTableIndex[regionIndex]=idx;
      regionsPerServer[serverIndex][regionPerServerIndex++]=regionIndex;
      if (loads != null) {
        List<RegionLoad> rl=loads.get(region.getRegionNameAsString());
        if (rl == null) {
          rl=loads.get(region.getEncodedName());
        }
        regionLoads[regionIndex]=rl;
      }
      if (regionFinder != null) {
        List<ServerName> loc=regionFinder.getTopBlockLocations(region);
        regionLocations[regionIndex]=new int[loc.size()];
        for (int i=0; i < loc.size(); i++) {
          regionLocations[regionIndex][i]=loc.get(i) == null ? -1 : (serversToIndex.get(loc.get(i)) == null ? -1 : serversToIndex.get(loc.get(i)));
        }
      }
      regionIndex++;
    }
  }
  numTables=tables.size();
  numRegionsPerServerPerTable=new int[numServers][numTables];
  for (int i=0; i < numServers; i++) {
    for (int j=0; j < numTables; j++) {
      numRegionsPerServerPerTable[i][j]=0;
    }
  }
  for (int i=0; i < regionIndexToServerIndex.length; i++) {
    numRegionsPerServerPerTable[regionIndexToServerIndex[i]][regionIndexToTableIndex[i]]++;
  }
  numMaxRegionsPerTable=new int[numTables];
  for (serverIndex=0; serverIndex < numRegionsPerServerPerTable.length; serverIndex++) {
    for (tableIndex=0; tableIndex < numRegionsPerServerPerTable[serverIndex].length; tableIndex++) {
      if (numRegionsPerServerPerTable[serverIndex][tableIndex] > numMaxRegionsPerTable[tableIndex]) {
        numMaxRegionsPerTable[tableIndex]=numRegionsPerServerPerTable[serverIndex][tableIndex];
      }
    }
  }
}
