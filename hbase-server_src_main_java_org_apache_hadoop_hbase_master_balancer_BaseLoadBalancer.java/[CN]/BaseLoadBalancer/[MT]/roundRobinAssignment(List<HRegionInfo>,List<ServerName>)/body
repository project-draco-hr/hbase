{
  metricsBalancer.incrMiscInvocations();
  if (regions == null || regions.isEmpty()) {
    return null;
  }
  int numServers=servers == null ? 0 : servers.size();
  if (numServers == 0) {
    LOG.warn("Wanted to do round robin assignment but no servers to assign to");
    return null;
  }
  Map<ServerName,List<HRegionInfo>> assignments=new TreeMap<ServerName,List<HRegionInfo>>();
  if (numServers == 1) {
    ServerName server=servers.get(0);
    assignments.put(server,new ArrayList<HRegionInfo>(regions));
    return assignments;
  }
  List<HRegionInfo> masterRegions=null;
  if (servers.contains(masterServerName)) {
    masterRegions=new ArrayList<HRegionInfo>();
  }
  Cluster cluster=createCluster(servers,regions,tablesOnMaster);
  List<HRegionInfo> unassignedRegions=new ArrayList<HRegionInfo>();
  roundRobinAssignment(cluster,regions,unassignedRegions,servers,masterRegions,assignments);
  if (masterRegions != null && !masterRegions.isEmpty()) {
    assignments.put(masterServerName,masterRegions);
    for (    HRegionInfo r : masterRegions) {
      cluster.doAssignRegion(r,masterServerName);
    }
  }
  List<HRegionInfo> lastFewRegions=new ArrayList<HRegionInfo>();
  int serverIdx=RANDOM.nextInt(numServers);
  for (  HRegionInfo region : unassignedRegions) {
    boolean assigned=false;
    for (int j=0; j < numServers; j++) {
      ServerName serverName=servers.get((j + serverIdx) % numServers);
      if (serverName.equals(masterServerName)) {
        continue;
      }
      if (!cluster.wouldLowerAvailability(region,serverName)) {
        List<HRegionInfo> serverRegions=assignments.get(serverName);
        if (serverRegions == null) {
          serverRegions=new ArrayList<HRegionInfo>();
          assignments.put(serverName,serverRegions);
        }
        serverRegions.add(region);
        cluster.doAssignRegion(region,serverName);
        serverIdx=(j + serverIdx + 1) % numServers;
        assigned=true;
        break;
      }
    }
    if (!assigned) {
      lastFewRegions.add(region);
    }
  }
  for (  HRegionInfo region : lastFewRegions) {
    int i=RANDOM.nextInt(numServers);
    ServerName server=servers.get(i);
    if (server.equals(masterServerName)) {
      i=(i == 0 ? 1 : i - 1);
      server=servers.get(i);
    }
    List<HRegionInfo> serverRegions=assignments.get(server);
    if (serverRegions == null) {
      serverRegions=new ArrayList<HRegionInfo>();
      assignments.put(server,serverRegions);
    }
    serverRegions.add(region);
    cluster.doAssignRegion(region,server);
  }
  return assignments;
}
