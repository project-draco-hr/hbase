{
  conf.setInt("hbase.client.retries.number",10);
  HTable table=new HTable(conf,TEST_TABLE);
  table.setAutoFlush(false);
  table.setWriteBufferSize(10 * 1024 * 1024);
  for (  byte[] k : keys) {
    Put put=new Put(k);
    put.add(BYTES_FAMILY,QUALIFIER,VALUE);
    table.put(put);
  }
  table.flushCommits();
  if (doAbort) {
    LOG.info("Aborting...");
    cluster.abortRegionServer(0);
    for (    byte[] k : keys) {
      Put put=new Put(k);
      put.add(BYTES_FAMILY,QUALIFIER,VALUE);
      table.put(put);
    }
    table.flushCommits();
  }
  for (  byte[] k : keys) {
    Get get=new Get(k);
    get.addColumn(BYTES_FAMILY,QUALIFIER);
    Result r=table.get(get);
    assertTrue(r.containsColumn(BYTES_FAMILY,QUALIFIER));
    assertEquals(0,Bytes.compareTo(VALUE,r.getValue(BYTES_FAMILY,QUALIFIER)));
  }
  HBaseAdmin admin=new HBaseAdmin(conf);
  ClusterStatus cs=admin.getClusterStatus();
  int expectedServerCount=2;
  if (doAbort)   expectedServerCount=1;
  LOG.info("Clusterstatus servers count " + cs.getServers());
  assertEquals(expectedServerCount,cs.getServers());
  for (  HServerInfo info : cs.getServerInfo()) {
    LOG.info("Info from clusterstatus=" + info);
    assertTrue(info.getLoad().getNumberOfRegions() > 8);
  }
}
