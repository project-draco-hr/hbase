{
  HLog hlog=new HLog(this.localFs,this.testDir,this.conf);
  HTableDescriptor htd=createTableDescriptor(getName());
  HRegionInfo hri=new HRegionInfo(1,htd,null,null);
  final HRegion r=new HRegion(testDir,hlog,this.localFs,this.conf,hri,null);
  try {
    createStoreFile(r);
    assertFalse(r.needsCompaction());
    int compactionThreshold=this.conf.getInt("hbase.hstore.compactionThreshold",3);
    for (int i=0; i < compactionThreshold; i++) {
      createStoreFile(r);
    }
    assertTrue(r.needsCompaction());
    addContent(new HRegionLoader(r),COLFAMILY_NAME1);
    Thread t1=new Thread(){
      @Override public void run(){
        try {
          r.flushcache(false);
        }
 catch (        IOException e) {
          e.printStackTrace();
        }
      }
    }
;
    Thread t2=new Thread(){
      @Override public void run(){
        try {
          assertTrue(r.compactStores());
        }
 catch (        IOException e) {
          e.printStackTrace();
        }
      }
    }
;
    t1.setDaemon(true);
    t1.start();
    t2.setDaemon(true);
    t2.start();
    t1.join();
    t2.join();
  }
  finally {
    r.close();
    hlog.closeAndDelete();
  }
}
