{
  createStoreFile(r);
  assertFalse(r.needsCompaction());
  for (int i=0; i < COMPACTION_THRESHOLD; i++) {
    createStoreFile(r);
  }
  assertTrue(r.needsCompaction());
  addContent(new HRegionIncommon(r),COLUMN_FAMILY);
  byte[][] bytes=this.r.get(STARTROW,COLUMN_FAMILY_TEXT,100);
  assertTrue(bytes.length >= 5);
  final HRegion region=this.r;
  Thread t1=new Thread(){
    @Override public void run(){
      try {
        region.flushcache(false);
      }
 catch (      IOException e) {
        e.printStackTrace();
      }
    }
  }
;
  Thread t2=new Thread(){
    @Override public void run(){
      try {
        assertTrue(region.compactStores());
      }
 catch (      IOException e) {
        e.printStackTrace();
      }
    }
  }
;
  t1.setDaemon(true);
  t1.start();
  t2.setDaemon(true);
  t2.start();
  t1.join();
  t2.join();
  byte[] secondRowBytes=START_KEY.getBytes(HConstants.UTF8_ENCODING);
  secondRowBytes[START_KEY_BYTES.length - 1]++;
  Text secondRow=new Text(secondRowBytes);
  bytes=this.r.get(secondRow,COLUMN_FAMILY_TEXT,100);
  LOG.info("Count of " + secondRow + ": "+ bytes.length);
  assertTrue(bytes.length == 3 || bytes.length == 4);
  this.r.deleteAll(STARTROW,COLUMN_FAMILY_TEXT,System.currentTimeMillis());
  assertNull(this.r.get(STARTROW,COLUMN_FAMILY_TEXT,100));
  this.r.flushcache(false);
  assertNull(this.r.get(STARTROW,COLUMN_FAMILY_TEXT,100));
  createBunchOfSmallStoreFiles(this.r);
  assertTrue(this.r.needsCompaction());
  this.r.compactStores();
  bytes=this.r.get(STARTROW,COLUMN_FAMILY_TEXT,100);
  assertNull(bytes);
  for (  MapFile.Reader reader : this.r.stores.get(COLUMN_FAMILY_TEXT_MINUS_COLON).readers.values()) {
    reader.reset();
    HStoreKey key=new HStoreKey();
    ImmutableBytesWritable val=new ImmutableBytesWritable();
    while (reader.next(key,val)) {
      assertFalse(key.getRow().equals(STARTROW));
    }
  }
}
