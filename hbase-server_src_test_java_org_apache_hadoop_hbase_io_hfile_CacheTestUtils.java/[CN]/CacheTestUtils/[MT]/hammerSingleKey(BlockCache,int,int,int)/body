{
  final BlockCacheKey key=new BlockCacheKey("key",0);
  final byte[] buf=new byte[5 * 1024];
  Arrays.fill(buf,(byte)5);
  final ByteArrayCacheable bac=new ByteArrayCacheable(buf);
  Configuration conf=new Configuration();
  MultithreadedTestUtil.TestContext ctx=new MultithreadedTestUtil.TestContext(conf);
  final AtomicInteger totalQueries=new AtomicInteger();
  toBeTested.cacheBlock(key,bac);
  for (int i=0; i < numThreads; i++) {
    TestThread t=new MultithreadedTestUtil.RepeatingTestThread(ctx){
      @Override public void doAnAction() throws Exception {
        ByteArrayCacheable returned=(ByteArrayCacheable)toBeTested.getBlock(key,false);
        assertArrayEquals(buf,returned.buf);
        totalQueries.incrementAndGet();
      }
    }
;
    t.setDaemon(true);
    ctx.addThread(t);
  }
  ctx.startThreads();
  while (totalQueries.get() < numQueries && ctx.shouldRun()) {
    Thread.sleep(10);
  }
  ctx.stop();
}
