{
  ZooKeeperKeepAliveConnection zkw;
  try {
    zkw=getKeepAliveZooKeeperWatcher();
  }
 catch (  IOException e) {
    throw new ZooKeeperConnectionException("Can't connect to ZooKeeper",e);
  }
  try {
    checkIfBaseNodeAvailable(zkw);
    byte[] masterAddress=ZKUtil.getData(zkw,zkw.masterAddressZNode);
    if (masterAddress == null) {
      throw new IOException("Can't get master address from ZooKeeper");
    }
    ServerName sn=ServerName.parseVersionedServerName(masterAddress);
    if (sn == null) {
      String msg="ZooKeeper available but no active master location found";
      LOG.info(msg);
      throw new MasterNotRunningException(msg);
    }
    InetSocketAddress isa=new InetSocketAddress(sn.getHostname(),sn.getPort());
    HMasterInterface tryMaster=(HMasterInterface)HBaseRPC.getProxy(HMasterInterface.class,HMasterInterface.VERSION,isa,this.conf,this.rpcTimeout);
    if (tryMaster.isMasterRunning()) {
      return tryMaster;
    }
 else {
      HBaseRPC.stopProxy(tryMaster);
      String msg="Can create a proxy to master, but it is not running";
      LOG.info(msg);
      throw new MasterNotRunningException(msg);
    }
  }
  finally {
    zkw.close();
  }
}
