{
  if (cellScanner == null) {
    return null;
  }
  if (codec == null) {
    throw new CellScannerButNoCodecException();
  }
  int bufferSize=this.cellBlockBuildingInitialBufferSize;
  ByteBufferOutputStream baos;
  if (pool != null) {
    ByteBuffer bb=pool.getBuffer();
    bufferSize=bb.capacity();
    baos=new ByteBufferOutputStream(bb);
  }
 else {
    if (cellScanner instanceof HeapSize) {
      long longSize=((HeapSize)cellScanner).heapSize();
      if (longSize > Integer.MAX_VALUE) {
        throw new IOException("Size " + longSize + " > "+ Integer.MAX_VALUE);
      }
      bufferSize=ClassSize.align((int)longSize);
    }
    baos=new ByteBufferOutputStream(bufferSize);
  }
  Compressor poolCompressor=null;
  try (OutputStream os=baos){
    OutputStream os2Compress=os;
    if (compressor != null) {
      if (compressor instanceof Configurable) {
        ((Configurable)compressor).setConf(this.conf);
      }
      poolCompressor=CodecPool.getCompressor(compressor);
      os2Compress=compressor.createOutputStream(os,poolCompressor);
    }
    Codec.Encoder encoder=codec.getEncoder(os2Compress);
    int count=0;
    while (cellScanner.advance()) {
      encoder.write(cellScanner.current());
      count++;
    }
    encoder.flush();
    if (count == 0) {
      return null;
    }
  }
 catch (  BufferOverflowException e) {
    throw new DoNotRetryIOException(e);
  }
 finally {
    if (poolCompressor != null) {
      CodecPool.returnCompressor(poolCompressor);
    }
  }
  if (LOG.isTraceEnabled()) {
    if (bufferSize < baos.size()) {
      LOG.trace("Buffer grew from initial bufferSize=" + bufferSize + " to "+ baos.size()+ "; up hbase.ipc.cellblock.building.initial.buffersize?");
    }
  }
  return baos.getByteBuffer();
}
