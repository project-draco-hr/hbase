{
  try {
    EnvironmentEdgeForMemstoreTest edge=new EnvironmentEdgeForMemstoreTest();
    EnvironmentEdgeManager.injectEdge(edge);
    HBaseTestingUtility hbaseUtility=HBaseTestingUtility.createLocalHTU(conf);
    HRegion region=hbaseUtility.createTestRegion("foobar",new HColumnDescriptor("foo"));
    List<Store> stores=region.getStores();
    assertTrue(stores.size() == 1);
    Store s=stores.iterator().next();
    edge.setCurrentTimeMillis(1234);
    s.add(KeyValueTestUtil.create("r","f","q",100,"v"));
    edge.setCurrentTimeMillis(1234 + 100);
    StringBuffer sb=new StringBuffer();
    assertTrue(!region.shouldFlush(sb));
    edge.setCurrentTimeMillis(1234 + 10000);
    assertTrue(region.shouldFlush(sb) == expected);
  }
  finally {
    EnvironmentEdgeManager.reset();
  }
}
