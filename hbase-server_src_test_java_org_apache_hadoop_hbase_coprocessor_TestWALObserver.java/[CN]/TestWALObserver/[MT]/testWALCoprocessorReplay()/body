{
  TableName tableName=TableName.valueOf("testWALCoprocessorReplay");
  final HTableDescriptor htd=getBasic3FamilyHTableDescriptor(tableName);
  final HRegionInfo hri=new HRegionInfo(tableName,null,null);
  final Path basedir=FSUtils.getTableDir(this.hbaseRootDir,tableName);
  deleteDir(basedir);
  fs.mkdirs(new Path(basedir,hri.getEncodedName()));
  final Configuration newConf=HBaseConfiguration.create(this.conf);
  HLog wal=createWAL(this.conf);
  WALEdit edit=new WALEdit();
  long now=EnvironmentEdgeManager.currentTimeMillis();
  final int countPerFamily=1000;
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addWALEdits(tableName,hri,TEST_ROW,hcd.getName(),countPerFamily,EnvironmentEdgeManager.getDelegate(),wal,htd);
  }
  wal.append(hri,tableName,edit,now,htd);
  wal.sync();
  User user=HBaseTestingUtility.getDifferentUser(newConf,".replay.wal.secondtime");
  user.runAs(new PrivilegedExceptionAction(){
    public Object run() throws Exception {
      Path p=runWALSplit(newConf);
      LOG.info("WALSplit path == " + p);
      FileSystem newFS=FileSystem.get(newConf);
      HLog wal2=createWAL(newConf);
      HRegion region=HRegion.openHRegion(newConf,FileSystem.get(newConf),hbaseRootDir,hri,htd,wal2,TEST_UTIL.getHBaseCluster().getRegionServer(0),null);
      long seqid2=region.getOpenSeqNum();
      SampleRegionWALObserver cp2=(SampleRegionWALObserver)region.getCoprocessorHost().findCoprocessor(SampleRegionWALObserver.class.getName());
      assertNotNull(cp2);
      assertTrue(cp2.isPreWALRestoreCalled());
      assertTrue(cp2.isPostWALRestoreCalled());
      region.close();
      wal2.closeAndDelete();
      return null;
    }
  }
);
}
